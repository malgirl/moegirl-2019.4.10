{"parse":{"title":"User:L.Yakumo/common.js","pageid":207363,"wikitext":{"*":"mw.loader.load('https://wikiplus-app.smartgslb.com/Main.js');\n\n// \u7ef4\u57fa\u767e\u79d1\n\n// Create portlet link\nvar portletLinkOnline = mw.util.addPortletLink(\n\t'p-personal',\n\t'#',\n\t'\u5728\u7ebf\u7ba1\u7406\u5458',\n\t't-onlineadmin',\n\t'\u67e5\u770b\u5f53\u524d\u5728\u7ebf\u7ba1\u7406\u5458',\n\t'',\n\t'#pt-userpage'\n);\n\n\nvar rcstart, rcend, time;\nvar users =[];\nvar admins =[];\nvar uniqueuser, userTotal;\nvar api = new mw.Api();\n\n// Bind click handler\n$( \"li#t-onlineadmin a\" ).click( function () {\n\tusers = [];\n\tusers_ext = [];\n\tadmins = [];\n\tuserTotal = 0;\n\t\n\t//\u6700\u8fd1\u66f4\u653930\u5206\u949f\u5185\u7684\u7f16\u8f91\u7528\u6237\n\ttime= new Date();\n\trcstart=time.toISOString();\n\ttime.setMinutes(time.getMinutes()-30);\n\trcend=time.toISOString();\n\t\n\t//API:RecentChanges\n\tapi.get( {\n\t\tformat: 'json',\n\t\taction: 'query',\n\t\tlist: 'recentchanges',\n\t\trcprop: 'user',\n\t\trcstart: rcstart,\n\t\trcend: rcend,\n\t\trcshow: '!bot|!anon',\n\t\trclimit: 500\n\t\t}).done( function ( data ) {\n\t\t\t$.each( data.query.recentchanges, function( i, item ) {\n\t\t\t    users[i] = item.user;\n\t\t\t});\n\t\t\tapi.get( {\n\t\t\t\tformat: 'json',\n\t\t\t\taction: 'query',\n\t\t\t\tlist: 'logevents',\n\t\t\t\tleprop: 'user',\n\t\t\t\tlepstart: rcstart,\n\t\t\t\tleend: rcend,\n\t\t\t\tlelimit: 500\n\t\t\t\t\t}).done( function ( data ) {\n\t\t\t\t\t\t$.each( data.query.logevents, function( i, item ) {\n\t\t\t    \t\t\tusers_ext[i] = item.user;\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\tArray.prototype.push.apply(users, users_ext); \n\t\t\t//\u7528\u6237\u53bb\u91cd\n\t\t\tusers.sort();\n\t\t\tuniqueuser=$.unique(users).join('|');\n\t\t\t//\u67e5\u8be2\u7528\u6237\u6743\u9650\n\t\t\tapi.get( {\n\t\t    \tformat: 'json',\n\t\t    \taction: 'query',\n\t\t\t\tlist: 'users',\n\t\t    \tususers: uniqueuser,\n\t\t\t\tusprop: 'groups'\n\t\t\t\t} ).done( function ( data ) {  \n\t\t\t\t\t$.each( data.query.users, function( i, user ) {\n\t\t\t\t\t\t//\u627e\u5230\u7ba1\u7406\u5458\uff0c\u53bb\u9664adminbot\n\t\t\t\t\t\tif ($.inArray('sysop', user.groups) > -1 && $.inArray('bot', user.groups) === -1) {\n\t\t\t  \t\t\t\tadmins[i]=user.name;\n\t\t\t\t\t\t}\n\t\t\t\t\t}); \n\t\t\t\t\t//\u6d88\u9664\u7a7a\u503c\n\t\t\t\t\tadmins = admins.filter(function(n){return n});\n\t\t\t\t\t//console.log( admins );\n\t\t\t\t\t//\u7ba1\u7406\u5458\u6570\n\t\t\t\t\tuserTotal=admins.length;\n\t\t\t\t\t//\tmw.notify( '\u4e0a\u7ebf'+userTotal+'\u540d\u7ba1\u7406\u5458' ); \n\t\t\t\t\t//\u663e\u793a\u7ba1\u7406\u5458\u6570\n\t\t\t\t\t$(\"li#t-onlineadmin a\").html(wgUVS( '\u5728\u7ebf\u7ba1\u7406\u5458', '\u7dda\u4e0a\u7ba1\u7406\u54e1' ) + '\uff1a<b>('+userTotal+')</b>');\n                    \n                    if (userTotal>0) {\n                    var adminsstring = '';\n                    //online.preventDefault();\n                    mw.loader.using( 'oojs-ui' ).done( function () {\n                        var popup = new OO.ui.PopupWidget( {\n                            $content: $( '<div id=popupadmin style=\"margin: 0 0 15px\"></div>' ),\n                            padded: true,\n                            head: true,\n                            label: wgUVS( '\u5f53\u524d\u5728\u7ebf\u7684\u7ba1\u7406\u5458\u6709\uff1a', '\u76ee\u524d\u7dda\u4e0a\u7ba1\u7406\u54e1\u6709\uff1a' ),\n                            $container: $(\"#t-onlineadmin\"),\n                            align: 'right',\n                            width: '',\n                            autoClose: true //popup\u53ea\u51fa\u73b0\u4e00\u4e2a\n                        } );\n                        $( '#t-onlineadmin' ).append( popup.$element );\n                            popup.toggle( true );\n                            //var uri = mw.config.get('wgServer')+mw.config.get('wgScript');\n                            $(\"div.oo-ui-popupWidget\").css(\"left\",\"200px\"); //popup\u504f\u79fb\u4fee\u6b63\n                            $.each( admins, function( i, adminuser ) {\n                                adminsstring=adminsstring+'<br /><a href=\"'+mw.config.get('wgScript')+'?title=User:'+adminuser+'\">'+adminuser+'</a> (<a href=\"'+mw.config.get('wgScript')+'?title=User_talk:'+adminuser+'\">\u7559\u8a00</a>)';\n                            });\n                            //console.log( adminsstring );\n                            $('div#popupadmin').append(adminsstring);\n                    });\n                    }\n                    else {\n                        mw.notify( wgUVS( '\u5f53\u524d\u6ca1\u6709\u7ba1\u7406\u5458\u5728\u7ebf\u3002', '\u7ba1\u7406\u54e1\u7121\u4eba\u5728\u7dda\u4e0a\u3002' ) ); // Send a plaintext notification\n                    }\n\t\t\t   });\n\t\t  });\n\t });\t\n});"}}}