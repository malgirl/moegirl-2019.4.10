{"parse":{"title":"MediaWiki:Gadget-patrolPlus.js","pageid":183281,"wikitext":{"*":"$(function() {\n    // Only load this script on RecentChanges and Watchlist\n    // Use wgCanonicalSpecialPageName to provide i18n support\n    if (['Recentchanges', 'Watchlist'].indexOf(mw.config.get('wgCanonicalSpecialPageName')) === -1) return;\n\n    var patrolling = false;\n\n    // For each unptrolled changes\n    $('abbr.unpatrolled').each(function() {\n        var self = $(this);\n\n        // This rules out grouped changes\n    \tif (self.closest('tr').index() === 0 && self.closest('tbody').find('tr')[1]) return;\n\n        // Get the link to diff\n        // XXX: Why not('[href*=\"diff=0\"]')\n    \tvar link = self.closest('li,tr').find('a[href*=\"diff\"]').not('[href*=\"diff=0\"]').first();\n\n        // If the link does not exist (new page), then return\n        if (!link[0]) return;\n\n        // \u5386\u53f2\u9057\u7559\u95ee\u9898\n        // XXX: What problem is it?\n        if (/action=history/.test(link.attr('href'))) return;\n\n        var container = $('<a href=\"#\" class=\"patrolLink\"></a>');\n        var revid = +link.attr('href').match(/diff=(\\d+)/)[1];\n\n        // Replace the node with container and add itself to it\n        self.replaceWith(container).appendTo(container).before('[').after(']');\n        self = container;\n\n        function clickHandler(event) {\n            event.preventDefault();\n\n            // There's a on-going patrolling request, abort\n            if (patrolling) return;\n\n            // Asks for confirmation\n            if (!window.confirm('\u4f60\u786e\u5b9a\u8981\u6807\u8bb0\u6b64\u7f16\u8f91\u4e3a\u5df2\u5de1\u67e5\u5417\uff1f')) return;\n\n            patrolling = true;\n\n            // Disable other links\n            $('a.patrolLink').not(self).css({\n                color: '#aaa',\n                \"text-decoration\": 'none'\n            });\n\n            // Replace the element with a span showing status\n            // Note that listener on self is removed ATM\n            var textStatus = $('<span></span>', {\n                html: '[<img src=\"https://static.mengniang.org/common/d/d1/Windows_10_loading.gif\" style=\"height: 1em; margin-top: -.25em;\">\u6b63\u5728\u6807\u8bb0\u4e2d\u2026\u2026]'\n            });\n            self.replaceWith(textStatus);\n\n            // Do the actual patrol request\n            var api = new mw.Api();\n            api.postWithToken('patrol', {\n                action: 'patrol',\n                format: 'json',\n                revid: revid\n            }).then(function(data) {\n                textStatus.text('[\u6807\u8bb0\u6210\u529f]');\n                window.setTimeout(function() {\n                    textStatus.replaceWith('\\u00A0');\n                }, 3000);\n\n                patrolling = false;\n                $('a.patrolLink').removeAttr('style');\n            }, function(error) {\n                textStatus.text('[\u6807\u8bb0\u5931\u8d25\uff1a' + error + '\uff0c\u8bf7\u57283\u79d2\u540e\u91cd\u8bd5]');\n                window.setTimeout(function() {\n                    textStatus.replaceWith(self);\n                    // Re-registering events\n                    self.on('click', clickHandler);\n                    \n                    patrolling = false;\n                    $('a.patrolLink').removeAttr('style');\n                }, 3000);\n            });\n        }\n\n        self.on('click', clickHandler);\n    });\n});"}}}