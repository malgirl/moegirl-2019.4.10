{"parse":{"title":"User:Fossetta/common.js","pageid":272738,"wikitext":{"*":"/*//syntax highlighter\nmw.loader.load('https://www.mediawiki.org/w/index.php?title=MediaWiki:Gadget-DotsSyntaxHighlighter.js&action=raw&ctype=text/javascript');\n\nsyntaxHighlighterConfig = {\n    timeout: 2000,\n    boldOrItalicColor:  \"gray\", \n    wikilinkColor: \"#E6FFFF\", //cyan \n    externalLinkColor: \"#E6E6FF\", //orange\n    listOrIndentColor: \"#purple\", \n    signatureColor: \"red\",\n    tableColor: \"lime\",//\u4e0d\u80fd\u662f\u9ec4\u8272yellow\u2026\u4f1a\u548c360\u6d4f\u89c8\u5668\u9875\u9762\u5185\u641c\u7d22\u529f\u80fd\u91cd\u590d\n    hrColor: \"brown\",\n    tagColor: \"pink\",\n    commentColor: \"#D1F6FD\", //\u84dd\n    entityColor: \"magenta\",\n};\n//syntax highlighter END\n//<!--Syntax highlighter\u88dc\u4e01-->\n*/\n//\u7ec8\u4e8e\u4fee\u590d\u4e86\n\n$(function(){\n    function nct(nct, url, life){\n        var life = life || 5000\n        if(url){ nct.onclick = function(){ open(url, '_blank') } } \n        setTimeout(function(){\n            nct.close()\n        }, life)\n    }\n    \n    if(! Notification){\n        alert('\u4f60\u7684\u6d4f\u89c8\u5668\u7248\u672c\u8fc7\u4f4e\u6216\u4e0d\u652f\u6301\u67d0\u4e9b\u529f\u80fd\uff0c\u65e0\u6cd5\u4f7f\u7528\u6b64\u63d2\u4ef6\uff01') \n        return false\n    }\n\n    if(Notification.permission == 'default'){\n        alert('\u70b9\u51fb\u5173\u95ed\u8fd9\u6761\u6d88\u606f\u540e\uff0c\u5c06\u5f39\u51fa\u6388\u4e88\u901a\u77e5\u6743\u9650\u7684\u7a97\u53e3\uff0c\u5c4a\u65f6\u8bf7\u70b9\u51fb\u201c\u5141\u8bb8\u201d\uff0c\u4ee5\u4fdd\u8bc1\u63d2\u4ef6\u7684\u6b63\u786e\u8fd0\u884c\u3002')\n    }\n\n    Notification.requestPermission(function(){\n        var status = Notification.permission\n        if(status == 'granted'){\n            if(! localStorage.getItem('widget-notification-messageMark')){\n                localStorage.setItem('widget-notification-messageMark', 'true')\n                nct(new Notification('\u6b22\u8fce', {\n                    body : '\u60a8\u5df2\u7ecf\u6210\u529f\u5f00\u542f\u901a\u77e5\u529f\u80fd\uff0c\u6b22\u8fce\u4f7f\u7528\uff01',\n                    icon : 'https://static.mengniang.org/common/d/d1/%E5%A4%A7%E8%90%8C%E5%AD%97.png'\n                }))\n            }\n        }\n        if(status == 'denied'){\n            alert('\u60a8\u672a\u80fd\u6b63\u786e\u6388\u4e88\u901a\u77e5\u6743\u9650\uff0c\u82e5\u8981\u7ee7\u7eed\u4f7f\u7528\uff0c\u8bf7\u5728url\u680f\u5de6\u4fa7\u70b9\u51fb\u5c0f\u9501\u6807\u5fd7\u5f00\u542f\u6743\u9650\uff0c\u82e5\u65e0\u6cd5\u8bbe\u7f6e\uff0c\u8bf7\u4ece\u4f60\u7684\u7528\u6237\u9875\u5220\u53bb\u6b64\u63d2\u4ef6\u3002')\n        }\n    })\n\n\tfunction getTimeISO8061(){\n\t\tvar fun = function(num){\n\t\t\treturn num < 10 ? '0' + num : num\n\t\t}\n\t    var time = new Date()\n\t    var y = time.getUTCFullYear(),\n\t    m = fun(time.getUTCMonth() + 1),\n\t    d = fun(time.getUTCDate()),\n\t    h = fun(time.getUTCHours()),\n\t    i = fun(time.getUTCMinutes()),\n\t    s = fun(time.getUTCSeconds())\n\t    var timeStr = y + '-' + m + '-' + d + 'T' + h + ':' + i + ':' + s + 'Z'\n\t    return timeStr\n\t}\n\tvar api = new mw.Api()\n\t\n    var watchList = []\n    var apiContinue = null\n    function getWatch(){\n        var request = {\n\t\t\t\"action\": \"query\",\n\t\t\t\"format\": \"json\",\n\t\t\t\"list\": \"watchlistraw\",\n\t\t\t\"utf8\": 1,\n\t\t\t\"wrlimit\": \"max\"\n\t\t}\n        if(apiContinue){\n            request.wrcontinue = apiContinue.wrcontinue\n            request.continue = apiContinue.continue\n        }else{\n        \tdelete request.wrcontinue\n        \tdelete request.continue\n        }\n        api.get(request).done(function(data){\n            apiContinue = data.continue\n            var watch = data.watchlistraw\n            $.each(watch, function(){\n                watchList.push(this.title)\n            })\n            apiContinue && getWatch()\n        })\n    }\n    getWatch()\t\n\n    pages = watchList\n\n\tvar lastSearchTime = getTimeISO8061()\n\tsetInterval(function(){\n\t    var memoryTime = localStorage.getItem('widget-notification-lastSearchTime')\n\t    if(memoryTime){\n\t        lastSearchTime = memoryTime\n\t    }\n\t    console.log(lastSearchTime)\n\t    api.get({\n\t        action: 'query',\n\t        format: 'json',\n\t        prop: '',\n\t        list: 'recentchanges',\n            rcend : lastSearchTime,\n\t        rclimit: 'max',\n\t        utf8: 1,\n\t        formatversion: 1,\n\t        rcprop: 'title|user|comment'\n\t    }).done(function(data){\n\t        localStorage.setItem('widget-notification-lastSearchTime', getTimeISO8061())\n\t        var query = data.query.recentchanges\n\t        var filter = []\n\t        $.each(query, function(){\n\t            for(var i=0; i < pages.length; i++){\n\t                if(this.title == pages[i]){\n\t                    var only = true\n\t                \tfor(var j=0;j < filter.length;j++){\n\t                \t\tif(this.title == filter[j].title){\n\t                \t\t\tonly = false\t\t\n\t                \t\t}\n\t                \t}\n\t\t\t\t\t\tonly && filter.push(this)\n\t                }\n\t            }\n\t        })\n\t        console.log(filter)\n\t        $.each(filter, function(){\n                nct(new Notification(this.user + ' \u5728' + '\u3010' + this.title + '\u3011' + '\\n\u4f5c\u51fa\u4e86\u7f16\u8f91\u3002', {\n                    body : this.comment ? '\u6458\u8981' + this.comment : '',\n                    icon : '//commons.moegirl.org/extensions/Avatar/avatar.php?user=' + this.user\n                }))\n            })\n\t    })\n\n        api.get({\n            action: \"query\",\n            format: \"json\",\n            prop: \"\",\n            meta: \"notifications\",\n            utf8: 1,\n            notfilter: \"!read\",\n            notlimit: \"max\"\n        }).done(function(data){\n            var query = data.query.notifications.list\n            $.each(query, function(){\n                var msgNct = function(text, $this){\n                    nct(new Notification($this.agent.name + '\uff1a', {\n                        body : text,\n                        icon : '//commons.moegirl.org/extensions/Avatar/avatar.php?user=' + $this.agent.name\n                    }), 'https://zh.moegirl.org/' + $this.title.full)\n                }\n                switch(this.type){\n                    case 'edit-thank' : {\n                        msgNct('\u5bf9\u60a8\u5728' + '\u3010' + this.title.full + '\u3011' + '\u7684\u7f16\u8f91\u8868\u793a\u4e86\u611f\u8c22\uff01', this)\n                        break\n                    }\n                    case 'edit-user-talk' : {\n                        msgNct('\u5728\u60a8\u7684\u8ba8\u8bba\u9875\u7559\u8a00\u4e86\u3002', this)\n                        break\n                    }\n                    case 'flowthread_reply' : {\n                        msgNct('\u56de\u590d\u4e86\u60a8\u5728' + '\u3010' + this.title.full + '\u3011' + '\u7684\u8bc4\u8bba\u3002', this)\n                        break\n                    }\n                    case 'flowthread_userpage' : {\n                        msgNct('\u5728\u60a8\u7684\u7528\u6237\u9875\u7559\u4e0b\u4e86\u8bc4\u8bba\u3002', this)\n                        break\n                    }\n                }\n            })\n        })\n\n\t}, 10000000)\n    \n})"}}}