{"parse":{"title":"Widget:BilibiliCount","pageid":185073,"wikitext":{"*":"<noinclude>\n\u4ec5\u4f9b{{tl|BilibiliCount}}\u4f7f\u7528\u3002\n</noinclude><includeonly><!--{if !isset($wgBilibiliCount) || !$wgBilibiliCount}--><!--{assign var=\"wgBilibiliCount\" value=true scope=\"global\"}--><script>\nwindow.RLQ = window.RLQ || [];\nwindow.RLQ.push(function() {\n    var helper = {\n        sendError: function sendError(error) {\n            console.info('widget:BilibiliCount', error.type, 'occurred:', error.information);\n            var t = '';\n            for (var i in error) {\n                t += '<br>' + i + ': ' + JSON.stringify(error[i]);\n            }\n            $('.bilibiliCount').first().html('BilibiliCount\u8fd0\u884c\u9519\u8bef\uff1a' + t);\n        },\n        format: function format(r, t) {\n            switch (t) {\n                case 'value':\n                    if (!/\\D/.test(r) && +r > 10000) r = (+r / 10000).toFixed(2) + '\u4e07';\n                    break;\n                case 'date':\n                    r = new Date(r).toISOString().replace(/T|\\.\\d{3}Z$/g, ' ').trim();\n                    break;\n            }\n            return r;\n        },\n        clear: function clear() {\n            $('.bilibiliCount[data-bilibili-count-onlyTime=\"false\"][data-bilibili-count-noTime=\"true\"] sub').remove();\n            $('.bilibiliCount[data-bilibili-count-onlyTime=\"true\"]').each(function() {\n                $(this).text($(this).find('sub').text().slice(1, -1));\n            });\n        }\n    }\n    $(function() {\n        try {\n            var typelist = [undefined, \"view\", \"danmaku\", \"reply\", \"favorite\", \"coin\", \"share\", \"his_rank\", \"like\", \"dislike\"], //\u9996\u4f4dundefined\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u51cf\u6cd5\n                map = {},\n                aidList = '',\n                localCache = {},\n                _localCache;\n            try {\n                _localCache = JSON.parse(localStorage.getItem('AnnTools-BilibiliCount'));\n                if (!$.isPlainObject(_localCache)) {\n                    console.info(\"Widget:BilibiliCount localCache type invalid\");\n                    _localCache = {};\n                }\n            } catch (e) {\n                _localCache = {};\n            }\n            var now = new Date().getTime();\n            Object.keys(_localCache).forEach(function(aid) {\n                var cache = _localCache[aid];\n                if (now - cache.timestamp < 86400000) localCache[aid] = cache;\n            });\n            $('.bilibiliCount').each(function() {\n                var id = this.dataset.bilibiliCountId,\n                    type = this.dataset.bilibiliCountType || \"1\";\n                if (!/^\\d+$/.test(id)) return;\n                if (/^\\d+$/.test(type)) type = typelist[type];\n                if (typelist.indexOf(type) < 1) type = undefined;\n                if (!type) return;\n                if (localCache[id] && localCache[id].data[type]) {\n                    $(this).empty().append('<span>' + helper.format(localCache[id].data[type], 'value') + '</span>').append('<sub>(' + helper.format(localCache[id].timestamp, 'date').slice(0, 10) + ')</sub>');\n                } else {\n                    if (!$.isPlainObject(map[id])) map[id] = {};\n                    if (!map[id][type] || map[id][type].jquery !== $.prototype.jquery) map[id][type] = $();\n                    map[id][type].push(this);\n                }\n            });\n            helper.clear();\n            aidList = Object.keys(map).join('|');\n            $.ajax({\n                url: 'https://moegirlpedia.annangela.moe/BilibiliRateCollector/BilibiliRateCollector.php?aid=' + aidList,\n                type: 'GET',\n                success: function(d) {\n                    if (d.error || d.query.code !== 0) return;\n                    for (var i in map) {\n                        var data = d.query.videos[i];\n                        for (var t in map[i]) {\n                            if (!data.data) {\n                                map[i][t].empty().append('<span> (Error: NO DATA for av' + i + ') </span>');\n                                continue;\n                            }\n                            map[i][t].empty().append('<span>' + helper.format(data.data[t], 'value') + '</span>').append('<sub>(' + data.time.slice(0, 10) + ')</sub>');\n                        }\n                        localCache[i] = {\n                            timestamp: now,\n                            data: data.data\n                        }\n                    }\n                    helper.clear();\n                    localStorage.setItem('AnnTools-BilibiliCount', JSON.stringify(localCache));\n                },\n                error: function(e) {\n                    helper.sendError({\n                        type: 'network',\n                        information: {\n                            readyState: e.readyState,\n                            state: e.state(),\n                            responseText: e.responseText,\n                            status: e.status,\n                            statusText: e.statusText\n                        }\n                    })\n                }\n            });\n        } catch (e) {\n            helper.sendError({\n                type: 'throw_error',\n                information: {\n                    name: e.name,\n                    message: e.message,\n                    stack: e.stack\n                }\n            });\n        }\n    });\n});\n</script><!--{/if}--></includeonly>"}}}