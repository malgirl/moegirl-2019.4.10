{"parse":{"title":"MediaWiki:Gadget-EditDraft.js","pageid":118531,"wikitext":{"*":"// <pre>\n/* eslint-disable */\n/* jshint ignore:start */\n'use strict';\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nif (['edit', 'submit'].indexOf(mw.config.get('wgAction')) !== -1) $.get('https://zh.moegirl.org/User:AnnAngela/css/QuickSaveDraft.main.css?action=raw&ctype=text/css', function (_d) {\n    \"use strict\";\n\n    var QuickSaveDraftUI = function () {\n        function QuickSaveDraftUI(buttonArea, textarea, section, timer) {\n            _classCallCheck(this, QuickSaveDraftUI);\n\n            var //vscode\u7684\u7f29\u8fdb\u8fd8\u662f\u6709\u95ee\u9898\n            saveButton = this.inputConstruct({\n                class: 'QuickSaveDraftSaveButton',\n                val: '\u7acb\u5373\u4fdd\u5b58\u8349\u7a3f',\n                attr: {\n                    type: 'button'\n                }\n            }),\n                recoverButton = this.inputConstruct({\n                class: 'QuickSaveDraftRecoverButton',\n                val: '\u6682\u65e0\u8349\u7a3f',\n                attr: {\n                    type: 'button'\n                }\n            }),\n                rollbackButton = this.inputConstruct({\n                class: 'QuickSaveDraftRollbackButton',\n                val: '\u56de\u9000\u8fd8\u539f',\n                attr: {\n                    type: 'button'\n                }\n            }),\n                timerInput = this.inputConstruct({\n                class: 'QuickSaveDraftTimerInput',\n                val: timer, //\u9ed8\u8ba4\u503c\n                maxlength: 2\n            }),\n                timerSave = $('<span/>', {\n                id: 'QuickSaveDraftTimerSave'\n            }),\n                lastRun = $('<div/>', {\n                class: 'QuickSaveDraftLastRunDiv',\n                text: '\u4e0a\u6b21\u8349\u7a3f\u4fdd\u5b58\u4e8e'\n            }).append($('<span/>', {\n                class: 'QuickSaveDraftLastRun'\n            })),\n                pasueButton = this.inputConstruct({\n                class: 'QuickSaveDraftPauseButton',\n                val: '\u70b9\u51fb\u6682\u505c\u81ea\u52a8\u4fdd\u5b58',\n                attr: {\n                    type: 'button'\n                }\n            }),\n                sectionList = $('<div/>').append('\u5f53\u524d\u7ae0\u8282\u53f7\u4e3a').append($('<span/>', {\n                class: 'QuickSaveDraftSectionNow',\n                css: {\n                    'font-weight': 'bold'\n                },\n                text: section\n            })).append($('<span/>', {\n                class: 'QuickSaveDraftSectionDraftSpan',\n                text: '\uff0c\u8349\u7a3f\u7ae0\u8282\u53f7\u4e3a'\n            }).append($('<span/>', {\n                class: 'QuickSaveDraftSectionDraft'\n            }))).append($('<span/>', {\n                class: 'QuickSaveDraftSame',\n                text: '\uff0c\u8349\u7a3f\u5185\u5bb9\u4e0e\u5f53\u524d\u7f16\u8f91\u5185\u5bb9\u4e00\u81f4'\n            }));\n            recoverButton.disable();\n            rollbackButton.disable();\n            buttonArea.append(saveButton).append(recoverButton).append(rollbackButton).append('\u6bcf\u9694').append(timerInput).append('\u5206\u949f\u4fdd\u5b58\u4e00\u6b21').append(timerSave).append(pasueButton).append(lastRun).append(sectionList);\n            Object.assign(this, {\n                textarea: textarea,\n                saveButton: saveButton,\n                recoverButton: recoverButton,\n                rollbackButton: rollbackButton,\n                pasueButton: pasueButton,\n                timerInput: timerInput,\n                lastRun: lastRun,\n                sectionList: sectionList,\n                timerSave: timerSave,\n                timerSaveCode: null\n            });\n        }\n\n        _createClass(QuickSaveDraftUI, [{\n            key: 'inputConstruct',\n            value: function inputConstruct(opt) {\n                var r = $('<span/>');\n                var input = $('<input/>', opt);\n                if (opt.attr && opt.attr.type === \"button\") {\n                    r.addClass('oo-ui-widget oo-ui-widget-enabled oo-ui-inputWidget oo-ui-buttonElement oo-ui-buttonElement-framed oo-ui-labelElement oo-ui-buttonInputWidget');\n                    input.addClass('oo-ui-inputWidget-input oo-ui-buttonElement-button');\n                } else {\n                    r.addClass('oo-ui-widget oo-ui-widget-enabled oo-ui-inputWidget oo-ui-textInputWidget oo-ui-textInputWidget-type-text QuickSaveDraftTimer');\n                    input.addClass('oo-ui-inputWidget-input');\n                }\n                r.append(input);\n                ['on', 'val', 'disable', 'enable'].forEach(function (key) {\n                    r[key] = input[key].bind(input);\n                });\n                return r;\n            }\n        }, {\n            key: 'watch',\n            value: function watch(callback, _self) {\n                var self = this;\n                self.timerInput.on('input', function () {\n                    var result = callback($(this).val(), _self) ? '\uff0c\u4fdd\u5b58\u6210\u529f\uff01' : '\uff0c\u4fdd\u5b58\u5931\u8d25';\n                    self.timerSave.text(result);\n                    self.timerSave.removeClass('disapper');\n                    if (self.timerSaveCode) window.clearTimeout(self.timerSaveCode);\n                    self.timerSaveCode = window.setTimeout(function () {\n                        self.timerSave.addClass('disapper');\n                    }, 3000);\n                });\n            }\n        }, {\n            key: 'complement',\n            value: function complement(n, l) {\n                n += '';\n                if (n.length >= l) return n;\n                var b = '<span style=\"speak:none;visibility:hidden;color:transparent;\">',\n                    c = '';\n                while (l > (n + c).length) {\n                    c += '0';\n                }return b + c + '</span>' + n;\n            }\n        }]);\n\n        return QuickSaveDraftUI;\n    }();\n\n    var QuickSaveDraft = function () {\n        function QuickSaveDraft() {\n            _classCallCheck(this, QuickSaveDraft);\n\n            var pagename = mw.config.get('wgPageName'),\n                user = mw.config.get('wgUserId');\n            //this.clear();\n            Object.assign(this, {\n                pagename: pagename,\n                user: user,\n                version: '2.0',\n                section: location.search.match(/section=(\\d+)/) ? +location.search.match(/section=(\\d+)/)[1] : -1,\n                pause: false,\n                originText: null\n            });\n            for (var i in localStorage) {\n                if (!/^AnnTools-QuickSaveDraft-\\d+-timestamp-/.test(i)) continue;\n                var pageName = i.replace(/^AnnTools-QuickSaveDraft-\\d+-timestamp-/, ''),\n                    userId = i.match(/^AnnTools-QuickSaveDraft-(\\d+)-timestamp-/)[1];\n                if (new Date().getTime() - +localStorage[i] > 86400) {\n                    localStorage.removeItem(i);\n                    localStorage.removeItem('AnnTools-QuickSaveDraft-' + userId + '-draft-' + pageName);\n                    localStorage.removeItem('AnnTools-QuickSaveDraft-' + userId + '-section-' + pageName);\n                }\n            }\n            this.init();\n        }\n\n        _createClass(QuickSaveDraft, [{\n            key: 'clear',\n            value: function clear() {\n                for (var i in localStorage) {\n                    if (/^AnnTools\\-QuickSaveDraft/.test(i)) localStorage.removeItem(i);\n                }\n            }\n        }, {\n            key: 'init',\n            value: function init() {\n                var self = this,\n                    textarea = $('#wpTextbox1'),\n                    buttonArea = $('<div/>', {\n                    css: {\n                        'margin-top': '.5em'\n                    }\n                }).appendTo('#editform .editButtons'),\n                    date = self.get('timestamp') ? new Date(+self.get('timestamp')) : undefined;\n                this.UI = new QuickSaveDraftUI(buttonArea, textarea, self.getSection(+self.section), self.get('timer') || (self.set('timer', 3), 3));\n                self.UI.watch(self.saveTime, self);\n                self.UI.rollbackButton.on('click', function () {\n                    if ($(this).is(':disabled') || self.originText === null) return;\n                    textarea.val(self.originText);\n                    self.originText = null;\n                    $(this).disable();\n                    self.check();\n                    return false;\n                });\n                self.UI.recoverButton.on('click', function () {\n                    if ($(this).is(':disabled')) return;\n                    if (self.checkCurrentSection()) return;\n                    self.originText = textarea.val();\n                    textarea.val(self.get('draft'));\n                    self.UI.rollbackButton.enable();\n                    self.check();\n                    return false;\n                });\n                self.UI.saveButton.on('click', function () {\n                    if ($(this).is(':disabled')) return;\n                    self.save(false);\n                    return false;\n                });\n                self.UI.pasueButton.on('click', function () {\n                    if (self.pause) {\n                        $(this).val('\u70b9\u51fb\u6682\u505c\u81ea\u52a8\u4fdd\u5b58');\n                        self.pause = false;\n                    } else {\n                        $(this).val('\u70b9\u51fb\u7ee7\u7eed\u81ea\u52a8\u4fdd\u5b58');\n                        self.pause = true;\n                    }\n                });\n                self.check();\n                /* \u4e0b\u9762\u4e00\u884c\u592a\u957f\u4e86\uff0c\u6362\u4e00\u4e0b\u884c */\n                if (date) self.UI.lastRun.fadeIn().find('span').html((date.getDate() === new Date().getDate() ? '\u4eca' : self.UI.complement(date.getDate(), 2)) + '\\u65E5' + self.UI.complement(date.getHours(), 2) + '\\u65F6' + self.UI.complement(date.getMinutes(), 2) + '\\u5206 \u8349\u7a3f\u957f\u5ea6\u4e3a ' + (self.get('draft').length || '-1\uff08\u6682\u65e0\uff09') + ' \u5b57\u7b26');\n                self.UI.sectionList.find('.QuickSaveDraftSectionDraft').text(self.get('section') || '\u3010\u6682\u65e0\u3011');\n                textarea.on('input change', function () {\n                    self.check();\n                });\n                window.setTimeout(self.loop, self.getTime(), self);\n            }\n        }, {\n            key: 'get',\n            value: function get(t) {\n                if (t === 'timer') return localStorage.getItem('AnnTools-QuickSaveDraft-' + this.user + '-timer');\n                return localStorage.getItem('AnnTools-QuickSaveDraft-' + this.user + '-' + t + '-' + this.pagename);\n            }\n        }, {\n            key: 'set',\n            value: function set(t, v) {\n                if (t === 'timer') return localStorage.setItem('AnnTools-QuickSaveDraft-' + this.user + '-timer', v);\n                return localStorage.setItem('AnnTools-QuickSaveDraft-' + this.user + '-' + t + '-' + this.pagename, v);\n            }\n        }, {\n            key: 'del',\n            value: function del(t) {\n                if (t === 'timer') return localStorage.removeItem('AnnTools-QuickSaveDraft-' + this.user + '-timer');\n                return localStorage.removeItem('AnnTools-QuickSaveDraft-' + this.user + '-' + t + '-' + this.pagename);\n            }\n        }, {\n            key: 'check',\n            value: function check() {\n                if (this.get('draft') === undefined) return this.UI.sectionList.find('.QuickSaveDraftSectionDraftSpan').fadeOut();\n                this.UI.sectionList.find('.QuickSaveDraftSectionDraftDraft').text(this.get('section')).parent().fadeIn();\n                if (this.checkCurrentSection()) //\u68c0\u6d4b\u662f\u5426\u540c\u4e00\u7ae0\u8282\n                    return this.UI.recoverButton.disable().val('\u6682\u65e0\u8349\u7a3f');\n                if (this.get('draft') !== this.UI.textarea.val()) {\n                    //\u68c0\u6d4b\u8349\u7a3f\u662f\u5426\u4e00\u81f4\n                    this.UI.recoverButton.enable().val('\u7acb\u5373\u8fd8\u539f\u8349\u7a3f');\n                    this.UI.sectionList.find('.QuickSaveDraftSame').fadeOut();\n                } else {\n                    this.UI.recoverButton.disable().val('\u6682\u65e0\u8349\u7a3f');\n                    this.UI.sectionList.find('.QuickSaveDraftSame').fadeIn();\n                }\n            }\n        }, {\n            key: 'checkCurrentSection',\n            value: function checkCurrentSection() {\n                return this.section !== (Number.parseInt || Window.parseInt)(this.get('section'));\n            }\n        }, {\n            key: 'getTime',\n            value: function getTime() {\n                return +this.get('timer') * 60000; //min => millisecond\n            }\n        }, {\n            key: 'saveTime',\n            value: function saveTime(time, self) {\n                if (!/\\D/.test(time) && +time > 0) {\n                    self.set('timer', time);\n                    return true;\n                } else {\n                    self.UI.timerInput.val(self.get('timer'));\n                    return false;\n                }\n            }\n        }, {\n            key: 'save',\n            value: function save(s) {\n                var date = new Date(),\n                    value = this.UI.textarea.val();\n                this.set('draft', value);\n                if (value !== this.get('draft')) {\n                    if (s) alert('\u5f53\u524d\u9875\u9762\u5185\u5bb9\u8fc7\u957f\uff0c\u65e0\u6cd5\u4fdd\u5b58\u8349\u7a3f\uff01');\n                    this.del('draft');\n                    this.UI.recoverButton.fadeOut();\n                    this.UI.saveButton.disable().val('\u65e0\u6cd5\u4fdd\u5b58\u8349\u7a3f');\n                    this.UI.lastRun.fadeIn().text('\u5f53\u524d\u9875\u9762\u5185\u5bb9\u8fc7\u957f\uff0c\u65e0\u6cd5\u4fdd\u5b58\u8349\u7a3f\uff01');\n                    return window.setTimeout(function (self) {\n                        self.save = self.loop = function () {\n                            return false;\n                        };\n                    }, 0, this);\n                }\n                this.set('section', this.getSection(+this.section));\n                this.set('timestamp', date.getTime());\n                this.UI.sectionList.find('.QuickSaveDraftSectionDraftSpan').fadeIn().find('.QuickSaveDraftSectionDraft').text(this.getSection(+this.section));\n                this.check();\n                this.UI.lastRun.fadeIn().find('span').html('\\u4ECA\\u65E5' + this.UI.complement(date.getHours(), 2) + '\\u65F6' + this.UI.complement(date.getMinutes(), 2) + '\\u5206 \u8349\u7a3f\u957f\u5ea6\u4e3a ' + (this.get('draft').length || '-1\uff08\u6682\u65e0\uff09') + ' \u5b57\u7b26');\n            }\n        }, {\n            key: 'loop',\n            value: function loop(self) {\n                if (!this.pause) self.save(true);\n                return window.setTimeout(self.loop, self.getTime(), self);\n            }\n        }, {\n            key: 'getSection',\n            value: function getSection(s) {\n                return s === -1 ? '-1\uff08\u5168\u6587\uff09' : s;\n            }\n        }]);\n\n        return QuickSaveDraft;\n    }();\n\n    jQuery.fn.extend({\n        disable: function disable() {\n            return this.each(function () {\n                if (!$(this).is('input,button')) return;\n                if ($(this).parent().hasClass('oo-ui-widget-enabled')) $(this).parent().toggleClass('oo-ui-widget-enabled oo-ui-widget-disabled');\n                this.disabled = true;\n            });\n        },\n        enable: function enable() {\n            return this.each(function () {\n                if (!$(this).is('input,button')) return;\n                if ($(this).parent().hasClass('oo-ui-widget-disabled')) $(this).parent().toggleClass('oo-ui-widget-enabled oo-ui-widget-disabled');\n                this.disabled = false;\n            });\n        }\n    });\n    $('<style/>', {\n        text: _d\n    }).appendTo(document.head);\n    window.AnnTools = window.AnnTools || {};\n    window.AnnTools.QuickSaveDraft = window.AnnTools.QuickSaveDraft || new QuickSaveDraft();\n});\n// </pre>"}}}