{"parse":{"title":"MediaWiki:Gadget-deletion.js","pageid":225051,"wikitext":{"*":"// <pre>\n$(function () {\n    if (mw.config.get('wgNamespaceNumber') !== 14) return;\n    var globalDeletionLock = false;\n    (function run() {\n        if (!mw || !mw.util || !mw.util.addPortletLink) return setTimeout(function () {\n            run();\n        }, 1000);\n        var container = $('.mw-category-generated'),\n            node = $('<p/>').attr('id', 'deletionControl');\n        $(mw.util.addPortletLink('p-cactions', '#', '\u6279\u91cf\u5220\u9664\u672c\u5206\u7c7b\u4e0b\u9875\u9762', 'startDeletion', '\u6279\u91cf\u5220\u9664\u672c\u5206\u7c7b\u4e0b\u9875\u9762')).attr('class', \"sysop-show\").on('click', function () {\n            if ($('#deletionControl')[0]) return false;\n            container.before(node);\n            node.text('\u8bf7\u9009\u62e9\u8981\u5220\u9664\u7684\u9875\u9762\uff1a').append('\uff08\u5df2\u9009\uff1a<span id=\"delectionSelectingNumber\"> - </span>/\u603b\u8ba1\uff1a<span id=\"delectionTotalNumber\"> - </span>\uff09').append($('<input/>').attr({\n                type: 'button',\n                value: '\u5168\u9009',\n                id: 'selectAll'\n            })).append($('<input/>').attr({\n                type: 'button',\n                value: '\u5168\u4e0d\u9009',\n                id: 'selectNone'\n            })).append($('<input/>').attr({\n                type: 'button',\n                value: '\u63d0\u4ea4',\n                id: 'runDeletion'\n            })).append($('<input/>').attr({\n                type: 'button',\n                value: '\u53d6\u6d88',\n                id: 'cancelDeletion'\n            }));\n            $('body').addClass('deletion');\n            $('.mw-category-generated li').prepend($('<input/>').attr({\n                type: 'checkbox',\n                class: 'selectBox'\n            })).find('.stub').toggleClass('stub _stub');\n            $('#delectionTotalNumber').text($('.mw-category-generated li :checkbox').length);\n            $('.mw-category-generated li :checkbox').on('change', function () {\n                $('#delectionSelectingNumber').text($('.mw-category-generated li :checkbox:checked').length);\n            }).change();\n            $('.mw-category-generated > div > p').each(function () {\n                $('<input/>').attr({\n                    type: 'button',\n                    value: '\u5168\u9009\u672c\u7c7b\u522b\u9875\u9762',\n                    class: 'deletionControlButton'\n                }).appendTo(this).on('click', function () {\n                    $(this).closest('.mw-category-generated > div').find(':checkbox:not(:disabled)').attr('checked', 'checked').first().change();\n                });\n                $('<input/>').attr({\n                    type: 'button',\n                    value: '\u5168\u4e0d\u9009\u672c\u7c7b\u522b\u9875\u9762',\n                    class: 'deletionControlButton'\n                }).appendTo(this).on('click', function () {\n                    $(this).closest('.mw-category-generated > div').find(':checkbox:not(:disabled)').removeAttr('checked').first().change();\n                });\n            });\n            return false;\n        });\n        $('body').on('click', function (event) {\n            var self = $(event.target);\n            if (self.is('#selectAll')) {\n                if (globalDeletionLock) return false;\n                container.find('li :checkbox:not(:disabled)').attr('checked', 'checked').first().change();\n            } else if (self.is('#selectNone')) {\n                if (globalDeletionLock) return false;\n                container.find('li :checkbox:not(:disabled)').removeAttr('checked').first().change();\n            } else if (self.is('#cancelDeletion')) {\n                if (globalDeletionLock) return false;\n                $('#deletionControl, .deletionControlButton').remove();\n                container.find('._stub').toggleClass('stub _stub');\n                container.find('.selectBox').remove();\n                $('.disabled').removeClass('disabled');\n            } else if (self.is('#runDeletion')) {\n                if (globalDeletionLock) return false;\n                if (!confirm('\u60a8\u786e\u5b9a\u8981\u5220\u9664\u8fd9\u4e9b\u9875\u9762\u5417\uff1f\uff08\u9009\u4e2d\u4e86' + $('.mw-category-generated li :checkbox:checked').length + '\u4e2a\u9875\u9762\uff09')) return;\n                container.find('.selectBox').attr('disabled', 'disabled');\n                $('#deletionControl').html('<span id=\"result_text\"><img src=\"https://static.mengniang.org/common/d/d1/Windows_10_loading.gif\" style=\"height: 1em; margin-top: -.25em;\"><span id=\"delectionStatus\"></span></span>');\n                var statu = $(\"#delectionStatus\");\n                statu.text(\"\u6b63\u5728\u83b7\u53d6\u8fd9\u4e9b\u9875\u9762\u7684\u6700\u540e\u4e00\u6b21\u7f16\u8f91\u7684\u6267\u884c\u8005\u2026\u2026\");\n                globalDeletionLock = true;\n                container.find('a').each(function () {\n                    if (/User:AnnAngela\\/SandBox/.test($(this).text()) || !$(this).closest('li').find(':checked')[0])\n                        $(this).addClass('disabled');\n                });\n                var api = new mw.Api();\n                api.post({\n                    action: \"query\",\n                    rvprop: \"user\",\n                    prop: 'revisions',\n                    titles: container.find('a').not('.disabled').map(function () {\n                        if ($(this).closest(\"#mw-subcategories\")[0]) {\n                            return '\u5206\u7c7b:' + $(this).text();\n                        }\n                        else {\n                            return $(this).text();\n                        }\n                    }).toArray().join(\"|\").replace(/\\|+/g, '|'),\n                }).then(function (data) {\n                    statu.text(\"\u6b63\u5728\u68c0\u67e5\u8fd9\u4e9b\u6267\u884c\u8005\u662f\u5426\u4e3a\u6709\u6743\u6267\u884c\u8005\u2026\u2026\");\n                    var d = [];\n                    for (var i in data.query.pages) {\n                        if (i < 0) continue;\n                        d.push({\n                            title: data.query.pages[i].title,\n                            user: data.query.pages[i].revisions[data.query.pages[i].revisions.length - 1].user,\n                        });\n                    }\n                    return api.post({\n                        action: \"query\",\n                        list: \"allusers\",\n                        aurights: \"rollback\",\n                        aulimit: 500,\n                    }).then(function (_users) {\n                        var users = _users.query.allusers.map(function (u) {\n                            return u.name;\n                        });\n                        return d.map(function (p) {\n                            p.isTrusted = users.includes(p.user);\n                            return p;\n                        });\n                    });\n                }).then(function (pages) {\n                    pages.forEach(function (page) {\n                        var link = $('a[href=\"/' + encodeURI(page.title) + '\"]');\n                        if (page.isTrusted === false) {\n                            link.addClass(\"disabled\").css({\n                                \"font-weight\": \"bold\", 'margin-right': '2em'\n                            }).after('<span class=\"delectionResult\">   \u5220\u9664\u5931\u8d25\uff08\u6743\u9650\u539f\u56e0\uff09\uff1a\u8be5\u9875\u9762\u6700\u540e\u4e00\u6b21\u7f16\u8f91\u7684\u6267\u884c\u8005\u65e0\u6743\u6302\u5220\uff0c\u8bf7\u624b\u52a8\u68c0\u67e5\u7f16\u8f91\u5386\u53f2\u3002</span>');\n                        }\n                    });\n                    statu.text(\"\u6b63\u5728\u5220\u9664\uff0c\u5df2\u5b8c\u6210\u5220\u9664\u7684\u9875\u9762\u5c06\u4f1a\u88ab\u5220\u9664\u7ebf\u5212\u53bb\u2026\u2026\");\n                    var links = container.find('a').not('.disabled'),\n                        length = links.length;\n                    links.each(function () {\n                        if ($(this).text().trim() === \"\") return;\n                        var self = $(this).css('margin-right', '2em'),\n                            link = decodeURIComponent(self.attr('href').replace('/', ''));\n                        api.postWithToken('csrf', {\n                            action: 'delete',\n                            format: 'json',\n                            title: link,\n                            tags: 'Automation tool',\n                            reason: '\u6279\u91cf\u5220\u9664\u3010' + mw.config.get('wgPageName') + '\u3011\u4e0b\u7684\u9875\u9762'\n                        }, {\n                                timeout: 99999\n                            }).then(function (data) {\n                                self.css('text-decoration', 'line-through').after('<span class=\"delectionResult\"> \u5220\u9664\u6210\u529f</span>');\n                                if (--length <= 0) $(\"#result_text\").text(\"\u5220\u9664\u5df2\u5b8c\u6210\uff01\");\n                            }, function (_, data) {\n                                if (data.error) {\n                                    self.after('<span class=\"delectionResult\">    \u5220\u9664\u5931\u8d25\uff1a' + data.error.info + '</span>');\n                                } else self.after('<span class=\"delectionResult\">   \u5220\u9664\u5931\u8d25\uff08\u7f51\u7edc\u539f\u56e0\uff09\uff1a' + JSON.stringify(data) + '</span>');\n                            });\n                    });\n                });\n            }\n            else if (self.is('a') && globalDeletionLock) {\n                window.open(self[0].href, '_blank');\n                return false;\n            }\n        });\n    })();\n});\n// </pre>"}}}