{"parse":{"title":"MediaWiki:Mobile.js","pageid":134285,"wikitext":{"*":"// <pre>\n/* \u8fd9\u91cc\u7684\u4efb\u4f55JavaScript\u5c06\u53ea\u5728\u79fb\u52a8\u7aef\u52a0\u8f7d \n * \u8bf7\u5c0a\u91cd\u840c\u5a18\u767e\u79d1\u7248\u6743\uff0c\u4ee5\u4e0b\u4ee3\u7801\u590d\u5236\u9700\u8981\u6ce8\u660e\u539f\u81ea\u840c\u5a18\u767e\u79d1\uff0c\u5e76\u4e14\u9644\u4e0aURL\u5730\u5740http://zh.moegirl.org/MediaWiki:Common.js\n * \u7248\u6743\u534f\u5b9a\uff1a\u77e5\u8bc6\u5171\u4eab \u7f72\u540d-\u975e\u5546\u4e1a\u6027\u4f7f\u7528-\u76f8\u540c\u65b9\u5f0f\u5171\u4eab 3.0\n */\n(function ($, mw) { //\u4f7f\u7528\u533f\u540d\u51fd\u6570\u4ee5\u907f\u514d\u6c61\u67d3\u9876\u7ea7\u53d8\u91cf\n    /* \u51fd\u6570\u5b9a\u4e49\u4f53 */\n\n    //Tabs\u652f\u6301\u51fd\u6570\uff0c\u7528\u4e8e\u83b7\u5f97\u5b9e\u9645\u80cc\u666f\u8272\n    function getRealBgColor(ele) {\n        var bgcolor = [0, 0, 0],\n            parent = $(ele).parent();\n        while (bgcolor[0] === 0 && bgcolor[1] === 0 && bgcolor[2] === 0) {\n            var temp = parent.css('background-color');\n            parent = $(parent).parent();\n            var color = temp.match(/rgba?\\((\\d+)\\, ?(\\d+)\\, ?(\\d+)\\,? ?(\\d+)?\\)/i);\n            var transparent = color[4] ? +color[4] : 1;\n            for (var i = 0; i < 3; i++) {\n                bgcolor[i] = +color[i + 1] * transparent;\n            }\n        }\n        return bgcolor;\n    }\n    //Tabs\n    function tabs() {\n        var defaultStyle = {\n            purple: {\n                labelColor: ' ', //anti check\n                labelBackgroundColor: '#9070c0',\n                labelBorderColor: '#b090e0 #7050a0 #9070c0 #b090e0',\n                labelPadding: '.2em .3em .2em .3em',\n                textBorderColor: '#9070c0',\n                textBackgroundColor: '#f0edf5',\n                textPadding: '1em',\n            },\n            green: {\n                labelColor: ' ',\n                labelBackgroundColor: '#75c045',\n                labelBorderColor: '#90d060 #60b030 #75c045 #90d060',\n                labelPadding: '.2em .3em .2em .3em',\n                textBorderColor: '#75c045 #60b030 #60b030 #75c045',\n                textBackgroundColor: '#f5fffa',\n                textPadding: '1em',\n            },\n            red: {\n                labelColor: ' ',\n                labelBackgroundColor: '#FF0000',\n                labelBorderColor: '#FF8888 #CC0000 #FF0000 #FF8888',\n                labelPadding: '.2em .3em .2em .3em',\n                textBorderColor: '#FF0000 #CC0000 #CC0000 #FF0000',\n                textBackgroundColor: '#fffafa',\n                textPadding: '1em',\n            },\n            blue: {\n                labelColor: ' ',\n                labelBackgroundColor: '#5b8dd6',\n                labelBorderColor: '#88abde #3379de #5b8dd6 #88abde',\n                labelPadding: '.2em .3em .2em .3em',\n                textBackgroundColor: '#f0f8ff',\n                textBorderColor: '#5b8dd6 #3379de #3379de #5b8dd6',\n                textPadding: '1em',\n            },\n            yellow: {\n                labelColor: ' ',\n                labelBackgroundColor: '#ffe147',\n                labelBorderColor: '#ffe977 #ffd813 #ffe147 #ffe977',\n                labelPadding: '.2em .3em .2em .3em',\n                textBackgroundColor: '#fffce8',\n                textBorderColor: '#ffe147 #ffd813 #ffd813 #ffe147',\n                textPadding: '1em',\n            },\n            orange: {\n                labelColor: ' ',\n                labelBackgroundColor: '#ff9d42',\n                labelBorderColor: '#ffac5d #ff820e #ff9d42 #ffac5d',\n                labelPadding: '.2em .3em .2em .3em',\n                textBackgroundColor: '#ffeedd',\n                textBorderColor: '#ff9d42 #ff820e #ff820e #ff9d42',\n                textPadding: '1em',\n            },\n            black: {\n                labelColor: ' ',\n                labelBackgroundColor: '#7f7f7f',\n                labelBorderColor: '#999999 #4c4c4c #7f7f7f #999999',\n                labelPadding: '.2em .3em .2em .3em',\n                textBackgroundColor: '#e5e5e5',\n                textBorderColor: '#7f7f7f #4c4c4c #4c4c4c #7f7f7f',\n                textPadding: '1em',\n            },\n        };\n        $('body').addClass('tab');\n        // A Class\n        function StyleSheet() { }\n        StyleSheet.prototype.getOwnPropertyNamesLength = function getOwnPropertyNamesLength() {\n            return Object.getOwnPropertyNames(this).length;\n        };\n        String.prototype.toLowerFirstCase = function toLowerFirstCase() {\n            return this[0].toLowerCase() + this.substring(1);\n        };\n        $('.Tabs').each(function (i) {\n            if ($(this).children('.TabLabel')[0]) return true;\n            var self = $(this),\n                data = $.extend({\n                    labelPadding: null,\n                    labelBorderColor: null,\n                    labelColor: null,\n                    labelBackgroundColor: $('#content').css('background-color'),\n                    textPadding: null,\n                    textBorderColor: null,\n                    textBackgroundColor: null,\n                    defaultTab: 1,\n                }, self.attr('class').length > 4 ? defaultStyle[self.attr('class').slice(5)] || {} : {}, this.dataset || {}),\n                tabLabel = self.append('<div class=\"TabLabel\"></div>').children('.TabLabel'),\n                tabContent = self.append('<div class=\"TabContent\"></div>').children('.TabContent'),\n                labelPadding = data.labelPadding,\n                labelColor = data.labelColor,\n                styleSheet = {\n                    label: new StyleSheet(),\n                    text: new StyleSheet(),\n                },\n                defaultTab = parseInt(data.defaultTab);\n            self.children('.Tab').each(function () {\n                if ($(this).children('.TabLabelText').text().replace(/\\s/g, '')) {\n                    $(this).children('.TabLabelText').appendTo(tabLabel);\n                    $(this).children('.TabContentText').appendTo(self.children('.TabContent'));\n                }\n                $(this).remove();\n            });\n            if (isNaN(defaultTab) || defaultTab <= 0 || defaultTab > tabLabel.children('.TabLabelText').length) defaultTab = 1;\n            tabLabel.children('.TabLabelText').on('click', function () {\n                var label = $(this);\n                label.addClass('selected').siblings().removeClass('selected').css({\n                    'border-color': '#aaa',\n                    'background-color': 'inherit',\n                });\n                tabContent.children('.TabContentText').eq(tabLabel.children('.TabLabelText').index(label)).addClass('selected').siblings().removeClass('selected').removeAttr('style');\n                if (styleSheet.label.getOwnPropertyNamesLength()) label.css(styleSheet.label);\n                if (label.is(':visible')) tabLabel.height(label.outerHeight(true));\n            }).eq(defaultTab - 1).click();\n            if (labelPadding) tabLabel.children('.TabLabelText').css('padding', labelPadding);\n            ['labelBorderColor', 'labelBackgroundColor', 'textPadding', 'textBorderColor', 'textBackgroundColor'].forEach(function (n) {\n                var target = /^label/.test(n) ? 'label' : 'text',\n                    key = n.replace(target, '').toLowerFirstCase();\n                styleSheet[target][key] = data[n];\n            });\n            if (labelColor) styleSheet.label.borderTopColor = labelColor;\n            else if (styleSheet.label.borderColor) styleSheet.label.borderTopColor = 'green';\n            tabLabel.find('.selected').click();\n            if (styleSheet.text.getOwnPropertyNamesLength()) tabContent.css(styleSheet.text);\n            if (data.autoWidth === 'yes') self.css('display', 'inline-block');\n        });\n        $('.TabLabel').each(function () {\n            $(this).css('background-color', getRealBgColor(this));\n            $(this).children('.TabLabelText').css('box-shadow', '0px 1px ' + $(this).next('.TabContent').css('border-top-color'));\n        });\n    }\n    //\u7528\u6237\u8d44\u6599\u9875\u76f8\u5173\n    function isUserProfile() {\n        return mw.config.get('wgCanonicalSpecialPageName') === \"UserProfile\" && mw.config.get('wgArticleId') === \"0\";\n    }\n    //\u9875\u9876\u63d0\u793a\u6a21\u677f\u76f8\u5173\n    function commonBoxs() {\n        if (window.mw && !!mw.config.get('wgNamespaceNumber')) return;\n        var contentParent = $('#mw-content-text')[0] ? $('#mw-content-text') : $('#content'),\n            commonBoxes = contentParent.find('.common-box');\n        if (!commonBoxes[0]) return;\n        var commonBoxContainer = $('<div id=\"commonBoxContainer\"><div id=\"commonBoxInfo\"></div></div>').prependTo(contentParent),\n            commonBoxList = $('<div id=\"commonBoxList\"></div>').appendTo('#commonBoxInfo');\n        commonBoxes.each(function () {\n            var commonBoxButton = $('<div class=\"commonBoxButton\"></div>').appendTo(commonBoxList),\n                commonBox = $(this);\n            commonBoxButton.data('element', commonBox).css({\n                'border-color': commonBox.css('border-left-color'),\n                'background-image': 'url(' + commonBox.find('tbody > tr > td:first-child img').prop('src') + ')',\n            }).on('click', function () {\n                if (commonBox.is(':visible')[0]) {\n                    commonBoxes.hide();\n                    $(this).add($(this).siblings()).removeClass('current');\n                    commonBoxList.removeClass('open');\n                } else {\n                    commonBoxes.filter(':visible').not(commonBox).hide();\n                    commonBox.show();\n                    $(this).toggleClass('current', commonBox.is(':visible')).siblings().removeClass('current');\n                    commonBoxList.toggleClass('open', commonBox.is(':visible'));\n                }\n            });\n        }).appendTo(commonBoxContainer).hide();\n    }\n    //\u94fe\u63a5\u63d0\u793a\n    function linkConfirm() {\n        mw.loader.using('mediawiki.Uri').then(function () {\n            if ($('body').css('position') === 'static') $('body').css('position', 'relative');\n            var prompt = $('<div/>').attr('class', 'linkConfirmprompt');\n            prompt.css('max-width', $('#mw-content-text').width() - 4);\n            var textnode = $('<div/>').attr('class', 'linkConfirmpromptTextnode');\n            var text = $('<span/>');\n            textnode.append(text);\n            var check = window.CSS && CSS.supports && CSS.supports('-webkit-line-clamp', '2') ? (function () {\n                text.css({\n                    display: '-webkit-box',\n                    '-webkit-line-clamp': '2',\n                    '-webkit-box-orient': 'vertical',\n                    'word-break': 'break-all',\n                    'text-overflow': 'ellipsis',\n                    overflow: 'hidden',\n                });\n                return $.noop;\n            })() : function (text) {\n                if (text.height() > 44.8) {\n                    text.text(text.text() + '\u2026\u2026');\n                    while (text.height() > 44.8) {\n                        text.text(text.text().slice(0, -3) + '\u2026\u2026');\n                    }\n                }\n            };\n            prompt.append('\u60a8\u70b9\u51fb\u4e86\u4e00\u4e2a\u94fe\u63a5\uff0c\u5730\u5740\u4e3a\uff1a')\n                .append(textnode)\n                .append($('<div/>').attr('class', 'linkConfirmpromptAlert').append('\u6b64\u7f51\u9875\u4e0d\u5c5e\u4e8e\u672c\u7f51\u7ad9\uff0c\u4e0d\u4fdd\u8bc1\u5176\u5b89\u5168\u6027').hide());\n            prompt.append($('<a/>').text('\u7ee7\u7eed\u8bbf\u95ee').on('click', function () {\n                window.open(prompt.data('href'), '_blank');\n            }))\n                .append($('<a/>').text('\u53d6\u6d88'))\n                .on('click', function (e) {\n                    if (!$(e.target).is('a')) return false;\n                    prompt.fadeOut(137);\n                });\n            prompt.appendTo('body');\n            $('#mw-content-text').on('click', function (e) {\n                var self = $(e.target);\n                if (!self.is(\"a\")) return;\n                if (!e.target.href || /^javascript:/.test(e.target.href) || $(e.target).is('.image')) return true;\n                if (!e.target.dataset.linkid) e.target.dataset.linkid = (Math.random() + '').replace(/\\D/g, '');\n                if (prompt.is(':visible') && prompt.data('linkid') === e.target.dataset.linkid) return false;\n                $('.linkConfirmprompt a:last').click();\n                var uri = new mw.Uri(e.target.href);\n                if (/\\.moegirl\\.org$/.test(uri.host)) {\n                    if (!self.closest('.heimu')[0]) return true;\n                    text.text(decodeURI(self.attr('href')));\n                    $('.linkConfirmpromptAlert').hide();\n                } else {\n                    text.text(uri);\n                    $('.linkConfirmpromptAlert').show();\n                }\n                var promptTop = 0,\n                    promptLeft = 0;\n                var offsetParent = self;\n                do {\n                    promptTop += offsetParent.offset().top;\n                    promptLeft += offsetParent.offset().left;\n                    offsetParent = offsetParent.offsetParent();\n                } while (!offsetParent.is(\"html, body\"));\n                promptTop += self.outerHeight() + 3;\n                promptLeft += self.outerWidth() / 2 - prompt.outerWidth() / 2;\n                if (promptTop + prompt.outerHeight() > $(document).height() - 3) promptTop = $(document).height() - prompt.outerHeight() - 3;\n                if (promptLeft + prompt.outerWidth() > $(window).width() - 3) promptLeft = $(window).width() - prompt.outerWidth() - 3;\n                if (promptLeft < 0) promptLeft = 3;\n                prompt.css({\n                    top: promptTop + 'px',\n                    left: promptLeft + 'px',\n                });\n                window.setTimeout(check, 0, text);\n                prompt.data({\n                    href: uri,\n                    linkid: self[0].dataset.linkid,\n                });\n                prompt.fadeIn(137);\n                return false;\n            });\n        });\n    }\n\n    function antiAbuseListener(textarea, event) {\n        var filters = [\n            \"{{\u5373\u5c06\u5220\u9664\",\n            \"{{\u5373\u5c07\u522a\u9664\",\n            \"{{\u6302\u5220\",\n            \"{{\u6a21\u677f:\u5373\u5c06\u5220\u9664\",\n            \"{{\u6a21\u677f:\u5373\u5c07\u522a\u9664\",\n            \"{{template:\u5373\u5c06\u5220\u9664\",\n            \"{{template:\u5373\u5c07\u522a\u9664\",\n            \"[[\u5206\u7c7b:\u5373\u5c06\u5220\u9664\u7684\u9875\u9762\",\n            \"[[\u5206\u985e:\u5373\u5c07\u522a\u9664\u7684\u9801\u9762\",\n            \"[[category:\u5373\u5c06\u5220\u9664\u7684\u9875\u9762\",\n            \"[[category:\u5373\u5c07\u522a\u9664\u7684\u9801\u9762\",\n            \"{{\u6587\u4ef6\u8f6c\u79fb\u5230\u840c\u5a18\u5171\u4eab\",\n            \"{{\u6587\u4ef6\u8f49\u79fb\u5230\u840c\u5a18\u5171\u4eab\",\n            \"{{\u6a21\u677f:\u6587\u4ef6\u8f6c\u79fb\u5230\u840c\u5a18\u5171\u4eab\",\n            \"{{\u6a21\u677f:\u6587\u4ef6\u8f49\u79fb\u5230\u840c\u5a18\u5171\u4eab\",\n            \"{{template:\u6587\u4ef6\u8f6c\u79fb\u5230\u840c\u5a18\u5171\u4eab\",\n            \"{{template:\u6587\u4ef6\u8f49\u79fb\u5230\u840c\u5a18\u5171\u4eab\",\n            \"[[\u5206\u7c7b:\u9700\u8981\u5220\u9664\u6267\u884c\u5458\u5220\u9664\u7684\u9875\u9762\",\n            \"[[\u5206\u985e:\u9700\u8981\u522a\u9664\u57f7\u884c\u54e1\u522a\u9664\u7684\u9801\u9762\",\n            \"[[category:\u9700\u8981\u5220\u9664\u6267\u884c\u5458\u5220\u9664\u7684\u9875\u9762\",\n            \"[[category:\u9700\u8981\u522a\u9664\u57f7\u884c\u54e1\u522a\u9664\u7684\u9801\u9762\",\n        ];\n        var text1 = textarea.value;\n        text1 = text1.replace(/\\<\\/?(?:nowiki|noinclude)\\>/g, '');\n        text1 = text1.replace(/\\<(onlyinclude|includeonly)\\>.*?\\<\\/\\1\\>/g, '');\n        var text2 = textarea.value;\n        text2 = text2.replace(/\\<\\/?(?:onlyinclude|includeonly)\\>/g, '');\n        text2 = text2.replace(/\\<(nowiki|noinclude)\\>.*?\\<\\/\\1\\>/g, '');\n        var results = [];\n        for (var i = 0, l = filters.length; i < l; i++) {\n            var regExp = new RegExp(filters[i].replace(/\\[/g, '\\\\['), \"i\");\n            if (regExp.test(text1) || regExp.test(text2)) results.push(filters[i]);\n        }\n        if (results.length > 0) {\n            var messageDialog = new OO.ui.MessageDialog();\n            var windowManager = new OO.ui.WindowManager();\n            $(\"body\").append(windowManager.$element);\n            windowManager.addWindows([messageDialog]);\n            messageDialog.title.$label.html(\"\u840c\u5a18\u767e\u79d1\u63d0\u9192\u60a8<br>\u60a8\u7684\u7f16\u8f91\u5305\u542b\u7981\u6b62\u5185\u5bb9\uff01\");\n            messageDialog.message.$label.html(\"<br>\u60a8\u63d0\u4ea4\u7684\u5185\u5bb9\u5305\u542b\u4ee5\u4e0b\u90e8\u5206\uff0c\u88ab\u7981\u6b62\u63d0\u4ea4\uff1a<br><br><ul>\" + results.map(function (result) {\n                return \"<li>\" + result + \"</li>\";\n            }).join(\"\") + '</ul><br><br>\u5982\u679c\u60a8\u8ba4\u4e3a\u60a8\u7684\u7f16\u8f91\u65e0\u8bef\uff0c\u8bf7\u5728\u81ea\u884c\u4fdd\u5b58\u7f16\u8f91\u5185\u5bb9\u540e\u5230<a target=\"_blank\" rel=\"nofollow noreferrer noopener\" class=\"external text\" href=\"https://zh.moegirl.org/Talk:%E6%8F%90%E9%97%AE%E6%B1%82%E5%8A%A9%E5%8C%BA\">\u63d0\u95ee\u6c42\u52a9\u533a</a>\u63d0\u95ee\u3002');\n            windowManager.openWindow(messageDialog, {\n                actions: [{\n                    action: 'accept',\n                    label: '\u6211\u77e5\u9053\u4e86',\n                    flags: 'primary',\n                }],\n            });\n            event.preventDefault();\n            event.stopImmediatePropagation();\n            event.stopPropagation();\n            return false;\n        }\n    }\n\n    function antiAbuse(textarea, submitButton, form) {\n        mw.loader.using([\"oojs-ui\"]).then(function () {\n            var captureSupported = false;\n            try {\n                var options = Object.defineProperty({}, \"capture\", {\n                    get: function () {\n                        captureSupported = true;\n                    },\n                });\n                window.addEventListener(\"test\", null, options);\n            } catch (err) { /* */ }\n            if (submitButton) {\n                submitButton.addEventListener(\"click\", function (e) {\n                    antiAbuseListener(textarea, e);\n                }, captureSupported ? {\n                    capture: true,\n                } : undefined);\n            }\n            if (form) {\n                form.addEventListener(\"submit\", function (e) {\n                    antiAbuseListener(textarea, e);\n                }, captureSupported ? {\n                    capture: true,\n                } : undefined);\n            }\n        });\n    }\n    /* \u51fd\u6570\u6267\u884c\u4f53 */\n    $(function () {\n        //tabs\n        tabs();\n        //\u6765\u81ea\u767e\u5ea6\u7684\u8bbf\u95ee\u9ed8\u8ba4\u8df3\u8f6czh\u7248\n        if (document.referrer.indexOf('//www.baidu.com/') !== -1) window.location.replace($('#mw-mf-display-toggle')[0].href);\n        //\u9875\u9876\u63d0\u793a\u6a21\u677f\u76f8\u5173\n        commonBoxs();\n        //\u7528\u6237\u8d44\u6599\u9875\n        if (isUserProfile()) {\n            var cardContainer = $('.card-container'),\n                containerImage = cardContainer.find('.card'),\n                containerImageFile = containerImage.find('a.image'),\n                containerImageCaption = containerImage.find('.caption');\n            containerImageCaption.css(\"padding\", \"0 8px\");\n            containerImageFile.before('<div id=\"#containerImage\" class=\"listThumb list-thumb-placeholder\" style=\"text-align: center;\"><img src=\"http://static.mengniang.org/common/a/a4/Placeholder-upload.png\" style=\"height:32px\" /></div>');\n        }\n        //\u9ed1\u5e55\n        $('.heimu a').on(\"click\", function () {\n            if (!$(this).closest('.heimu').is(':active, :focus')) return false;\n        });\n        //Template:hide\n        if ($('.mw-collapsible')[0]) mw.loader.using('jquery.makeCollapsible').then(function () {\n            //console.debug('jquery.makeCollapsible is loaded.');\n            $('.mw-collapsible').makeCollapsible();\n        });\n        //\u94fe\u63a5\u63d0\u793a\n        linkConfirm();\n\n        //\u9632\u6ee5\u7528\u5373\u5c06\u5220\u9664\n        if (!mw.config.get('wgUserGroups').includes('sysop') && !mw.config.get('wgUserGroups').includes('patroller')) {\n            setInterval(function () {\n                if ($('#wikitext-editor')[0]) {\n                    var target = $('#wikitext-editor');\n                    if (target.data('isTrusted') !== true) {\n                        target.data('isTrusted', true);\n                        $('.editor-overlay').css('z-index', 3);\n                        antiAbuse(target[0], $('.editor-overlay .header .header-action button.continue')[0], undefined);\n                    }\n                }\n            }, 1000);\n        }\n    });\n})(jQuery, mediaWiki); //\u7acb\u5373\u6267\u884c\u533f\u540d\u51fd\u6570\u5e76\u4f20\u9012\u539f\u59cb\u53d8\u91cf\n// </pre>"}}}