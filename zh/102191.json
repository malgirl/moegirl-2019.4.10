{"parse":{"title":"MediaWiki:Gadget-morebits.js","pageid":164854,"wikitext":{"*":"/*\n * \u672c\u9875\u9762\u662f[[zhwiki:MediaWiki:Gadget-morebits.js]]\u7684\u786c\u5d4c\u5165\u3010[[zhwiki:Special:Permalink/39584068]]\u3011\uff0c\u4f60\u53ef\u4ee5\u8bbf\u95ee[https://github.com/azatoth/twinkle/blob/master/morebits.js]\u4ee5\u83b7\u5f97\u6700\u65b0\u4ee3\u7801\n */\n//<nowiki>\n/* jshint ignore: start */ //too many error\uff0c\u7b80\u76f4\u6bd4w\u541b\u8fd8\u7d27\uff08too small\u2014\u2014\u6559\u4e3b\u4f5b\u62c9\u5c4e\uff09\n(function(window, document, $, undefined) {\n    var Morebits = {};\n    window.Morebits = Morebits;\n    Morebits.userIsInGroup = function(group) {\n        return $.inArray(group, mw.config.get(\"wgUserGroups\")) !== -1;\n    };\n    Morebits.isIPAddress = function(address) {\n        return mw.util.isIPv4Address(address) || mw.util.isIPv6Address(address);\n    };\n    Morebits.sanitizeIPv6 = function(address) {\n        address = address.trim();\n        if (address === \"\") {\n            return null;\n        }\n        if (mw.util.isIPv4Address(address) || !mw.util.isIPv6Address(address)) {\n            return address;\n        }\n        address = address.toUpperCase();\n        var abbrevPos = address.indexOf(\"::\");\n        if (abbrevPos > -1) {\n            var CIDRStart = address.indexOf(\"/\");\n            var addressEnd = CIDRStart > -1 ? CIDRStart - 1 : address.length - 1;\n            var repeat, extra, pad;\n            if (abbrevPos === 0) {\n                repeat = \"0:\";\n                extra = address == \"::\" ? \"0\" : \"\";\n                pad = 9;\n            } else if (abbrevPos === addressEnd - 1) {\n                repeat = \":0\";\n                extra = \"\";\n                pad = 9;\n            } else {\n                repeat = \":0\";\n                extra = \":\";\n                pad = 8;\n            }\n            var replacement = repeat;\n            pad -= address.split(\":\").length - 1;\n            for (var i = 1; i < pad; i++) {\n                replacement += repeat;\n            }\n            replacement += extra;\n            address = address.replace(\"::\", replacement);\n        }\n        address = address.replace(/(^|:)0+([0-9A-Fa-f]{1,4})/g, \"$1$2\");\n        return address;\n    };\n    Morebits.quickForm = function QuickForm(event, eventType) {\n        this.root = new Morebits.quickForm.element({\n            type: \"form\",\n            event: event,\n            eventType: eventType\n        });\n    };\n    Morebits.quickForm.prototype.render = function QuickFormRender() {\n        var ret = this.root.render();\n        ret.names = {};\n        return ret;\n    };\n    Morebits.quickForm.prototype.append = function QuickFormAppend(data) {\n        return this.root.append(data);\n    };\n    Morebits.quickForm.element = function QuickFormElement(data) {\n        this.data = data;\n        this.childs = [];\n        this.id = Morebits.quickForm.element.id++;\n    };\n    Morebits.quickForm.element.id = 0;\n    Morebits.quickForm.element.prototype.append = function QuickFormElementAppend(data) {\n        var child;\n        if (data instanceof Morebits.quickForm.element) {\n            child = data;\n        } else {\n            child = new Morebits.quickForm.element(data);\n        }\n        this.childs.push(child);\n        return child;\n    };\n    Morebits.quickForm.element.prototype.render = function QuickFormElementRender(internal_subgroup_id) {\n        var currentNode = this.compute(this.data, internal_subgroup_id);\n        for (var i = 0; i < this.childs.length; ++i) {\n            currentNode[1].appendChild(this.childs[i].render());\n        }\n        return currentNode[0];\n    };\n    Morebits.quickForm.element.prototype.compute = function QuickFormElementCompute(data, in_id) {\n        var node;\n        var childContainder = null;\n        var label;\n        var id = (in_id ? in_id + \"_\" : \"\") + \"node_\" + this.id;\n        if (data.adminonly && !Morebits.userIsInGroup(\"sysop\")) {\n            data.type = \"hidden\";\n        }\n        var i, current, subnode;\n        switch (data.type) {\n            case \"form\":\n                node = document.createElement(\"form\");\n                node.className = \"quickform\";\n                node.setAttribute(\"action\", \"javascript:void(0);\");\n                if (data.event) {\n                    node.addEventListener(data.eventType || \"submit\", data.event, false);\n                }\n                break;\n            case \"fragment\":\n                node = document.createDocumentFragment();\n                return [node, node];\n            case \"select\":\n                node = document.createElement(\"div\");\n                node.setAttribute(\"id\", \"div_\" + id);\n                if (data.label) {\n                    label = node.appendChild(document.createElement(\"label\"));\n                    label.setAttribute(\"for\", id);\n                    label.appendChild(document.createTextNode(data.label));\n                }\n                var select = node.appendChild(document.createElement(\"select\"));\n                if (data.event) {\n                    select.addEventListener(\"change\", data.event, false);\n                }\n                if (data.multiple) {\n                    select.setAttribute(\"multiple\", \"multiple\");\n                }\n                if (data.size) {\n                    select.setAttribute(\"size\", data.size);\n                }\n                select.setAttribute(\"name\", data.name);\n                if (data.list) {\n                    for (i = 0; i < data.list.length; ++i) {\n                        current = data.list[i];\n                        if (current.list) {\n                            current.type = \"optgroup\";\n                        } else {\n                            current.type = \"option\";\n                        }\n                        subnode = this.compute(current);\n                        select.appendChild(subnode[0]);\n                    }\n                }\n                childContainder = select;\n                break;\n            case \"option\":\n                node = document.createElement(\"option\");\n                node.values = data.value;\n                node.setAttribute(\"value\", data.value);\n                if (data.selected) {\n                    node.setAttribute(\"selected\", \"selected\");\n                }\n                if (data.disabled) {\n                    node.setAttribute(\"disabled\", \"disabled\");\n                }\n                node.setAttribute(\"label\", data.label);\n                node.appendChild(document.createTextNode(data.label));\n                break;\n            case \"optgroup\":\n                node = document.createElement(\"optgroup\");\n                node.setAttribute(\"label\", data.label);\n                if (data.list) {\n                    for (i = 0; i < data.list.length; ++i) {\n                        current = data.list[i];\n                        current.type = \"option\";\n                        subnode = this.compute(current);\n                        node.appendChild(subnode[0]);\n                    }\n                }\n                break;\n            case \"field\":\n                node = document.createElement(\"fieldset\");\n                label = node.appendChild(document.createElement(\"legend\"));\n                label.appendChild(document.createTextNode(data.label));\n                if (data.name) {\n                    node.setAttribute(\"name\", data.name);\n                }\n                break;\n            case \"checkbox\":\n            case \"radio\":\n                node = document.createElement(\"div\");\n                if (data.list) {\n                    for (i = 0; i < data.list.length; ++i) {\n                        var cur_id = id + \"_\" + i;\n                        current = data.list[i];\n                        var cur_div;\n                        if (current.type === \"header\") {\n                            cur_div = node.appendChild(document.createElement(\"h6\"));\n                            cur_div.appendChild(document.createTextNode(current.label));\n                            if (current.tooltip) {\n                                Morebits.quickForm.element.generateTooltip(cur_div, current);\n                            }\n                            continue;\n                        }\n                        cur_div = node.appendChild(document.createElement(\"div\"));\n                        subnode = cur_div.appendChild(document.createElement(\"input\"));\n                        subnode.values = current.value;\n                        subnode.setAttribute(\"value\", current.value);\n                        subnode.setAttribute(\"name\", current.name || data.name);\n                        subnode.setAttribute(\"type\", data.type);\n                        subnode.setAttribute(\"id\", cur_id);\n                        if (current.checked) {\n                            subnode.setAttribute(\"checked\", \"checked\");\n                        }\n                        if (current.disabled) {\n                            subnode.setAttribute(\"disabled\", \"disabled\");\n                        }\n                        label = cur_div.appendChild(document.createElement(\"label\"));\n                        label.appendChild(document.createTextNode(current.label));\n                        label.setAttribute(\"for\", cur_id);\n                        if (current.tooltip) {\n                            Morebits.quickForm.element.generateTooltip(label, current);\n                        }\n                        if (current.style) {\n                            subnode.setAttribute(\"style\", current.style);\n                        }\n                        var event;\n                        if (current.subgroup) {\n                            var tmpgroup = current.subgroup;\n                            if (!$.isArray(tmpgroup)) {\n                                tmpgroup = [tmpgroup];\n                            }\n                            var subgroupRaw = new Morebits.quickForm.element({\n                                type: \"div\",\n                                id: id + \"_\" + i + \"_subgroup\"\n                            });\n                            $.each(tmpgroup, function(idx, el) {\n                                var newEl = $.extend({}, el);\n                                if (!newEl.type) {\n                                    newEl.type = data.type;\n                                }\n                                newEl.name = (current.name || data.name) + \".\" + newEl.name;\n                                subgroupRaw.append(newEl);\n                            });\n                            var subgroup = subgroupRaw.render(cur_id);\n                            subgroup.className = \"quickformSubgroup\";\n                            subnode.subgroup = subgroup;\n                            subnode.shown = false;\n                            event = function(e) {\n                                if (e.target.checked) {\n                                    e.target.parentNode.appendChild(e.target.subgroup);\n                                    if (e.target.type === \"radio\") {\n                                        var name = e.target.name;\n                                        if (e.target.form.names[name] !== undefined) {\n                                            e.target.form.names[name].parentNode.removeChild(e.target.form.names[name].subgroup);\n                                        }\n                                        e.target.form.names[name] = e.target;\n                                    }\n                                } else {\n                                    e.target.parentNode.removeChild(e.target.subgroup);\n                                }\n                            };\n                            subnode.addEventListener(\"change\", event, true);\n                            if (current.checked) {\n                                subnode.parentNode.appendChild(subgroup);\n                            }\n                        } else if (data.type === \"radio\") {\n                            event = function(e) {\n                                if (e.target.checked) {\n                                    var name = e.target.name;\n                                    if (e.target.form.names[name] !== undefined) {\n                                        e.target.form.names[name].parentNode.removeChild(e.target.form.names[name].subgroup);\n                                    }\n                                    delete e.target.form.names[name];\n                                }\n                            };\n                            subnode.addEventListener(\"change\", event, true);\n                        }\n                        if (data.event) {\n                            subnode.addEventListener(\"change\", data.event, false);\n                        } else if (current.event) {\n                            subnode.addEventListener(\"change\", current.event, true);\n                        }\n                    }\n                }\n                break;\n            case \"input\":\n                node = document.createElement(\"div\");\n                node.setAttribute(\"id\", \"div_\" + id);\n                if (data.label) {\n                    label = node.appendChild(document.createElement(\"label\"));\n                    label.appendChild(document.createTextNode(data.label));\n                    label.setAttribute(\"for\", id);\n                }\n                subnode = node.appendChild(document.createElement(\"input\"));\n                if (data.value) {\n                    subnode.setAttribute(\"value\", data.value);\n                }\n                subnode.setAttribute(\"name\", data.name);\n                subnode.setAttribute(\"id\", id);\n                subnode.setAttribute(\"type\", \"text\");\n                if (data.size) {\n                    subnode.setAttribute(\"size\", data.size);\n                }\n                if (data.disabled) {\n                    subnode.setAttribute(\"disabled\", \"disabled\");\n                }\n                if (data.readonly) {\n                    subnode.setAttribute(\"readonly\", \"readonly\");\n                }\n                if (data.maxlength) {\n                    subnode.setAttribute(\"maxlength\", data.maxlength);\n                }\n                if (data.event) {\n                    subnode.addEventListener(\"keyup\", data.event, false);\n                }\n                break;\n            case \"dyninput\":\n                var min = data.min || 1;\n                var max = data.max || Infinity;\n                node = document.createElement(\"div\");\n                label = node.appendChild(document.createElement(\"h5\"));\n                label.appendChild(document.createTextNode(data.label));\n                var listNode = node.appendChild(document.createElement(\"div\"));\n                var more = this.compute({\n                    type: \"button\",\n                    label: \"more\",\n                    disabled: min >= max,\n                    event: function(e) {\n                        var new_node = new Morebits.quickForm.element(e.target.sublist);\n                        e.target.area.appendChild(new_node.render());\n                        if (++e.target.counter >= e.target.max) {\n                            e.target.setAttribute(\"disabled\", \"disabled\");\n                        }\n                        e.stopPropagation();\n                    }\n                });\n                node.appendChild(more[0]);\n                var moreButton = more[1];\n                var sublist = {\n                    type: \"_dyninput_element\",\n                    label: data.sublabel || data.label,\n                    name: data.name,\n                    value: data.value,\n                    size: data.size,\n                    remove: false,\n                    maxlength: data.maxlength,\n                    event: data.event\n                };\n                for (i = 0; i < min; ++i) {\n                    var elem = new Morebits.quickForm.element(sublist);\n                    listNode.appendChild(elem.render());\n                }\n                sublist.remove = true;\n                sublist.morebutton = moreButton;\n                sublist.listnode = listNode;\n                moreButton.sublist = sublist;\n                moreButton.area = listNode;\n                moreButton.max = max - min;\n                moreButton.counter = 0;\n                break;\n            case \"_dyninput_element\":\n                node = document.createElement(\"div\");\n                if (data.label) {\n                    label = node.appendChild(document.createElement(\"label\"));\n                    label.appendChild(document.createTextNode(data.label));\n                    label.setAttribute(\"for\", id);\n                }\n                subnode = node.appendChild(document.createElement(\"input\"));\n                if (data.value) {\n                    subnode.setAttribute(\"value\", data.value);\n                }\n                subnode.setAttribute(\"name\", data.name);\n                subnode.setAttribute(\"type\", \"text\");\n                if (data.size) {\n                    subnode.setAttribute(\"size\", data.size);\n                }\n                if (data.maxlength) {\n                    subnode.setAttribute(\"maxlength\", data.maxlength);\n                }\n                if (data.event) {\n                    subnode.addEventListener(\"keyup\", data.event, false);\n                }\n                if (data.remove) {\n                    var remove = this.compute({\n                        type: \"button\",\n                        label: \"remove\",\n                        event: function(e) {\n                            var list = e.target.listnode;\n                            var node = e.target.inputnode;\n                            var more = e.target.morebutton;\n                            list.removeChild(node);\n                            --more.counter;\n                            more.removeAttribute(\"disabled\");\n                            e.stopPropagation();\n                        }\n                    });\n                    node.appendChild(remove[0]);\n                    var removeButton = remove[1];\n                    removeButton.inputnode = node;\n                    removeButton.listnode = data.listnode;\n                    removeButton.morebutton = data.morebutton;\n                }\n                break;\n            case \"hidden\":\n                node = document.createElement(\"input\");\n                node.setAttribute(\"type\", \"hidden\");\n                node.values = data.value;\n                node.setAttribute(\"value\", data.value);\n                node.setAttribute(\"name\", data.name);\n                break;\n            case \"header\":\n                node = document.createElement(\"h5\");\n                node.appendChild(document.createTextNode(data.label));\n                break;\n            case \"div\":\n                node = document.createElement(\"div\");\n                if (data.name) {\n                    node.setAttribute(\"name\", data.name);\n                }\n                if (data.label) {\n                    if (!$.isArray(data.label)) {\n                        data.label = [data.label];\n                    }\n                    var result = document.createElement(\"span\");\n                    result.className = \"quickformDescription\";\n                    for (i = 0; i < data.label.length; ++i) {\n                        if (typeof data.label[i] === \"string\") {\n                            result.appendChild(document.createTextNode(data.label[i]));\n                        } else if (data.label[i] instanceof Element) {\n                            result.appendChild(data.label[i]);\n                        }\n                    }\n                    node.appendChild(result);\n                }\n                break;\n            case \"submit\":\n                node = document.createElement(\"span\");\n                childContainder = node.appendChild(document.createElement(\"input\"));\n                childContainder.setAttribute(\"type\", \"submit\");\n                if (data.label) {\n                    childContainder.setAttribute(\"value\", data.label);\n                }\n                childContainder.setAttribute(\"name\", data.name || \"submit\");\n                if (data.disabled) {\n                    childContainder.setAttribute(\"disabled\", \"disabled\");\n                }\n                break;\n            case \"button\":\n                node = document.createElement(\"span\");\n                childContainder = node.appendChild(document.createElement(\"input\"));\n                childContainder.setAttribute(\"type\", \"button\");\n                if (data.label) {\n                    childContainder.setAttribute(\"value\", data.label);\n                }\n                childContainder.setAttribute(\"name\", data.name);\n                if (data.disabled) {\n                    childContainder.setAttribute(\"disabled\", \"disabled\");\n                }\n                if (data.event) {\n                    childContainder.addEventListener(\"click\", data.event, false);\n                }\n                break;\n            case \"textarea\":\n                node = document.createElement(\"div\");\n                node.setAttribute(\"id\", \"div_\" + id);\n                if (data.label) {\n                    label = node.appendChild(document.createElement(\"h5\"));\n                    label.appendChild(document.createTextNode(data.label));\n                }\n                subnode = node.appendChild(document.createElement(\"textarea\"));\n                subnode.setAttribute(\"name\", data.name);\n                if (data.cols) {\n                    subnode.setAttribute(\"cols\", data.cols);\n                }\n                if (data.rows) {\n                    subnode.setAttribute(\"rows\", data.rows);\n                }\n                if (data.disabled) {\n                    subnode.setAttribute(\"disabled\", \"disabled\");\n                }\n                if (data.readonly) {\n                    subnode.setAttribute(\"readonly\", \"readonly\");\n                }\n                if (data.value) {\n                    subnode.value = data.value;\n                }\n                break;\n            default:\n                throw new Error(\"Morebits.quickForm: unknown element type \" + data.type.toString());\n        }\n        if (!childContainder) {\n            childContainder = node;\n        }\n        if (data.tooltip) {\n            Morebits.quickForm.element.generateTooltip(label || node, data);\n        }\n        if (data.extra) {\n            childContainder.extra = data.extra;\n        }\n        if (data.style) {\n            childContainder.setAttribute(\"style\", data.style);\n        }\n        if (data.className) {\n            childContainder.className = childContainder.className ? childContainder.className + \" \" + data.className : data.className;\n        }\n        childContainder.setAttribute(\"id\", data.id || id);\n        return [node, childContainder];\n    };\n    Morebits.quickForm.element.autoNWSW = function() {\n        return $(this).offset().top > $(document).scrollTop() + $(window).height() / 2 ? \"sw\" : \"nw\";\n    };\n    Morebits.quickForm.element.generateTooltip = function QuickFormElementGenerateTooltip(node, data) {\n        $(\"<span/>\", {\n            \"class\": \"ui-icon ui-icon-help ui-icon-inline morebits-tooltip\"\n        }).appendTo(node).tipsy({\n            fallback: data.tooltip,\n            fade: true,\n            gravity: data.type === \"input\" || data.type === \"select\" ? Morebits.quickForm.element.autoNWSW : $.fn.tipsy.autoWE,\n            html: true,\n            delayOut: 250\n        });\n    };\n    Morebits.quickForm.getElements = function QuickFormGetElements(form, fieldName) {\n        var $form = $(form);\n        var $elements = $form.find('[name=\"' + fieldName + '\"]');\n        if ($elements.length > 0) {\n            return $elements.toArray();\n        }\n        $elements = $form.find(\"#\" + fieldName);\n        if ($elements.length > 0) {\n            return $elements.toArray();\n        }\n        return null;\n    };\n    Morebits.quickForm.getCheckboxOrRadio = function QuickFormGetCheckboxOrRadio(elementArray, value) {\n        var found = $.grep(elementArray, function(el) {\n            return el.value === value;\n        });\n        if (found.length > 0) {\n            return found[0];\n        }\n        return null;\n    };\n    Morebits.quickForm.getElementContainer = function QuickFormGetElementContainer(element) {\n        if (element instanceof HTMLFieldSetElement || element instanceof HTMLDivElement || element instanceof HTMLHeadingElement) {\n            return element;\n        }\n        return element.parentNode;\n    };\n    Morebits.quickForm.getElementLabelObject = function QuickFormGetElementLabelObject(element) {\n        if (element.type === \"button\" || element.type === \"submit\" || element instanceof HTMLDivElement || element instanceof HTMLHeadingElement) {\n            return element;\n        } else if (element instanceof HTMLFieldSetElement) {\n            return element.getElementsByTagName(\"legend\")[0];\n        } else if (element instanceof HTMLTextAreaElement) {\n            return element.parentNode.getElementsByTagName(\"h5\")[0];\n        } else {\n            return element.parentNode.getElementsByTagName(\"label\")[0];\n        }\n        return null;\n    };\n    Morebits.quickForm.getElementLabel = function QuickFormGetElementLabel(element) {\n        var labelElement = Morebits.quickForm.getElementLabelObject(element);\n        if (!labelElement) {\n            return null;\n        }\n        return labelElement.firstChild.textContent;\n    };\n    Morebits.quickForm.setElementLabel = function QuickFormSetElementLabel(element, labelText) {\n        var labelElement = Morebits.quickForm.getElementLabelObject(element);\n        if (!labelElement) {\n            return false;\n        }\n        labelElement.firstChild.textContent = labelText;\n        return true;\n    };\n    Morebits.quickForm.overrideElementLabel = function QuickFormOverrideElementLabel(element, temporaryLabelText) {\n        if (!element.hasAttribute(\"data-oldlabel\")) {\n            element.setAttribute(\"data-oldlabel\", Morebits.quickForm.getElementLabel(element));\n        }\n        return Morebits.quickForm.setElementLabel(element, temporaryLabelText);\n    };\n    Morebits.quickForm.resetElementLabel = function QuickFormResetElementLabel(element) {\n        if (element.hasAttribute(\"data-oldlabel\")) {\n            return Morebits.quickForm.setElementLabel(element, element.getAttribute(\"data-oldlabel\"));\n        }\n        return null;\n    };\n    Morebits.quickForm.setElementVisibility = function QuickFormSetElementVisibility(element, visibility) {\n        $(element).toggle(visibility);\n    };\n    Morebits.quickForm.setElementTooltipVisibility = function QuickFormSetElementTooltipVisibility(element, visibility) {\n        $(Morebits.quickForm.getElementContainer(element)).find(\".morebits-tooltip\").toggle(visibility);\n    };\n    HTMLFormElement.prototype.getChecked = function(name, type) {\n        var elements = this.elements[name];\n        if (!elements) {\n            return null;\n        }\n        var return_array = [];\n        var i;\n        if (elements instanceof HTMLSelectElement) {\n            var options = elements.options;\n            for (i = 0; i < options.length; ++i) {\n                if (options[i].selected) {\n                    if (options[i].values) {\n                        return_array.push(options[i].values);\n                    } else {\n                        return_array.push(options[i].value);\n                    }\n                }\n            }\n        } else if (elements instanceof HTMLInputElement) {\n            if (type && elements.type !== type) {\n                return [];\n            } else if (elements.checked) {\n                return [elements.value];\n            }\n        } else {\n            for (i = 0; i < elements.length; ++i) {\n                if (elements[i].checked) {\n                    if (type && elements[i].type !== type) {\n                        continue;\n                    }\n                    if (elements[i].values) {\n                        return_array.push(elements[i].values);\n                    } else {\n                        return_array.push(elements[i].value);\n                    }\n                }\n            }\n        }\n        return return_array;\n    };\n    RegExp.escape = function(text, space_fix) {\n        text = mw.RegExp.escape(text);\n        if (space_fix) {\n            text = text.replace(/ |_/g, \"[_ ]\");\n        }\n        return text;\n    };\n    Morebits.bytes = function(value) {\n        if (typeof value === \"string\") {\n            var res = /(\\d+) ?(\\w?)(i?)B?/.exec(value);\n            var number = res[1];\n            var mag = res[2];\n            var si = res[3];\n            if (!number) {\n                this.number = 0;\n                return;\n            }\n            if (!si) {\n                this.value = number * Math.pow(10, Morebits.bytes.magnitudes[mag] * 3);\n            } else {\n                this.value = number * Math.pow(2, Morebits.bytes.magnitudes[mag] * 10);\n            }\n        } else {\n            this.value = value;\n        }\n    };\n    Morebits.bytes.magnitudes = {\n        \"\": 0,\n        K: 1,\n        M: 2,\n        G: 3,\n        T: 4,\n        P: 5,\n        E: 6,\n        Z: 7,\n        Y: 8\n    };\n    Morebits.bytes.rmagnitudes = {\n        0: \"\",\n        1: \"K\",\n        2: \"M\",\n        3: \"G\",\n        4: \"T\",\n        5: \"P\",\n        6: \"E\",\n        7: \"Z\",\n        8: \"Y\"\n    };\n    Morebits.bytes.prototype.valueOf = function() {\n        return this.value;\n    };\n    Morebits.bytes.prototype.toString = function(magnitude) {\n        var tmp = this.value;\n        if (magnitude) {\n            var si = /i/.test(magnitude);\n            var mag = magnitude.replace(/.*?(\\w)i?B?.*/g, \"$1\");\n            if (si) {\n                tmp /= Math.pow(2, Morebits.bytes.magnitudes[mag] * 10);\n            } else {\n                tmp /= Math.pow(10, Morebits.bytes.magnitudes[mag] * 3);\n            }\n            if (parseInt(tmp, 10) !== tmp) {\n                tmp = Number(tmp).toPrecision(4);\n            }\n            return tmp + \" \" + mag + (si ? \"i\" : \"\") + \"B\";\n        } else {\n            var current = 0;\n            while (tmp >= 1024) {\n                tmp /= 1024;\n                ++current;\n            }\n            tmp = this.value / Math.pow(2, current * 10);\n            if (parseInt(tmp, 10) !== tmp) {\n                tmp = Number(tmp).toPrecision(4);\n            }\n            return tmp + \" \" + Morebits.bytes.rmagnitudes[current] + (current > 0 ? \"iB\" : \"B\");\n        }\n    };\n    if (!String.prototype.trimLeft) {\n        String.prototype.trimLeft = function stringPrototypeLtrim() {\n            return this.replace(/^[\\s]+/g, \"\");\n        };\n    }\n    if (!String.prototype.trimRight) {\n        String.prototype.trimRight = function stringPrototypeRtrim() {\n            return this.replace(/[\\s]+$/g, \"\");\n        };\n    }\n    if (!String.prototype.trim) {\n        String.prototype.trim = function stringPrototypeTrim() {\n            return this.trimRight().trimLeft();\n        };\n    }\n    Morebits.string = {\n        toUpperCaseFirstChar: function(str) {\n            str = str.toString();\n            return str.substr(0, 1).toUpperCase() + str.substr(1);\n        },\n        toLowerCaseFirstChar: function(str) {\n            str = str.toString();\n            return str.substr(0, 1).toLowerCase() + str.substr(1);\n        },\n        splitWeightedByKeys: function(str, start, end, skip) {\n            if (start.length !== end.length) {\n                throw new Error(\"\u8d77\u59cb\u548c\u7ed3\u675f\u6807\u8bb0\u5fc5\u987b\u7b49\u957f\");\n            }\n            var level = 0;\n            var initial = null;\n            var result = [];\n            if (!$.isArray(skip)) {\n                if (skip === undefined) {\n                    skip = [];\n                } else if (typeof skip === \"string\") {\n                    skip = [skip];\n                } else {\n                    throw new Error(\"\u4e0d\u9002\u7528\u7684\u8df3\u8fc7\u53c2\u6570\");\n                }\n            }\n            for (var i = 0; i < str.length; ++i) {\n                for (var j = 0; j < skip.length; ++j) {\n                    if (str.substr(i, skip[j].length) === skip[j]) {\n                        i += skip[j].length - 1;\n                        continue;\n                    }\n                }\n                if (str.substr(i, start.length) === start) {\n                    if (initial === null) {\n                        initial = i;\n                    }\n                    ++level;\n                    i += start.length - 1;\n                } else if (str.substr(i, end.length) === end) {\n                    --level;\n                    i += end.length - 1;\n                }\n                if (!level && initial !== null) {\n                    result.push(str.substring(initial, i + 1));\n                    initial = null;\n                }\n            }\n            return result;\n        },\n        formatReasonText: function(str) {\n            var result = str.toString().trimRight();\n            var unbinder = new Morebits.unbinder(result);\n            unbinder.unbind(\"<no\" + \"wiki>\", \"</no\" + \"wiki>\");\n            unbinder.content = unbinder.content.replace(/\\|/g, \"{{subst:!}}\");\n            return unbinder.rebind();\n        }\n    };\n    Morebits.array = {\n        uniq: function(arr) {\n            if (!$.isArray(arr)) {\n                throw \"A non-array object passed to Morebits.array.uniq\";\n            }\n            var result = [];\n            for (var i = 0; i < arr.length; ++i) {\n                var current = arr[i];\n                if (result.indexOf(current) === -1) {\n                    result.push(current);\n                }\n            }\n            return result;\n        },\n        dups: function(arr) {\n            if (!$.isArray(arr)) {\n                throw \"A non-array object passed to Morebits.array.dups\";\n            }\n            var uniques = [];\n            var result = [];\n            for (var i = 0; i < arr.length; ++i) {\n                var current = arr[i];\n                if (uniques.indexOf(current) === -1) {\n                    uniques.push(current);\n                } else {\n                    result.push(current);\n                }\n            }\n            return result;\n        },\n        chunk: function(arr, size) {\n            if (!$.isArray(arr)) {\n                throw \"A non-array object passed to Morebits.array.chunk\";\n            }\n            if (typeof size !== \"number\" || size <= 0) {\n                return [arr];\n            }\n            var result = [];\n            var current;\n            for (var i = 0; i < arr.length; ++i) {\n                if (i % size === 0) {\n                    current = [];\n                    result.push(current);\n                }\n                current.push(arr[i]);\n            }\n            return result;\n        }\n    };\n    Morebits.pageNameNorm = mw.config.get(\"wgPageName\").replace(/_/g, \" \");\n    Morebits.unbinder = function Unbinder(string) {\n        if (typeof string !== \"string\") {\n            throw new Error(\"\u4e0d\u662f\u5b57\u7b26\u4e32\");\n        }\n        this.content = string;\n        this.counter = 0;\n        this.history = {};\n        this.prefix = \"%UNIQ::\" + Math.random() + \"::\";\n        this.postfix = \"::UNIQ%\";\n    };\n    Morebits.unbinder.prototype = {\n        unbind: function UnbinderUnbind(prefix, postfix) {\n            var re = new RegExp(prefix + \"(.*?)\" + postfix, \"g\");\n            this.content = this.content.replace(re, Morebits.unbinder.getCallback(this));\n        },\n        rebind: function UnbinderRebind() {\n            var content = this.content;\n            content.self = this;\n            for (var current in this.history) {\n                if (this.history.hasOwnProperty(current)) {\n                    content = content.replace(current, this.history[current]);\n                }\n            }\n            return content;\n        },\n        prefix: null,\n        postfix: null,\n        content: null,\n        counter: null,\n        history: null\n    };\n    Morebits.unbinder.getCallback = function UnbinderGetCallback(self) {\n        return function UnbinderCallback(match) {\n            var current = self.prefix + self.counter + self.postfix;\n            self.history[current] = match;\n            ++self.counter;\n            return current;\n        };\n    };\n    Date.monthNames = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\", \"August\", \"September\", \"October\", \"November\", \"December\"];\n    Date.monthNamesAbbrev = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\n    Date.prototype.getMonthName = function() {\n        return Date.monthNames[this.getMonth()];\n    };\n    Date.prototype.getMonthNameAbbrev = function() {\n        return Date.monthNamesAbbrev[this.getMonth()];\n    };\n    Date.prototype.getUTCMonthName = function() {\n        return Date.monthNames[this.getUTCMonth()];\n    };\n    Date.prototype.getUTCMonthNameAbbrev = function() {\n        return Date.monthNamesAbbrev[this.getUTCMonth()];\n    };\n    Morebits.wikipedia = {};\n    Morebits.wikipedia.namespaces = {\n        \"-2\": \"Media\",\n        \"-1\": \"Special\",\n        \"0\": \"\",\n        \"1\": \"Talk\",\n        \"2\": \"User\",\n        \"3\": \"User talk\",\n        \"4\": \"Project\",\n        \"5\": \"Project talk\",\n        \"6\": \"File\",\n        \"7\": \"File talk\",\n        \"8\": \"MediaWiki\",\n        \"9\": \"MediaWiki talk\",\n        \"10\": \"Template\",\n        \"11\": \"Template talk\",\n        \"12\": \"Help\",\n        \"13\": \"Help talk\",\n        \"14\": \"Category\",\n        \"15\": \"Category talk\",\n        \"100\": \"Portal\",\n        \"101\": \"Portal talk\",\n        \"108\": \"Book\",\n        \"109\": \"Book talk\",\n        \"118\": \"Draft\",\n        \"119\": \"Draft talk\",\n        \"446\": \"Education Program\",\n        \"447\": \"Education Program talk\",\n        \"710\": \"TimedText\",\n        \"711\": \"TimedText talk\",\n        \"828\": \"Module\",\n        \"829\": \"Module talk\"\n    };\n    Morebits.wikipedia.namespacesFriendly = {\n        \"0\": \"\uff08\u6761\u76ee\uff09\",\n        \"1\": \"Talk\",\n        \"2\": \"User\",\n        \"3\": \"User talk\",\n        \"4\": \"Wikipedia\",\n        \"5\": \"Wikipedia talk\",\n        \"6\": \"File\",\n        \"7\": \"File talk\",\n        \"8\": \"MediaWiki\",\n        \"9\": \"MediaWiki talk\",\n        \"10\": \"Template\",\n        \"11\": \"Template talk\",\n        \"12\": \"Help\",\n        \"13\": \"Help talk\",\n        \"14\": \"Category\",\n        \"15\": \"Category talk\",\n        \"100\": \"Portal\",\n        \"101\": \"Portal talk\",\n        \"108\": \"Book\",\n        \"109\": \"Book talk\",\n        \"118\": \"Draft\",\n        \"119\": \"Draft talk\",\n        \"446\": \"Education Program\",\n        \"447\": \"Education Program talk\",\n        \"710\": \"TimedText\",\n        \"711\": \"TimedText talk\",\n        \"828\": \"Module\",\n        \"829\": \"Module talk\"\n    };\n    Morebits.wiki = {};\n    Morebits.wiki.isPageRedirect = function wikipediaIsPageRedirect() {\n        return !!(mw.config.get(\"wgIsRedirect\") || document.getElementById(\"softredirect\"));\n    };\n    Morebits.wiki.numberOfActionsLeft = 0;\n    Morebits.wiki.nbrOfCheckpointsLeft = 0;\n    Morebits.wiki.actionCompleted = function(self) {\n        if (--Morebits.wiki.numberOfActionsLeft <= 0 && Morebits.wiki.nbrOfCheckpointsLeft <= 0) {\n            Morebits.wiki.actionCompleted.event(self);\n        }\n    };\n    Morebits.wiki.actionCompleted.event = function() {\n        new Morebits.status(Morebits.wiki.actionCompleted.notice, Morebits.wiki.actionCompleted.postfix, \"info\");\n        if (Morebits.wiki.actionCompleted.redirect) {\n            if (!/^\\w+\\:\\/\\//.test(Morebits.wiki.actionCompleted.redirect)) {\n                Morebits.wiki.actionCompleted.redirect = mw.util.getUrl(Morebits.wiki.actionCompleted.redirect);\n                if (Morebits.wiki.actionCompleted.followRedirect === false) {\n                    Morebits.wiki.actionCompleted.redirect += \"?redirect=no\";\n                }\n            }\n            window.setTimeout(function() {\n                window.location = Morebits.wiki.actionCompleted.redirect;\n            }, Morebits.wiki.actionCompleted.timeOut);\n        }\n    };\n    Morebits.wiki.actionCompleted.timeOut = typeof window.wpActionCompletedTimeOut === \"undefined\" ? 5e3 : window.wpActionCompletedTimeOut;\n    Morebits.wiki.actionCompleted.redirect = null;\n    Morebits.wiki.actionCompleted.notice = \"\u52a8\u4f5c\";\n    Morebits.wiki.actionCompleted.postfix = \"\u5df2\u5b8c\u6210\";\n    Morebits.wiki.addCheckpoint = function() {\n        ++Morebits.wiki.nbrOfCheckpointsLeft;\n    };\n    Morebits.wiki.removeCheckpoint = function() {\n        if (--Morebits.wiki.nbrOfCheckpointsLeft <= 0 && Morebits.wiki.numberOfActionsLeft <= 0) {\n            Morebits.wiki.actionCompleted.event();\n        }\n    };\n    Morebits.wiki.api = function(currentAction, query, onSuccess, statusElement, onError) {\n        this.currentAction = currentAction;\n        this.query = query;\n        this.query.format = \"xml\";\n        this.query.assert = \"user\";\n        this.onSuccess = onSuccess;\n        this.onError = onError;\n        if (statusElement) {\n            this.statelem = statusElement;\n            this.statelem.status(currentAction);\n        } else {\n            this.statelem = new Morebits.status(currentAction);\n        }\n    };\n    Morebits.wiki.api.prototype = {\n        currentAction: \"\",\n        onSuccess: null,\n        onError: null,\n        parent: window,\n        query: null,\n        responseXML: null,\n        setParent: function(parent) {\n            this.parent = parent;\n        },\n        statelem: null,\n        statusText: null,\n        errorCode: null,\n        errorText: null,\n        post: function(callerAjaxParameters) {\n            ++Morebits.wiki.numberOfActionsLeft;\n            var ajaxparams = $.extend({}, {\n                context: this,\n                type: \"POST\",\n                url: mw.util.wikiScript(\"api\"),\n                data: Morebits.queryString.create(this.query),\n                dataType: \"xml\",\n                headers: {\n                    \"Api-User-Agent\": morebitsWikiApiUserAgent\n                }\n            }, callerAjaxParameters);\n            return $.ajax(ajaxparams).done(function(xml, statusText, jqXHR) {\n                this.statusText = statusText;\n                this.responseXML = xml;\n                this.errorCode = $(xml).find(\"error\").attr(\"code\");\n                this.errorText = $(xml).find(\"error\").attr(\"info\");\n                if (typeof this.errorCode === \"string\") {\n                    this.returnError();\n                    return;\n                }\n                if (this.onSuccess) {\n                    this.onSuccess.call(this.parent, this);\n                } else {\n                    this.statelem.info(\"\u5b8c\u6210\");\n                }\n                Morebits.wiki.actionCompleted();\n            }).fail(function(jqXHR, statusText, errorThrown) {\n                this.statusText = statusText;\n                this.errorThrown = errorThrown;\n                this.errorText = statusText + \"\u5728\u8c03\u7528API\u65f6\u53d1\u751f\u4e86\u9519\u8bef\u201c\" + jqXHR.statusText + \"\u201d\u3002\";\n                this.returnError();\n            });\n        },\n        returnError: function() {\n            if (this.errorCode === \"badtoken\") {\n                this.statelem.error(\"\u65e0\u6548\u4ee4\u724c\uff0c\u8bf7\u5237\u65b0\u9875\u9762\u5e76\u91cd\u8bd5\");\n            } else {\n                this.statelem.error(this.errorText);\n            }\n            if (this.onError) {\n                this.onError.call(this.parent, this);\n            }\n        },\n        getStatusElement: function() {\n            return this.statelem;\n        },\n        getErrorCode: function() {\n            return this.errorCode;\n        },\n        getErrorText: function() {\n            return this.errorText;\n        },\n        getXML: function() {\n            return this.responseXML;\n        }\n    };\n    var morebitsWikiApiUserAgent = \"morebits.js~zh/2.0 ([[w:zh:WT:TW]])\";\n    Morebits.wiki.api.setApiUserAgent = function(ua) {\n        morebitsWikiApiUserAgent = (ua ? ua + \" \" : \"\") + \"morebits.js~zh/2.0 ([[w:zh:WT:TW]])\";\n    };\n    Morebits.wiki.page = function(pageName, currentAction) {\n        if (!currentAction) {\n            currentAction = \"\u6253\u5f00\u9875\u9762\u201c\" + pageName + \"\u201d\";\n        }\n        var ctx = {\n            pageName: pageName,\n            pageExists: false,\n            editSummary: null,\n            callbackParameters: null,\n            statusElement: new Morebits.status(currentAction),\n            pageText: null,\n            editMode: \"all\",\n            appendText: null,\n            prependText: null,\n            createOption: null,\n            minorEdit: false,\n            botEdit: false,\n            pageSection: null,\n            maxConflictRetries: 2,\n            maxRetries: 2,\n            followRedirect: false,\n            watchlistOption: \"nochange\",\n            creator: null,\n            revertOldID: null,\n            moveDestination: null,\n            moveTalkPage: false,\n            moveSubpages: false,\n            moveSuppressRedirect: false,\n            protectEdit: null,\n            protectMove: null,\n            protectCreate: null,\n            protectCascade: false,\n            flaggedRevs: null,\n            pageLoaded: false,\n            editToken: null,\n            loadTime: null,\n            lastEditTime: null,\n            revertCurID: null,\n            revertUser: null,\n            fullyProtected: false,\n            suppressProtectWarning: false,\n            conflictRetries: 0,\n            retries: 0,\n            onLoadSuccess: null,\n            onLoadFailure: null,\n            onSaveSuccess: null,\n            onSaveFailure: null,\n            onLookupCreatorSuccess: null,\n            onMoveSuccess: null,\n            onMoveFailure: null,\n            onDeleteSuccess: null,\n            onDeleteFailure: null,\n            onProtectSuccess: null,\n            onProtectFailure: null,\n            onStabilizeSuccess: null,\n            onStabilizeFailure: null,\n            loadQuery: null,\n            loadApi: null,\n            saveApi: null,\n            lookupCreatorApi: null,\n            moveApi: null,\n            moveProcessApi: null,\n            deleteApi: null,\n            deleteProcessApi: null,\n            protectApi: null,\n            protectProcessApi: null,\n            stabilizeApi: null,\n            stabilizeProcessApi: null\n        };\n        var emptyFunction = function() {};\n        this.getPageName = function() {\n            return ctx.pageName;\n        };\n        this.getPageText = function() {\n            return ctx.pageText;\n        };\n        this.setPageText = function(pageText) {\n            ctx.editMode = \"all\";\n            ctx.pageText = pageText;\n        };\n        this.setAppendText = function(appendText) {\n            ctx.editMode = \"append\";\n            ctx.appendText = appendText;\n        };\n        this.setPrependText = function(prependText) {\n            ctx.editMode = \"prepend\";\n            ctx.prependText = prependText;\n        };\n        this.setEditSummary = function(summary) {\n            ctx.editSummary = summary;\n        };\n        this.setCreateOption = function(createOption) {\n            ctx.createOption = createOption;\n        };\n        this.setMinorEdit = function(minorEdit) {\n            ctx.minorEdit = minorEdit;\n        };\n        this.setBotEdit = function(botEdit) {\n            ctx.botEdit = botEdit;\n        };\n        this.setPageSection = function(pageSection) {\n            ctx.pageSection = pageSection;\n        };\n        this.setMaxConflictRetries = function(maxRetries) {\n            ctx.maxConflictRetries = maxRetries;\n        };\n        this.setMaxRetries = function(maxRetries) {\n            ctx.maxRetries = maxRetries;\n        };\n        this.setCallbackParameters = function(callbackParameters) {\n            ctx.callbackParameters = callbackParameters;\n        };\n        this.getCallbackParameters = function() {\n            return ctx.callbackParameters;\n        };\n        this.getCreator = function() {\n            return ctx.creator;\n        };\n        this.setOldID = function(oldID) {\n            ctx.revertOldID = oldID;\n        };\n        this.getCurrentID = function() {\n            return ctx.revertCurID;\n        };\n        this.getRevisionUser = function() {\n            return ctx.revertUser;\n        };\n        this.setMoveDestination = function(destination) {\n            ctx.moveDestination = destination;\n        };\n        this.setMoveTalkPage = function(flag) {\n            ctx.moveTalkPage = !!flag;\n        };\n        this.setMoveSubpages = function(flag) {\n            ctx.moveSubpages = !!flag;\n        };\n        this.setMoveSuppressRedirect = function(flag) {\n            ctx.moveSuppressRedirect = !!flag;\n        };\n        this.setEditProtection = function(level, expiry) {\n            ctx.protectEdit = {\n                level: level,\n                expiry: expiry\n            };\n        };\n        this.setMoveProtection = function(level, expiry) {\n            ctx.protectMove = {\n                level: level,\n                expiry: expiry\n            };\n        };\n        this.setCreateProtection = function(level, expiry) {\n            ctx.protectCreate = {\n                level: level,\n                expiry: expiry\n            };\n        };\n        this.setCascadingProtection = function(flag) {\n            ctx.protectCascade = !!flag;\n        };\n        this.setFlaggedRevs = function(level, expiry) {\n            ctx.flaggedRevs = {\n                level: level,\n                expiry: expiry\n            };\n        };\n        this.getStatusElement = function() {\n            return ctx.statusElement;\n        };\n        this.setFollowRedirect = function(followRedirect) {\n            if (ctx.pageLoaded) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u4e0d\u80fd\u5728\u9875\u9762\u52a0\u8f7d\u540e\u4fee\u6539\u91cd\u5b9a\u5411\u8bbe\u7f6e\uff01\");\n                return;\n            }\n            ctx.followRedirect = followRedirect;\n        };\n        this.setWatchlist = function(flag) {\n            if (flag) {\n                ctx.watchlistOption = \"watch\";\n            } else {\n                ctx.watchlistOption = \"nochange\";\n            }\n        };\n        this.setWatchlistFromPreferences = function(flag) {\n            if (flag) {\n                ctx.watchlistOption = \"preferences\";\n            } else {\n                ctx.watchlistOption = \"nochange\";\n            }\n        };\n        this.suppressProtectWarning = function() {\n            ctx.suppressProtectWarning = true;\n        };\n        this.exists = function() {\n            return ctx.pageExists;\n        };\n        this.load = function(onSuccess, onFailure) {\n            ctx.onLoadSuccess = onSuccess;\n            ctx.onLoadFailure = onFailure || emptyFunction;\n            if (!onSuccess) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u672a\u7ed9load()\u63d0\u4f9bonSuccess\u56de\u8c03\u51fd\u6570\uff01\");\n                ctx.onLoadFailure(this);\n                return;\n            }\n            ctx.loadQuery = {\n                action: \"query\",\n                prop: \"info|revisions\",\n                intoken: \"edit\",\n                titles: ctx.pageName\n            };\n            if (ctx.editMode === \"all\") {\n                ctx.loadQuery.rvprop = \"content|timestamp\";\n            } else if (ctx.editMode === \"revert\") {\n                ctx.loadQuery.rvprop = \"timestamp\";\n                ctx.loadQuery.rvlimit = 1;\n                ctx.loadQuery.rvstartid = ctx.revertOldID;\n            }\n            if (ctx.followRedirect) {\n                ctx.loadQuery.redirects = \"\";\n            }\n            if (typeof ctx.pageSection === \"number\") {\n                ctx.loadQuery.rvsection = ctx.pageSection;\n            }\n            if (Morebits.userIsInGroup(\"sysop\")) {\n                ctx.loadQuery.inprop = \"protection\";\n            }\n            ctx.loadApi = new Morebits.wiki.api(\"\u6293\u53d6\u9875\u9762\u2026\", ctx.loadQuery, fnLoadSuccess, ctx.statusElement, ctx.onLoadFailure);\n            ctx.loadApi.setParent(this);\n            ctx.loadApi.post();\n        };\n        this.save = function(onSuccess, onFailure) {\n            ctx.onSaveSuccess = onSuccess;\n            ctx.onSaveFailure = onFailure || emptyFunction;\n            var canUseMwUserToken = fnCanUseMwUserToken(\"edit\");\n            if (!ctx.pageLoaded && !canUseMwUserToken) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u8bd5\u56fe\u4fdd\u5b58\u672a\u88ab\u52a0\u8f7d\u7684\u9875\u9762\uff01\");\n                ctx.onSaveFailure(this);\n                return;\n            }\n            if (!ctx.editSummary) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u4fdd\u5b58\u524d\u672a\u8bbe\u7f6e\u7f16\u8f91\u6458\u8981\uff01\");\n                ctx.onSaveFailure(this);\n                return;\n            }\n            if (ctx.fullyProtected && !ctx.suppressProtectWarning && !confirm('\u60a8\u5373\u5c06\u7f16\u8f91\u5168\u4fdd\u62a4\u9875\u9762 \"' + ctx.pageName + (ctx.fullyProtected === \"infinity\" ? \"\uff08\u6c38\u4e45\uff09\" : \"\uff08\u5230\u671f\uff1a\" + ctx.fullyProtected + \")\") + \"\u3002\\n\\n\u70b9\u51fb\u786e\u5b9a\u4ee5\u786e\u5b9a\uff0c\u6216\u70b9\u51fb\u53d6\u6d88\u4ee5\u53d6\u6d88\u3002\")) {\n                ctx.statusElement.error(\"\u5bf9\u5168\u4fdd\u62a4\u9875\u9762\u7684\u7f16\u8f91\u88ab\u53d6\u6d88\u3002\");\n                ctx.onSaveFailure(this);\n                return;\n            }\n            ctx.retries = 0;\n            var query = {\n                action: \"edit\",\n                tags: \"Twinkle\",\n                title: ctx.pageName,\n                summary: ctx.editSummary,\n                token: canUseMwUserToken ? mw.user.tokens.get(\"editToken\") : ctx.editToken,\n                watchlist: ctx.watchlistOption\n            };\n            if (typeof ctx.pageSection === \"number\") {\n                query.section = ctx.pageSection;\n            }\n            if (ctx.minorEdit) {\n                query.minor = true;\n            } else {\n                query.notminor = true;\n            }\n            if (ctx.botEdit) {\n                query.bot = true;\n            }\n            switch (ctx.editMode) {\n                case \"append\":\n                    query.appendtext = ctx.appendText;\n                    break;\n                case \"prepend\":\n                    query.prependtext = ctx.prependText;\n                    break;\n                case \"revert\":\n                    query.undo = ctx.revertCurID;\n                    query.undoafter = ctx.revertOldID;\n                    if (ctx.lastEditTime) {\n                        query.basetimestamp = ctx.lastEditTime;\n                    }\n                    query.starttimestamp = ctx.loadTime;\n                    break;\n                default:\n                    query.text = ctx.pageText;\n                    if (ctx.lastEditTime) {\n                        query.basetimestamp = ctx.lastEditTime;\n                    }\n                    query.starttimestamp = ctx.loadTime;\n                    break;\n            }\n            if ([\"recreate\", \"createonly\", \"nocreate\"].indexOf(ctx.createOption) !== -1) {\n                query[ctx.createOption] = \"\";\n            }\n            if (canUseMwUserToken && ctx.followRedirect) {\n                query.redirect = true;\n            }\n            ctx.saveApi = new Morebits.wiki.api(\"\u4fdd\u5b58\u9875\u9762\u2026\", query, fnSaveSuccess, ctx.statusElement, fnSaveError);\n            ctx.saveApi.setParent(this);\n            ctx.saveApi.post();\n        };\n        this.append = function(onSuccess, onFailure) {\n            ctx.editMode = \"append\";\n            if (fnCanUseMwUserToken(\"edit\")) {\n                this.save(onSuccess, onFailure);\n            } else {\n                ctx.onSaveSuccess = onSuccess;\n                ctx.onSaveFailure = onFailure || emptyFunction;\n                this.load(fnAutoSave, ctx.onSaveFailure);\n            }\n        };\n        this.prepend = function(onSuccess, onFailure) {\n            ctx.editMode = \"prepend\";\n            if (fnCanUseMwUserToken(\"edit\")) {\n                this.save(onSuccess, onFailure);\n            } else {\n                ctx.onSaveSuccess = onSuccess;\n                ctx.onSaveFailure = onFailure || emptyFunction;\n                this.load(fnAutoSave, ctx.onSaveFailure);\n            }\n        };\n        this.lookupCreator = function(onSuccess) {\n            if (!onSuccess) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u672a\u7ed9lookupCreator()\u63d0\u4f9bonSuccess\u56de\u8c03\u51fd\u6570\uff01\");\n                return;\n            }\n            ctx.onLookupCreatorSuccess = onSuccess;\n            var query = {\n                action: \"query\",\n                prop: \"revisions\",\n                titles: ctx.pageName,\n                rvlimit: 1,\n                rvprop: \"user\",\n                rvdir: \"newer\"\n            };\n            if (ctx.followRedirect) {\n                query.redirects = \"\";\n            }\n            ctx.lookupCreatorApi = new Morebits.wiki.api(\"\u6293\u53d6\u9875\u9762\u521b\u5efa\u8005\u4fe1\u606f\", query, fnLookupCreatorSuccess, ctx.statusElement);\n            ctx.lookupCreatorApi.setParent(this);\n            ctx.lookupCreatorApi.post();\n        };\n        this.patrol = function() {\n            if (!$(\".patrollink\").length) {\n                return;\n            }\n            var patrolhref = $(\".patrollink a\").attr(\"href\"),\n                rcid = mw.util.getParamValue(\"rcid\", patrolhref);\n            if (rcid) {\n                var patrolstat = new Morebits.status(\"\u6807\u8bb0\u9875\u9762\u4e3a\u5df2\u5de1\u67e5\");\n                var wikipedia_api = new Morebits.wiki.api(\"\u8fdb\u884c\u4e2d\u2026\", {\n                    action: \"patrol\",\n                    rcid: rcid,\n                    token: mw.user.tokens.get(\"patrolToken\")\n                }, null, patrolstat);\n                wikipedia_api.post();\n            }\n        };\n        this.revert = function(onSuccess, onFailure) {\n            ctx.onSaveSuccess = onSuccess;\n            ctx.onSaveFailure = onFailure || emptyFunction;\n            if (!ctx.revertOldID) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u56de\u9000\u524d\u672a\u63d0\u4f9b\u4fee\u8ba2\u7248\u672cID\uff01\");\n                ctx.onSaveFailure(this);\n                return;\n            }\n            ctx.editMode = \"revert\";\n            this.load(fnAutoSave, ctx.onSaveFailure);\n        };\n        this.move = function(onSuccess, onFailure) {\n            ctx.onMoveSuccess = onSuccess;\n            ctx.onMoveFailure = onFailure || emptyFunction;\n            if (!ctx.editSummary) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u79fb\u52a8\u524d\u672a\u63d0\u4f9b\u7406\u7531\uff08\u4f7f\u7528setEditSummary\u51fd\u6570\uff09\uff01\");\n                ctx.onMoveFailure(this);\n                return;\n            }\n            if (!ctx.moveDestination) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u79fb\u52a8\u524d\u672a\u6307\u5b9a\u76ee\u6807\u9875\u9762\uff01\");\n                ctx.onMoveFailure(this);\n                return;\n            }\n            var query = {\n                action: \"query\",\n                prop: \"info\",\n                intoken: \"move\",\n                titles: ctx.pageName\n            };\n            if (ctx.followRedirect) {\n                query.redirects = \"\";\n            }\n            if (Morebits.userIsInGroup(\"sysop\")) {\n                query.inprop = \"protection\";\n            }\n            ctx.moveApi = new Morebits.wiki.api(\"\u6293\u53d6\u79fb\u52a8\u4ee4\u724c\u2026\", query, fnProcessMove, ctx.statusElement, ctx.onMoveFailure);\n            ctx.moveApi.setParent(this);\n            ctx.moveApi.post();\n        };\n        this.deletePage = function(onSuccess, onFailure) {\n            ctx.onDeleteSuccess = onSuccess;\n            ctx.onDeleteFailure = onFailure || emptyFunction;\n            if (!Morebits.userIsInGroup(\"sysop\")) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u5220\u9664\u9875\u9762\uff1a\u53ea\u6709\u7ba1\u7406\u5458\u53ef\u8fdb\u884c\u8be5\u64cd\u4f5c\");\n                ctx.onDeleteFailure(this);\n                return;\n            }\n            if (!ctx.editSummary) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u5220\u9664\u524d\u672a\u63d0\u4f9b\u7406\u7531\uff08\u4f7f\u7528setEditSummary\u51fd\u6570\uff09\uff01\");\n                ctx.onDeleteFailure(this);\n                return;\n            }\n            if (fnCanUseMwUserToken(\"delete\")) {\n                fnProcessDelete.call(this, this);\n            } else {\n                var query = {\n                    action: \"query\",\n                    prop: \"info\",\n                    inprop: \"protection\",\n                    intoken: \"delete\",\n                    titles: ctx.pageName\n                };\n                if (ctx.followRedirect) {\n                    query.redirects = \"\";\n                }\n                ctx.deleteApi = new Morebits.wiki.api(\"\u6293\u53d6\u5220\u9664\u4ee4\u724c\u2026\", query, fnProcessDelete, ctx.statusElement, ctx.onDeleteFailure);\n                ctx.deleteApi.setParent(this);\n                ctx.deleteApi.post();\n            }\n        };\n        this.protect = function(onSuccess, onFailure) {\n            ctx.onProtectSuccess = onSuccess;\n            ctx.onProtectFailure = onFailure || emptyFunction;\n            if (!Morebits.userIsInGroup(\"sysop\")) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u4fdd\u62a4\u9875\u9762\uff1a\u53ea\u6709\u7ba1\u7406\u5458\u53ef\u8fdb\u884c\u8be5\u64cd\u4f5c\");\n                ctx.onProtectFailure(this);\n                return;\n            }\n            if (!ctx.protectEdit && !ctx.protectMove && !ctx.protectCreate) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u8c03\u7528protect()\u524d\u672a\u8bbe\u7f6e\u7f16\u8f91\u548c/\u6216\u79fb\u52a8\u548c/\u6216\u767d\u7eb8\u4fdd\u62a4\uff01\");\n                ctx.onProtectFailure(this);\n                return;\n            }\n            if (!ctx.editSummary) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u4fdd\u62a4\u524d\u672a\u63d0\u4f9b\u7406\u7531\uff08\u4f7f\u7528setEditSummary\u51fd\u6570\uff09\uff01\");\n                ctx.onProtectFailure(this);\n                return;\n            }\n            var query = {\n                action: \"query\",\n                prop: \"info\",\n                inprop: \"protection\",\n                intoken: \"protect\",\n                titles: ctx.pageName,\n                watchlist: ctx.watchlistOption\n            };\n            if (ctx.followRedirect) {\n                query.redirects = \"\";\n            }\n            ctx.protectApi = new Morebits.wiki.api(\"\u6293\u53d6\u4fdd\u62a4\u4ee4\u724c\u2026\", query, fnProcessProtect, ctx.statusElement, ctx.onProtectFailure);\n            ctx.protectApi.setParent(this);\n            ctx.protectApi.post();\n        };\n        this.stabilize = function(onSuccess, onFailure) {\n            ctx.onStabilizeSuccess = onSuccess;\n            ctx.onStabilizeFailure = onFailure || emptyFunction;\n            if (!Morebits.userIsInGroup(\"sysop\")) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u5e94\u7528FlaggedRevs\u8bbe\u5b9a\uff1a\u53ea\u6709\u7ba1\u7406\u5458\u80fd\u8fd9\u4e48\u505a\");\n                ctx.onStabilizeFailure(this);\n                return;\n            }\n            if (!ctx.flaggedRevs) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u8c03\u7528stabilize()\u524d\u5fc5\u987b\u8bbe\u7f6eflaggedRevs\uff01\");\n                ctx.onStabilizeFailure(this);\n                return;\n            }\n            if (!ctx.editSummary) {\n                ctx.statusElement.error(\"\u5185\u90e8\u9519\u8bef\uff1a\u8c03\u7528stabilize()\u524d\u672a\u63d0\u4f9b\u7406\u7531\uff08\u7528setEditSummary\u51fd\u6570\uff09\uff01\");\n                ctx.onStabilizeFailure(this);\n                return;\n            }\n            var query = {\n                action: \"query\",\n                prop: \"info|flagged\",\n                intoken: \"edit\",\n                titles: ctx.pageName\n            };\n            if (ctx.followRedirect) {\n                query.redirects = \"\";\n            }\n            ctx.stabilizeApi = new Morebits.wiki.api(\"\u6293\u53d6stabilize\u4ee4\u724c\u2026\", query, fnProcessStabilize, ctx.statusElement, ctx.onStabilizeFailure);\n            ctx.stabilizeApi.setParent(this);\n            ctx.stabilizeApi.post();\n        };\n        var fnCanUseMwUserToken = function(action) {\n            if (ctx.followRedirect && (action !== \"edit\" || ctx.editMode !== \"append\" && ctx.editMode !== \"prepend\")) {\n                return false;\n            }\n            if (Morebits.userIsInGroup(\"sysop\") && !ctx.suppressProtectWarning) {\n                if (Morebits.string.toUpperCaseFirstChar(mw.config.get(\"wgPageName\")).replace(/ /g, \"_\").trim() !== Morebits.string.toUpperCaseFirstChar(ctx.pageName).replace(/ /g, \"_\").trim()) {\n                    return false;\n                }\n                var editRestriction = mw.config.get(\"wgRestrictionEdit\");\n                if (!editRestriction || editRestriction.indexOf(\"sysop\") !== -1) {\n                    return false;\n                }\n            }\n            return !!mw.user.tokens.get(\"editToken\");\n        };\n        var fnAutoSave = function(pageobj) {\n            pageobj.save(ctx.onSaveSuccess, ctx.onSaveFailure);\n        };\n        var fnLoadSuccess = function() {\n            var xml = ctx.loadApi.getXML();\n            if (!fnCheckPageName(xml, ctx.onLoadFailure)) {\n                return;\n            }\n            ctx.pageExists = $(xml).find(\"page\").attr(\"missing\") !== \"\";\n            if (ctx.pageExists) {\n                ctx.pageText = $(xml).find(\"rev\").text();\n            } else {\n                ctx.pageText = \"\";\n            }\n            if (Morebits.userIsInGroup(\"sysop\")) {\n                var editprot = $(xml).find('pr[type=\"edit\"]');\n                if (editprot.length > 0 && editprot.attr(\"level\") === \"sysop\") {\n                    ctx.fullyProtected = editprot.attr(\"expiry\");\n                } else {\n                    ctx.fullyProtected = false;\n                }\n            }\n            ctx.editToken = $(xml).find(\"page\").attr(\"edittoken\");\n            if (!ctx.editToken) {\n                ctx.statusElement.error(\"\u672a\u80fd\u6293\u53d6\u7f16\u8f91\u4ee4\u724c\u3002\");\n                ctx.onLoadFailure(this);\n                return;\n            }\n            ctx.loadTime = $(xml).find(\"page\").attr(\"starttimestamp\");\n            if (!ctx.loadTime) {\n                ctx.statusElement.error(\"\u672a\u80fd\u6293\u53d6\u8d77\u59cb\u65f6\u95f4\u6233\u3002\");\n                ctx.onLoadFailure(this);\n                return;\n            }\n            ctx.lastEditTime = $(xml).find(\"rev\").attr(\"timestamp\");\n            ctx.revertCurID = $(xml).find(\"page\").attr(\"lastrevid\");\n            if (ctx.editMode === \"revert\") {\n                ctx.revertCurID = $(xml).find(\"rev\").attr(\"revid\");\n                if (!ctx.revertCurID) {\n                    ctx.statusElement.error(\"\u672a\u80fd\u6293\u53d6\u5f53\u524d\u4fee\u8ba2\u7248\u672cID\u3002\");\n                    ctx.onLoadFailure(this);\n                    return;\n                }\n                ctx.revertUser = $(xml).find(\"rev\").attr(\"user\");\n                if (!ctx.revertUser) {\n                    if ($(xml).find(\"rev\").attr(\"userhidden\") === \"\") {\n                        ctx.revertUser = \"<\u7528\u6237\u540d\u5df2\u9690\u85cf>\";\n                    } else {\n                        ctx.statusElement.error(\"\u672a\u80fd\u6293\u53d6\u6b64\u4fee\u8ba2\u7248\u672c\u7684\u7f16\u8f91\u8005\u3002\");\n                        ctx.onLoadFailure(this);\n                        return;\n                    }\n                }\n                ctx.editSummary = \"[[WP:UNDO|\u53d6\u6d88]]\u7531 \" + ctx.revertUser + \" \u6240\u505a\u51fa\u7684\u4fee\u8ba2 \" + ctx.revertOldID + \"\uff1a\" + ctx.editSummary;\n            }\n            ctx.pageLoaded = true;\n            ctx.onLoadSuccess(this);\n        };\n        var fnCheckPageName = function(xml, onFailure) {\n            if (!onFailure) {\n                onFailure = emptyFunction;\n            }\n            if ($(xml).find(\"page\").attr(\"invalid\")) {\n                ctx.statusElement.error(\"\u6807\u9898\u4e0d\u5408\u6cd5\uff1a\" + ctx.pageName);\n                onFailure(this);\n                return false;\n            }\n            if ($(xml).find(\"page\").attr(\"title\")) {\n                var resolvedName = $(xml).find(\"page\").attr(\"title\");\n                if ($(xml).find(\"redirects\").length > 0) {\n                    Morebits.status.info(\"Info\", \"\u4ece \" + ctx.pageName + \" \u91cd\u5b9a\u5411\u5230 \" + resolvedName);\n                }\n                ctx.pageName = resolvedName;\n            } else {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u89e3\u91ca\u9875\u9762\u7684\u91cd\u5b9a\u5411\uff1a\" + ctx.pageName);\n                onFailure(this);\n                ++Morebits.wiki.numberOfActionsLeft;\n                return false;\n            }\n            return true;\n        };\n        var fnSaveSuccess = function() {\n            ctx.editMode = \"all\";\n            var xml = ctx.saveApi.getXML();\n            if ($(xml).find(\"edit\").attr(\"result\") === \"Success\") {\n                var link = document.createElement(\"a\");\n                link.setAttribute(\"href\", mw.util.getUrl(ctx.pageName));\n                link.appendChild(document.createTextNode(ctx.pageName));\n                ctx.statusElement.info([\"\u5b8c\u6210\uff08\", link, \"\uff09\"]);\n                if (ctx.onSaveSuccess) {\n                    ctx.onSaveSuccess(this);\n                }\n                return;\n            }\n            var $editNode = $(xml).find(\"edit\");\n            var blacklist = $editNode.attr(\"spamblacklist\");\n            if (blacklist) {\n                var code = document.createElement(\"code\");\n                code.style.fontFamily = \"monospace\";\n                code.appendChild(document.createTextNode(blacklist));\n                ctx.statusElement.error([\"\u4e0d\u80fd\u4fdd\u5b58\u9875\u9762\uff0c\u56e0URL \", code, \" \u5728\u5783\u573e\u9ed1\u540d\u5355\u4e2d\u3002\"]);\n            } else if ($(xml).find(\"captcha\").length > 0) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u4fdd\u5b58\u9875\u9762\uff0c\u56e0\u670d\u52a1\u5668\u8bd5\u56fe\u8ba9\u60a8\u5b8c\u6210\u4e00\u4e2a\u5168\u81ea\u52a8\u533a\u5206\u8ba1\u7b97\u673a\u548c\u4eba\u7c7b\u7684\u56fe\u7075\u6d4b\u8bd5\u3002\");\n            } else if ($editNode.attr(\"code\") === \"abusefilter-disallowed\") {\n                ctx.statusElement.error(\"\u7f16\u8f91\u88ab\u9632\u6ee5\u7528\u8fc7\u6ee4\u5668\u89c4\u5219\u201c\" + $editNode.attr(\"info\").substring(17) + \"\u201d\u963b\u6b62\u3002\");\n            } else if ($editNode.attr(\"info\").indexOf(\"Hit AbuseFilter:\") === 0) {\n                var div = document.createElement(\"div\");\n                div.className = \"toccolours\";\n                div.style.fontWeight = \"normal\";\n                div.style.color = \"black\";\n                div.innerHTML = $editNode.attr(\"warning\");\n                ctx.statusElement.error([\"\u9632\u6ee5\u7528\u8fc7\u6ee4\u5668\u7ed9\u51fa\u4e86\u5982\u4e0b\u8b66\u544a\uff1a\", div, \"\u5982\u679c\u60a8\u4ecd\u5e0c\u671b\u505a\u51fa\u8be5\u7f16\u8f91\uff0c\u8bf7\u91cd\u65b0\u63d0\u4ea4\u3002\u6b64\u8b66\u544a\u4e0d\u4f1a\u518d\u6b21\u51fa\u73b0\u3002\"]);\n            } else {\n                ctx.statusElement.error(\"\u4fdd\u5b58\u9875\u9762\u65f6\u7531API\u5f97\u5230\u672a\u77e5\u9519\u8bef\");\n            }\n            ++Morebits.wiki.numberOfActionsLeft;\n            ctx.onSaveFailure(this);\n        };\n        var fnSaveError = function() {\n            var errorCode = ctx.saveApi.getErrorCode();\n            if (errorCode === \"editconflict\" && ctx.conflictRetries++ < ctx.maxConflictRetries) {\n                var purgeQuery = {\n                    action: \"purge\",\n                    titles: ctx.pageName\n                };\n                var purgeApi = new Morebits.wiki.api(\"\u68c0\u6d4b\u5230\u7f16\u8f91\u51b2\u7a81\uff0c\u66f4\u65b0\u670d\u52a1\u5668\u7f13\u5b58\", purgeQuery, null, ctx.statusElement);\n                var result = purgeApi.post({\n                    async: false\n                });\n                --Morebits.wiki.numberOfActionsLeft;\n                ctx.statusElement.info(\"\u68c0\u6d4b\u5230\u7f16\u8f91\u51b2\u7a81\uff0c\u91cd\u8bd5\u4fee\u6539\");\n                if (fnCanUseMwUserToken(\"edit\")) {\n                    ctx.saveApi.post();\n                } else {\n                    ctx.loadApi.post();\n                }\n            } else if (errorCode === \"notoken\" && ctx.conflictRetries++ < ctx.maxConflictRetries) {\n                ctx.statusElement.info(\"\u7f16\u8f91\u4ee4\u724c\u4e0d\u53ef\u7528\uff0c\u91cd\u8bd5\");\n                --Morebits.wiki.numberOfActionsLeft;\n                if (fnCanUseMwUserToken(\"edit\")) {\n                    this.load(fnAutoSave, ctx.onSaveFailure);\n                } else {\n                    ctx.loadApi.post();\n                }\n            } else if (errorCode === \"undefined\" && ctx.retries++ < ctx.maxRetries) {\n                ctx.statusElement.info(\"\u4fdd\u5b58\u5931\u8d25\uff0c\u91cd\u8bd5\");\n                --Morebits.wiki.numberOfActionsLeft;\n                ctx.saveApi.post();\n            } else {\n                if (errorCode === \"protectedpage\") {\n                    ctx.statusElement.error(\"\u4e0d\u80fd\u4fdd\u5b58\u4fee\u6539\uff1a\u9875\u9762\u88ab\u5168\u4fdd\u62a4\");\n                } else if (errorCode === \"hookaborted\") {\n                    ctx.statusElement.error(\"\u4e0d\u80fd\u4fdd\u5b58\u4fee\u6539\uff1a\u88ab\u9632\u6ee5\u7528\u8fc7\u6ee4\u5668\u963b\u6b62\");\n                } else {\n                    ctx.statusElement.error(\"\u4e0d\u80fd\u4fdd\u5b58\u4fee\u6539\uff1a\" + ctx.saveApi.getErrorText());\n                }\n                ctx.editMode = \"all\";\n                if (ctx.onSaveFailure) {\n                    ctx.onSaveFailure(this);\n                }\n            }\n        };\n        var fnLookupCreatorSuccess = function() {\n            var xml = ctx.lookupCreatorApi.getXML();\n            if (!fnCheckPageName(xml)) {\n                return;\n            }\n            ctx.creator = $(xml).find(\"rev\").attr(\"user\");\n            if (!ctx.creator) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u83b7\u53d6\u9875\u9762\u521b\u5efa\u8005\u7684\u540d\u5b57\");\n                return;\n            }\n            ctx.onLookupCreatorSuccess(this);\n        };\n        var fnProcessMove = function() {\n            var xml = ctx.moveApi.getXML();\n            if ($(xml).find(\"page\").attr(\"missing\") === \"\") {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u79fb\u52a8\u9875\u9762\uff0c\u56e0\u5176\u5df2\u4e0d\u5b58\u5728\");\n                ctx.onMoveFailure(this);\n                return;\n            }\n            if (Morebits.userIsInGroup(\"sysop\")) {\n                var editprot = $(xml).find('pr[type=\"edit\"]');\n                if (editprot.length > 0 && editprot.attr(\"level\") === \"sysop\" && !ctx.suppressProtectWarning && !confirm(\"\u60a8\u5373\u5c06\u79fb\u52a8\u5168\u4fdd\u62a4\u9875\u9762\u201c\" + ctx.pageName + \"\u201d\" + (editprot.attr(\"expiry\") === \"infinity\" ? \"\uff08\u6c38\u4e45\uff09\" : \"\uff08\u5230\u671f\uff1a\" + editprot.attr(\"expiry\") + \"\uff09\") + \"\u3002\\n\\n\u70b9\u51fb\u786e\u5b9a\u4ee5\u786e\u5b9a\uff0c\u6216\u70b9\u51fb\u53d6\u6d88\u4ee5\u53d6\u6d88\u3002\")) {\n                    ctx.statusElement.error(\"\u5bf9\u5168\u4fdd\u62a4\u9875\u9762\u7684\u79fb\u52a8\u5df2\u53d6\u6d88\u3002\");\n                    ctx.onMoveFailure(this);\n                    return;\n                }\n            }\n            var moveToken = $(xml).find(\"page\").attr(\"movetoken\");\n            if (!moveToken) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u6293\u53d6\u79fb\u52a8\u4ee4\u724c\u3002\");\n                ctx.onMoveFailure(this);\n                return;\n            }\n            var query = {\n                action: \"move\",\n                from: $(xml).find(\"page\").attr(\"title\"),\n                to: ctx.moveDestination,\n                token: moveToken,\n                reason: ctx.editSummary\n            };\n            if (ctx.moveTalkPage) {\n                query.movetalk = \"true\";\n            }\n            if (ctx.moveSubpages) {\n                query.movesubpages = \"true\";\n            }\n            if (ctx.moveSuppressRedirect) {\n                query.noredirect = \"true\";\n            }\n            if (ctx.watchlistOption === \"watch\") {\n                query.watch = \"true\";\n            }\n            ctx.moveProcessApi = new Morebits.wiki.api(\"\u79fb\u52a8\u9875\u9762\u2026\", query, ctx.onMoveSuccess, ctx.statusElement, ctx.onMoveFailure);\n            ctx.moveProcessApi.setParent(this);\n            ctx.moveProcessApi.post();\n        };\n        var fnProcessDelete = function() {\n            var pageTitle, token;\n            if (fnCanUseMwUserToken(\"delete\")) {\n                token = mw.user.tokens.get(\"editToken\");\n                pageTitle = ctx.pageName;\n            } else {\n                var xml = ctx.deleteApi.getXML();\n                if ($(xml).find(\"page\").attr(\"missing\") === \"\") {\n                    ctx.statusElement.error(\"\u4e0d\u80fd\u5220\u9664\u9875\u9762\uff0c\u56e0\u5176\u5df2\u4e0d\u5b58\u5728\");\n                    ctx.onDeleteFailure(this);\n                    return;\n                }\n                var editprot = $(xml).find('pr[type=\"edit\"]');\n                if (editprot.length > 0 && editprot.attr(\"level\") === \"sysop\" && !ctx.suppressProtectWarning && !confirm(\"\u60a8\u5373\u5c06\u5220\u9664\u5168\u4fdd\u62a4\u9875\u9762\u201c\" + ctx.pageName + \"\u201d\" + (editprot.attr(\"expiry\") === \"infinity\" ? \"\uff08\u6c38\u4e45\uff09\" : \"\uff08\u5230\u671f \" + editprot.attr(\"expiry\") + \"\uff09\") + \"\u3002\\n\\n\u70b9\u51fb\u786e\u5b9a\u4ee5\u786e\u5b9a\uff0c\u6216\u70b9\u51fb\u53d6\u6d88\u4ee5\u53d6\u6d88\u3002\")) {\n                    ctx.statusElement.error(\"\u5bf9\u5168\u4fdd\u62a4\u9875\u9762\u7684\u5220\u9664\u5df2\u53d6\u6d88\u3002\");\n                    ctx.onDeleteFailure(this);\n                    return;\n                }\n                token = $(xml).find(\"page\").attr(\"deletetoken\");\n                if (!token) {\n                    ctx.statusElement.error(\"\u4e0d\u80fd\u6293\u53d6\u5220\u9664\u4ee4\u724c\u3002\");\n                    ctx.onDeleteFailure(this);\n                    return;\n                }\n                pageTitle = $(xml).find(\"page\").attr(\"title\");\n            }\n            var query = {\n                action: \"delete\",\n                title: pageTitle,\n                token: token,\n                reason: ctx.editSummary\n            };\n            if (ctx.watchlistOption === \"watch\") {\n                query.watch = \"true\";\n            }\n            ctx.deleteProcessApi = new Morebits.wiki.api(\"\u5220\u9664\u9875\u9762\u2026\", query, ctx.onDeleteSuccess, ctx.statusElement, fnProcessDeleteError);\n            ctx.deleteProcessApi.setParent(this);\n            ctx.deleteProcessApi.post();\n        };\n        var fnProcessDeleteError = function() {\n            var errorCode = ctx.deleteProcessApi.getErrorCode();\n            if (errorCode === \"internal_api_error_DBQueryError\" && ctx.retries++ < ctx.maxRetries) {\n                ctx.statusElement.info(\"\u6570\u636e\u5e93\u67e5\u8be2\u9519\u8bef\uff0c\u91cd\u8bd5\");\n                --Morebits.wiki.numberOfActionsLeft;\n                ctx.deleteProcessApi.post();\n            } else if (errorCode === \"badtoken\") {\n                ctx.statusElement.error(\"\u65e0\u6548\u4ee4\u724c\uff0c\u8bf7\u5237\u65b0\u9875\u9762\u5e76\u91cd\u8bd5\u3002\");\n                if (ctx.onDeleteFailure) {\n                    ctx.onDeleteFailure.call(this, this, ctx.deleteProcessApi);\n                }\n            } else if (errorCode === \"missingtitle\") {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u5220\u9664\u9875\u9762\uff0c\u56e0\u5176\u5df2\u4e0d\u5b58\u5728\");\n                if (ctx.onDeleteFailure) {\n                    ctx.onDeleteFailure.call(this, ctx.deleteProcessApi);\n                }\n            } else {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u5220\u9664\u9875\u9762\uff1a\" + ctx.deleteProcessApi.getErrorText());\n                if (ctx.onDeleteFailure) {\n                    ctx.onDeleteFailure.call(this, ctx.deleteProcessApi);\n                }\n            }\n        };\n        var fnProcessProtect = function() {\n            var xml = ctx.protectApi.getXML();\n            var missing = $(xml).find(\"page\").attr(\"missing\") === \"\";\n            if ((ctx.protectEdit || ctx.protectMove) && missing) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u4fdd\u62a4\u9875\u9762\uff0c\u56e0\u5176\u5df2\u4e0d\u5b58\u5728\");\n                ctx.onProtectFailure(this);\n                return;\n            }\n            if (ctx.protectCreate && !missing) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u767d\u7eb8\u4fdd\u62a4\u9875\u9762\uff0c\u56e0\u5176\u5df2\u5b58\u5728\");\n                ctx.onProtectFailure(this);\n                return;\n            }\n            var protectToken = $(xml).find(\"page\").attr(\"protecttoken\");\n            if (!protectToken) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u6293\u53d6\u4fdd\u62a4\u4ee4\u724c\u3002\");\n                ctx.onProtectFailure(this);\n                return;\n            }\n            var prs = $(xml).find(\"pr\");\n            var editprot = prs.filter('[type=\"edit\"]');\n            var moveprot = prs.filter('[type=\"move\"]');\n            var createprot = prs.filter('[type=\"create\"]');\n            var protections = [],\n                expirys = [];\n            if (ctx.protectEdit) {\n                protections.push(\"edit=\" + ctx.protectEdit.level);\n                expirys.push(ctx.protectEdit.expiry);\n            } else if (editprot.length) {\n                protections.push(\"edit=\" + editprot.attr(\"level\"));\n                expirys.push(editprot.attr(\"expiry\").replace(\"infinity\", \"indefinite\"));\n            }\n            if (ctx.protectMove) {\n                protections.push(\"move=\" + ctx.protectMove.level);\n                expirys.push(ctx.protectMove.expiry);\n            } else if (moveprot.length) {\n                protections.push(\"move=\" + moveprot.attr(\"level\"));\n                expirys.push(moveprot.attr(\"expiry\").replace(\"infinity\", \"indefinite\"));\n            }\n            if (ctx.protectCreate) {\n                protections.push(\"create=\" + ctx.protectCreate.level);\n                expirys.push(ctx.protectCreate.expiry);\n            } else if (createprot.length) {\n                protections.push(\"create=\" + createprot.attr(\"level\"));\n                expirys.push(createprot.attr(\"expiry\").replace(\"infinity\", \"indefinite\"));\n            }\n            var query = {\n                action: \"protect\",\n                title: $(xml).find(\"page\").attr(\"title\"),\n                token: protectToken,\n                protections: protections.join(\"|\"),\n                expiry: expirys.join(\"|\"),\n                reason: ctx.editSummary\n            };\n            if (ctx.protectCascade) {\n                query.cascade = \"true\";\n            }\n            if (ctx.watchlistOption === \"watch\") {\n                query.watch = \"true\";\n            }\n            ctx.protectProcessApi = new Morebits.wiki.api(\"\u4fdd\u62a4\u9875\u9762\u2026\", query, ctx.onProtectSuccess, ctx.statusElement, ctx.onProtectFailure);\n            ctx.protectProcessApi.setParent(this);\n            ctx.protectProcessApi.post();\n        };\n        var fnProcessStabilize = function() {\n            var xml = ctx.stabilizeApi.getXML();\n            var missing = $(xml).find(\"page\").attr(\"missing\") === \"\";\n            if (missing) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u4fdd\u62a4\u9875\u9762\uff0c\u56e0\u5176\u5df2\u4e0d\u5b58\u5728\");\n                ctx.onStabilizeFailure(this);\n                return;\n            }\n            var stabilizeToken = $(xml).find(\"page\").attr(\"edittoken\");\n            if (!stabilizeToken) {\n                ctx.statusElement.error(\"\u4e0d\u80fd\u6293\u53d6stabilize\u4ee4\u724c\u3002\");\n                ctx.onStabilizeFailure(this);\n                return;\n            }\n            var query = {\n                action: \"stabilize\",\n                title: $(xml).find(\"page\").attr(\"title\"),\n                token: stabilizeToken,\n                protectlevel: ctx.flaggedRevs.level,\n                expiry: ctx.flaggedRevs.expiry,\n                reason: ctx.editSummary\n            };\n            if (ctx.watchlistOption === \"watch\") {\n                query.watch = \"true\";\n            }\n            ctx.stabilizeProcessApi = new Morebits.wiki.api(\"\u914d\u7f6estabilization\u8bbe\u5b9a\u2026\", query, ctx.onStabilizeSuccess, ctx.statusElement, ctx.onStabilizeFailure);\n            ctx.stabilizeProcessApi.setParent(this);\n            ctx.stabilizeProcessApi.post();\n        };\n    };\n    Morebits.wiki.preview = function(previewbox) {\n        this.previewbox = previewbox;\n        $(previewbox).addClass(\"morebits-previewbox\").hide();\n        this.beginRender = function(wikitext, pageTitle) {\n            $(previewbox).show();\n            var statusspan = document.createElement(\"span\");\n            previewbox.appendChild(statusspan);\n            Morebits.status.init(statusspan);\n            var query = {\n                action: \"parse\",\n                prop: \"text\",\n                pst: \"true\",\n                text: wikitext,\n                title: pageTitle || mw.config.get(\"wgPageName\")\n            };\n            var renderApi = new Morebits.wiki.api(\"\u8f7d\u5165\u4e2d\u2026\", query, fnRenderSuccess, new Morebits.status(\"\u9884\u89c8\"));\n            renderApi.post();\n        };\n        var fnRenderSuccess = function(apiobj) {\n            var xml = apiobj.getXML();\n            var html = $(xml).find(\"text\").text();\n            if (!html) {\n                apiobj.statelem.error(\"\u8f7d\u5165\u9884\u89c8\u5931\u8d25\uff0c\u6216\u6a21\u677f\u88ab\u6e05\u7a7a\");\n                return;\n            }\n            previewbox.innerHTML = html;\n            $(previewbox).find(\"a\").attr(\"target\", \"_blank\");\n        };\n        this.closePreview = function() {\n            $(previewbox).empty().hide();\n        };\n    };\n    Morebits.wikitext = {};\n    Morebits.wikitext.template = {\n        parse: function(text, start) {\n            var count = -1;\n            var level = -1;\n            var equals = -1;\n            var current = \"\";\n            var result = {\n                name: \"\",\n                parameters: {}\n            };\n            var key, value;\n            for (var i = start; i < text.length; ++i) {\n                var test3 = text.substr(i, 3);\n                if (test3 === \"{{{\") {\n                    current += \"{{{\";\n                    i += 2;\n                    ++level;\n                    continue;\n                }\n                if (test3 === \"}}}\") {\n                    current += \"}}}\";\n                    i += 2;\n                    --level;\n                    continue;\n                }\n                var test2 = text.substr(i, 2);\n                if (test2 === \"{{\" || test2 === \"[[\") {\n                    current += test2;\n                    ++i;\n                    ++level;\n                    continue;\n                }\n                if (test2 === \"]]\") {\n                    current += test2;\n                    ++i;\n                    --level;\n                    continue;\n                }\n                if (test2 === \"}}\") {\n                    current += test2;\n                    ++i;\n                    --level;\n                    if (level <= 0) {\n                        if (count === -1) {\n                            result.name = current.substring(2).trim();\n                            ++count;\n                        } else {\n                            if (equals !== -1) {\n                                key = current.substring(0, equals).trim();\n                                value = current.substring(equals).trim();\n                                result.parameters[key] = value;\n                                equals = -1;\n                            } else {\n                                result.parameters[count] = current;\n                                ++count;\n                            }\n                        }\n                        break;\n                    }\n                    continue;\n                }\n                if (text.charAt(i) === \"|\" && level <= 0) {\n                    if (count === -1) {\n                        result.name = current.substring(2).trim();\n                        ++count;\n                    } else {\n                        if (equals !== -1) {\n                            key = current.substring(0, equals).trim();\n                            value = current.substring(equals + 1).trim();\n                            result.parameters[key] = value;\n                            equals = -1;\n                        } else {\n                            result.parameters[count] = current;\n                            ++count;\n                        }\n                    }\n                    current = \"\";\n                } else if (equals === -1 && text.charAt(i) === \"=\" && level <= 0) {\n                    equals = current.length;\n                    current += text.charAt(i);\n                } else {\n                    current += text.charAt(i);\n                }\n            }\n            return result;\n        }\n    };\n    Morebits.wikitext.page = function mediawikiPage(text) {\n        this.text = text;\n    };\n    Morebits.wikitext.page.prototype = {\n        text: \"\",\n        removeLink: function(link_target) {\n            var first_char = link_target.substr(0, 1);\n            var link_re_string = \"[\" + first_char.toUpperCase() + first_char.toLowerCase() + \"]\" + RegExp.escape(link_target.substr(1), true);\n            var link_simple_re = new RegExp(\"\\\\[\\\\[:?(\" + link_re_string + \")\\\\]\\\\]\", \"g\");\n            var link_named_re = new RegExp(\"\\\\[\\\\[:?\" + link_re_string + \"\\\\|(.+?)\\\\]\\\\]\", \"g\");\n            this.text = this.text.replace(link_simple_re, \"$1\").replace(link_named_re, \"$1\");\n        },\n        commentOutImage: function(image, reason) {\n            var unbinder = new Morebits.unbinder(this.text);\n            unbinder.unbind(\"<!--\", \"-->\");\n            reason = reason ? reason + \"\uff1a\" : \"\";\n            var first_char = image.substr(0, 1);\n            var image_re_string = \"[\" + first_char.toUpperCase() + first_char.toLowerCase() + \"]\" + RegExp.escape(image.substr(1), true);\n            var links_re = new RegExp(\"\\\\[\\\\[(?:[Ii]mage|[Ff]ile|\u6587\u4ef6|\u6a94\u6848):\\\\s*\" + image_re_string);\n            var allLinks = Morebits.array.uniq(Morebits.string.splitWeightedByKeys(unbinder.content, \"[[\", \"]]\"));\n            for (var i = 0; i < allLinks.length; ++i) {\n                if (links_re.test(allLinks[i])) {\n                    var replacement = \"<!-- \" + reason + allLinks[i] + \" -->\";\n                    unbinder.content = unbinder.content.replace(allLinks[i], replacement, \"g\");\n                }\n            }\n            unbinder.unbind(\"<!--\", \"-->\");\n            var gallery_image_re = new RegExp(\"(^\\\\s*(?:[Ii]mage|[Ff]ile|\u6587\u4ef6|\u6a94\u6848):\\\\s*\" + image_re_string + \".*?$)\", \"mg\");\n            unbinder.content = unbinder.content.replace(gallery_image_re, \"<!-- \" + reason + \"$1 -->\");\n            unbinder.unbind(\"<!--\", \"-->\");\n            var free_image_re = new RegExp(\"(\\\\|\\\\s*(?:[\\\\w\\\\s]+\\\\=)?\\\\s*(?:(?:[Ii]mage|[Ff]ile|\u6587\u4ef6|\u6a94\u6848):\\\\s*)?\" + image_re_string + \")\", \"mg\");\n            unbinder.content = unbinder.content.replace(free_image_re, \"<!-- \" + reason + \"$1 -->\");\n            this.text = unbinder.rebind();\n        },\n        addToImageComment: function(image, data) {\n            var first_char = image.substr(0, 1);\n            var first_char_regex = RegExp.escape(first_char, true);\n            if (first_char.toUpperCase() !== first_char.toLowerCase()) {\n                first_char_regex = \"[\" + RegExp.escape(first_char.toUpperCase(), true) + RegExp.escape(first_char.toLowerCase(), true) + \"]\";\n            }\n            var image_re_string = \"(?:[Ii]mage|[Ff]ile|\u6587\u4ef6|\u6a94\u6848):\\\\s*\" + first_char_regex + RegExp.escape(image.substr(1), true);\n            var links_re = new RegExp(\"\\\\[\\\\[\" + image_re_string);\n            var allLinks = Morebits.array.uniq(Morebits.string.splitWeightedByKeys(this.text, \"[[\", \"]]\"));\n            for (var i = 0; i < allLinks.length; ++i) {\n                if (links_re.test(allLinks[i])) {\n                    var replacement = allLinks[i];\n                    replacement = replacement.replace(/\\]\\]$/, \"|\" + data + \"]]\");\n                    this.text = this.text.replace(allLinks[i], replacement, \"g\");\n                }\n            }\n            var gallery_re = new RegExp(\"^(\\\\s*\" + image_re_string + \".*?)\\\\|?(.*?)$\", \"mg\");\n            var newtext = \"$1|$2 \" + data;\n            this.text = this.text.replace(gallery_re, newtext);\n        },\n        removeTemplate: function(template) {\n            var first_char = template.substr(0, 1);\n            var template_re_string = \"(?:[Tt]emplate:|\u6a21\u677f:)?\\\\s*[\" + first_char.toUpperCase() + first_char.toLowerCase() + \"]\" + RegExp.escape(template.substr(1), true);\n            var links_re = new RegExp(\"\\\\{\\\\{\" + template_re_string);\n            var allTemplates = Morebits.array.uniq(Morebits.string.splitWeightedByKeys(this.text, \"{{\", \"}}\", [\"{{{\", \"}}}\"]));\n            for (var i = 0; i < allTemplates.length; ++i) {\n                if (links_re.test(allTemplates[i])) {\n                    this.text = this.text.replace(allTemplates[i], \"\", \"g\");\n                }\n            }\n        },\n        getText: function() {\n            return this.text;\n        }\n    };\n    Morebits.queryString = function QueryString(qString) {\n        this.string = qString;\n        this.params = {};\n        if (!qString.length) {\n            return;\n        }\n        qString.replace(/\\+/, \" \");\n        var args = qString.split(\"&\");\n        for (var i = 0; i < args.length; ++i) {\n            var pair = args[i].split(\"=\");\n            var key = decodeURIComponent(pair[0]),\n                value = key;\n            if (pair.length === 2) {\n                value = decodeURIComponent(pair[1]);\n            }\n            this.params[key] = value;\n        }\n    };\n    Morebits.queryString.staticstr = null;\n    Morebits.queryString.staticInit = function() {\n        if (!Morebits.queryString.staticstr) {\n            Morebits.queryString.staticstr = new Morebits.queryString(location.search.substring(1));\n        }\n    };\n    Morebits.queryString.get = function(key) {\n        Morebits.queryString.staticInit();\n        return Morebits.queryString.staticstr.get(key);\n    };\n    Morebits.queryString.prototype.get = function(key) {\n        return this.params[key] ? this.params[key] : null;\n    };\n    Morebits.queryString.exists = function(key) {\n        Morebits.queryString.staticInit();\n        return Morebits.queryString.staticstr.exists(key);\n    };\n    Morebits.queryString.prototype.exists = function(key) {\n        return this.params[key] ? true : false;\n    };\n    Morebits.queryString.equals = function(key, value) {\n        Morebits.queryString.staticInit();\n        return Morebits.queryString.staticstr.equals(key, value);\n    };\n    Morebits.queryString.prototype.equals = function(key, value) {\n        return this.params[key] === value ? true : false;\n    };\n    Morebits.queryString.toString = function() {\n        Morebits.queryString.staticInit();\n        return Morebits.queryString.staticstr.toString();\n    };\n    Morebits.queryString.prototype.toString = function() {\n        return this.string ? this.string : null;\n    };\n    Morebits.queryString.create = function(arr) {\n        var resarr = [];\n        var editToken;\n        for (var i in arr) {\n            if (arr[i] === undefined) {\n                continue;\n            }\n            var res;\n            if ($.isArray(arr[i])) {\n                var v = [];\n                for (var j = 0; j < arr[i].length; ++j) {\n                    v[j] = encodeURIComponent(arr[i][j]);\n                }\n                res = v.join(\"|\");\n            } else {\n                res = encodeURIComponent(arr[i]);\n            }\n            if (i === \"token\") {\n                editToken = res;\n            } else {\n                resarr.push(encodeURIComponent(i) + \"=\" + res);\n            }\n        }\n        if (editToken !== undefined) {\n            resarr.push(\"token=\" + editToken);\n        }\n        return resarr.join(\"&\");\n    };\n    Morebits.queryString.prototype.create = Morebits.queryString.create;\n    Morebits.status = function Status(text, stat, type) {\n        this.textRaw = text;\n        this.text = this.codify(text);\n        this.type = type || \"status\";\n        this.generate();\n        if (stat) {\n            this.update(stat, type);\n        }\n    };\n    Morebits.status.init = function(root) {\n        if (!(root instanceof Element)) {\n            throw new Error(\"\u5bf9\u8c61\u4e0d\u662f\u4e00\u4e2aElement\");\n        }\n        while (root.hasChildNodes()) {\n            root.removeChild(root.firstChild);\n        }\n        Morebits.status.root = root;\n        Morebits.status.errorEvent = null;\n    };\n    Morebits.status.root = null;\n    Morebits.status.onError = function(handler) {\n        if ($.isFunction(handler)) {\n            Morebits.status.errorEvent = handler;\n        } else {\n            throw \"Morebits.status.onError\uff1a\u5904\u7406\u7a0b\u5e8f\u4e0d\u662f\u4e00\u4e2a\u51fd\u6570\";\n        }\n    };\n    Morebits.status.prototype = {\n        stat: null,\n        text: null,\n        textRaw: null,\n        type: \"status\",\n        target: null,\n        node: null,\n        linked: false,\n        link: function() {\n            if (!this.linked && Morebits.status.root) {\n                Morebits.status.root.appendChild(this.node);\n                this.linked = true;\n            }\n        },\n        unlink: function() {\n            if (this.linked) {\n                Morebits.status.root.removeChild(this.node);\n                this.linked = false;\n            }\n        },\n        codify: function(obj) {\n            if (!$.isArray(obj)) {\n                obj = [obj];\n            }\n            var result;\n            result = document.createDocumentFragment();\n            for (var i = 0; i < obj.length; ++i) {\n                if (typeof obj[i] === \"string\") {\n                    result.appendChild(document.createTextNode(obj[i]));\n                } else if (obj[i] instanceof Element) {\n                    result.appendChild(obj[i]);\n                }\n            }\n            return result;\n        },\n        update: function(status, type) {\n            this.stat = this.codify(status);\n            if (type) {\n                this.type = type;\n                if (type === \"error\") {\n                    Morebits.wiki.numberOfActionsLeft = 1e3;\n                    if (Morebits.status.errorEvent) {\n                        Morebits.status.errorEvent();\n                    }\n                    if (console && console.error) {\n                        console.error(this.textRaw + \": \" + status);\n                    }\n                }\n            }\n            this.render();\n        },\n        generate: function() {\n            this.node = document.createElement(\"div\");\n            this.node.appendChild(document.createElement(\"span\")).appendChild(this.text);\n            this.node.appendChild(document.createElement(\"span\")).appendChild(document.createTextNode(\": \"));\n            this.target = this.node.appendChild(document.createElement(\"span\"));\n            this.target.appendChild(document.createTextNode(\"\"));\n        },\n        render: function() {\n            this.node.className = \"tw_status_\" + this.type;\n            while (this.target.hasChildNodes()) {\n                this.target.removeChild(this.target.firstChild);\n            }\n            this.target.appendChild(this.stat);\n            this.link();\n        },\n        status: function(status) {\n            this.update(status, \"status\");\n        },\n        info: function(status) {\n            this.update(status, \"info\");\n        },\n        warn: function(status) {\n            this.update(status, \"warn\");\n        },\n        error: function(status) {\n            this.update(status, \"error\");\n        }\n    };\n    Morebits.status.info = function(text, status) {\n        return new Morebits.status(text, status, \"info\");\n    };\n    Morebits.status.warn = function(text, status) {\n        return new Morebits.status(text, status, \"warn\");\n    };\n    Morebits.status.error = function(text, status) {\n        return new Morebits.status(text, status, \"error\");\n    };\n    Morebits.status.printUserText = function(comments, message) {\n        var p = document.createElement(\"p\");\n        p.textContent = message;\n        var div = document.createElement(\"div\");\n        div.className = \"toccolours\";\n        div.style.marginTop = \"0\";\n        div.style.whiteSpace = \"pre-wrap\";\n        div.textContent = comments;\n        p.appendChild(div);\n        Morebits.status.root.appendChild(p);\n    };\n    Morebits.htmlNode = function(type, content, color) {\n        var node = document.createElement(type);\n        if (color) {\n            node.style.color = color;\n        }\n        node.appendChild(document.createTextNode(content));\n        return node;\n    };\n    Morebits.checkboxShiftClickSupport = function(jQuerySelector, jQueryContext) {\n        var lastCheckbox = null;\n        function clickHandler(event) {\n            var cb = this;\n            if (event.shiftKey && lastCheckbox !== null) {\n                var cbs = $(jQuerySelector, jQueryContext);\n                var index = -1,\n                    lastIndex = -1;\n                for (var i = 0; i < cbs.length; i++) {\n                    if (cbs[i] == cb) {\n                        index = i;\n                        if (lastIndex > -1) break;\n                    }\n                    if (cbs[i] == lastCheckbox) {\n                        lastIndex = i;\n                        if (index > -1) break;\n                    }\n                }\n                if (index > -1 && lastIndex > -1) {\n                    var endState = cb.checked;\n                    var start, finish;\n                    if (index < lastIndex) {\n                        start = index + 1;\n                        finish = lastIndex;\n                    } else {\n                        start = lastIndex;\n                        finish = index - 1;\n                    }\n                    for (var i = start; i <= finish; i++) cbs[i].checked = endState;\n                }\n            }\n            lastCheckbox = cb;\n            return true;\n        }\n        $(jQuerySelector, jQueryContext).click(clickHandler);\n    };\n    Morebits.batchOperation = function(currentAction) {\n        var ctx = {\n            pageList: null,\n            options: {\n                chunkSize: 50,\n                preserveIndividualStatusLines: false\n            },\n            statusElement: new Morebits.status(currentAction || \"\u6267\u884c\u6279\u91cf\u64cd\u4f5c\"),\n            worker: null,\n            countStarted: 0,\n            countFinished: 0,\n            countFinishedSuccess: 0,\n            currentChunkIndex: -1,\n            pageChunks: [],\n            running: false\n        };\n        this.getStatusElement = function() {\n            return ctx.statusElement;\n        };\n        this.setPageList = function(pageList) {\n            ctx.pageList = pageList;\n        };\n        this.setOption = function(optionName, optionValue) {\n            ctx.options[optionName] = optionValue;\n        };\n        this.run = function(worker) {\n            if (ctx.running) {\n                ctx.statusElement.error(\"\u6279\u91cf\u64cd\u4f5c\u5df2\u5728\u8fd0\u884c\");\n                return;\n            }\n            ctx.running = true;\n            ctx.worker = worker;\n            ctx.countStarted = 0;\n            ctx.countFinished = 0;\n            ctx.countFinishedSuccess = 0;\n            ctx.currentChunkIndex = -1;\n            ctx.pageChunks = [];\n            var total = ctx.pageList.length;\n            if (!total) {\n                ctx.statusElement.info(\"\u6ca1\u4ec0\u4e48\u8981\u505a\u7684\");\n                ctx.running = false;\n                return;\n            }\n            ctx.pageChunks = Morebits.array.chunk(ctx.pageList, ctx.options.chunkSize);\n            Morebits.wiki.addCheckpoint();\n            ctx.statusElement.status(\"0%\");\n            fnStartNewChunk();\n        };\n        this.workerSuccess = function(apiobj) {\n            if (apiobj && apiobj.getStatusElement) {\n                var statelem = apiobj.getStatusElement();\n                if (ctx.options.preserveIndividualStatusLines) {\n                    if (apiobj.getPageName || apiobj.pageName || apiobj.query && apiobj.query.title) {\n                        var pageName = apiobj.getPageName ? apiobj.getPageName() : apiobj.pageName || apiobj.query.title;\n                        var link = document.createElement(\"a\");\n                        link.setAttribute(\"href\", mw.util.getUrl(pageName));\n                        link.appendChild(document.createTextNode(pageName));\n                        statelem.info([\"\u5b8c\u6210\uff08\", link, \"\uff09\"]);\n                    } else {\n                        statelem.info(\"\u5b8c\u6210\");\n                    }\n                } else {\n                    statelem.unlink();\n                }\n            }\n            ctx.countFinishedSuccess++;\n            fnDoneOne(apiobj);\n        };\n        this.workerFailure = function(apiobj) {\n            fnDoneOne(apiobj);\n        };\n        var thisProxy = this;\n        var fnStartNewChunk = function() {\n            var chunk = ctx.pageChunks[++ctx.currentChunkIndex];\n            if (!chunk) {\n                return;\n            }\n            ctx.countStarted += chunk.length;\n            chunk.forEach(function(page) {\n                ctx.worker(page, thisProxy);\n            });\n        };\n        var fnDoneOne = function() {\n            ctx.countFinished++;\n            var total = ctx.pageList.length;\n            if (ctx.countFinished === total) {\n                var statusString = \"\u5b8c\u6210\uff08\" + ctx.countFinishedSuccess + \"/\" + ctx.countFinished + \"\u64cd\u4f5c\u6210\u529f\u5b8c\u6210\uff09\";\n                if (ctx.countFinishedSuccess < ctx.countFinished) {\n                    ctx.statusElement.warn(statusString);\n                } else {\n                    ctx.statusElement.info(statusString);\n                }\n                Morebits.wiki.removeCheckpoint();\n                ctx.running = false;\n                return;\n            }\n            if (ctx.countFinished > total) {\n                ctx.statusElement.warn(\"\u5b8c\u6210\uff08\u591a\u6267\u884c\u4e86\" + (ctx.countFinished - total) + \"\uff09\");\n                Morebits.wiki.removeCheckpoint();\n                ctx.running = false;\n                return;\n            }\n            ctx.statusElement.status(parseInt(100 * ctx.countFinished / total, 10) + \"%\");\n            if (ctx.countFinished >= ctx.countStarted - Math.max(ctx.options.chunkSize / 10, 2) && Math.floor(ctx.countFinished / ctx.options.chunkSize) > ctx.currentChunkIndex) {\n                fnStartNewChunk();\n            }\n        };\n    };\n    Morebits.simpleWindow = function SimpleWindow(width, height) {\n        var content = document.createElement(\"div\");\n        this.content = content;\n        content.className = \"morebits-dialog-content\";\n        content.id = \"morebits-dialog-content-\" + Math.round(Math.random() * 1e15);\n        this.height = height;\n        $(this.content).dialog({\n            autoOpen: false,\n            buttons: {\n                \"\u5360\u4f4d\u6309\u94ae\": function() {}\n            },\n            dialogClass: \"morebits-dialog\",\n            width: Math.min(parseInt(window.innerWidth, 10), parseInt(width ? width : 800, 10)),\n            height: height + 20,\n            close: function(event, ui) {\n                $(event.target).dialog(\"destroy\").remove();\n            },\n            resizeStart: function(event, ui) {\n                this.scrollbox = $(this).find(\".morebits-scrollbox\")[0];\n                if (this.scrollbox) {\n                    this.scrollbox.style.maxHeight = \"none\";\n                }\n            },\n            resizeEnd: function(event, ui) {\n                this.scrollbox = null;\n            },\n            resize: function(event, ui) {\n                this.style.maxHeight = \"\";\n                if (this.scrollbox) {\n                    this.scrollbox.style.width = \"\";\n                }\n            }\n        });\n        var $widget = $(this.content).dialog(\"widget\");\n        var $titlebar = $widget.find(\".ui-dialog-titlebar\");\n        var oldstyle = $titlebar.attr(\"style\");\n        $titlebar.attr(\"style\", (oldstyle ? oldstyle : \"\") + \"; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAkCAMAAAB%2FqqA%2BAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAEhQTFRFr73ZobTPusjdsMHZp7nVwtDhzNbnwM3fu8jdq7vUt8nbxtDkw9DhpbfSvMrfssPZqLvVztbno7bRrr7W1d%2Fs1N7qydXk0NjpkW7Q%2BgAAADVJREFUeNoMwgESQCAAAMGLkEIi%2FP%2BnbnbpdB59app5Vdg0sXAoMZCpGoFbK6ciuy6FX4ABAEyoAef0BXOXAAAAAElFTkSuQmCC) !important;\");\n        $widget.find(\"button\").each(function(key, value) {\n            value.parentNode.removeChild(value);\n        });\n        var buttonspan = document.createElement(\"span\");\n        buttonspan.className = \"morebits-dialog-buttons\";\n        var linksspan = document.createElement(\"span\");\n        linksspan.className = \"morebits-dialog-footerlinks\";\n        $widget.find(\".ui-dialog-buttonpane\").append(buttonspan, linksspan);\n        $widget.resizable(\"option\", \"alsoResize\", \"#\" + this.content.id + \" .morebits-scrollbox, #\" + this.content.id);\n    };\n    Morebits.simpleWindow.prototype = {\n        buttons: [],\n        height: 600,\n        hasFooterLinks: false,\n        scriptName: null,\n        focus: function(event) {\n            $(this.content).dialog(\"moveToTop\");\n            return this;\n        },\n        close: function(event) {\n            if (event) {\n                event.preventDefault();\n            }\n            $(this.content).dialog(\"close\");\n            return this;\n        },\n        display: function() {\n            if (this.scriptName) {\n                var $widget = $(this.content).dialog(\"widget\");\n                $widget.find(\".morebits-dialog-scriptname\").remove();\n                var scriptnamespan = document.createElement(\"span\");\n                scriptnamespan.className = \"morebits-dialog-scriptname\";\n                scriptnamespan.textContent = this.scriptName + \" \u00b7 \";\n                $widget.find(\".ui-dialog-title\").prepend(scriptnamespan);\n            }\n            var dialog = $(this.content).dialog(\"open\");\n            if (window.setupTooltips && window.pg && window.pg.re && window.pg.re.diff) {\n                dialog.parent()[0].ranSetupTooltipsAlready = false;\n                if (window.setupTooltips) window.setupTooltips(dialog.parent()[0]);\n            }\n            this.setHeight(this.height);\n            return this;\n        },\n        setTitle: function(title) {\n            $(this.content).dialog(\"option\", \"title\", title);\n            return this;\n        },\n        setScriptName: function(name) {\n            this.scriptName = name;\n            return this;\n        },\n        setWidth: function(width) {\n            $(this.content).dialog(\"option\", \"width\", width);\n            return this;\n        },\n        setHeight: function(height) {\n            this.height = height;\n            if (parseInt(getComputedStyle($(this.content).dialog(\"widget\")[0], null).height, 10) > window.innerHeight) {\n                $(this.content).dialog(\"option\", \"height\", window.innerHeight - 2).dialog(\"option\", \"position\", \"top\");\n            } else {\n                $(this.content).dialog(\"option\", \"height\", \"auto\");\n            }\n            $(this.content).dialog(\"widget\").find(\".morebits-dialog-content\")[0].style.maxHeight = parseInt(this.height - 30, 10) + \"px\";\n            return this;\n        },\n        setContent: function(content) {\n            this.purgeContent();\n            this.addContent(content);\n            return this;\n        },\n        addContent: function(content) {\n            this.content.appendChild(content);\n            var thisproxy = this;\n            $(this.content).find('input[type=\"submit\"], button[type=\"submit\"]').each(function(key, value) {\n                value.style.display = \"none\";\n                var button = document.createElement(\"button\");\n                button.textContent = value.hasAttribute(\"value\") ? value.getAttribute(\"value\") : value.textContent ? value.textContent : \"\u63d0\u4ea4\";\n                button.addEventListener(\"click\", function() {\n                    value.click();\n                }, false);\n                thisproxy.buttons.push(button);\n            });\n            if (this.buttons.length > 0) {\n                $(this.content).dialog(\"widget\").find(\".morebits-dialog-buttons\").empty().append(this.buttons)[0].removeAttribute(\"data-empty\");\n            } else {\n                $(this.content).dialog(\"widget\").find(\".morebits-dialog-buttons\")[0].setAttribute(\"data-empty\", \"data-empty\");\n            }\n            return this;\n        },\n        purgeContent: function() {\n            this.buttons = [];\n            $(this.content).dialog(\"widget\").find(\".morebits-dialog-buttons\").empty();\n            while (this.content.hasChildNodes()) {\n                this.content.removeChild(this.content.firstChild);\n            }\n            return this;\n        },\n        addFooterLink: function(text, wikiPage) {\n            var $footerlinks = $(this.content).dialog(\"widget\").find(\".morebits-dialog-footerlinks\");\n            if (this.hasFooterLinks) {\n                var bullet = document.createElement(\"span\");\n                bullet.textContent = \" \u2022 \";\n                $footerlinks.append(bullet);\n            }\n            var link = document.createElement(\"a\");\n            link.setAttribute(\"href\", mw.util.getUrl(wikiPage));\n            link.setAttribute(\"title\", wikiPage);\n            link.setAttribute(\"target\", \"_blank\");\n            link.textContent = text;\n            $footerlinks.append(link);\n            this.hasFooterLinks = true;\n            return this;\n        },\n        setModality: function(modal) {\n            $(this.content).dialog(\"option\", \"modal\", modal);\n            return this;\n        }\n    };\n    Morebits.simpleWindow.setButtonsEnabled = function(enabled) {\n        $(\".morebits-dialog-buttons button\").prop(\"disabled\", !enabled);\n    };\n})(window, document, jQuery);\nif (typeof arguments === \"undefined\") {\n    window.SimpleWindow = window.Morebits.simpleWindow;\n    window.QuickForm = window.Morebits.quickForm;\n    window.Wikipedia = window.Morebits.wiki;\n    window.Status = window.Morebits.status;\n    window.QueryString = window.Morebits.queryString;\n}\n/* jshint ignore:end */\n//</nowiki>"}}}