{"parse":{"title":"User:Imbushuo/MonacoLoader.js","pageid":221883,"wikitext":{"*":"var MwMonaco;(function(n){var t=function(){function n(n,t){this.m_textAreaControl=n;this.m_docType=\"markdown\";monaco.languages.register({id:\"mediawiki\"});window.monacoUserConfig&&(this.m_userOptions=window.monacoUserConfig);t&&t.autoLoad&&this.initialize()}return n.determineAvailability=function(){return document.getElementById(\"wpTextbox1\")?!0:!1},n.prototype.checkTitleExtensionAsync=function(){var t=this;return new monaco.Promise(function(i,r){mw.loader.using(\"mediawiki.Uri\").then(function(){var f=new mw.Uri;if(f.query.title){var u=f.query.title,e=u.lastIndexOf(\".\"),o=u.indexOf(\":\");t.m_docPrefix=u.substring(0,o);t.m_docExtension=u.substring(e);t.m_title=u;n.g_prefixMapping[t.m_docPrefix]?i(n.g_prefixMapping[t.m_docPrefix]):n.g_extMapping[t.m_docExtension]?i(n.g_extMapping[t.m_docExtension]):i(\"mediawiki\")}else r(\"Unable to load title\")})})},n.prototype.createLibraryXhrPromise=function(n){return new monaco.Promise(function(t,i){$.ajax({url:n.url,cache:!0}).then(function(i){t({content:i,fileName:n.fileName,url:n.url})}).fail(function(){i(null)})})},n.prototype.loadReferenceLibrariesAsync=function(){var t=this;return new monaco.Promise(function(i){switch(t.m_docType){case\"javascript\":case\"typescript\":console.info(\"Loading references for script editor.\");var r=[];n.g_commonLibraries.forEach(function(n){return r.push(t.createLibraryXhrPromise(n))});monaco.Promise.join(r).then(function(n){n.forEach(function(n){console.info(\"Loaded module \"+n.fileName+\".\");monaco.languages.typescript.typescriptDefaults.addExtraLib(n.content,n.fileName);monaco.languages.typescript.javascriptDefaults.addExtraLib(n.content,n.fileName)});i(!0)},function(){return i(!1)});break;case\"mediawiki\":t.setupMediaWikiHighlight();$.getScript(\"/User:imbushuo/MonacoEditor/MediaWikiIntelliSense.min.js?action=raw&ctype=text/javascript\",function(){var n=new MwMonacoExtension.TitleAutoCompletionSource,t=new MwMonacoExtension.TemplateAutoCompletionSource;monaco.languages.registerCompletionItemProvider(\"mediawiki\",{provideCompletionItems:function(i,r){var f=i.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:r.lineNumber,endColumn:r.column}),u=n.matchRule.exec(f);return u&&u.length>1?n.getCandidateItemsAsync(u[1]):(u=t.matchRule.exec(f),u&&u.length>1)?t.getCandidateItemsAsync(u[1]):[]}});i(!0)}).fail(function(){return i(!1)});break;default:i(!0)}})},n.prototype.createEditorHost=function(){var n=document.createElement(\"div\");return n.id=\"editorContainer\",n.style.cssText=\"width:100%;height:500px;\",$(\"#wpTextbox1\").after(n),$(\"#wpTextbox1\").hide(),n},n.prototype.getTheme=function(){return this.m_userOptions&&this.m_userOptions.theme?this.m_userOptions.theme:\"vs\"},n.prototype.getFontFamily=function(){return this.m_userOptions&&this.m_userOptions.fontFamily?this.m_userOptions.fontFamily:\"Iosevka, Consolas, Monaco, 'Source Han Sans SC', 'Source Han Sans', 'Microsoft YaHei', monospace\"},n.prototype.flushEditor=function(){this.m_editorControl&&$(\"#wpTextbox1\").val(this.m_editorControl.getModel().getValue())},n.prototype.setupActions=function(){var n=this;this.m_editorControl.addAction({id:\"save-action\",label:\"Save changes\",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.F7],keybindingContext:null,contextMenuGroupId:\"mediawikiActions\",contextMenuOrder:1,run:function(){n.flushEditor();$(\"#editform\").submit()}});this.m_editorControl.addAction({id:\"diff-toggle-action\",label:\"Compare with current\",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyMod.Shift|monaco.KeyCode.KEY_D],keybindingContext:null,contextMenuGroupId:\"mediawikiActions\",contextMenuOrder:2,run:function(){n.initializeDiffEditor()}})},n.prototype.setupDiffActions=function(){var n=this;this.m_diffEditorControl.addAction({id:\"save-action\",label:\"Save changes\",keybindings:[monaco.KeyMod.CtrlCmd|monaco.KeyCode.F7],keybindingContext:null,contextMenuGroupId:\"mediawikiActions\",contextMenuOrder:1,run:function(){n.flushEditor();$(\"#editform\").submit()}})},n.prototype.setupMediaWikiHighlight=function(){MwMonacoExtension.MediaWikiTokenizer?(monaco.languages.setMonarchTokensProvider(\"mediawiki\",new MwMonacoExtension.MediaWikiTokenizer),console.info(\"MediaWiki Monarch token provider is set.\")):console.info(\"MediaWiki Monarch token provider is NOT loaded.\")},n.prototype.initialize=function(){var t=this;n.determineAvailability()&&this.checkTitleExtensionAsync().then(function(n){t.m_docType=n;t.m_hostControl=t.createEditorHost();t.loadReferenceLibrariesAsync().then(function(){t.m_originalContent=t.m_textAreaControl.value;monaco.editor.defineTheme(\"localTheme\",{base:t.getTheme(),inherit:!0,rules:[{token:\"bold\",fontStyle:\"bold\"},{token:\"bold.quote\",fontStyle:\"bold\"},{token:\"italic\",fontStyle:\"italic\"},{token:\"italic.quote\",fontStyle:\"italic\"}]});t.m_editorControl=monaco.editor.create(t.m_hostControl,{value:t.m_textAreaControl.value,language:t.m_docType,theme:\"localTheme\",fontFamily:t.getFontFamily(),automaticLayout:!0,wordWrap:t.m_docType===\"mediawiki\",folding:true});window.setInterval(function(){return t.flushEditor()},5e3);$(\"#editform\").submit(function(){t.flushEditor()});t.setupActions();MwMonacoExtension.LanguageServices.LinkLinter&&t.m_docType===\"mediawiki\"&&(t.m_linter=new MwMonacoExtension.LanguageServices.LinkLinter(t.m_editorControl))})})},n.prototype.initializeDiffEditor=function(){this.m_originalContent&&(this.flushEditor(),this.m_editorControl.dispose(),this.m_editorControl=null,$(this.m_hostControl).empty(),this.m_diffEditorControl=monaco.editor.createDiffEditor(this.m_hostControl,{fontFamily:this.getFontFamily(),automaticLayout:!0,theme:\"localTheme\",wordWrap:this.m_docType===\"mediawiki\",folding:true}),this.m_diffEditorControl.setModel({original:monaco.editor.createModel(this.m_originalContent,this.m_docType),modified:monaco.editor.createModel(this.m_textAreaControl.value,this.m_docType)}),this.m_editorControl=this.m_diffEditorControl.getModifiedEditor(),this.setupDiffActions())},n}();t.g_prefixMapping={Module:\"lua\",\"\u6a21\u5757\":\"lua\"};t.g_extMapping={\".js\":\"javascript\",\".ts\":\"typescript\",\".css\":\"css\",\".less\":\"less\",\".scss\":\"scss\"};t.g_commonLibraries=[{url:\"/User:Imbushuo/MonacoEditor/jquery.d.ts?action=raw&ctype=text/typescript\",fileName:\"jquery.d.ts\"},{url:\"/User:Imbushuo/MonacoEditor/mediawiki.d.ts?action=raw&ctype=text/typescript\",fileName:\"mediawiki.d.ts\"}];n.MonacoLoader=t})(MwMonaco||(MwMonaco={}));\n//# sourceMappingURL=MonacoLoader.min.js.map"}}}