{"parse":{"title":"MediaWiki:Gadget-FlowThreadCheck.js","pageid":155524,"wikitext":{"*":"// <pre>\n/* globals $ */\n$(function() {\n    var rules = [],\n        checkBox = {\n            node: $('<div id=\"flowthreadCheckBox\"><div id=\"flowthreadCheckBoxTitle\"><div id=\"flowthreadCheckBoxTitleContent\">\u8bc4\u8bba\u9884\u89c8</div><span id=\"flowthreadCheckBoxCloseButton\">\u00d7</span></div><div id=\"flowthreadCheckBoxContent\"><div id=\"flowthreadCheckBoxContentBox\"></div></div></div>'),\n            closeButton: $('#flowthreadCheckBoxCloseButton').on('click', checkBoxFadeOut),\n            content: $('#flowthreadCheckBoxContentBox')\n        };\n    checkBox.node.appendTo(\"body\");\n\n    function addCheckButton() {\n        $('.comment-submit').each(function() {\n            var submitButton = $(this);\n            if (submitButton.data('addCheckButton') === true) return;\n            var checkButton = $('<button/>').text('\u8bc4\u8bba\u68c0\u67e5').addClass('comment-check').css('right', submitButton.width());\n            checkButton.on('click', showCheckBox);\n            submitButton.before(checkButton).data('addCheckButton', true);\n        });\n        var container = $(\".comment-container, .comment-container-top\").map(function() { return !(($(this).find('[href^=\"/\"]')[0] || {}).onmouseover || {}).name === \"mouseOverWikiLink\" ? this : undefined });\n        if (container.length > 0) mw.hook(\"wikipage.content\").fire(container);\n    }\n\n    function checkBoxFadeIn() {\n        return checkBox.node.fadeIn(370).delay(370);\n    }\n\n    function checkBoxFadeOut() {\n        return checkBox.node.fadeOut(370).delay(370);\n    }\n\n    function showCheckBox() {\n        var self = this,\n            text = $(this).closest('.comment-replybox').find('textarea').val();\n        if (/\\s{1307,}/.test(text)) return alert('\u8f93\u5165\u5185\u5bb9\u6709\u8bef\uff0c\u8bf7\u4e0d\u8981\u8f93\u5165\u90a3\u4e48\u591a\u7a7a\u683c');\n        if (!text) return alert('\u8bf7\u8f93\u5165\u8bc4\u8bba\u5185\u5bb9\u540e\u68c0\u67e5');\n        if (checkBox.content.text()) checkBox.content.empty();\n        if (!rules[0]) $.ajax({\n            url: '//zh.moegirl.org/MediaWiki:Flowthread-blacklist?action=raw',\n            type: 'GET',\n            success: function(data) {\n                rules = data.split('\\n');\n                rules.splice(0, 5);\n                rules.forEach(function(v, i) {\n                    var length = v.indexOf('#') === -1 ? i.length : v.indexOf('#'),\n                        regexp = v.slice(0, length).trim();\n                    if (!/^\\s*\\#/.test(v) && regexp) rules[i] = [rules[i], RegExp(regexp, 'ig')];\n                    else rules[i] = ['Unexpected Rule', /\\s{1307,}/];\n                });\n                checkText(text);\n            },\n            error: function() {\n                showCheckBox.call(self);\n            }\n        });\n        else checkText(text);\n    }\n\n    function checkText(text) {\n        var errorText = [];\n        rules.forEach(function(v) {\n            if (v[1].test(text)) errorText.push([v[0], text.match(v[1])]);\n        });\n        checkBoxFadeIn();\n        if (!errorText[0]) checkBox.content.append('\u60a8\u7684\u8bc4\u8bba\u6ca1\u6709\u89e6\u53d1\u9ed1\u540d\u5355\u673a\u5236\u3002');\n        else {\n            var table = checkBox.content.append('\u60a8\u7684\u8bc4\u8bba\u89e6\u53d1\u4ee5\u4e0b\u9ed1\u540d\u5355\uff08\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f<sup><a rel=\"nofollow\" target=\"_blank\" class=\"external text\" href=\"http://baike' + '.baidu.com/view/94238.htm\">\u89e3\u91ca</a></sup>\uff09\uff1a').append($('<table/>')).find('table');\n            table.append('<tr><th>No.</th>' /* + '<th>\u9ed1\u540d\u5355</th>' */ + '<th>\u547d\u4e2d\u5b57\u7b26\u4e32</th></tr>');\n            errorText.forEach(function(n) {\n                table.append(\n                    $('<tr/>').append($('<td/>').addClass('first').text(table.find('tr').length))\n                    //.append($('<td/>').text(n[0]))\n                    .append($('<td/>').append(n[1].map(function(t) {\n                        return '<code>' + $('<span/>').text(t).html() + '</code>';\n                    }).join('<br/>')))\n                );\n            });\n        }\n    }\n    addCheckButton();\n    $('.comment-container').on('click', function(e) {\n        if ($(e.target).hasClass(\"comment-reply\")) window.setTimeout(function() {\n            addCheckButton();\n        }, 0);\n    });\n});\n// </pre>"}}}