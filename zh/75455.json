{"parse":{"title":"User:\u6771\u6771\u541b/js/pair.js","pageid":282226,"wikitext":{"*":"/*\n\t\u8f7d\u5165\u8be5\u63d2\u4ef6\u540e\uff0c\u5c06\u5bf9wikitext\u8bed\u6cd5\u6240\u4f7f\u7528\u7684\u7b26\u53f7\u548chtml\u6807\u7b7e\u8fdb\u884c\u6210\u5bf9\u7684\u8865\u5168\u3002\n\t\u8be5\u63d2\u4ef6\u5e76\u4e0d\u4f1a\u8ba1\u7b97\u6574\u4e2a\u6e90\u4ee3\u7801\u4e2d\u7684html\u6807\u7b7e\u914d\u5bf9\u60c5\u51b5\uff0c\u6807\u7b7e\u7684\u8865\u5168\u4ec5\u53d1\u751f\u5728\u8f93\u5165\u5927\u4e8e\u53f7(>)\u65f6\uff0c\u8865\u5168\u8ddd\u79bb\u6700\u8fd1\u7684html\u6807\u7b7e\u3002\n\t\u5728\u8f93\u5165\u65e0\u5176\u4ed6\u4fe1\u606f\u7684\u6807\u7b7e\u540e\uff08\u5982\uff1a<div></div>\uff09\uff0c\u82e5\u6309\u4e0b\u9000\u683c\uff08backspace\uff09\u952e\uff0c\u53ef\u4ee5\u76f4\u63a5\u5220\u9664\u8fd9\u4e00\u7ec4\u6807\u7b7e\u3002\n\t\u6ce8\u610f\uff1a\u56e0\u4e3a\u6bcf\u6b21\u8f93\u5165\u65f6\u90fd\u4f1a\u5bf9\u6574\u4e2a\u6e90\u4ee3\u7801\u8fdb\u884c\u67e5\u627e\u5339\u914d\uff0c\u4e3a\u4e86\u9632\u6b62\u5361\u987f\uff0c\u9ed8\u8ba4\u9650\u5236\u4e3a500\u4e2a\u5b57\u7b26\uff0c\u4f46\u8fd9\u4f1a\u5bfc\u81f4\u5f53\u6807\u7b7e\u8fc7\u957f\uff08\u4f8b\u5982\u5728\u8282\u70b9\u4e0a\u6dfb\u52a0\u4e86\u5927\u91cfcss\u4ee3\u7801\uff09\u65f6\uff0c\u65e0\u6cd5\u81ea\u52a8\u8865\u5168\u3002\n\t\u8fc7\u957f\u7684\u6e90\u4ee3\u7801\u4f1a\u4f7f\u8f93\u5165\u65f6\u6027\u80fd\u5927\u5e45\u4e0b\u964d\uff0c\u9020\u6210\u5361\u987f\u3002\u5f53\u603b\u5b57\u7b26\u6570\u5927\u4e8e20000\u65f6\uff0c\u5c06\u81ea\u52a8\u5173\u95ed\u8865\u5168\uff0c\u8bf7\u5408\u7406\u4f7f\u7528\u6bb5\u843d\u7f16\u8f91\u7684\u529f\u80fd\u3002\n*/\n\n$(function(){\n    if(/action=(edit|submit)/.test(location.href)){\n\t    var wpText = $('#wpTextbox1')\n\t    \n\t    if(wpText.val().length > 20000){\n\t    \tmw.notify('\u56e0\u6e90\u4ee3\u7801\u8fc7\u957f\uff0c\u8865\u5168\u529f\u80fd\u88ab\u5173\u95ed\uff01', { type : 'warn' })\n\t    \treturn\n\t    }\n\t    \n\t\tvar retrospect = 500\n\t\tvar pattern = [\n\t\t\t['-{', '}-'],\n\t\t\t['[', ']'],\n\t\t\t['{', '}'],\n\t\t\t[\"'\", \"'\"],\n\t\t\t['\"', '\"'],\n\t\t\t['(', ')'],\n\t\t\t['<!--', '-->']\n\t\t]\n\t\n\t    //\u5149\u6807\u540e\u63d2\u5165\u4fe1\u606f\n\t    function insertText(obj, str){\n\t\t\tvar content = obj.value,\n\t\t\tposition = obj.selectionEnd,\n\t\t\tleft = content.substring(0, position),\n\t\t\tright = content.substring(position)\n\t\t\tobj.value = left + str + right\n\t    }\n\n\t\tvar original = null\n\t\twpText.one('click', function(){\n\t\t\toriginal = {\n\t\t\t\tcode : wpText.val(),\n\t\t\t\tstart : wpText[0].selectionStart,\n\t\t\t\tend : wpText[0].selectionEnd\n\t\t\t}\n\t\t})\t\n\t\n\t    // \u7f13\u5b58\u8f93\u5165\u5185\u5bb9 & \u5224\u65ad\n\t\tvar end = 0, \n\t\tthisLength = 0,\n\t\tlastLength = 0,\n\t\tcode = '',\n\t\tthisCode = '',\n\t\tdeletedKeyword = '',\n\t\t\n\t\t// \u9700\u8981\u6682\u505c\u8865\u5168\u7684\u72b6\u6001\n\t\ttypewritingMode = false,\n\t\tcutPaste = false,\n\t\tselectInput = false,\n\t\tselectDelete = false,\n\t\tinputFinish = false\n \n\t\tvar codeSave = [{\n\t\t\tcode : wpText.val(),\n\t\t\tstart : wpText[0].selectionStart,\n\t\t\tend : wpText[0].selectionEnd\n\t\t}],\n\t\tinputMark = false\n\t    function selectionReset(){\n\t        end = wpText[0].selectionEnd\n\t        lastLength = wpText.val().length\n\t\t}\n\t\n\t    wpText.click(function(){\n\t        selectionReset()\n\t    }).keyup(function(e){\n\t        if(e.keyCode > 36 && e.keyCode < 41){\n\t            selectionReset()\n\t            code = ''\n\t        }\n\t    }).on('keydown keyup', function(e){\n\t\t\tif(e.keyCode == 8){\n\t\t\t\tvar subStart = (this.selectionEnd - 1) < 0 ? 0 : (this.selectionEnd - 1)\n\t\t\t\tvar left = thisCode.substring(subStart, this.selectionEnd)\n\t\t\t\tdeletedKeyword = left\n\t\t\t\tselectionReset()\n\t\t\t}\n\t\t}).on('compositionstart', function(){\n\t\t\ttypewritingMode = true\n\t\t}).on('compositionend', function(){\n\t\t\ttypewritingMode = false\n            inputFinish = true\n            $(this).trigger('input')\n            selectionReset()\n\t\t}).on('cut paste', function(){\n\t\t\tcutPaste = true\n\t\t\t\n\t\t\tcodeSave.push({\n\t\t\t\tcode : wpText.val(),\n\t\t\t\tstart : wpText[0].selectionStart,\n\t\t\t\tend : wpText[0].selectionEnd\n\t\t\t})\n\t\t\tinputMark = false\n\t\t\tsetTimeout(selectionReset, 0)\n\t\t}).on('keydown', function(e){\n\t\t\tselectInput = !! document.getSelection().toString()\n\t\t\tif(selectInput){ end = wpText[0].selectionStart}\n\t\t\tif(selectInput && (e.keyCode == 8 || e.keyCode == 46)){ selectDelete = true }\n\t\t}).on('input', function(){\n\t\t\t;(function(_this){\n                if(typewritingMode){ return }\n                if(inputFinish){ inputFinish = false; return }\n\t\t\t\tif(cutPaste){ cutPaste = false; return }\n\t\t\t\tif(selectDelete){ selectDelete = false; return }\n\t\t        thisCode = $(_this).val()\n\t\t        var right = thisCode.substring(end)\n\t\t        thisLength = $(_this).val().length\n\t\t        if(thisLength - lastLength == 1 || selectInput){\n\t\t\t\t\tcode += right.substring(0, 1)\n\t\t        }else{\n\t\t            code = ''\n\t\t            \n\t\t            if(lastLength - thisLength == 1){\n\t\t            \tvar subStart = (_this.selectionEnd - 20) < 0 ? 0 : (_this.selectionEnd - 20),\n\t\t            \tsubEnd = (_this.selectionEnd + 20) > thisLength ? thisLength : (_this.selectionEnd + 20)\n\t\t            \t\n\t\t            \tvar subLeft = thisCode.substring(0, subStart),\n\t\t            \tsubRight = thisCode.substring(subEnd)\n\t\t            \t\n\t\t            \tvar left = thisCode.substring(subStart, _this.selectionEnd),\n\t\t            \tright = thisCode.substring(_this.selectionEnd, subEnd),\n\t\t            \tleftRE = /([\\s\\S]*)<(.+)$/,\n\t\t\t\t\t\trightRE = /^\\<\\/(.+?)>([\\s\\S]*)/\n\t\t            \tvar tagLeft = left.replace(leftRE, '$2')\n\t\t\t\t\t\tvar tagRight = right.replace(rightRE, '$1')\n\t\t            \tif(tagLeft == tagRight){\n\t\t            \t\tvar leftCode = left.replace(leftRE, '$1')\n\t\t            \t\tvar rightCode = right.replace(rightRE, '$2')\n\t\t            \t\t$(_this).val(subLeft + leftCode + rightCode + subRight)\n\t\t            \t\tvar cursorPos = new String(subLeft + leftCode).length\n\t\t            \t\t_this.selectionStart = _this.selectionEnd = cursorPos\n\t\t            \t}\n\t \n\t\t\t\t\t\t$.each(pattern, function(){\n\t\t\t\t\t\t\tvar $this = wpText[0]\n\t\t\t\t\t\t\tif(lastLength - thisLength == 1){\n\t\t\t\t\t\t\t\tvar subStart = $this.selectionEnd < 0 ? 0 : $this.selectionEnd\n\t\t\t\t\t\t\t\tvar subEnd = ($this.selectionEnd + 1) > thisLength ? thisLength : ($this.selectionEnd + 1)\n\t\t\t\t\t\t\t\t$this.selectionEnd == subEnd && subEnd++\n\t\t\t\t\t\t\t\tvar subLeft = thisCode.substring(0, $this.selectionEnd),\n\t\t\t\t\t\t\t\tsubRight = thisCode.substring(subEnd)\n\t\t\t\t\t\t\t\tvar left = thisCode.substring(subStart, $this.selectionEnd),\n\t\t\t\t\t\t\t\tright = thisCode.substring($this.selectionEnd, subEnd)\n\t \n\t\t\t\t\t\t\t\tif(deletedKeyword == this[0] && right == this[1]){\t\n\t\t\t\t\t\t\t\t\t$($this).val(subLeft + subRight)\n\t\t\t\t\t\t\t\t\t$this.selectionStart = $this.selectionEnd = subLeft.length\n\t\t\t\t\t\t\t\t\tselectionReset()\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t\t\t})\n\t\t            }\n\t\t            \n\t\t        }\n\t \n\t\t        function pair(keyword, char, num){\n\t\t            if(code.indexOf(keyword) != -1){\n\t\t\t\t\t\tvar num = num || char.length\n\t\t\t\t\t\tvar position = wpText[0].selectionEnd\n\t\t                insertText(wpText[0], char)\n\t\t                wpText[0].selectionStart = wpText[0].selectionEnd = position\n\t\t                selectionReset()\n\t\t                code = ''\n\t\t            }\n\t\t        }\n\t  \n\t\t        function addPair(arr){\n\t\t        \t$.each(arr, function(){\n\t\t\t\t\t\tpair(this[0], this[1], this[2])\n\t\t\t\t\t})\n\t\t\t\t\t\n\t\t        }\n\t            selectionReset()\n\t \n\t\t        addPair(pattern)\n\t\t\n\t            \n\t\t\t\t// \u914d\u5bf9\u6807\u7b7e\n\t            if(code.indexOf('>') != -1){\n\t            \tvar start = (end - retrospect) < 0 ? 0 : (end - retrospect)\n\t                var left = wpText.val().substring(start, end)\n\t                var ptn = /[\\s\\S]*<((?!br|hr|img|references|templatestyles|\\!--|\\/|\\>)[^\\s<>]+)[^>]*?>$/\n\t                if(ptn.test(left)){\n\t\t\t\t\t\tvar tagEnd = '</' + left.replace(ptn, '$1') + '>'\n\t\t\t\t\t\tvar position = wpText[0].selectionEnd\n\t                    insertText(wpText[0], tagEnd)\n\t\t                wpText[0].selectionStart = wpText[0].selectionEnd = position\n\t                    selectionReset()\n\t                    code = ''                        \n\t                }\t                \t\n\t            }\t\n\t\t\t})(this)\n            \n\t\t\tcodeSave.push({\n\t\t\t\tcode : wpText.val(),\n\t\t\t\tstart : wpText[0].selectionStart,\n\t\t\t\tend : wpText[0].selectionEnd\n\t\t\t})\n\t\t\tinputMark = true            \n\t\t\t\n\t\t\tinput = false\n\t\t})\n\t\t\n\t\twpText.on('keydown', function(e){\n\t\t\tif(e.ctrlKey && e.keyCode == 90){\n\t\t\t\te.preventDefault()\n\t\t\t\tif(inputMark){\n\t\t\t\t\tcodeSave.pop()\n\t\t\t\t\tinputMark = false\n\t\t\t\t}\n\t\t\t\tvar history = codeSave.pop() || original\n\t\t\t\tif(history){\n\t\t\t\t\twpText.val(history.code).focus()\n\t\t\t\t\twpText[0].selectionStart = history.start\n\t\t\t\t\twpText[0].selectionEnd = history.end\n\t\t\t\t}\n\t\t\t}\n\t\t})\n    }\n})"}}}