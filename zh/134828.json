{"parse":{"title":"Widget:BilibiliVideo","pageid":242089,"wikitext":{"*":"<noinclude><poem>\n\u540d\u79f0\uff1aBilibili\u89c6\u9891\u63d2\u4ef6\n\u4f5c\u8005\uff1a\u52a0\u5927\u53f7\u7684\u732b\n\u4fee\u8ba2\uff1a[[User:Boxsnake|Boxsnake]]\n\u91cd\u4fee\u8ba2\uff1a[[User:AnnAngela|AnnAngela]]\nH5\u7248\u518d\u4fee\u8ba2\uff1a[[User:AnnAngela|AnnAngela]]\n\u7248\u6743\u534f\u5b9a\uff1aMIT\n\u79fb\u52a8\u7248\u652f\u6301\uff1a[[User:Nbdd0121|XYZ\u6307\u793a\u7269]]\n\u53d1\u5e03\u65e5\u671f\uff1a2012\u5e746\u670829\u65e5\u7b2c\u4e00\u7248\u53d1\u5e03\uff0c2015\u5e742\u67086\u65e5\u66f4\u65b0\uff0c2016\u5e7411\u670829\u65e5\u66f4\u65b0\u66f4\u591a\u7ec6\u8282\uff0c2017\u5e744\u670810\u65e5\u66f4\u65b0\u81f3H5\u7248\uff08\u611f\u8c22\u4f17\u591adalao\u7684debug_(:\u0437\u309d\u2220)_\uff09\u3002\n\u53d1\u5e03\u5730\u5740\uff1azh.moegirl.org/Widget:BilibiliVideo && zh.moegirl.org/Template:BilibiliVideo\n\u6ce8\u610f\u4e8b\u9879\uff1a\u5982\u6709\u95ee\u9898\uff0c\u8bf7\u8054\u7cfb\u4f5c\u8005\u3002\n'''\u672cWidget\u4e0d\u80fd\u5355\u72ec\u4f7f\u7528'''\uff0c\u8bf7\u4f7f\u7528{{tl|BilibiliVideo}}\uff01\n</poem></noinclude><includeonly>\n<!--{if !isset($wgBilibili) || !$wgBilibili}-->\n<!--{assign var=\"wgBilibili\" value=true scope=\"global\"}-->\n<style>\n.bilibili-video-container {\n    border: 1px solid rgba(170,170,170,0.37);\n    max-width: 100%;\n}\n.bilibili-video-container.exec {\n    display: table;\n}\n.bilibili-iframe-container,\n.bilibili-video-container {\n    display: none;\n}\n.bilibili-video-container,\n.bilibili-video-container div,\n.bilibili-video-container .bilibili-widescreen,\n.bilibili-video-container iframe {\n    max-width: 100%;\n    background-color: #fff!important;\n}\n.bilibili-title {\n    padding: .2em 6.5em .2em 1em;\n    position: relative;\n}\n.bilibili-title a {\n    word-break: break-word;\n}\n.bilibili-widescreen {\n    position: absolute;\n    display: none;\n    width: 1em;\n    right: -2rem;\n    border: 1px solid rgba(170,170,170,0.37);\n    padding: .25rem .5rem;\n    line-height: 1.5em;\n    top: -1px;\n    user-select: none;\n    cursor: pointer;\n}\n.onshow .bilibili-widescreen{\n    display: block;\n}\n.bilibili-toggle {\n    position: absolute;\n    top: calc(50% - .5em);\n    right: .7em;\n    line-height: 1em;\n    cursor: pointer;\n    padding-left: 1em;\n    background-image: url(/skins/Vector/images/search-ltr.png?39f97);\n    background-image: linear-gradient(transparent,transparent), url(data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2212%22%20height%3D%2213%22%3E%3Cg%20stroke-width%3D%222%22%20stroke%3D%22%236c6c6c%22%20fill%3D%22none%22%3E%3Cpath%20d%3D%22M11.29%2011.71l-4-4%22%2F%3E%3Ccircle%20cx%3D%225%22%20cy%3D%225%22%20r%3D%224%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E);\n    background-image: linear-gradient(transparent,transparent), url(/skins/Vector/images/search-ltr.svg?07752)!ie;\n    background-image: -o-linear-gradient(transparent,transparent), url(/skins/Vector/images/search-ltr.png?39f97);\n    background-position: left center;\n    background-repeat: no-repeat;\n}\n.bilibili-toggle:hover {\n    color: #36b;\n}\n.bilibili-video-button,\n.bilibili-video-button:visited {\n    display: inline-block;\n    margin: 4px 5px;\n    padding: 10px 25px;\n    font-size: 14px;\n    text-align: center;\n    color: #fff;\n    background: #de698c;\n    border-radius: 4px;\n}\n.bilibili-iframe-container {\n    padding: 6px 6px 0!important;\n    position: relative;\n    border: 0 solid rgba(170,170,170,0.37);\n    border-top-width: 1px;\n    max-width: calc(100% - 12px)!important;\n}\n.onshow .bilibili-iframe-container {\n    max-height: calc(100% - 27px)!important;\n}\n.bilibili-video-container textarea {\n    background: white;\n    color: black;\n    width: 80%;\n    margin: auto;\n}\n.bilibili-iframe-overlay {\n    width: 0;\n    height: 0;\n    padding-top: 30%;\n    text-align: center;\n    box-sizing: border-box;\n    background: rgb(167, 215, 249);\n    position: absolute;\n    top: 3px;\n    left: 6px;\n    z-index: 2;\n}\n.bilibili-iframe-retry-link {\n    position: absolute;\n    top: 10px;\n    right: 10px;\n    display: none;\n    background: white;\n    padding: 0px 0.5em;\n}\n</style><script>\nwindow.RLQ.push(function() {\n    $(function() {\n        'use strict';\n        var isNaN = Number.isNaN || window.isNaN;\n        if (mw.config.get('skin') === 'minerva') $('.bilibili-video-container').each(function() {\n            var element = $(this),\n                dataset = this.dataset;\n            var id = dataset.aid.replace('av', ''),\n                title = dataset.title,\n                pagename = dataset.pagename,\n                page = parseInt(dataset.page),\n                t = parseInt(dataset.t),\n                tIsInvalid = isNaN(t) || t <= 0,\n                subtitle = dataset.subtitle === 'true' ? true : false;\n            $.ajax({\n                url: 'https://mgwbcprd.azureedge.net/BilibiliMeta/Index/' + encodeURIComponent('av' + id),\n                type: 'GET',\n                success: function(data) {\n                    var list = data.VideoEntities\n                        .map(function(e, i) {\n                            e.page = i + 1;\n                            e.title = e.Title.replace(/^\\d+\u3001/, '');\n                            return e;\n                        }),\n                        _page = 1,\n                        name = title || (data.Title ? data.Title : 'av' + id),\n                        index,\n                        length;\n                    if (pagename) {\n                        for (index = 0, length = list.length; index < length; index++) {\n                            if (list[index].Title !== pagename && list[index].title !== pagename) continue;\n                            _page = list[index].page;\n                            break;\n                        }\n                    } else _page = page;\n                    index = _page - 1;\n                    var sec = t % 60 + '';\n                    if (sec.length === 1) sec = '0' + sec;\n                    var time = Math.floor(t / 60) + ':' + sec;\n                    var button = $('<a/>').addClass('bilibili-video-button').attr('href', \"https://www.bilibili.com/video/av\" + id + \"/?p=\" + _page + (tIsInvalid ? '' : '&t=' + t)).text(name + ' [' + _page + '/' + list.length + ']' + (tIsInvalid ? '' : '[\u8df3\u8f6c\u81f3' + time + ']'));\n                    if (list[index] !== undefined && list[index].VideoCid !== undefined && subtitle) {\n                        button.append('<br>\uff08' + _page + '\u3001' + list[index].Title + '\uff09');\n                    }\n                    element.before(button).remove();\n                },\n                error: function(e) {\n                    element.before($('<a/>').addClass('bilibili-video-button').attr('href', link).text((title || 'av' + id) + ([0, 1].indexOf(page) !== -1 && !isNaN(page) ? ' (P' + page + ')' : ''))).remove();\n                },\n            });\n        });\n        else {\n            var global_element = $('#mw-content-text');\n            window.widget = window.widget || {};\n            window.widget.bilibili = {\n                iframes: new(window.Map || mw.Map)(),\n            };\n            var EPSILON = 2.220446049250313e-16,\n                rememberWH = function rememberWH(ele) {\n                    ele.data({ width: ele.width(), height: ele.height() });\n                },\n                setTureHeight = function setTureHeight(ele) {\n                    var barHeight = ele.data('height') - ele.data('width') * 9 / 16; //\u8ba1\u7b97\u6807\u9898\u548c\u64ad\u653e\u5668\u63a7\u5236\u680f\u9ad8\u5ea6\n                    ele.height(ele.width() * 9 / 16 + barHeight);\n                },\n                setWH = function setWH(ele) {\n                    ele.css({ width: '100%', height: '100%' });\n                },\n                recallWH = function recallWH(ele) {\n                    ele.width(ele.data('width')).height(ele.data('height'));\n                },\n                setMaxHeight = function setMaxHeight(container, target) {\n                    var h = container.outerHeight(true);\n                    var t = 0;\n                    container.children().each(function() {\n                        t += $(this).outerHeight(true);\n                    });\n                    target.css('max-height', 'calc(100% - ' + parseInt(t - h + 2 - (Number.EPSILON || EPSILON)) + 'px)');\n                };\n            $('.bilibili-video-container').addClass('exec').each(function() {\n                var dataset = this.dataset,\n                    id = parseInt(+dataset.aid.replace('av', '')),\n                    selfbox = $(this);\n                if (isNaN(id) || id <= 0) return;\n                var page = parseInt(+(dataset.page || 1)),\n                    pagename = dataset.pagename,\n                    title = dataset.title,\n                    height = +dataset.height || 441,\n                    width = +dataset.width || 665,\n                    subtitle = dataset.subtitle === 'true' ? true : false,\n                    t = parseInt(dataset.t),\n                    tIsInvalid = isNaN(t) || t <= 0,\n                    iframeContainer = $(this).find('.bilibili-iframe-container'),\n                    title_text = $('<a/>').addClass('external text').attr({\n                        href: \"http://www.bilibili.com/video/av\" + id + \"/?p=\" + page + (tIsInvalid ? '' : '&t=' + t),\n                        target: '_blank',\n                    }).prependTo($(this).find('.bilibili-title')),\n                    iframe = $('<iframe/>').attr({\n                        frameborder: 0,\n                        scrolling: 'no',\n                        src: '',\n                        allowfullscreen: true,\n                    }).css({\n                        width: width,\n                        height: height,\n                    });\n                if (isNaN(page) || page < 1) page = 1;\n                if (isNaN(width)) width = 665;\n                if (isNaN(height)) height = 441;\n                var sec = t % 60 + '';\n                if (sec.length === 1) sec = '0' + sec;\n                var time = Math.floor(t / 60) + ':' + sec;\n                title_text.text((title || 'av' + id) + ([0, 1].indexOf(page) === -1 ? ' (' + page + ')' : '') + (tIsInvalid ? '' : '[\u89c6\u9891\u4ece' + time + '\u5f00\u59cb\u64ad\u653e]'));\n                iframeContainer.css({\n                    width: width,\n                    height: height,\n                }).find('div').css({\n                    width: width,\n                    height: height,\n                }).text('\u6b63\u5728\u52a0\u8f7d\uff0c\u8bf7\u7a0d\u5019\u2026\u2026');\n                $.extend(iframe, {\n                    execAppend: function execAppend() {\n                        var iframe = this,\n                            retryLink = $('<a/>').text('\u91cd\u65b0\u52a0\u8f7d').addClass('bilibili-iframe-retry-link').on('click', function() {\n                                var container = $(this).closest('.bilibili-iframe-container'),\n                                    iframe = container.find('iframe'),\n                                    clone = iframe.clone();\n                                window.widget.bilibili.iframes.delete(iframe[0]);\n                                iframe.remove();\n                                container.append(clone.on('load', function() {\n                                    $(this).data('load', 'complete');\n                                }));\n                                window.widget.bilibili.iframes.set(clone[0], $(this));\n                            });\n                        iframe.appendTo(iframeContainer.empty()).data('ready', 'appended').on('load', function() {\n                            $(this).data('load', 'complete');\n                        });\n                        window.setTimeout(function() {\n                            window.widget.bilibili.iframes.set(iframe[0], retryLink);\n                        }, 10000);\n                    },\n                });\n                iframe.data('ready', false);\n                window.setTimeout(function() { //\u5f02\u6b65\u51fa\u53bb\u4e0d\u8981\u5361\u4e3b\u7ebf\u7a0b\n                    $.ajax({\n                        url: 'https://mgwbcprd.azureedge.net/BilibiliMeta/Index/' + encodeURIComponent('av' + id),\n                        type: 'GET',\n                        success: function(data) {\n                            var list = data.VideoEntities\n                                .map(function(e, i) {\n                                    e.page = i + 1;\n                                    e.title = e.Title.replace(/^\\d+\u3001/, '');\n                                    return e;\n                                }),\n                                _page = 1,\n                                name = title || (data.Title ? data.Title : 'av' + id),\n                                index,\n                                length;\n                            if (pagename) {\n                                for (index = 0, length = list.length; index < length; index++) {\n                                    if (list[index].Title !== pagename && list[index].title !== pagename) continue;\n                                    _page = list[index].page;\n                                    break;\n                                }\n                            } else _page = page;\n                            index = _page - 1;\n                            var href = title_text.attr('href');\n                            if (list[index] !== undefined && list[index].VideoCid !== undefined) {\n                                iframe.attr('src', 'https://www.bilibili.com/blackboard/html5player.html?aid=' + id + '&cid=' + list[index].VideoCid + '&enable_ssl=1&crossDomain=1&as_wide=1' + (tIsInvalid ? '' : '&t=' + t));\n                                if (iframeContainer.is(':visible')) iframe.execAppend();\n                                else iframe.data('ready', true);\n                                title_text.attr('href', href.replace(new RegExp(\"/\\\\?p=\" + page, 'g'), \"/?p=\" + _page));\n                                title_text.text(name + ' [' + _page + '/' + list.length + ']' + (tIsInvalid ? '' : '[\u89c6\u9891\u4ece' + time + '\u5f00\u59cb\u64ad\u653e]'));\n                                if (subtitle) title_text.append('<br>\uff08' + _page + '\u3001' + list[index].Title + '\uff09');\n                            } else {\n                                title_text.text(name + (tIsInvalid ? '' : '[\u89c6\u9891\u4ece' + time + '\u5f00\u59cb\u64ad\u653e]'));\n                                iframe.attr('src', 'https://www.bilibili.com/blackboard/player.html?aid=' + id + '&page=' + _page + '&enable_ssl=1&as_wide=1' + (tIsInvalid ? '' : '&t=' + t));\n                                if (iframeContainer.is(':visible')) iframe.execAppend();\n                                else iframe.data('ready', true);\n                            }\n                        },\n                        error: function(e) {\n                            title_text.text((title || 'av' + id) + ([0, 1].indexOf(page) === -1 ? ' (' + page + ')' : '') + (tIsInvalid ? '' : '[\u89c6\u9891\u4ece' + time + '\u5f00\u59cb\u64ad\u653e]'));\n                            if (e && e.responseJSON && e.responseJSON.message && e.responseJSON.message === \"Authentication is required for accessing this video.\") title_text.parent().append('<sup title=\"\u201cBilibili\u91c7\u7528\u4f1a\u5458\u5236\uff0c\u5927\u90e8\u5206\u6295\u7a3f\u89c6\u9891\u4f1a\u5458\u4e0e\u6e38\u5ba2\u90fd\u53ef\u4ee5\u89c2\u770b\uff0c\\n   \u4f46\u90e8\u5206\u89c6\u9891\u5728UP\u4e3b\u8bbe\u5b9a\u4e0b\u53ea\u6709\u4f1a\u5458\u624d\u53ef\u4ee5\u89c2\u770b\uff08\u8fd9\u4e9b\u89c6\u9891\u5e38\u88ab\u79f0\u4e3a\u2018\u53ea\u6709\u4f1a\u5458\u624d\u77e5\u9053\u7684\u4e16\u754c\u2019\uff09\u3002\u201d\\n   - Bilibili#\u7528\u6237\u5236\u5ea6 @ ZhMoegirl\\n\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u65e0\u6cd5\u4e3a\u60a8\u89e3\u6790\u89c6\u9891\u53ca\u5176\u5206P\u6807\u9898\u3001\u5206P\u6570\u91cf\u7b49\uff0c\u4e5f\u4e0d\u80fd\u5f3a\u5236\u4f7f\u7528H5\u64ad\u653e\u5668\u3002\\n\u4f46\u5982\u679c\u60a8\u5df2\u7ecf\u767b\u5f55B\u7ad9\u5e76\u4e14\u8bbe\u7f6e\u9ed8\u8ba4\u64ad\u653e\u5668\u4e3aH5\u64ad\u653e\u5668\u65f6\u6b64\u5904\u4ecd\u4f1a\u662fH5\u64ad\u653e\u5668\u3002\">\uff08\u53ea\u6709\u4f1a\u5458\u624d\u77e5\u9053\u7684\u4e16\u754c\uff09</sup>');\n                            iframe.attr('src', 'https://www.bilibili.com/blackboard/player.html?aid=' + id + '&page=' + page + '&enable_ssl=1&as_wide=1' + (tIsInvalid ? '' : '&t=' + t));\n                            if (iframeContainer.is(':visible')) iframe.execAppend();\n                            else iframe.data('ready', true);\n                        },\n                    });\n                }, 137);\n                //toggle\n                selfbox.find('.bilibili-toggle').on('click', function() {\n                    selfbox.width(iframeContainer.outerWidth(true));\n                    selfbox.toggleClass('onshow');\n                    iframeContainer.toggle();\n                    if ($(this).text() === '\u663e\u793a\u89c6\u9891') {\n                        $(this).text('\u9690\u85cf\u89c6\u9891');\n                        if (iframe.data('ready') === true) iframe.execAppend();\n                        $(window).resize();\n                    } else {\n                        $(this).text('\u663e\u793a\u89c6\u9891');\n                        selfbox.removeAttr('style');\n                    }\n                });\n                selfbox.find('.bilibili-widescreen').on('click', function() {\n                    if (selfbox.is(':not(.onshow)')) return;\n                    if (selfbox.is('.widescreen')) {\n                        selfbox.removeClass('widescreen');\n                        $(this).text('\u663e\u793a\u5bbd\u5c4f');\n                        recallWH(iframeContainer);\n                        recallWH(iframe);\n                        recallWH(selfbox);\n                    } else {\n                        selfbox.addClass('widescreen');\n                        $(this).text('\u9000\u51fa\u5bbd\u5c4f');\n                        rememberWH(selfbox);\n                        selfbox.css('width', selfbox.parent().width() > Math.min(911, global_element.width()) ? '73%' : '100%'); //\u53ef\u4ee5\u770b\u89c1\u6309\u94ae\u7684\u6700\u5c0f\u5bbd\u5ea6 665 \u7684 1/0.73 \u500d\n                        setTureHeight(selfbox);\n                        rememberWH(iframe);\n                        rememberWH(iframeContainer);\n                        setWH(iframe);\n                        setWH(iframeContainer);\n                        iframeContainer.height(selfbox.height() - title_text.parent().height());\n                        setMaxHeight(selfbox, iframeContainer);\n                    }\n                });\n            });\n            window.setInterval(function() {\n                if (!window.widget.bilibili.iframes || window.widget.bilibili.iframes.size === 0) return;\n                window.widget.bilibili.iframes.forEach(function(retryLink, iframe) {\n                    if (!retryLink || !retryLink.closest || !iframe || !$(iframe).data) return window.widget.bilibili.iframes.delete(iframe);\n                    if (!retryLink.closest('.bilibili-iframe-container')[0]) retryLink.appendTo(iframe.closest('.bilibili-iframe-container'));\n                    if ($(iframe).data('load') !== 'complete') retryLink.fadeIn();\n                    else retryLink.fadeOut();\n                });\n            }, 1000);\n            $(window).on('resize', function() {\n                $('.bilibili-video-container.onshow.widescreen').each(function() {\n                    var selfbox = $(this);\n                    selfbox.css('width', selfbox.parent().width() > Math.min(911, global_element.width()) ? '73%' : '100%');\n                    setTureHeight(selfbox);\n                    setMaxHeight(selfbox, selfbox.find('.bilibili-iframe-container'));\n                });\n            });\n        }\n    });\n});\n</script><!--{/if}-->\n</includeonly>"}}}