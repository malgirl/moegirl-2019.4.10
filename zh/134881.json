{"parse":{"title":"Widget:TalkToc","pageid":208883,"wikitext":{"*":"<noinclude>Only for [[Talk:\u8ba8\u8bba\u7248]] & [[Talk:\u63d0\u95ee\u6c42\u52a9\u533a]]</noinclude><includeonly><!--{if !isset($wgTalkToc) || !$wgTalkToc}--><!--{assign var=\"wgTalkToc\" value=true scope=\"global\"}--><script>\nwindow.RLQ = window.RLQ || [];\nwindow.RLQ.push(function() {\n    if (location.hostname.includes(\"m.moegirl.org\")) return;\n    mw.hook('wikipage.content').add(function() {\n        if (!mw.config.get('talkTocLoaded')) {\n            mw.config.set('talkTocLoaded', window.setTimeout(function() {\n                if (!$('#talkTocBox')[0]) {\n                    console.debug('widgetTalkToc', 'initing');\n                    if (localStorage.getItem('widgetTalkToc') === 'disable') {\n                        $('body').addClass('widgetTalkTocDisable');\n                        $('.toctitle').after('<' + 'div style=\"text-align: center;\">[<' + 'a class=\"enableWidgetTalkToc\">\u542f\u7528\u8ba8\u8bba\u9875\u9762\u6574\u7406\u5de5\u5177<' + '/a>]<' + '/div>');\n                        $('.enableWidgetTalkToc').on('click', function() {\n                            localStorage.setItem('widgetTalkToc', 'enable');\n                            $(this).text('\u542f\u7528\u6210\u529f\uff01\u5237\u65b0\u9875\u9762\u4e2d\u2026\u2026');\n                            setTimeout(location.reload.bind(location), 150);\n                        });\n                        return;\n                    }\n\n                    $('body').addClass('widgetTalkTocEnable');\n                    var toclist = ['tocBox', 'talkTocBox', 'toc'],\n                        bgcolor = $('body').css('background-color'),\n                        $toc = $('#toc'),\n                        titlereg = {},\n                        $tocBox, $level2, $li, $svdDcs, $title, $toggle, $tocText,\n                        appendToggleButton;\n\n                    /* \u9884\u5904\u7406 */\n                    //\u5907\u4efd\u76ee\u5f55\n                    $toc.after($toc.clone().hide().attr('id', 'tocClone'));\n                    //\u6574\u7406\u8ba8\u8bba\u4e32\n                    $('#mw-content-text > .mw-parser-output > h2').each(function() {\n                        var head = $(this);\n                        var container = $('<' + 'div/>');\n                        container.addClass('discussionContainer');\n                        head.addClass('discussionHead');\n                        head.before(container);\n                        head.nextUntil('h2').not('h2').appendTo(container);\n                        head.prependTo(container);\n                        if (container.find('.saveNotice')[0] && head.nextUntil(\".saveNotice\").length === 0) {\n                            $toc.find('a[href=\"#' + head.find('.mw-headline')[0].id + '\"]').parent().addClass(\"savedDiscussion hiddenDiscussion\");\n                            container.addClass('savedDiscussion');\n                        } else if (window.CSS && CSS.supports && CSS.supports('position', 'sticky')) {\n                            head.css({\n                                position: 'sticky',\n                                top: 0,\n                                'background-color': bgcolor,\n                                'z-index': 2\n                            });\n                            container.css('position', 'relative');\n                        }\n                    });\n\n                    // Temporary padding fix for Microsoft Edge\n                    // TODO: Report this issue to Edge team\n                    if (/Edge/.test(navigator.userAgent)) {\n                        $('.discussionContainer').css('padding-top', '10px');\n                    }\n\n                    //\u6574\u7406\u6807\u9898\u5217\u8868\n                    $toc.append(\"<\" + \"ol style='margin-left: 1.7em;'><\" + \"/ol>\").after('<' + 'div id=\"tocBox\"><' + '/div>');\n                    $toc.children('ul').children().appendTo($toc.find('ol'));\n                    $toc.find(\".toclevel-1 > a > .tocnumber\").remove();\n                    $toc.appendTo(\"#tocBox\");\n\n                    /* \u5b9a\u4e49\u53d8\u91cf */\n                    $tocBox = $('#tocBox');\n                    $level2 = $toc.find('.toclevel-2').hide();\n                    $li = $toc.find('ol > li');\n                    $svdDcs = $toc.find('.savedDiscussion');\n                    $title = $toc.find('.toctitle').css(\"margin-right\", \"1em\").append('<' + 'span id=\"toctoggle\"><' + '/span>');\n                    $toggle = $title.append('<' + 'div id=\"toggle\"><' + '/div>').find('#toggle');\n                    $tocText = $title.after('<' + 'div id=\"tocText\"><' + '/div>').parents('#toc').find('#tocText');\n                    appendToggleButton = function($Obj, $set, shTx, hiTx, fun) {\n                        if (!$Obj[0]) return false;\n                        $set.append($('<' + 'a/>', {\n                            text: function() {\n                                if ($Obj.is(':visible')) return hiTx;\n                                else return shTx;\n                            },\n                            'class': 'toggleButton',\n                            href: 'javascript:void(0);',\n                            bind: {\n                                click: function() {\n                                    if ($Obj.is(':visible')) {\n                                        $Obj.fadeOut();\n                                        $(this).text(shTx);\n                                    } else {\n                                        $Obj.fadeIn();\n                                        $(this).text(hiTx);\n                                    }\n                                }\n                            }\n                        }));\n                        if (typeof fun == 'function') fun();\n                    };\n\n                    /* \u4e1a\u52a1\u5904\u7406*/\n                    //\u6dfb\u52a0\u5b58\u6863\u8ba8\u8bba\u4e32\u6807\u9898toggle\u6309\u94ae\n                    if ($svdDcs[0]) {\n                        $toggle.append($('<' + 'a/>', {\n                            text: '\u663e\u793a\u5df2\u88ab\u5b58\u6863\u6807\u9898',\n                            'class': 'toggleButton',\n                            href: 'javascript:void(0);',\n                            on: {\n                                click: function() {\n                                    if ($svdDcs.hasClass('hiddenDiscussion')) {\n                                        $svdDcs.removeClass('hiddenDiscussion');\n                                        $(this).text('\u9690\u85cf\u5df2\u88ab\u5b58\u6863\u6807\u9898');\n                                    } else {\n                                        $svdDcs.addClass('hiddenDiscussion');\n                                        $(this).text('\u663e\u793a\u5df2\u88ab\u5b58\u6863\u6807\u9898');\n                                    }\n                                }\n                            }\n                        }));\n                        $tocText.append(\"<\" + \"div class='tocText'>\uff08\u6709\u4e0b\u5212\u7ebf\u6807\u9898\u662f\u5df2\u88ab\u5b58\u6863\u6807\u9898\uff09<\" + \"/div>\");\n                    }\n                    //\u6dfb\u52a0\u4e8c\u4e09\u56db\u4e94\u7ea7\u6807\u9898toggle\u6309\u94ae\u548c\u6807\u9898\u6570\u91cf\n                    appendToggleButton($level2, $toggle, '\u663e\u793a\u6bb5\u843d', '\u9690\u85cf\u6bb5\u843d', function() {\n                        $tocText.append(\"<\" + \"div class='tocText'>\uff08\u4e2d\u62ec\u53f7\u5185\u6570\u5b57\u662f\u8be5\u5927\u6bb5\u4e0b\u5c0f\u6bb5\u6570\u91cf\uff09<\" + \"/div>\");\n                        $toc.find('.toclevel-1').each(function() {\n                            var subtitleLength = $(this).find('.toctext').length - 1;\n                            if (subtitleLength) $(this).children('a').after('[' + subtitleLength + ']');\n                        });\n                    });\n                    //\u6dfb\u52a0\u6574\u4f53toggle\u6309\u94ae\n                    appendToggleButton($toc.find('ol'), $title.find('#toctoggle'), '\u663e\u793a', '\u9690\u85cf');\n                    $('#toc').addClass('noOrigin');\n                    /*\n                    $('.saveNotice').each(function() {\n                        $(this).prev('h2').addClass('savedNotice');\n                    });*/\n                    var containers = $('.discussionContainer');\n                    containers.first().before('<' + 'div id=\"talkTocBox\"><' + 'table><' + '/table><' + '/div>');\n                    var self = $('#talkTocBox table'),\n                        a = $('<' + 'a/>').text('\u663e\u793a\u5df2\u5b58\u6863\u8ba8\u8bba\u4e32\u6807\u9898');\n                    self.append('<' + 'caption/>').find('caption').append(mw.config.get('wgTitle') + '\u73b0\u6709\u8ba8\u8bba\u4e32').append(' [').append(a).append(']<' + 'br>').append('\uff08\u6709\u4e0b\u5212\u7ebf\u6807\u9898\u662f\u5df2\u88ab\u5b58\u6863\u8ba8\u8bba\u4e32\u6807\u9898\uff09')\n                        .end().append('<' + 'tbody/>');\n                    containers.not('.savedDiscussion').each(function(i) {\n                        if (i % 4 === 0) self.find('tbody:last').append('<' + 'tr/>');\n                        var that = $(this);\n                        /* var content = that.children().not('h2');\n                        content.find('a').each(function() {\n                            try {\n                                var href = $(this)[0].href;\n                                if (!href) return;\n                                var link = new mw.Uri(href);\n                                if (link.host !== 'zh.moegirl.org') this.userNameErrorReason = \"link.host !== 'zh.moegirl.org'\";\n                                else if (/^\\/api\\.php/i.test(link.path)) this.userNameErrorReason = \"!!/^\\\\/api\\\\.php/i.test(link.path)\";\n                                else if (!link.query.title && /\\.php$/i.test(link.path)) this.userNameErrorReason = \"!!(!link.query.title && /\\\\.php$/i.test(link.path))\";\n                                else {\n                                    var t = link.query.title || decodeURIComponent(link.path.substring(1));\n                                    if (/^user([ _]talk)?:[^\\/]+$/i.test(t)) $(this).data('userName', t.replace(/^user([ _]talk)?:/i, '')).addClass('userTalkPage');\n                                    else this.userNameErrorReason = \"!!/^user([ _]talk)?:[^\\\\/]+$/i.test(t)\";\n                                }\n                            } catch (e) {\n                                return;\n                            }\n                        });\n                        content.find('.userTalkPage').each(function() {\n                            var parent = $(this).closest(containers).clone();\n                            var now = Date.now() + (Math.random() + '').substring(2);\n                            parent.find('.userTalkPage').text(now);\n                            var regExec = RegExp(now + '(.*)(\\\\d{4}\u5e74([1-9]|1[0-2])\u6708([1-9]|[12]\\\\d|3[01])\u65e5\\\\s{0,10}\\\\([\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u65e5]\\\\)\\\\s{0,10}([01]\\\\d|2[0-3]):[0-5]\\\\d\\\\s{0,10}(\\\\([A-Z]{3}\\\\))?)').exec(parent.text());\n                            if (!regExec || regExec[1].length > 20) {\n                                this.userNameErrorReason = 'Too far away from timestamp (' + (regExec ? regExec[1].length : 'null') + ')';\n                                this.userNameErrorRegExec = regExec;\n                                $(this).removeClass('userTalkPage');\n                            } else $(this).data('userTalkTime', regExec[2]);\n                        });\n                        var userTalkPage = [];\n                        content.find('.userTalkPage').each(function() {\n                            var timestamp = $(this).data('userTalkTime').replace(/ \\([A-Z]{3,4}\\)$|\\([\u65e5\u4e00\u4e8c\u4e09\u56db\u4e94\u516d]\\)/g, ''),\n                                date = new Date(),\n                                time = timestamp.split(/[\u5e74\u6708\u65e5\\s\\(\\)\\:]+/).map(function(n) {\n                                    return +n;\n                                });\n                            if (!time || !time[4]) return $(this).removeClass('.userTalkPage')[0].userNameErrorReason = 'Error Timestamp(' + timestamp + ')';\n                            date.setFullYear(time[0]);\n                            date.setMonth(time[1] - 1);\n                            date.setDate(time[2]);\n                            date.setHours(time[3]);\n                            date.setMinutes(time[4]);\n                            userTalkPage.push([$(this).data('userName'), timestamp, date.getTime()]);\n                        });\n                        if (!userTalkPage[0]) userTalkPage.push(['Unsigned user/Nonstandard sign', 'Unknown Time']);\n                        else userTalkPage.sort(function(a, b) {\n                            return a[2] - b[2]\n                        });\n                        var firstName = userTalkPage[0],\n                            lastName = userTalkPage[userTalkPage.length - 1];\n                        titlereg[that.find('.mw-headline:first').attr('id')] = that;*/\n                        self.find('tr:last').append('<' + 'td><' + '/td>')\n                            .find('td:last').append(\n                                $('<' + 'a/>').attr('href', '#' + that.find('.mw-headline:first').attr('id')).append(that.find('.mw-headline:first').clone().find('a').replaceWith(function() {\n                                    return $(this).text();\n                                }).end().html())\n                            );\n                        /* .append(\n                            $('<' + 'div/>').addClass('signInfo').append('\u8bdd\u9898\u53d1\u8d77\uff1a' + (firstName[0] === 'Unsigned user/Nonstandard sign' ? 'Unsigned user/Nonstandard sign' : '<' + 'a href=\"/User_talk:' + firstName[0] + '\" title=\"' + firstName[0] + '\u7684\u8ba8\u8bba\u9875\" target=\"_blank\">' + firstName[0].replace(/_/g, ' ') + '<' + '/a>'))\n                            .append('<' + 'br>\u6700\u540e\u56de\u590d\uff1a' + (lastName[0] === 'Unsigned user/Nonstandard sign' ? 'Unsigned user/Nonstandard sign' : '<' + 'a href=\"/User_talk:' + lastName[0] + '\" title=\"' + lastName[0] + '\u7684\u8ba8\u8bba\u9875\" target=\"_blank\">' + lastName[0].replace(/_/g, ' ') + '<' + '/a>') + '\uff08' + lastName[1] + '\uff09')\n                        ); */\n                    });\n                    /* if ($('.signInfo').filter(function() {\n                            return $(this).text().indexOf('Unsigned user/Nonstandard sign') !== -1;\n                        }).length * 2 > $('.signInfo').length) $('.signInfo').hide(); */\n                    self.append('<' + 'tbody class=\"hr\"><' + 'tr><' + 'td colspan=\"4\"> <' + '/td><' + '/tr><' + '/tbody>').append('<' + 'tbody/>').find('tbody').not(':first').hide();\n                    containers.filter('.savedDiscussion').each(function(i) {\n                        if (i % 4 === 0) self.find('tbody:last').append('<' + 'tr/>');\n                        self.find('tr:last').append('<' + 'td><' + 'a class=\"savedTitle\" href=\"#' + $(this).find('.mw-headline:first').attr('id') + '\">' + $(this).clone().find('.mw-headline:first').children('.mw-headline-number').remove().end().prepend(containers.index(this) + 1 + ' ').text() + '<' + '/a><' + '/td>');\n                    });\n                    a.on('click', function() {\n                        self.find('tbody').not(':first').fadeToggle();\n                        $(this).text($(this).text() === '\u663e\u793a\u5df2\u5b58\u6863\u8ba8\u8bba\u4e32\u6807\u9898' ? '\u9690\u85cf\u5df2\u5b58\u6863\u8ba8\u8bba\u4e32\u6807\u9898' : '\u663e\u793a\u5df2\u5b58\u6863\u8ba8\u8bba\u4e32\u6807\u9898');\n                    });\n                    self.find('tbody').not('.hr').each(function() {\n                        var that = $(this).find('tr:last');\n                        that.append((\"<\" + \"td>&#32;<\" + \"/td>\").repeat(4 - that.find(\"td\").length));\n                    });\n                    $('#talkTocBox caption').append('<' + 'br>[').append($('<' + 'a/>').addClass('cbutton')).append(']');\n                    $('#tocText').append('<' + 'br>[').append($('<' + 'a/>').addClass('cbutton')).append(']');\n                    $('.cbutton').on('click', function() {\n                        if (!localStorage.wgTocStyle || localStorage.wgTocStyle !== 'list') {\n                            $('#talkTocBox').fadeOut();\n                            $('#tocBox').fadeIn();\n                            localStorage.setItem('wgTocStyle', 'list');\n                            $('.cbutton').text('\u70b9\u51fb\u5207\u6362\u81f3\u8868\u683c\u683c\u5f0f');\n                            $(toclist.filter(function(l) {\n                                return l !== \"tocBox\";\n                            }).map(function(l) {\n                                return 'a[href=\"#' + l + '\"]';\n                            }).join(', ')).attr(\"href\", \"#tocBox\");\n                        } else {\n                            $('#talkTocBox').fadeIn();\n                            $('#tocBox').fadeOut();\n                            localStorage.setItem('wgTocStyle', 'table');\n                            $('.cbutton').text('\u70b9\u51fb\u5207\u6362\u81f3\u5217\u8868\u683c\u5f0f');\n                            $(toclist.filter(function(l) {\n                                return l !== \"talkTocBox\";\n                            }).map(function(l) {\n                                return 'a[href=\"#' + l + '\"]';\n                            }).join(', ')).attr(\"href\", \"#talkTocBox\");\n                        }\n                    });\n                    if (!localStorage.wgTocStyle || localStorage.wgTocStyle !== 'list') {\n                        $('#talkTocBox').fadeIn();\n                        $('.cbutton').text('\u70b9\u51fb\u5207\u6362\u81f3\u5217\u8868\u683c\u5f0f');\n                        $(toclist.filter(function(l) {\n                            return l !== \"talkTocBox\";\n                        }).map(function(l) {\n                            return 'a[href=\"#' + l + '\"]';\n                        }).join(', ')).attr(\"href\", \"#talkTocBox\");\n                    } else {\n                        $('#tocBox').fadeIn();\n                        $('.cbutton').text('\u70b9\u51fb\u5207\u6362\u81f3\u8868\u683c\u683c\u5f0f');\n                        $(toclist.filter(function(l) {\n                            return l !== \"tocBox\";\n                        }).map(function(l) {\n                            return 'a[href=\"#' + l + '\"]';\n                        }).join(', ')).attr(\"href\", \"#tocBox\");\n                    }\n                    $('.cbutton').parent().append(' [<' + 'a class=\"disableWidgetTalkToc\">\u7981\u7528\u8ba8\u8bba\u9875\u9762\u6574\u7406\u5de5\u5177<' + '/a>]');\n                    $('.disableWidgetTalkToc').on('click', function() {\n                        localStorage.setItem('widgetTalkToc', 'disable');\n                        $(this).text('\u7981\u7528\u6210\u529f\uff01\u5237\u65b0\u9875\u9762\u4e2d\u2026\u2026');\n                        setTimeout(location.reload.bind(location), 150);\n                    });\n                    $tocBox.css({\n                        position: 'relative',\n                        'z-index': 10\n                    });\n                    $(window).on('hashchange', function(e) {\n                        try {\n                            var hash = location.hash.substring(1);\n                            var target = $('[id=\"' + hash + '\"]');\n                            if (target[0]) {\n                                var scrollTop = target.offset().top;\n                                if (target.parent().css('position') !== 'sticky') {\n                                    var parent = target.closest('h1, h2, h3, h4, h5, h6');\n                                    if (parent.length > 0) {\n                                        scrollTop -= parent.outerHeight(true) - parent.height();\n                                        var h = parent.prevAll('h1, h2, h3, h4, h5, h6').filter(function() {\n                                            return $(this).css('position') === 'sticky';\n                                        });\n                                        if (h.length > 0) scrollTop -= h.outerHeight();\n                                    }\n                                } else scrollTop = target.closest('.discussionContainer').offset().top;\n                                setTimeout(function() {\n                                    $('html,body').animate({\n                                        scrollTop: scrollTop\n                                    }, 0);\n                                }, 1);\n                            }\n                        } catch (e) {\n                            return;\n                        }\n                    }).trigger('hashchange');\n                }\n            }, 7));\n        }\n    });\n});</script><style>\n/* <pre> */\n.widgetTalkTocEnable #tocBox {\n    max-width: 37%;\n    min-width: 300px;\n    float: left;\n}\n.widgetTalkTocEnable #toc.noOrigin {\n    display: table;\n}\n.widgetTalkTocEnable div.toc#toc {\n    min-width: 300px;\n    box-sizing: border-box;\n    margin-right: 37px;\n    padding-right: 1em;\n    padding-left: 1em;\n}\n.widgetTalkTocEnable div.toc#toc div.toctitle h2 {\n    margin-right: 1em;\n}\n.widgetTalkTocEnable div.toc.noOrigin#toc .toctoggle {\n    display: none;\n}\n.widgetTalkTocEnable div#toc.toc #toctoggle,\n.widgetTalkTocEnable div#toc.toc #toggle {\n    font-size: 94%;\n    -webkit-user-select: none;\n    -ms-user-select: none;\n    -o-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n}\n.widgetTalkTocEnable div#toc.toc .toggleButton:before {\n    content: \"[\";\n    color: black;\n}\n.widgetTalkTocEnable div#toc.toc .toggleButton:after {\n    content: \"]\";\n    color: black;\n}\n.widgetTalkTocEnable #toc .toggleButton:first-child {\n    margin-right: 0.5em;\n}\n.widgetTalkTocEnable div#toc.toc .toggleButton:last-child {\n    margin-right: 0;\n}\n.widgetTalkTocEnable div#toc.toc .hiddenDiscussion {\n    visibility: hidden;\n    height: 0;\n    margin: 0;\n}\n.widgetTalkTocEnable div.toc#toc li.savedDiscussion a {\n    text-decoration: underline;\n}\n.widgetTalkTocEnable #toc div#tocText {\n    text-align:center;\n}\n.widgetTalkTocEnable #toc div.tocText {\n    display:inline-block;\n}\n.widgetTalkTocEnable /* \u8282\u64cd\u9171\u7684beg */\n.widgetTalkTocEnable #content ol,\n.widgetTalkTocEnable #content ul {\n    margin: 0 !important;\n    padding: 0.3em 0 0 1.6em !important;\n}\n.widgetTalkTocEnable #toc .toclevel-1 > ul {\n    padding-left: 0!important;\n}\n.widgetTalkTocEnable /* \u7531\u4e8e\u8282\u64cd\u9171\u7684beg\u5bfc\u81f4\u5206\u7c7b\u90a3\u8fb9\u6709\u79d8\u5236\u7a7a\u767d */\n.widgetTalkTocEnable #content #catlinks ol,\n.widgetTalkTocEnable #content #catlinks ul {\n    padding: 0 !important;\n}\n#toc,\n#tocBox,\n#talkTocBox {\n    display: none;\n}\n.widgetTalkTocDisable #toc {\n    display: table;\n}\n.widgetTalkTocEnable #talkTocBox td {\n    text-align: center;\n    border: 1px solid #a7d7f9;\n    width: 25%;\n    padding: 0 1em;\n}\n.widgetTalkTocEnable #talkTocBox .hr td {\n    width: 100%;\n}\n.widgetTalkTocEnable #talkTocBox table {\n    border-collapse: collapse;\n    margin-bottom: 1em;\n    width: 100%;\n}\n.widgetTalkTocEnable #talkTocBox a {\n    cursor: pointer;\n}\n.widgetTalkTocEnable #talkTocBox .savedTitle {\n    text-decoration: underline;\n}\n.widgetTalkTocEnable .cbutton {\n    cursor: pointer;\n}\n.signInfo { display: none !important; }\n/* </pre> */\n</style><!--{/if}--></includeonly>"}}}