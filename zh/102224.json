{"parse":{"title":"MediaWiki:Gadget-twinkleunlink.js","pageid":164872,"wikitext":{"*":"//\u672cjs\u5f15\u81ea\u4e2d\u6587\u7ef4\u57fa\u767e\u79d1[[zhwiki:Special:Permalink/39584065]]\n!function(a){Twinkle.unlink=function(){mw.config.get(\"wgNamespaceNumber\")<0||\"Wikipedia:\u6c99\u76d2\"===mw.config.get(\"wgPageName\")||Morebits.userIsInGroup(\"sysop\")&&Twinkle.addPortletLink(Twinkle.unlink.callback,\"\u94fe\u5165\",\"tw-unlink\",\"\u53d6\u6d88\u5230\u672c\u9875\u7684\u94fe\u63a5\")},Twinkle.unlink.getChecked2=function(a){var b,c;if(!(a instanceof NodeList||a instanceof HTMLCollection))return a.checked?[a.values]:[];for(b=[],c=0;c<a.length;++c)a[c].checked&&b.push(a[c].values);return b},Twinkle.unlink.callback=function(a){var c,d,e,f,g,h,b=new Morebits.simpleWindow(600,440);b.setTitle(\"\u53d6\u6d88\u94fe\u5165\"+(6===mw.config.get(\"wgNamespaceNumber\")?\"\u548c\u6587\u4ef6\u4f7f\u7528\":\"\")),b.setScriptName(\"Twinkle\"),b.addFooterLink(\"Twinkle\u5e2e\u52a9\",\"WP:TW/DOC#unlink\"),c=new Morebits.quickForm(Twinkle.unlink.callback.evaluate),d=Morebits.htmlNode(\"code\",\"[[\"+Morebits.pageNameNorm+\"|\u94fe\u63a5\u6587\u672c]]\"),e=Morebits.htmlNode(\"code\",\"\u94fe\u63a5\u6587\u672c\"),d.style.fontFamily=e.style.fontFamily=\"monospace\",d.style.fontStyle=e.style.fontStyle=\"normal\",c.append({type:\"div\",style:\"margin-bottom: 0.5em\",label:[\"\u8fd9\u4e2a\u5de5\u5177\u53ef\u4ee5\u53d6\u6d88\u6240\u6709\u6307\u5411\u8be5\u9875\u7684\u94fe\u63a5\uff08\u201c\u94fe\u5165\u201d\uff09\"+(6===mw.config.get(\"wgNamespaceNumber\")?\"\uff0c\u548c/\u6216\u901a\u8fc7\u52a0\u5165<!-- -->\u6ce8\u91ca\u6807\u8bb0\u9690\u85cf\u6240\u6709\u5bf9\u6b64\u6587\u4ef6\u7684\u4f7f\u7528\":\"\")+\"\u3002\u6bd4\u5982\uff0c\",d,\"\u5c06\u4f1a\u53d8\u6210\",e,\"\u3002\u8bf7\u5c0f\u5fc3\u4f7f\u7528\u3002\"]}),c.append({type:\"input\",name:\"reason\",label:\"\u7406\u7531\uff1a\",value:a?a:\"\",size:60}),f=6===mw.config.get(\"wgNamespaceNumber\")?{action:\"query\",list:[\"backlinks\",\"imageusage\"],bltitle:Morebits.pageNameNorm,iutitle:Morebits.pageNameNorm,bllimit:Morebits.userIsInGroup(\"sysop\")?5e3:500,iulimit:Morebits.userIsInGroup(\"sysop\")?5e3:500,blnamespace:Twinkle.getPref(\"unlinkNamespaces\"),iunamespace:Twinkle.getPref(\"unlinkNamespaces\"),rawcontinue:!0}:{action:\"query\",list:\"backlinks\",bltitle:Morebits.pageNameNorm,blfilterredir:\"nonredirects\",bllimit:Morebits.userIsInGroup(\"sysop\")?5e3:500,blnamespace:Twinkle.getPref(\"unlinkNamespaces\"),rawcontinue:!0},g=new Morebits.wiki.api(\"\u6293\u53d6\u94fe\u5165\",f,Twinkle.unlink.callbacks.display.backlinks),g.params={form:c,Window:b,image:6===mw.config.get(\"wgNamespaceNumber\")},g.post(),h=document.createElement(\"div\"),h.style.padding=\"15px\",Morebits.status.init(h),g.statelem.status(\"\u8f7d\u5165\u4e2d\u2026\"),b.setContent(h),b.display()},Twinkle.unlink.callback.evaluate=function(b){var d,e,f,g,h,c=b.target.reason.value;return c?(d=[],e=[],b.target.backlinks&&(d=Twinkle.unlink.getChecked2(b.target.backlinks)),b.target.imageusage&&(e=Twinkle.unlink.getChecked2(b.target.imageusage)),Morebits.simpleWindow.setButtonsEnabled(!1),Morebits.status.init(b.target),f=Morebits.array.uniq(d.concat(e)),g=new Morebits.batchOperation(\"\u53d6\u6d88\u94fe\u5165\"+(e?\"\u4e0e\u6587\u4ef6\u4f7f\u7528\":\"\")),g.setOption(\"preserveIndividualStatusLines\",!0),g.setPageList(f),h={reason:c,unlinker:g},g.run(function(b){var f,c=new Morebits.wiki.page(b,\"\u5728\u6761\u76ee\u201c\"+b+\"\u201d\u4e2d\u53d6\u6d88\u94fe\u5165\");c.setBotEdit(!0),f=a.extend({},h),f.doBacklinks=d&&-1!==d.indexOf(b),f.doImageusage=e&&-1!==e.indexOf(b),c.setCallbackParameters(f),c.load(Twinkle.unlink.callbacks.unlinkBacklinks)}),void 0):(alert(\"\u60a8\u5fc5\u987b\u6307\u5b9a\u53d6\u6d88\u94fe\u5165\u7684\u7406\u7531\u3002\"),void 0)},Twinkle.unlink.callbacks={display:{backlinks:function(b){var e,f,g,h,i,j,k,l,c=b.responseXML,d=!1;if(b.params.image){for(h=a(c).find(\"query imageusage iu\"),e=[],g=0;g<h.length;++g)i=h[g].getAttribute(\"title\"),e.push({label:i,value:i,checked:!0});e.length?(b.params.form.append({type:\"header\",label:\"\u6587\u4ef6\u4f7f\u7528\"}),f=[],a.each(Twinkle.getPref(\"unlinkNamespaces\"),function(a,b){f.push(Morebits.wikipedia.namespacesFriendly[b])}),b.params.form.append({type:\"div\",label:\"\u5df2\u9009\u62e9\u7684\u540d\u5b57\u7a7a\u95f4\uff1a\"+f.join(\", \"),tooltip:\"\u60a8\u53ef\u5728Twinkle\u5c5e\u6027\u4e2d\u66f4\u6539\u8fd9\u4e2a\uff0c\u8bf7\u53c2\u89c1[[WP:TWPREFS]]\"}),a(c).find(\"query-continue\").length&&b.params.form.append({type:\"div\",label:\"\u663e\u793a\u5934 \"+e.length.toString()+\" \u4e2a\u6587\u4ef6\u4f7f\u7528\u3002\"}),b.params.form.append({type:\"button\",label:\"\u5168\u9009\",event:function(b){a(Morebits.quickForm.getElements(b.target.form,\"imageusage\")).prop(\"checked\",!0)}}),b.params.form.append({type:\"button\",label:\"\u5168\u4e0d\u9009\",event:function(b){a(Morebits.quickForm.getElements(b.target.form,\"imageusage\")).prop(\"checked\",!1)}}),b.params.form.append({type:\"checkbox\",name:\"imageusage\",list:e}),d=!0):b.params.form.append({type:\"div\",label:\"\u672a\u627e\u5230\u6587\u4ef6\u4f7f\u7528\u3002\"})}if(j=a(c).find(\"query backlinks bl\"),j.length>0){for(e=[],g=0;g<j.length;++g)k=j[g].getAttribute(\"title\"),e.push({label:k,value:k,checked:!0});b.params.form.append({type:\"header\",label:\"Backlinks\"}),f=[],a.each(Twinkle.getPref(\"unlinkNamespaces\"),function(a,b){f.push(Morebits.wikipedia.namespacesFriendly[b])}),b.params.form.append({type:\"div\",label:\"\u5df2\u9009\u62e9\u7684\u540d\u5b57\u7a7a\u95f4\uff1a\"+f.join(\", \"),tooltip:\"\u60a8\u53ef\u5728Twinkle\u5c5e\u6027\u4e2d\u66f4\u6539\u8fd9\u4e2a\uff0c\u8bf7\u53c2\u89c1[[WP:TWPREFS]]\"}),a(c).find(\"query-continue\").length&&b.params.form.append({type:\"div\",label:\"\u663e\u793a\u5934 \"+e.length.toString()+\" \u4e2a\u94fe\u5165\u3002\"}),b.params.form.append({type:\"button\",label:\"\u5168\u9009\",event:function(b){a(Morebits.quickForm.getElements(b.target.form,\"backlinks\")).prop(\"checked\",!0)}}),b.params.form.append({type:\"button\",label:\"\u5168\u4e0d\u9009\",event:function(b){a(Morebits.quickForm.getElements(b.target.form,\"backlinks\")).prop(\"checked\",!1)}}),b.params.form.append({type:\"checkbox\",name:\"backlinks\",list:e}),d=!0}else b.params.form.append({type:\"div\",label:\"\u672a\u627e\u5230\u94fe\u5165\u3002\"});d&&b.params.form.append({type:\"submit\"}),l=b.params.form.render(),b.params.Window.setContent(l),Morebits.checkboxShiftClickSupport(a(\"input[name='imageusage']\",l)),Morebits.checkboxShiftClickSupport(a(\"input[name='backlinks']\",l))}},unlinkBacklinks:function(a){var g,b=a.getPageText(),c=a.getCallbackParameters(),d=new Morebits.wikitext.page(b),e=\"\",f=!1;return c.doImageusage&&(d.commentOutImage(mw.config.get(\"wgTitle\"),\"\u6ce8\u91ca\u51fa\"),g=d.getText(),g===b?f=\"\u6587\u4ef6\u4f7f\u7528\":(e=\"\u6ce8\u91ca\u51fa\u6587\u4ef6\u4f7f\u7528\",b=g)),c.doBacklinks&&(d.removeLink(Morebits.pageNameNorm),g=d.getText(),g===b?f=f?\"\u53cd\u94fe\u6216\u6587\u4ef6\u4f7f\u7528\":\"\u53cd\u94fe\":(e=(e?e+\" / \":\"\")+\"\u53d6\u6d88\u94fe\u63a5\u5230\",b=g)),f?(a.getStatusElement().error(\"\u672a\u80fd\u5728\u9875\u9762\u4e0a\u627e\u5230\"+f+\"\u3002\"),c.unlinker.workerFailure(a),void 0):(a.setPageText(g),a.setEditSummary(e+' \"'+Morebits.pageNameNorm+'\": '+c.reason+\".\"+Twinkle.getPref(\"summaryAd\")),a.setCreateOption(\"nocreate\"),a.save(c.unlinker.workerSuccess,c.unlinker.workerFailure),void 0)}}}(jQuery);"}}}