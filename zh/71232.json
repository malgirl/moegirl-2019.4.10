{"parse":{"title":"User:AnnAngela/js/Music163Lrc.js","pageid":270238,"wikitext":{"*":"(function() {\n    var tagsRegMap = {\n            ti: 'title',\n            ar: 'artist',\n            al: 'album',\n        },\n        isLrcLine = function isLrcLine(lrc) {\n            return /^\\[(\\d{2,}):(\\d{2})(\\.\\d{2,3})?\\](.*)$|^\\[(ti|ar|al):([^\\]]*)\\]$/g.test(lrc);\n        },\n        isLoaded = false;\n\n    function parseLrc(lrc) {\n        var tags = {},\n            lrcs = {},\n            times = [],\n            result = '';\n        lrc.split(/\\r*\\n/).forEach(function(lrc) {\n            if (!isLrcLine(lrc)) return;\n            var tag = /^\\[(ti|ar|al):([^\\]]*)\\]$/i.exec(lrc);\n            if (tag) {\n                tags[tagsRegMap[tag[1]]] = tag[2];\n                return;\n            }\n            var exec = /^\\[(\\d{2,}):(\\d{2})(\\.\\d{2,3})?\\](.*)$/g.exec(lrc);\n            if (!exec) return;\n            var text = exec[4] || '',\n                min = +exec[1],\n                sec = +exec[2],\n                ms = +exec[3] || 0;\n            if (text === '') text = '<break>';\n            var time = parseInt((min * 60 + sec + ms) * 1000) + '';\n            if (!lrcs[time]) {\n                lrcs[time] = text;\n                times.push(+time);\n            } else lrcs[time] += '\\n' + text;\n        });\n        if (tags.title) {\n            result += tags.title;\n            if (tags.artist) result += ' - ' + tags.artist;\n            if (tags.album) result += ' - ' + tags.album;\n        }\n        result += '\\n<main_break>';\n        times.sort(function(a, b) { return a - b });\n        times.forEach(function(time) {\n            result += '\\n' + lrcs[time];\n        });\n        return result;\n    }\n\n    if ([\"edit\", \"submit\"].includes(mw.config.get(\"wgAction\"))) {\n        var c;\n        c = setInterval(function() {\n            if (!$(\"#wikiEditor-section-advanced > div.group.group-insert\").length) return;\n            clearInterval(c);\n            $(\"#wikiEditor-section-advanced > div.group.group-insert\").append($(\"<a/>\").addClass(\"label\").css({\n                \"cursor\": \"pointer\",\n                \"float\": \"right\",\n                \"margin-left\": \"8px\",\n                \"margin-right\": \"5px\",\n            }).text(\"\u83b7\u53d6\u7f51\u6613\u4e91\u97f3\u4e50\u7ffb\u8bd1\u6b4c\u8bcd\").on(\"click\", function() {\n                var textbox = $(\"#wpTextbox1\"),\n                    start = textbox[0].selectionStart,\n                    text = textbox.val(),\n                    id = prompt(\"\u7f51\u6613\u4e91\u97f3\u4e50\u6b4c\u66f2ID\uff1a\");\n                if (id === null) return;\n                if (isNaN(+id) || +id <= 0 || id % 1 !== 0) return alert('\u6b4c\u66f2ID\u975e\u6cd5\uff01\u5fc5\u987b\u4e3a\u6b63\u6574\u6570\uff01');\n                var url = 'https://annangela.moe/moegirlpedia/proxy.php?target=https%3A%2F%2Fmusic.163.com%2Fapi%2Fsong%2Flyric%3Fos%3Dpc%26id%3D' + id + '%26lv%3D-1%26tv%3D0',\n                    defaultCursor = $('body').css('cursor');\n                $('body').css('cursor', 'wait');\n                $.ajax({\n                    url: url,\n                    type: \"GET\",\n                    error: function() {\n                        var info = '';\n                        for (var i = 0, l = arguments.length; i < l; i++) info += JSON.stringify(arguments[i]) + '\\n';\n                        info += '\\n\u51fa\u73b0\u95ee\u9898\uff01\u8bf7\u622a\u56fe\u672c\u5185\u5bb9\u8054\u7cfb\u5f00\u53d1\u4eba\u5458\uff01';\n                        alert(info);\n                    },\n                    timeout: 60000,\n                    success: function(data) {\n                        var string = '{{Lyrics';\n                        var originLrcText = parseLrc(data.lrc.lyric);\n                        string += '\\n' + originLrcText.split('<main_break>').map(function(t, i) {\n                            if (i === 0) return '|lb-text1=' + t;\n                            else return t.split('<break>').map(function(t, i) {\n                                return '\\n|lb-text' + (i + 2) + '=' + t.replace(/^\\n*/, '');\n                            }).join('');\n                        }).join('');\n                        var translatedLrcText = parseLrc(data.tlyric.lyric);\n                        string += '\\n' + translatedLrcText.split('<main_break>').map(function(t, i) {\n                            if (i === 0) return '|rb-text1=\u7ffb\u8bd1\u8005\uff1a' + data.transUser.nickname + '\\n';\n                            else return t.split('<break>').map(function(t, i) {\n                                return '\\n|rb-text' + (i + 2) + '=' + t.replace(/^\\n*/, '');\n                            }).join('');\n                        }).join('');\n                        string += '\\n}}';\n\n                        textbox.val(text.substring(0, start) + \"\\n\" + string.replace(/\\n+/g, '\\n') + \"\\n\" + text.substring(start));\n                        textbox[0].selectionStart = textbox[0].selectionEnd = start + 30 + string.length;\n                        textbox.focus();\n\n                        $('body').css('cursor', defaultCursor);\n                    }\n                });\n            }));\n        }, 1000);\n    }\n})();"}}}