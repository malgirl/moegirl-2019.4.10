{"parse":{"title":"MediaWiki:Gadget-partrollCount.js","pageid":99465,"wikitext":{"*":"/**\n   Author: ZUO Haocheng from ZHWikipedia\n   URL:https://zh.wikipedia.org/w/index.php?title=User:Zuohaocheng/patrollCount.js\n   \u4e3a\u4ee3\u7801\u80fd\u9002\u7528\u505a\u51fa\u4e86\u9002\u5f53\u4fee\u6539\n*/\n$(document).ready(function() {\n    if (mw.config.get('wgAction') !== 'view') {\n        return;\n    }\n    //\u5728\u6b64\u4fee\u6539\u76d1\u89c6\u7684\u540d\u5b57\u7a7a\u95f4\n    var namespaceWatched = {\n        //\u5c06\u4f60  \u60f3\u76d1\u89c6\u7684\u540d\u5b57\u7a7a\u95f4\u524d\u9762\u7684   // \u53bb\u6389\uff0c\u7136\u540e\u628a false \u6539\u4e3a true  \uff1b\n        //\u5c06\u4f60\u4e0d\u60f3\u76d1\u89c6\u7684\u540d\u5b57\u7a7a\u95f4\u524d\u9762\u52a0\u4e0a // \uff0c\u7136\u540e\u628a     true  \u6539\u4e3a false \u3002\n        '(main)': true,\n        //\"talk\": false,\n        //\"user\": false,\n        //\"user_talk\": false,\n        //\"\u840c\u5a18\u767e\u79d1\": false,\n        //\"\u840c\u5a18\u767e\u79d1_talk\": false,\n        //\"file\": false,\n        //\"file_talk\": false,\n        //\"mediawiki\": false,\n        //\"mediawiki_talk\": false,\n        \"template\": true,\n        //\"template_talk\": false,\n        //\"help\": false,\n        //\"help_talk\": false,\n        //\"category\": false,\n        //\"category_talk\": false,\n        //\"widget\": false,\n        //\"widget_talk\": false,\n        //\"r18\": false,\n        //\"r18_talk\": false,\n        //\"timedtext\": false,\n        //\"timedtext_talk\": false,\n        //\"\u6a21\u5757\": false,\n        //\"\u6a21\u5757\u8ba8\u8bba\": false,\n        //\"gadget\": false,\n        //\"gadget_talk\": false,\n        //\"gadget_definition\": false,\n        //\"gadget_definition_talk\": false\n    }\n    var apiPrefix = '//zh.moegirl.org/api.php';\n    var newPageMax = 50;\n    var timeEvent;\n    var writeCountNum = function(pages, plus) {\n        var strCount = '';\n        if (pages.length !== 0) {\n            var vNum = Math.round(Math.random() * (pages.length - 1));\n            var page = pages[vNum];\n            var link = page['title'] + '&redirect=no&rcid=' + page['rcid'];\n            strCount = pages.length.toString();\n            if (plus) {\n                strCount += '+';\n            }\n            var title = page.title;\n            if (!page.confidence) {\n                title += '\" class=\"patrollListNotConfident';\n            }\n            strCount = '(<a id=\"unpatrollArticle\" href=\"//zh.moegirl.org/index.php?title=' + link + '\" title=\"' + title + '\">' + strCount + '</a>)';\n            ptPatrollLink.attr('href', '//zh.moegirl.org/index.php?title=Special:\u6700\u65b0\u9875\u9762&hidepatrolled=1');\n        } else {\n            ptPatrollLink.attr('href', '//zh.moegirl.org/index.php?title=Special:\u6700\u65b0\u9875\u9762&hidepatrolled=0');\n        }\n        $(\"span#not-patrolled-count\").html(strCount);\n        generateList(pages);\n        return page;\n    };\n    var showAllUnbind = [];\n    var showAll = false;\n    var prepareList = function(pages, countMax) {\n        var $list = $(\"#patrollTooltipList\").empty();\n        var addItem = function(istart, iend) {\n            for (var idx = istart; idx < iend; ++idx) {\n                var page = pages[idx];\n                var link = page.title + '&redirect=no&rcid=' + page.rcid;\n                var shortTitle = page.title;\n                if (shortTitle.length > 8) {\n                    shortTitle = shortTitle.slice(0, 7) + '...';\n                }\n                var item = $(\"<li></li>\").html('<a href=\"//zh.moegirl.org/index.php?title=' + link + '\" title=\"' + page.title + '\">' + shortTitle + '</a>').appendTo($list);\n                if (!page.confidence) {\n                    item.addClass('patrollListNotConfident');\n                }\n            }\n        };\n        var length = pages.length;\n        if (length > countMax && !showAll) {\n            addItem(0, countMax);\n            var $showAll = $(\"#patrollListShowAll\");\n            if ($showAll.length === 0) {\n                $showAll = $(\"<div></div>\", {\n                    id: \"patrollListShowAll\",\n                }).css({\n                    \"text-align\": \"right\",\n                    \"font-weight\": \"bold\",\n                    \"margin-bottom\": \"10px\"\n                }).append($(\"<a></a>\", {\n                    text: \"more...\",\n                    href: \"#patrollListShowAll\",\n                    title: \"Show all unpatrolled articles\"\n                }));\n                $list.after($showAll);\n            } else {\n                $showAll.show();\n            }\n            $showAll.unbind(\"click\");\n            $showAll.click(function() {\n                addItem(countMax, length);\n                $showAll.hide();\n                for (var idx = 0; idx < showAllUnbind.length; ++idx) {\n                    showAllUnbind[idx].unbind(\"mouseover.autohide mouseout\");\n                }\n                showAll = true;\n            });\n        } else {\n            addItem(0, pages.length);\n        }\n    };\n    var ttListShow = false;\n    var generateList = function(pages) {\n        if (ttListShow) {\n            prepareList(pages, 10);\n        } else {\n            var timer = null;\n            var $ptPatroll = $(\"#pt-patroll\").unbind(\"mouseover mouseover.autohide mouseout\");\n            $ptPatroll.mouseover(function() {\n                if (timer) {\n                    return;\n                }\n                timer = setTimeout(function() {\n                    timer = null;\n                    if (pages.length !== 0 && !ttListShow) {\n                        if (typeof($.fn.cvtooltip) === 'undefined') {\n                            loadCvtooltip();\n                        }\n                        prepareList(pages, 10);\n                        ttListShow = true;\n                        var ctt = $(\"#patrollTooltip\").cvtooltip({\n                            left: 60,\n                            top: 45,\n                            callback: function() {\n                                ttListShow = false;\n                                showAll = false;\n                                $ptPatroll.unbind(\"mouseover.autohide mouseout\");\n                            }\n                        });\n                        var tipCloseTimer;\n                        var clearHideTimer = function() {\n                            if (tipCloseTimer) {\n                                clearTimeout(tipCloseTimer);\n                                tipCloseTimer = null;\n                            }\n                        };\n                        ctt.body.bind(\"mouseover.autohide\", clearHideTimer);\n                        $ptPatroll.bind(\"mouseover.autohide\", clearHideTimer);\n                        var setHideTimer = function() {\n                            if (!tipCloseTimer) {\n                                tipCloseTimer = setTimeout(ctt.hide, 1000);\n                            }\n                        };\n                        ctt.body.mouseout(setHideTimer);\n                        $ptPatroll.mouseout(setHideTimer);\n                        showAllUnbind = [ctt.body, $ptPatroll];\n                    }\n                }, 500);\n                $ptPatroll.mouseout(function() {\n                    if (timer) {\n                        clearTimeout(timer);\n                        timer = null;\n                    }\n                });\n            });\n        }\n    };\n    var missingPage = {};\n    var checkMissing = function(pages, plus) {\n        var missingQuery = [];\n        for (var idx = 0; idx < pages.length; ++idx) {\n            var title = pages[idx].title;\n            if (typeof(title) === 'undefined') {\n                continue;\n            }\n            var isMissing = missingPage[title];\n            if (typeof(isMissing) === 'undefined') {\n                missingQuery.push(title);\n            } else if (isMissing) {\n                pages.splice(idx, 1);\n            }\n        }\n        //\u67e5\u8be2\u5220\u9664\u72b6\u6001\n        if (missingQuery.length !== 0) {\n            var pagesStr = missingQuery.join('|');\n            var checkMissingURI = apiPrefix + '?action=query&format=xml&prop=info';\n            $.post(checkMissingURI, {\n                titles: pagesStr\n            }, function(result) {\n                var regenerate = false;\n                $(result).find(\"pages page\").each(function() {\n                    var isMissing = (typeof($(this).attr('missing')) !== 'undefined');\n                    var title = $(this).attr('title');\n                    missingPage[title] = isMissing;\n                    if (isMissing) {\n                        for (var idx = 0; idx < pages.length; ++idx) {\n                            if (pages[idx].title === title) {\n                                pages.splice(idx, 1);\n                                break;\n                            }\n                        }\n                        if (title === $(\"#unpatrollArticle\").attr(\"title\")) {\n                            regenerate = true;\n                        }\n                    }\n                });\n                if (regenerate) {\n                    writeCountNum(pages, plus);\n                }\n            });\n        }\n    };\n    //\u52a0\u5165\u6807\u8bb0\u5de1\u67e5\u6309\u94ae \n    var addPatrollLink = (function() {\n        var checked = false;\n        var addlink = function(page) {\n            var $patrollinks = $(\"<a></a>\", {\n                href: (\"index.php?title=\" + encodeURIComponent(page.title) + \"&rcid=\" + encodeURIComponent(page.rcid)),\n                text: \"\u6807\u8bb0\u6b64\u9875\u9762\u4e3a\u5df2\u5de1\u67e5\"\n            });\n            var $divPatrolllink = $(\"<div></div>\", {\n                'class': 'patrollink'\n            }).append('[').append($patrollinks).append(']');\n            $(\"div.printfooter\").before($divPatrolllink);\n            var markAsPatrol = function(e) {\n                e.preventDefault();\n                var data = {\n                    rcid: page.rcid,\n                    token: page.rctoken\n                };\n                var uri = apiPrefix + '?format=xml&action=patrol';\n                $patrollinks.text('Marking as patrolled...');\n                $patrollinks = $patrollinks.parent();\n                $.post(uri, data, function(data, status, request) {\n                    //window.data = [data, status, request]; // DEBUG\n                    if (status == 'success') {\n                        $patrollinks.html('<span style=\"color:green\">Marked as patrolled</span>'); // MediaWiki:Markedaspatrolled\n                        if (typeof kAjaxPatrolLinks_closeafter !== 'undefined' && kAjaxPatrolLinks_closeafter == true) {\n                            window.close();\n                            // Firefox 2+ doesn't allow closing normal windows. If we're still here, open up the selfclosing page.\n                            window.open(\"http://toolserver.org/~krinkle/close.html\", \"_self\");\n                        }\n                    } else {\n                        $patrollinks.html('<span style=\"color:red\">Cannot mark as patrolled</span>'); // MediaWiki:Markedaspatrollederror\n                    }\n                });\n            };\n            $patrollinks.click(markAsPatrol);\n        };\n        return (function(pages) {\n            if (!checked && ($(\"div.patrollink\").length === 0)) {\n                var pageName = mediaWiki.config.get('wgPageName');\n                for (var idx = 0; idx < pages.length; ++idx) {\n                    var page = pages[idx];\n                    if (page.title === pageName) {\n                        addlink(page);\n                        break;\n                    }\n                }\n                checked = true;\n            }\n        });\n    })();\n    //\u5b9a\u65f6\u6293\u53d6\u672a\u5de1\u67e5\u7684\u9875\u9762\u6570\u91cf\n    var namespaceWatchList = [];\n    var namespaceList = mw.config.get('wgNamespaceIds');\n    for (var i in namespaceWatched) {\n        if (!namespaceWatched[i]) continue;\n        if (i === '(main)') i = '';\n        namespaceWatchList.push(namespaceList[i]);\n    }\n    var updateUnpatrolled = function() {\n        var d = new Date();\n        var requestid = d.getTime();\n        var newPages = apiPrefix + '?action=query&format=xml&list=recentchanges&rctype=new&rcnamespace=' + namespaceWatchList.join('|') + '&rcshow=!redirect|!patrolled&rctoken=patrol&rcprop=title|ids|user|tags';\n        $.get(newPages, {\n            rclimit: newPageMax,\n            requestid: requestid\n        }, function(result) {\n            var pages = [];\n            var jqResult = $(result);\n            jqResult.find(\"rc\").each(function() {\n                var $self = $(this);\n                var confidence = (typeof($self.attr('anon')) === 'undefined') && ($self.find('tag').length == 0);\n                var t = {\n                    'title': $self.attr('title'),\n                    'rcid': $self.attr('rcid'),\n                    'rctoken': $self.attr('patroltoken'),\n                    'confidence': confidence\n                };\n                pages.push(t);\n            });\n            addPatrollLink(pages);\n            var plus = (jqResult.find('query-continue').length !== 0);\n            if (pages.length !== 0) {\n                checkMissing(pages, plus);\n            }\n            writeCountNum(pages, plus);\n        });\n    };\n    setInterval(updateUnpatrolled, 10000);\n    updateUnpatrolled();\n    //\u5728\"\u76d1\u89c6\u5217\u8868\"\u53f3\u8fb9\u52a0\u5165\"\u6700\u65b0\u9875\u9762\"\u4ee5\u4fbf\u5de1\u67e5\n    var ptPatrollLink = $('<a></a>', {\n        'href': \"Special:\u6700\u65b0\u9875\u9762?hidepatrolled=1\",\n        'title': '\u6700\u65b0\u9875\u9762',\n        'text': '\u6700\u65b0\u9875\u9762'\n    });\n    $(\"body div#mw-head div#p-personal ul li#pt-watchlist\").after($('<li></li>', {\n        'id': 'pt-patroll'\n    }).append(ptPatrollLink).append($('<span></span>', {\n        'id': \"not-patrolled-count\"\n    })));\n});\nvar loadCvtooltip = function() {\n    $(\"body\").append($(\"<div></div>\", {\n        id: \"patrollTooltip\",\n        style: \"display: none;\"\n    }).css({\n        \"font-size\": \"0.75em\",\n        \"margin-right\": \"30px\"\n    }).append($(\"<ul></ul>\", {\n        id: \"patrollTooltipList\"\n    })));\n    /* \n     * JQuery.cvtooltip.js\n     * http://www.chinavalue.net\n     *\n     * J.Wang\n     * http://0417.cnblogs.ocm\n     *\n     * 2010.11.17\n     */\n    (function($) {\n        $.fn.cvtooltip = function(options) {\n            var self = $(this);\n            var defaults = {\n                panel: \"body\", //\u8be5\u53c2\u6570\u662f\u52a0\u8f7d\u6c14\u6ce1\u63d0\u793a\u7684\u5bb9\u5668\uff0c\u503c\u4e0d\u540c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u8ba1\u7b97\u7684\u4f4d\u7f6e\u4e0d\u540c\uff0c\u9ed8\u8ba4\u4e3a\u6dfb\u52a0\u81f3body\u5bb9\u5668\n                selector: \"\", //\u7528\u4e8e\u8ba1\u7b97\u5b9a\u4f4d\u7684\u63a7\u4ef6\n                width: 0, //\u6c14\u6ce1\u63d0\u793a\u5bbd\u5ea6\uff0c\u5b8c\u5168\u624b\u52a8\u8bbe\u7f6e\n                left: 0, //\u8ddd\u79bbpanel\u53c2\u6570\u7684\u5de6\u8fb9\u8ddd\n                top: 0, //\u8ddd\u79bbpanel\u53c2\u6570\u7684\u4e0a\u8fb9\u8ddd\n                delay: -1, //\u5ef6\u8fdf\u5173\u95ed\uff0c\u5355\u4f4d\u6beb\u79d2\uff0c\u503c\u4e3a0\u65f6\u8868\u793a\u7acb\u523b\u5173\u95ed\n                speed: 600, //\u5173\u95ed\u65f6\u7684\u6548\u679c\uff0c\u6de1\u51fa\u901f\u5ea6\n                close: true, //\u662f\u5426\u663e\u793a\u5173\u95ed\u6309\u94ae\n                callback: function() {\n                    $.noop(); //\u70b9\u51fb\u5173\u95ed\u540e\u7684\u4e8b\u4ef6\n                }\n            };\n            var param = $.extend({}, defaults, options || {});\n            var controlID = self.attr(\"ID\");\n            //\u6c14\u6ce1\u6837\u5f0f\n            var cvToolTipCssBtm = 'position: absolute; border-color: transparent transparent #A7D7F9 transparent; border-style: dashed dashed solid dashed; border-width: 7px 7px 7px 7px; width: 0; overflow: hidden; right:40px; top:-17px;';\n            var cvToolTipCssTop = 'position: absolute; border-color: transparent transparent #A7D7F9 transparent; border-style: dashed dashed solid dashed; border-width: 7px 7px 7px 7px; width: 0; overflow: hidden; right:40px; top:-17px;';\n            var cvToolTipCss = 'z-index:713; display:none; position: absolute; border: 3px solid #A7D7F9; background-color: #F3F3F3; line-height:14px; border-radius: 10px; right:' + param.left + 'px; top:' + param.top + 'px;';\n            if (param.width !== 0) {\n                cvToolTipCss += 'width: ' + param.width + 'px;';\n            }\n            //\u6c14\u6ce1\u663e\u793a\n            var cvTipsElement = '';\n            cvTipsElement += '<div id=\"' + controlID + 'Body\" class=\"cvToolTip\" style=\"' + cvToolTipCss + '\">';\n            cvTipsElement += '<span style=\"' + cvToolTipCssBtm + '\"></span><span style=\"' + cvToolTipCssTop + '\"></span>';\n            cvTipsElement += '<span id=\"' + controlID + 'Content\" style=\"float:left;\"></span>';\n            if (param.close) {\n                cvTipsElement += '<a id=\"' + controlID + 'Close\" style=\"display:none;\"><span style=\"float:right; font-family:verdana; position: absolute; top:1px; right:5px; font-size:12px; cursor:pointer;\">x</span></a>';\n            }\n            cvTipsElement += '</div>';\n            if ($(\"#\" + controlID + \"Body\").length == 0) {\n                $(param.panel).append(cvTipsElement);\n            }\n            //\u6c14\u6ce1\u5bb9\u5668\u3001\u88c5\u8f7d\u5185\u5bb9\u7684\u5bb9\u5668\n            var cttBody = $(\"#\" + controlID + \"Body\");\n            var cttContent = $(\"#\" + controlID + \"Content\");\n            var cttClose = $(\"#\" + controlID + \"Close\");\n            cttBody.show();\n            var ctt = {\n                body: cttBody,\n                content: function() {\n                    self.show();\n                    return self;\n                },\n                position: function() {\n                    var p = $(param.selector).position();\n                    cttBody.css({\n                        top: p.top + param.top,\n                        left: p.left + param.left\n                    });\n                },\n                hide: function() {\n                    cttClose.hide();\n                    cttBody.unbind();\n                    cttContent.slideUp(param.speed, function() {\n                        ctt.content().hide().appendTo($(param.panel));\n                        cttBody.remove();\n                    });\n                    param.callback();\n                },\n                timer: null,\n                show: function() {\n                    var timer;\n                    if (cttContent.html() == \"\") {\n                        cttContent.append(ctt.content()).css(\"height\", cttContent[0].scrollHeight + 'px').hide().slideDown(param.speed, function() {\n                            cttContent.css(\"height\", \"\");\n                            cttBody.mouseover(function() {\n                                cttClose.show();\n                            });\n                            cttBody.mouseout(function() {\n                                cttClose.hide();\n                            });\n                        });\n                    }\n                    if (param.selector != \"\") {\n                        ctt.position();\n                    }\n                    if (param.delay >= 0) {\n                        timer = setTimeout(ctt.hide, param.delay);\n                    }\n                }\n            };\n            ctt.show();\n            //\u5173\u95ed\u6c14\u6ce1        \n            cttClose.click(ctt.hide);\n            return ctt;\n        }\n    })(jQuery);\n}"}}}