{"parse":{"title":"MediaWiki:Gadget-twinkledelimages.js","pageid":164866,"wikitext":{"*":"//\u672cjs\u5f15\u81ea\u4e2d\u6587\u7ef4\u57fa\u767e\u79d1[[zhwiki:Special:Permalink/32272487]]\n!function(a){Twinkle.delimages=function(){mw.config.get(\"wgNamespaceNumber\")<0||!mw.config.get(\"wgCurRevisionId\")||Morebits.userIsInGroup(\"sysop\")&&Twinkle.addPortletLink(Twinkle.delimages.callback,\"\u6279\u56fe\",\"tw-deli\",\"\u6279\u91cf\u5220\u9664\u6b64\u9875\u5185\u7684\u6587\u4ef6\")},Twinkle.delimages.unlinkCache={},Twinkle.delimages.callback=function(){var c,d,e,f,b=new Morebits.simpleWindow(800,400);b.setTitle(\"\u6279\u91cf\u6587\u4ef6\u5220\u9664\"),b.setScriptName(\"Twinkle\"),b.addFooterLink(\"Twinkle\u5e2e\u52a9\",\"WP:TW/DOC#delimages\"),c=new Morebits.quickForm(Twinkle.delimages.callback.evaluate),c.append({type:\"checkbox\",list:[{label:\"\u5220\u9664\u6587\u4ef6\",name:\"delete_image\",value:\"delete\",checked:!0},{label:\"\u53d6\u6d88\u6b64\u6587\u4ef6\u7684\u4f7f\u7528\",name:\"unlink_image\",value:\"unlink\",checked:!0}]}),c.append({type:\"textarea\",name:\"reason\",label:\"\u7406\u7531\uff1a\"}),14===mw.config.get(\"wgNamespaceNumber\")?d={action:\"query\",generator:\"categorymembers\",gcmtitle:mw.config.get(\"wgPageName\"),gcmnamespace:6,gcmlimit:Twinkle.getPref(\"deliMax\"),prop:[\"imageinfo\",\"categories\",\"revisions\"],grvlimit:1,grvprop:[\"user\"]}:(alert(\"\u81f4\u7ba1\u7406\u5458\uff1a\\n\\n\u6211\u4eec\u6b63\u5728\u8ba1\u5212\u7ffb\u65b0\u201c\u6279\u91cf\u6587\u4ef6\u5220\u9664\u201d\u6a21\u5757\uff0c\u5e76\u5728\u8003\u8651\u5bf9\u4e8e\u5206\u7c7b\u4ee5\u5916\u7684\u9875\u9762\uff0c\u6b64\u529f\u80fd\u662f\u5426\u4ecd\u65e7\u503c\u5f97\u7ef4\u62a4\u3002\\n\\n\u65e2\u7136\u60a8\u6b63\u4e8e\u5206\u7c7b\u4ee5\u5916\u7684\u9875\u9762\u8c03\u7528\u201c\u6279\u91cf\u6587\u4ef6\u5220\u9664\u201d\uff0c\u6211\u4eec\u5e0c\u671b\u60a8\u80fd\u591f\u4e8e[[WT:TW]]\u544a\u77e5Twinkle\u56e2\u961f\u3002\u5982\u679c\u6ca1\u6709\u4eba\u544a\u8bc9\u6211\u4eec\u4ed6\u8fd8\u5728\u4f7f\u7528\uff0c\u6211\u4eec\u5c31\u53ef\u80fd\u4f1a\u79fb\u9664\u6216\u4fee\u6539\u8fd9\u4e2a\u529f\u80fd\u3002\\n\\n\u8c22\u8c22\uff0c\\nTwinkle\u56e2\u961f\"),d={action:\"query\",generator:\"images\",titles:mw.config.get(\"wgPageName\"),prop:[\"imageinfo\",\"categories\",\"revisions\"],gimlimit:\"max\"}),e=new Morebits.wiki.api(\"\u6293\u53d6\u6587\u4ef6\",d,function(b){var f,c=b.responseXML,d=a(c).find('page[imagerepository=\"local\"]'),e=[];a.each(d,function(){var b=a(this),c=b.attr(\"title\"),d=b.find(\"imageinfo ii\").attr(\"user\"),f=b.find(\"revisions rev\").attr(\"user\"),g=b.find('categories cl[title=\"Category:\u5feb\u901f\u5220\u9664\u5019\u9009\"]').size()>0;e.push({label:c+\"\u2014\u4f5c\u8005\uff1a\"+d+\"\uff0c\u4e0a\u6b21\u7f16\u8f91\uff1a\"+f+(g?\"\uff08\u4e89\u8bae\":\"\"),value:c,checked:!g})}),b.params.form.append({type:\"checkbox\",name:\"images\",list:e}),b.params.form.append({type:\"submit\"}),f=b.params.form.render(),b.params.Window.setContent(f)}),e.params={form:c,Window:b},e.post(),f=document.createElement(\"div\"),Morebits.status.init(f),b.setContent(f),b.display()},Twinkle.delimages.currentDeleteCounter=0,Twinkle.delimages.currentUnlinkCounter=0,Twinkle.delimages.currentdeletor=0,Twinkle.delimages.callback.evaluate=function(a){function f(a){var b,f,g,h,i;if(0===a.length&&Twinkle.delimages.currentDeleteCounter<=0&&Twinkle.delimages.currentUnlinkCounter<=0)return window.clearInterval(Twinkle.delimages.currentdeletor),Morebits.wiki.removeCheckpoint(),void 0;if(0!==a.length&&Twinkle.delimages.currentDeleteCounter<=Twinkle.getPref(\"batchDeleteMinCutOff\")&&Twinkle.delimages.currentUnlinkCounter<=Twinkle.getPref(\"batchDeleteMinCutOff\"))for(Twinkle.delimages.unlinkCache=[],b=a.shift(),Twinkle.delimages.currentDeleteCounter=b.length,Twinkle.delimages.currentUnlinkCounter=b.length,f=0;f<b.length;++f)g=b[f],h={action:\"query\",titles:g},i=new Morebits.wiki.api(\"\u68c0\u67e5\u6587\u4ef6 \"+g+\" \u662f\u5426\u5b58\u5728\",h,Twinkle.delimages.callbacks.main),i.params={image:g,reason:c,unlink_image:e,delete_image:d},i.post()}var g,b=a.target.getChecked(\"images\"),c=a.target.reason.value,d=a.target.delete_image.checked,e=a.target.unlink_image.checked;c&&(Morebits.simpleWindow.setButtonsEnabled(!1),Morebits.status.init(a.target),g=Morebits.array.chunk(b,Twinkle.getPref(\"deliChunks\")),Morebits.wiki.addCheckpoint(),Twinkle.delimages.currentdeletor=window.setInterval(f,1e3,g))},Twinkle.delimages.callbacks={main:function(b){var f,g,h,i,c=b.responseXML,d=a(c),e=d.find(\"normalized n\").attr(\"to\");return e&&(b.params.image=e),(f=d.find('pages page[title=\"'+b.params.image.replace(/\"/g,'\\\\\"')+'\"]:not([missing])').size()>0)?(b.params.unlink_image&&(g={action:\"query\",list:\"imageusage\",iutitle:b.params.image,iulimit:Morebits.userIsInGroup(\"sysop\")?5e3:500},h=new Morebits.wiki.api(\"\u6293\u53d6\u6587\u4ef6\u94fe\u63a5\",g,Twinkle.delimages.callbacks.unlinkImageInstancesMain),h.params=b.params,h.post()),b.params.delete_image&&(i=new Morebits.wiki.page(b.params.image,\"\u5220\u9664\u6587\u4ef6\"),i.setEditSummary(\"\u6587\u4ef6\u88ab\u5220\u9664\uff1a\"+b.params.reason+Twinkle.getPref(\"deletionSummaryAd\")),i.deletePage()),void 0):(b.statelem.error(\"\u6587\u4ef6\u4e0d\u5b58\u5728\uff0c\u53ef\u80fd\u5df2\u88ab\u5220\u9664\"),void 0)},unlinkImageInstancesMain:function(b){var c=b.responseXML,d=[];return a(c).find(\"imageusage iu\").each(function(){d.push(a(this).attr(\"title\"))}),0===d.length?(--Twinkle.delimages.currentUnlinkCounter,void 0):(a.each(d,function(a,c){var d=new Morebits.wiki.page(c,\"\u53d6\u6d88\u6587\u4ef6\u5728\"+c+\" \u4e0a\u7684\u4f7f\u7528\");d.setFollowRedirect(!0),d.setCallbackParameters({image:b.params.image,reason:b.params.reason}),d.load(Twinkle.delimages.callbacks.unlinkImageInstances)}),void 0)},unlinkImageInstances:function(a){var g,b=a.getCallbackParameters(),c=a.getStatusElement(),d=b.image.replace(/^(?:Image|File|\u6587\u4ef6):/,\"\"),e=a.getPageText(),f=new Morebits.wikitext.page(e);return f.commentOutImage(d,\"\u6ce8\u91ca\u6b64\u6587\u4ef6\u56e0\u5176\u5df2\u88ab\u5220\u9664\"),g=f.getText(),g===e?(c.error(\"\u53d6\u6d88 \"+d+\" \u5728 \"+a.getPageName()+\" \u4e0a\u7684\u4f7f\u7528\u5931\u8d25\"),void 0):(a.setPageText(g),a.setEditSummary(\"\u79fb\u9664\u6587\u4ef6 \"+d+\" \u56e0\u5176\u5df2\u88ab\u5220\u9664\uff0c\u7406\u7531\u4e3a\u201c\"+b.reason+\"\u201d\u3002\"+Twinkle.getPref(\"deletionSummaryAd\")),a.setCreateOption(\"nocreate\"),a.save(),void 0)}}}(jQuery);"}}}