{"parse":{"title":"User:AnnAngela/js/backlog.js","pageid":310488,"wikitext":{"*":"// <pre>\ntry {\n    const run = async () => {\n        if (!mw.config.get(\"wgUserGroups\").includes(\"sysop\") && !mw.config.get(\"wgUserGroups\").includes(\"patroller\")) return;\n        if (mw.config.get(\"wgArticleId\") !== 38120) { return; }\n        const container = $(\"#__anntools__inject__\");\n        if (!container.length) { return; }\n        container.empty().html(`<div id=\"Anntools-backlog-loading\" style=\"text-align: center;\"><hr>\u6b63\u5728\u52a0\u8f7d\u4e2d\u2026\u2026</a>`).show();\n        await mw.loader.using(\"mw.Api\");\n        await mw.loader.using(\"moment\");\n        const now = moment();\n        const nowYear = RegExp(new Date().getFullYear() + \"\u5e74\", \"g\");\n        const nowDay = now.format(\"D\");\n        const durationUnits = new Map([\n            [/\\s*years?/ig, \"\u5e74\"],\n            [/\\s*months?/ig, \"\u6708\"],\n            [/\\s*weeks?/ig, \"\u5468\"],\n            [/\\s*days?/ig, \"\u5929\"],\n            [/\\s*hours?/ig, \"\u5c0f\u65f6\"],\n            [/infinite/ig, \"\u65e0\u9650\u671f\"],\n        ]);\n        const users = new Set();\n        const groups = new Map([\n            [\"system\", \"\u7cfb\u7edf\"],\n            [\"bot\", \"\u673a\"],\n            [\"bureaucrat\", \"\u884c\"],\n            [\"sysop\", \"\u7ba1\"],\n            [\"patroller\", \"\u5de1\"],\n        ]);\n        const systemUsers = [\"\u6ee5\u7528\u8fc7\u6ee4\u5668\"];\n        let scrollFlag = false;\n        const dayFlag = localStorage.getItem(\"AnnTools_Backlog_DayFlag\") || \"-1\";\n        const blockLogLengthFlag = parseInt(localStorage.getItem(\"AnnTools_Backlog_blockLogLengthFlag\")) || -1;\n        const abuseLogLengthFlag = parseInt(localStorage.getItem(\"AnnTools_Backlog_abuseLogLengthFlag\")) || -1;\n        const api = new mw.Api();\n        const blockLogResult = await api.post({\n            action: \"query\",\n            format: \"json\",\n            list: \"logevents\",\n            leprop: \"ids|title|type|user|timestamp|details|parsedcomment|tags\",\n            letype: \"block\",\n            leend: moment().subtract(7, \"days\").toISOString(),\n            lelimit: \"10\",\n        });\n        if (blockLogResult && blockLogResult.query && blockLogResult.query.logevents) {\n            const blocklogevents = blockLogResult.query.logevents;\n            container.append(\"<hr>\");\n            if (blocklogevents.length > 0) {\n                const blocklogFlags = {\n                    anononly: \"\u4ec5\u5c01\u7981\u533f\u540d\u7528\u6237\",\n                    nocreate: \"\u963b\u6b62\u521b\u5efa\u65b0\u8d26\u53f7\",\n                    autoblock: \"\u81ea\u52a8\u5c01\u7981\u8be5\u7528\u6237\u6700\u540e\u4f7f\u7528\u7684IP\u5730\u5740\uff0c\u4ee5\u53ca\u5176\u968f\u540e\u8bd5\u56fe\u7528\u4e8e\u7f16\u8f91\u7684\u6240\u6709IP\u5730\u5740\",\n                    noemail: \"\u963b\u6b62\u7528\u6237\u53d1\u9001\u7535\u5b50\u90ae\u4ef6\",\n                    nousertalk: \"\u963b\u6b62\u7528\u6237\u5728\u5c01\u7981\u671f\u95f4\u7f16\u8f91\u81ea\u5df1\u7684\u8ba8\u8bba\u9875\",\n                    hiddenname: \"\u9690\u85cf\u7528\u6237\u540d\",\n                };\n                const actions = {\n                    block: \"\u5c01\u7981\",\n                    reblock: \"\u66f4\u6539\u5c01\u7981\",\n                    unblock: \"\u89e3\u5c01\",\n                };\n                const lastBlockLogIdFromLocalStorage = +(localStorage.getItem(\"AnnTools-backlog-lastBlockLogId\") || \"-1\");\n                let lastBlockLogIdFromBlockLogEvents = -1;\n                const blocklogeventsContainerRoot = $(\"<div/>\");\n                container.append(blocklogeventsContainerRoot);\n                blocklogeventsContainerRoot.addClass(\"blocklogevents\");\n                const blocklogeventsHead = $(\"<table/>\");\n                blocklogeventsHead.addClass(\"wikitable blocklogevents-head blocklogevents-table\");\n                blocklogeventsHead.html(`<caption>\u6700\u8fd17\u5929\u5185\u6700\u65b010\u6b21\u5c01\u7981\u65e5\u5fd7 [<a id=\"expand-blocklogevents\">\u6269\u5c55/\u6536\u7f29\u5217\u8868</a>]</caption><tbody><tr><th>\u65f6\u95f4</th><th>\u6267\u884c\u8005</th><th>\u76ee\u6807</th><th>\u7c7b\u578b</th><th>\u7ed3\u675f\u65f6\u95f4</th><th>\u989d\u5916\u9650\u5236</th><th>\u5907\u6ce8</th><th>\u64cd\u4f5c</th></tr></body>`);\n                blocklogeventsContainerRoot.append(blocklogeventsHead);\n                const blocklogeventsContainer = $(\"<table/>\");\n                blocklogeventsContainer.addClass(\"wikitable blocklogevents-table\");\n                blocklogeventsContainer.html(\"<tbody></tbody>\");\n                blocklogeventsContainerRoot.append(blocklogeventsContainer);\n                mw.loader.addStyleTag(`.blocklogevents { overflow-x: hidden; overflow-y: scroll; max-height: 15em; padding: 0 0 1px 0; position: relative; } .blocklogevents.nothing-new { max-height: 1.5em; overflow-y: hidden; } .blocklogevents.expand { max-height: unset; overflow-y: unset; } .blocklogevents-head { position: sticky; z-index: 2; top: 0; left: 0; } .blocklogevents .blocklogevents-head caption { background-color: white; } .blocklogevents .blocklogevents-head th { background-color: #F6F6F6!important; } .blocklogevents-table { width: 100%; margin: 0 !important; } .blocklogevents .style-justify { white-space: nowrap; text-align: center; } .blocklogevents-ul { margin-top: 0; } .blocklogevents-flags-nousertalk{ text-decoration: underline; } .blocklogevents-flags-autoblock{ color: red; }`);\n                $(\"#expand-blocklogevents\").on(\"click\", () => {\n                    blocklogeventsContainerRoot.toggleClass(\"expand\");\n                    $(window).resize();\n                });\n                const blocklogeventTemplate = $(\"<tr/>\");\n                blocklogeventTemplate.addClass(\"need-usergroup\");\n                blocklogeventTemplate.html(`<td class=\"style-justify\"></td>`.repeat(5) + `<td></td><td></td><td class=\"style-justify\"></td>`);\n                blocklogevents.forEach(({\n                    logid,\n                    action,\n                    title: _target,\n                    user,\n                    timestamp,\n                    tags,\n                    parsedcomment: comment,\n                    params: {\n                        duration: _duration,\n                        expiry,\n                        flags,\n                    },\n                }) => {\n                    users.add(user);\n                    const target = _target.replace(/^user:/i, \"\");\n                    if (flags) {\n                        const noautoblockIndex = flags.indexOf(\"noautoblock\");\n                        if (noautoblockIndex === -1) {\n                            flags.push(\"autoblock\");\n                        } else {\n                            flags.splice(noautoblockIndex, 1);\n                        }\n                    }\n                    let endTime = \"-\";\n                    if (expiry) {\n                        const expiryMoment = moment(expiry);\n                        endTime = `<span title=\"${expiry}\">${expiryMoment.format(\"YYYY[\u5e74]M[\u6708]D[\u65e5 (]dd[)<br>]HH[:]mm[:]ss\").replace(nowYear, \"\")}${now.diff(expiryMoment) > 0 ? \"\uff08\u5df2\u8fc7\u671f\uff09\" : \"\"}</span>`;\n                    }\n                    let duration = \"\";\n                    if (_duration && !moment(_duration).isValid()) {\n                        duration = `\u6301\u7eed\u65f6\u95f4\u4e3a${_duration}`;\n                        for (const [unit, text] of durationUnits) {\n                            duration = duration.replace(unit, text);\n                        }\n                        duration = `<span title=\"${_duration}\">${duration}</span>`;\n                        if (endTime !== \"-\") {\n                            endTime = `${duration}<br>${endTime}`;\n                        } else {\n                            endTime = duration;\n                        }\n                    }\n                    const blocklogevent = blocklogeventTemplate.clone();\n                    blocklogevent.attr(\"data-user\", user);\n                    [\n                        `<span title=\"${timestamp}\">${moment(timestamp).format(\"YYYY[\u5e74]M[\u6708]D[\u65e5 (]dd[)<br>]HH[:]mm[:]ss\").replace(nowYear, \"\")}</span>`,\n                        `<a href=\"/User:${user}\" class=\"mw-userlink\" title=\"User:${user}\"><bdi>${user}</bdi></a><span class=\"usergroup\"></span><br><span class=\"mw-usertoollinks\">\uff08<a href=\"/User_talk:${user}\" class=\"mw-usertoollinks-talk\" title=\"User talk:${user}\">\u8ba8\u8bba</a> | <a href=\"/Special:%E7%94%A8%E6%88%B7%E8%B4%A1%E7%8C%AE/${user}\" class=\"mw-usertoollinks-contribs\" title=\"Special:\u7528\u6237\u8d21\u732e/${user}\">\u8d21\u732e</a> | <a href=\"/Special:%E5%B0%81%E7%A6%81/${user}\" class=\"mw-usertoollinks-block\" title=\"Special:\u5c01\u7981/${user}\">\u5c01\u7981</a>\uff09</span>`,\n                        `<a href=\"/User:${target}\" class=\"mw-userlink\" title=\"User:${target}\"><bdi>${target}</bdi></a><br><span class=\"mw-usertoollinks\">\uff08<a href=\"/User_talk:${target}\" class=\"mw-usertoollinks-talk\" title=\"User talk:${target}\">\u8ba8\u8bba</a> | <a href=\"/Special:%E7%94%A8%E6%88%B7%E8%B4%A1%E7%8C%AE/${target}\" class=\"mw-usertoollinks-contribs\" title=\"Special:\u7528\u6237\u8d21\u732e/${target}\">\u8d21\u732e</a>\uff09</span>`,\n                        actions[action],\n                        endTime,\n                        flags ? flags.length > 0 ? `<ul class=\"blocklogevents-ul\">${flags.map(f => `<li class=\"blocklogevents-flags-${f}\" ${blocklogFlags[f] ? \"\" : `style=\"font-style: italic;\"`} title=\"${f}\">${blocklogFlags[f] || f}</li>`).join(\"\")}</ul>` : \"\uff08\u65e0\uff09\" : \"-\",\n                        (comment || \"\uff08\u65e0\uff09\") + (tags.length ? `\uff08<a href=\"/Special:%E6%A0%87%E7%AD%BE\" title=\"Special:\u6807\u7b7e\">${tags.length}\u4e2a\u6807\u7b7e</a>${tags.join(\"\u3001\")}\uff09` : \"\"),\n                        action === \"unblock\" ? \"-\" : `<span class=\"mw-logevent-actionlink\"><a href=\"/Special:%E8%A7%A3%E9%99%A4%E5%B0%81%E7%A6%81/${target}\" title=\"Special:\u89e3\u9664\u5c01\u7981/${target}\">\u89e3\u5c01</a> | <a href=\"/Special:%E5%B0%81%E7%A6%81/${target}\" title=\"Special:\u5c01\u7981/${target}\">\u66f4\u6539\u5c01\u7981</a></span>`,\n                    ].forEach((data, index) => {\n                        var cell = blocklogevent.children(\"td\").eq(index);\n                        cell.html(data);\n                        if ([\"-\", \"\uff08\u65e0\uff09\"].includes(data)) {\n                            cell.addClass(\"style-justify\");\n                        }\n                    });\n                    if (lastBlockLogIdFromLocalStorage !== -1 && logid > lastBlockLogIdFromLocalStorage) {\n                        blocklogevent.children().css(\"background-color\", \"#eef\").attr('title', '\u4e0a\u6b21\u67e5\u770b\u540e\u51fa\u73b0\u7684\u65b0\u7684\u5c01\u7981\u65e5\u5fd7');\n                    }\n                    if (logid > lastBlockLogIdFromBlockLogEvents) {\n                        lastBlockLogIdFromBlockLogEvents = logid;\n                    }\n                    blocklogeventsContainer.children(\"tbody\").append(blocklogevent);\n                });\n                if (nowDay === dayFlag && blocklogevents.length <= blockLogLengthFlag) {\n                    blocklogeventsContainerRoot.addClass(\"nothing-new\");\n                    blocklogeventsHead.find(\"caption\").append(\"[\u81ea\u4eca\u65e5\u4e0a\u6b21\u67e5\u770b\u4ee5\u6765\u65e0\u65b0\u7684\u8bb0\u5f55]\");\n                }\n                localStorage.setItem(\"AnnTools_Backlog_DayFlag\", nowDay);\n                localStorage.setItem(\"AnnTools_Backlog_blockLogLengthFlag\", blocklogevents.length + \"\");\n                if (lastBlockLogIdFromBlockLogEvents > lastBlockLogIdFromLocalStorage) {\n                    localStorage.setItem(\"AnnTools-backlog-lastBlockLogId\", lastBlockLogIdFromBlockLogEvents + \"\");\n                }\n                $(window).on(\"resize\", () => {\n                    blocklogeventsContainer.find(\"tr:first td\").each((index, ele) => {\n                        blocklogeventsHead.find(\"th\").eq(index).width($(ele).width());\n                    });\n                }).resize();\n                scrollFlag = true;\n            } else {\n                container.append(`<div style=\"text-align: center;\">\u6700\u8fd17\u5929\u5185\u65e0\u5c01\u7981\u8bb0\u5f55=\u3002=</div>`);\n            }\n        }\n        /* let aflend = localStorage.getItem(\"AnnTools-aflend\") || undefined;\n        if (!aflend || !moment(aflend).isValid()) {\n            aflend = undefined;\n        } */\n        const abuseLogQuest = {\n            action: \"query\",\n            format: \"json\",\n            list: \"abuselog\",\n            afllimit: 500,\n            aflprop: \"timestamp|user|action|filter|result|ids|title\",\n        };\n        /* if (aflend) {\n            abuseLogQuest.aflend = aflend;\n        } else {\n            abuseLogQuest.afllimit = \"10\";\n        } */\n        const abuseLogResult = await api.post(abuseLogQuest);\n        if (abuseLogResult && abuseLogResult.query && abuseLogResult.query.abuselog) {\n            const veryFirstAbuselogId = abuseLogResult.query.abuselog.slice(-1)[0].id;\n            const abuseLogAcceptedFlags = [\"block\", \"blockautopromote\", \"degroup\"];\n            const abuselogevents = abuseLogResult.query.abuselog.filter(({\n                result: _result,\n            }) => {\n                let result = false;\n                _result.split(\",\").forEach((tag) => {\n                    if (abuseLogAcceptedFlags.includes(tag)) {\n                        result = true;\n                    }\n                });\n                return result;\n            }).slice(-10);\n            container.append(\"<hr>\");\n            if (abuselogevents.length > 0) {\n                const abuselogFlags = {\n                    tag: \"\u6807\u7b7e\",\n                    block: `<span style=\"color: red;\">\u5c01\u7981</span>`,\n                    blockautopromote: `<span style=\"font-weight: bold;\">\u64a4\u9500\u81ea\u52a8\u786e\u8ba4</span>`,\n                    warn: \"\u8b66\u544a\",\n                    degroup: `<span style=\"font-weight: bold;\">\u4ece\u7528\u6237\u7ec4\u79fb\u9664</span>`,\n                    disallow: \"\u963b\u6b62\u8be5\u7f16\u8f91\",\n                };\n                const abuselogActions = {\n                    edit: \"\u7f16\u8f91\",\n                };\n                const lastAbuseLogIdFromLocalStorage = +(localStorage.getItem(\"AnnTools-backlog-lastAbuseLogId\") || \"-1\");\n                let lastAbuseLogIdFromAbuseLogEvents = -1;\n                const abuselogeventsContainerRoot = $(\"<div/>\");\n                container.append(abuselogeventsContainerRoot);\n                abuselogeventsContainerRoot.addClass(\"abuselogevents\");\n                const abuselogeventsHead = $(\"<table/>\");\n                abuselogeventsHead.addClass(\"wikitable abuselogevents-head abuselogevents-table\");\n                abuselogeventsHead.html(`<caption title=\"\u7b2c\u4e00\u6761\u65e5\u5fd7ID\uff1a${veryFirstAbuselogId}\">\u6700\u8fd1500\u6761\u6ee5\u7528\u65e5\u5fd7\u4e2d\u6700\u65b010\u6761\u5e26\u6709\u201c\u7981\u6b62\u81ea\u52a8\u6388\u6743\u3001\u4ece\u7528\u6237\u7ec4\u79fb\u9664\u3001\u5c01\u7981\u201d\u4e2d\u90e8\u5206\u6216\u5168\u90e8\u8bbe\u5b9a\u7684\u8fc7\u6ee4\u5668\u7684\u65e5\u5fd7 [<a id=\"expand-abuselogevents\">\u6269\u5c55/\u6536\u7f29\u5217\u8868</a>]</caption><tbody><tr><th>\u65f6\u95f4</th><th>\u7528\u6237</th><th>\u9875\u9762</th><th>\u64cd\u4f5c</th><th>\u8fc7\u6ee4\u5668</th><th>\u8fc7\u6ee4\u5668\u63cf\u8ff0</th><th>\u91c7\u53d6\u7684\u884c\u52a8</th><th>\u64cd\u4f5c</th></tr></body>`);\n                abuselogeventsContainerRoot.append(abuselogeventsHead);\n                const abuselogeventsContainer = $(\"<table/>\");\n                abuselogeventsContainer.addClass(\"wikitable abuselogevents-table\");\n                abuselogeventsContainer.html(\"<tbody></tbody>\");\n                abuselogeventsContainerRoot.append(abuselogeventsContainer);\n                mw.loader.addStyleTag(`.abuselogevents { overflow-x: hidden; overflow-y: scroll; max-height: 10em; padding: 0 0 1px 0; position: relative; } .abuselogevents.nothing-new { max-height: 1.5em; overflow-y: hidden; } .abuselogevents.expand { max-height: unset; overflow-y: unset; } .abuselogevents-head { position: sticky; z-index: 2; top: 0; left: 0; } .abuselogevents .abuselogevents-head caption { background-color: white; } .abuselogevents .abuselogevents-head th { background-color: #F6F6F6!important; } .abuselogevents-table { width: 100%; margin: 0 !important; } .abuselogevents .style-justify { white-space: nowrap; text-align: center; } .abuselogevents-ul { margin-top: 0; }`);\n                $(\"#expand-abuselogevents\").on(\"click\", () => {\n                    abuselogeventsContainerRoot.toggleClass(\"expand\");\n                    $(window).resize();\n                });\n                const abuselogeventTemplate = $(\"<tr/>\");\n                abuselogeventTemplate.html(`<td class=\"style-justify\"></td>`.repeat(8));\n                /* let lastTimestamp = moment(aflend || 0); */\n                abuselogevents.forEach(({\n                    action: _action,\n                    filter: description,\n                    filter_id,\n                    id,\n                    result: _result,\n                    timestamp,\n                    title,\n                    user,\n                }) => {\n                    /* const time = moment(timestamp);\n                    if (time.diff(lastTimestamp) > 0) {\n                        lastTimestamp = time;\n                    } */\n                    const action = abuselogActions[_action] || _action;\n                    const result = _result.split(\",\").map(r => abuselogFlags[r] || r);\n                    const abuselogevent = abuselogeventTemplate.clone();\n                    [\n                        `<span title=\"${timestamp}\">${moment(timestamp).format(\"YYYY[\u5e74]M[\u6708]D[\u65e5 (]dd[) ]HH[:]mm[:]ss\").replace(nowYear, \"\")}</span>`,\n                        `<a href=\"/User:${user}\" class=\"mw-userlink\" title=\"User:${user}\"><bdi>${user}</bdi></a><span class=\"mw-usertoollinks\">\uff08<a href=\"/User_talk:${user}\" class=\"mw-usertoollinks-talk\" title=\"User talk:${user}\">\u8ba8\u8bba</a> | <a href=\"/Special:%E7%94%A8%E6%88%B7%E8%B4%A1%E7%8C%AE/${user}\" class=\"mw-usertoollinks-contribs\" title=\"Special:\u7528\u6237\u8d21\u732e/${user}\">\u8d21\u732e</a> | <a href=\"/Special:%E5%B0%81%E7%A6%81/${user}\" class=\"mw-usertoollinks-block\" title=\"Special:\u5c01\u7981/${user}\">\u5c01\u7981</a>\uff09</span>`,\n                        `<a href=\"/${title}\" title=\"${title}\">${title}</a>`,\n                        `<span title=\"${_action}\">${action}</span<`,\n                        `<a href=\"/Special:%E6%BB%A5%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/${filter_id}\" title=\"Special:\u6ee5\u7528\u8fc7\u6ee4\u5668/${filter_id}\">\u8fc7\u6ee4\u5668${filter_id}</a>`,\n                        description,\n                        `<span title=\"${_result}\">${result.join(\"\u3001\")}</span>`,\n                        `<a href=\"/Special:%E6%BB%A5%E7%94%A8%E6%97%A5%E5%BF%97/${id}\" title=\"Special:\u6ee5\u7528\u65e5\u5fd7/${id}\">\u8be6\u60c5</a> | <a href=\"/Special:%E6%BB%A5%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/examine/log/${id}\" title=\"Special:\u6ee5\u7528\u8fc7\u6ee4\u5668/examine/log/${id}\">\u68c0\u67e5</a>`,\n                    ].forEach((data, index) => {\n                        var cell = abuselogevent.children(\"td\").eq(index);\n                        cell.html(data);\n                    });\n                    if (lastAbuseLogIdFromLocalStorage !== -1 && id > lastAbuseLogIdFromLocalStorage) {\n                        abuselogevent.children().css(\"background-color\", \"#eef\").attr('title', '\u4e0a\u6b21\u67e5\u770b\u540e\u51fa\u73b0\u7684\u65b0\u7684\u6ee5\u7528\u65e5\u5fd7');\n                    }\n                    if (id > lastAbuseLogIdFromAbuseLogEvents) {\n                        lastAbuseLogIdFromAbuseLogEvents = id;\n                    }\n                    abuselogeventsContainer.children(\"tbody\").append(abuselogevent);\n                });\n                if (nowDay === dayFlag && abuselogevents.length <= abuseLogLengthFlag) {\n                    abuselogeventsContainerRoot.addClass(\"nothing-new\");\n                    abuselogeventsHead.find(\"caption\").append(\"[\u81ea\u4eca\u65e5\u4e0a\u6b21\u67e5\u770b\u4ee5\u6765\u65e0\u65b0\u7684\u8bb0\u5f55]\");\n                }\n                localStorage.setItem(\"AnnTools_Backlog_DayFlag\", nowDay);\n                localStorage.setItem(\"AnnTools_Backlog_abuseLogLengthFlag\", abuselogevents.length + \"\");\n                if (lastAbuseLogIdFromAbuseLogEvents > lastAbuseLogIdFromLocalStorage) {\n                    localStorage.setItem(\"AnnTools-backlog-lastAbuseLogId\", lastAbuseLogIdFromAbuseLogEvents + \"\");\n                }\n                $(window).on(\"resize\", () => {\n                    abuselogeventsContainer.find(\"tr:first td\").each((index, ele) => {\n                        abuselogeventsHead.find(\"th\").eq(index).width($(ele).width());\n                    });\n                }).resize();\n                scrollFlag = true;\n                /* $(\"#abuselogevents-mark-as-readed\").on(\"click\", () => {\n                    lastTimestamp.add(1000);\n                    localStorage.setItem(\"AnnTools-aflend\", lastTimestamp.toISOString());\n                    $(\"#abuselogevents-mark-as-readed\").replaceWith(\"<span>\u8bbe\u7f6e\u6210\u529f</span>\");\n                    $(window).resize();\n                }); */\n            } else {\n                container.append(`<div style=\"text-align: center;\">\u65e0\u65b0\u7684\u6ee5\u7528\u65e5\u5fd7</div>`);\n            }\n        }\n        if (users.size !== 0) {\n            var sUsers = new Set();\n            systemUsers.forEach(systemUsers => {\n                if (users.has(systemUsers)) {\n                    users.delete(systemUsers);\n                    sUsers.add(systemUsers);\n                }\n            });\n            const _usersGroup = await api.post({\n                action: \"query\",\n                format: \"json\",\n                list: \"users\",\n                usprop: \"groupmemberships\",\n                ususers: Array.from(users).join(\"|\"),\n            });\n            if (_usersGroup && _usersGroup.query && _usersGroup.query.users) {\n                const usersGroup = _usersGroup.query.users;\n                sUsers.forEach(systemUsers => {\n                    usersGroup.push({\n                        name: systemUsers,\n                        groupmemberships: [\n                            {\n                                \"group\": \"system\",\n                                \"expiry\": \"infinity\",\n                            },\n                        ],\n                    });\n                });\n                const groupsIndex = Array.from(groups.keys());\n                usersGroup.forEach(({\n                    name: user,\n                    groupmemberships,\n                }) => {\n                    let group = [];\n                    let title = [];\n                    groupmemberships.sort(({ group: a }, { group: b }) => groupsIndex.indexOf(a) - groupsIndex.indexOf(b));\n                    groupmemberships.forEach(({\n                        group: _group,\n                        expiry: _expiry,\n                    }) => {\n                        title.push(_group);\n                        if (groups.has(_group)) {\n                            const groupText = $(\"<span/>\");\n                            groupText.text(groups.get(_group));\n                            if (_expiry !== \"infinity\") {\n                                const popup = $(\"<a/>\");\n                                const expiry = moment(_expiry).format(\"YYYY[\u5e74]M[\u6708]D[\u65e5 (]dd[)]HH[:]mm[:]ss\").replace(nowYear, \"\");\n                                popup.text(\"\u671f\u9650\").attr(\"href\", \"javascript:void(0);\");\n                                popup.on(\"click\", () => {\n                                    alert(`\u7528\u6237${user}\u7684\u7528\u6237\u7ec4${groups.get(_group)}\u6709\u6548\u671f\u81f3${expiry}`);\n                                });\n                                const popupContainer = $(\"<sup/>\");\n                                popupContainer.append(popup);\n                                groupText.append(popupContainer);\n                            }\n                            group.push(groupText);\n                        }\n                    });\n                    if (group.length === 0) {\n                        group.push(\"\u65e0\");\n                    }\n                    const injectTarget = $(`.need-usergroup[data-user=\"${user}\"] .usergroup`);\n                    injectTarget.attr(\"title\", title.join(\", \")).append(\"[\");\n                    group.forEach((value, index) => {\n                        if (index !== 0) {\n                            injectTarget.append(\"\u3001\");\n                        }\n                        injectTarget.append(value);\n                    });\n                    injectTarget.append(\"]\");\n                });\n                $(window).resize();\n            }\n        }\n        if (scrollFlag) {\n            $(\"html,body\").animate({\n                scrollTop: $(\"#mw-content-text\").offset().top,\n            }, 730);\n        }\n        $(\"#Anntools-backlog-loading\").remove();\n        if (mw.config.exists(\"useravatar\")) {\n            mw.config.get(\"useravatar\")();\n            $(window).resize();\n        }\n        mw.hook(\"wikipage.content\").fire($(\"#__anntools__inject__\"));\n        $(window).on({\n            focus: () => {\n                $(window).resize();\n            },\n            blur: () => {\n                $(window).resize();\n            },\n        });\n    };\n    $(() => {\n        run().catch((reason) => {\n            if (reason instanceof Error) {\n                $(\"#__anntools__inject__\").css({\n                    \"border\": \"2px solid rgb(0, 0, 0)\",\n                    \"margin\": \"14px 40px 10px\",\n                    \"padding\": \"10px 15px\",\n                    \"background-color\": \"rgb(254, 237, 232)\"\n                }).html(\"<p>\u65e5\u5fd7\u67e5\u6838\u5de5\u5177\u53d1\u751f\u9519\u8bef\uff1a</p><dl><dt>\u9519\u8bef\u7c7b\u578b\uff1a</dt><dd>\" + reason.name + \"</dd><dt>\u9519\u8bef\u4fe1\u606f\uff1a</dt><dd><pre>\" + reason.message + \"</pre></dd></dl>\");\n            } else {\n                $(\"#__anntools__inject__\").css({\n                    \"border\": \"2px solid rgb(0, 0, 0)\",\n                    \"margin\": \"14px 40px 10px\",\n                    \"padding\": \"10px 15px\",\n                    \"background-color\": \"rgb(254, 237, 232)\"\n                }).html(\"<p>\u65e5\u5fd7\u67e5\u6838\u5de5\u5177\u53d1\u751f\u9519\u8bef\uff1a</p><pre>\" + JSON.stringify(reason, null, 4) + \"</pre>\");\n            }\n        });\n    });\n} catch (e) {\n    $(\"#__anntools__inject__\").css({\n        \"border\": \"2px solid rgb(0, 0, 0)\",\n        \"margin\": \"14px 40px 10px\",\n        \"padding\": \"10px 15px\",\n        \"background-color\": \"rgb(254, 237, 232)\"\n    }).html(\"<p>\u65e5\u5fd7\u67e5\u6838\u5de5\u5177\u53d1\u751f\u9519\u8bef\" + ([\"ReferenceError\", \"SyntaxError\", \"TypeError\"].includes(e.name) ? \"\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u4f60\u7684\u6d4f\u89c8\u5668\u7248\u672c\u8fc7\u4f4e\uff0c\u8bf7\u5c1d\u8bd5\u66f4\u65b0\u81f3\u6700\u65b0\u7248 Google Chrome\" : \"\") + \"\uff1a</p><dl><dt>\u9519\u8bef\u7c7b\u578b\uff1a</dt><dd>\" + e.name + \"</dd>+<dt>\u9519\u8bef\u4fe1\u606f\uff1a</dt><dd>\" + e.message + \"</dd></dl>\");\n}\n// </pre>"}}}