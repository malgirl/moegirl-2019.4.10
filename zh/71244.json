{"parse":{"title":"User:AnnAngela/js/watchlist-log.js","pageid":119581,"wikitext":{"*":"// <pre>\n/* global mediaWiki */\n(function (mw) {\n    mw.loader.implement('AnnToolsWatchlistLog', function ($, jQuery) {\n        function containAny( /* arguments desu */) {\n            var list, text, matchWholeWordOnly, index, _index, _length, _object;\n            for (index in arguments) {\n                _object = arguments[index], text = _object.text, matchWholeWordOnly = _object.matchWholeWordOnly || false, list = _object.list, _length = list.length;\n                for (_index = 0; _index < _length; _index++) {\n                    if (matchWholeWordOnly === true ? text === list[_index] : text.includes(list[_index])) {\n                        return true;\n                    }\n                }\n            }\n        }\n        var dayFlag = +localStorage.getItem('AnnTools-watch-log-dayFlag') || -1,\n            lengthFlag = +localStorage.getItem('AnnTools-watch-log-lengthFlag') || -1,\n            myUserName = mw.config.get('wgUserName'),\n            nowDay, logLength;\n        $('.mw-special-Watchlist .mw-changeslist li').each(function () {\n            if ($(this).find('.botedit')[0] || //\u673a\u5668\u4eba\u7f16\u8f91\n                containAny(\n                    {\n                        text: decodeURIComponent($(this).find('a')[0].href), //\u65e5\u5fd7\u9875\u9762\n                        list: ['/Special:\u65e5\u5fd7'],\n                    }, {\n                        text: $(this).find('.comment').text(), //\u7f16\u8f91\u6458\u8981\u5185\u5bb9\u6807\u660e\u4e3a\u7279\u6b8a\u64cd\u4f5c\n                        list: ['\u6587\u672c\u66ff\u6362 - \u66ff\u6362\u300c'],\n                    }, {\n                        text: $(this).find('.mw-tag-markers').text(), //\u6709\u7279\u6b8a\u7f16\u8f91\u6807\u7b7e\n                        list: [\n                            'Welcome to MoegirlPedia',\n                            '\u5feb\u901f\u5b58\u6863\u8ba8\u8bba\u4e32'\n                        ],\n                    }, {\n                        text: $(this).find('.mw-title').text(), //\u9875\u9762\u540d\u79f0\u8868\u660e\u4e3a\u91cd\u8981\u9875\u9762\n                        list: [\n                            'Template:\u4eba\u7269\u4fe1\u606f',\n                            'Template:\u7528\u6237\u4fe1\u606f',\n                            'Template:\u6b4c\u66f2\u4fe1\u606f',\n                            'Template:\u97f3\u6e38\u66f2\u4fe1\u606f',\n                            'Template:Navbox',\n                            'Template:\u7528\u6237 \u840c\u5a18\u767e\u79d1\u7684\u82e6\u529b',\n                            'Template:\u58f0\u4f18\u4fe1\u606f\u200e',\n                        ],\n                        matchWholeWordOnly: true, //\u4e0d\u5305\u542b\u5b50\u9875\u9762\n                    }, {\n                        text: $(this).find('.mw-title').text(), //\u9875\u9762\u540d\u79f0\u8868\u660e\u4e3a\u91cd\u8981\u9875\u9762\n                        list: [\n                            '\u840c\u5a18\u767e\u79d1:',\n                            'MediaWiki:',\n                        ],\n                    }\n                )\n            ) {\n                $(this).addClass('mw-watchlist-log');\n                if ($(this).find('.mw-userlink').text() === myUserName) $(this).addClass('mw-watchlist-my-log');\n            }\n        });\n        if ($('.mw-watchlist-log')[0]) {\n            $(document.head).append('<style>.mw-special-Watchlist .mw-watchlist-log{border:1px dashed #aaa;background-color:#f9f9f9}.mw-special-Watchlist .mw-changeslist h3 span,.mw-special-Watchlist .mw-changeslist h4 span{float:right;cursor:pointer;color:#0645ad;font-weight:normal}.mw-special-Watchlist .mw-changeslist h3 span:before,.mw-special-Watchlist .mw-changeslist h4 span:before{content:\"[\";color:black}.mw-special-Watchlist .mw-changeslist h3 span:after,.mw-special-Watchlist .mw-changeslist h4 span:after{content:\"]\";color:black}</style>');\n            $('.mw-special-Watchlist .mw-changeslist li a').removeAttr('tabindex');\n            $('.mw-special-Watchlist .mw-changeslist .special').each(function () {\n                var self = $(this),\n                    time = self.prev().text();\n                self.attr('data-time', time);\n                if (self.find('.mw-watchlist-log')[0]) {\n                    if (!$('.mw-special-Watchlist .mw-changeslist')[1]) $('.mw-special-Watchlist .mw-changeslist').before('<div class=\"mw-changeslist\"/>');\n                    if (!$('.mw-special-Watchlist .mw-changeslist:first h4[data-time=\"' + time + '\"]')[0]) $('.mw-special-Watchlist .mw-changeslist:first').append('<h4 data-time=\"' + time + '\">' + time + '</h4><ul data-time=\"' + time + '\"/>');\n                    self.find('.mw-watchlist-log').attr('class', 'mw-watchlist-log').appendTo('.mw-special-Watchlist .mw-changeslist:first ul[data-time=\"' + time + '\"]').find('.mw-rollback-link').remove();\n                }\n            });\n            $('.mw-special-Watchlist .mw-changeslist').each(function (index) {\n                if (index !== 0) $(this).prepend('<h3>\u9875\u9762</h3>');\n                else {\n                    var self = $(this);\n                    self.prepend('<h3>\u65e5\u5fd7</h3>');\n                    self.find('h3').append($('<span>', {\n                        attr: {\n                            'data-hidden': 'true',\n                        },\n                        click: function () {\n                            if ($(this).attr('data-hidden') === 'true') {\n                                $(this).attr('data-hidden', 'false').text('\u9690\u85cf');\n                                self.find('ul').each(function () {\n                                    if ($(this).is(':hidden')) $(this).fadeIn().prev().find('span').text('\u9690\u85cf');\n                                });\n                            } else {\n                                $(this).attr('data-hidden', 'true').text('\u663e\u793a');\n                                self.find('ul').each(function () {\n                                    if (!$(this).is(':hidden')) $(this).fadeOut().prev().find('span').text('\u663e\u793a');\n                                });\n                            }\n                        },\n                        text: '\u663e\u793a',\n                    }));\n                    self.find('h4').each(function (index) {\n                        var needHidden = false;\n                        if (index === 0) {\n                            nowDay = +$(this).attr('data-time').split(/[\\D]/g)[2];\n                            logLength = $('.mw-changeslist ul:first li:not(.mw-watchlist-my-log)').length;\n                            if (dayFlag && dayFlag === nowDay && lengthFlag >= logLength) needHidden = true;\n                            localStorage.setItem('AnnTools-watch-log-dayFlag', nowDay);\n                            localStorage.setItem('AnnTools-watch-log-lengthFlag', logLength);\n                        } else {\n                            needHidden = true;\n                        }\n                        var next = $(this).next();\n                        $(this).append($('<span>', {\n                            click: function () {\n                                if (next.css('display') === 'none') {\n                                    next.fadeIn();\n                                    $(this).text('\u9690\u85cf');\n                                } else {\n                                    next.fadeOut();\n                                    $(this).text('\u663e\u793a');\n                                }\n                            },\n                            text: function () {\n                                if (needHidden) {\n                                    next.hide();\n                                    return '\u663e\u793a';\n                                } else {\n                                    next.show();\n                                    return '\u9690\u85cf';\n                                }\n                            },\n                        }));\n                    });\n                }\n            });\n\n            var redirectLink = {};\n            $('.mw-changeslist:first li').each(function () {\n                if ($(this).find('a:first').attr('href') === \"/Special:%E6%97%A5%E5%BF%97/move\" && $(this).text().includes(\"\u4e0d\u7559\u91cd\u5b9a\u5411\")) {\n                    $(this).children('a.new').not('.mw-userlink').each(function () {\n                        var title = mw.util.getParamValue('title', decodeURI(this.href));\n                        if (Object.keys(redirectLink).indexOf(title) === -1) redirectLink[title] = $(this).next('a').attr('href');\n                    });\n                }\n            });\n            $('.mw-changeslist:last a.new').each(function () {\n                var title = mw.util.getParamValue('title', decodeURI(this.href));\n                if (Object.keys(redirectLink).indexOf(title) !== -1) $(this).attr({\n                    href: redirectLink[title],\n                    title: title + '\uff08\u5df2\u88ab\u91cd\u5b9a\u5411\u81f3 ' + decodeURIComponent(redirectLink[title].substring(1)) + ' \uff09',\n                }).removeClass('new').after($('<sup/>', {\n                    text: '[\u91cd\u5b9a\u5411]',\n                    css: {\n                        'font-size': 'smaller',\n                        'vertical-align': 'super',\n                        color: '#0645ad',\n                        cursor: 'pointer',\n                    },\n                    title: '\uff08\u5df2\u88ab\u91cd\u5b9a\u5411\u81f3 ' + decodeURIComponent(redirectLink[title].substring(1)) + ' \uff09',\n                }).on('click', function () {\n                    alert('\u672c\u9875\u9762\u5df2\u4ece\\n    ' + title + '\\n\u91cd\u5b9a\u5411\u5230\\n    ' + decodeURIComponent(redirectLink[title].substring(1)));\n                }));\n            });\n        }\n    });\n})(mediaWiki);\n// </pre>"}}}