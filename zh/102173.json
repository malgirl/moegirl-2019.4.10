{"parse":{"title":"MediaWiki:Gadget-colortoggle.js","pageid":169325,"wikitext":{"*":"var dropMenu = $('<div id=\"p-colorconv\" role=\"navigation\" class=\"vectorMenu\" aria-labelledby=\"p-colorconv-label\" style=\"background: linear-gradient(rgba(255,255,255,0),#fff);\"><h3 id=\"p-colorconv-label\" tabindex=\"0\"><span data-color=\"yellow\" style=\"padding:1px 3px;margin-left: 0.7em;margin-top: 1.375em;\">\u989c\u8868\u7acb</span><a href=\"#\" tabindex=\"-1\"></a></h3><div class=\"menu\"><ul></ul></div></div>');\n\nfunction cachedFactory(factory) {\n\tvar cache = {};\n\treturn function(key) {\n\t\tif (!(key in cache)) {\n\t\t\tcache[key] = factory(key);\n\t\t}\n\t\treturn cache[key];\n\t};\n}\n\nvar colorToRgba = (function() {\n\tvar canvas = $('<canvas>')[0];\n\tcanvas.width = canvas.height = 1;\n\tvar ctx = canvas.getContext('2d');\n\n\treturn cachedFactory(function(col) {\n\t\tctx.clearRect(0, 0, 1, 1);\n\t\tctx.fillStyle = col;\n\t\tctx.fillRect(0, 0, 1, 1);\n\t\tvar ret = $.makeArray(ctx.getImageData(0, 0, 1, 1).data);\n\t\tret[3] /= 255;\n\t\treturn ret;\n\t});\n})();\n\nfunction rgbaToColor(color) {\n\tif (color.length === 3) {\n\t\treturn 'rgb(' + color[0] + ',' + color[1] + ',' + color[2] + ')';\n\t} else {\n\t\treturn 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\n\t}\n}\n\nfunction luminance(color) {\n\tvar output = [];\n\tfor (var i = 0; i < 3; i++) {\n\t\tvar c = color[i] / 255;\n\t\tif (c <= 0.03928) output[i] = c / 12.92;\n\t\telse output[i] = Math.pow((c + 0.055) / 1.055, 2.4);\n\t}\n\treturn 0.2126 * output[0] + 0.7152 * output[1] + 0.0722 * output[2];\n}\n\nfunction contrastRatio(c1, c2) {\n\tvar l1 = luminance(c1) + 0.05;\n\tvar l2 = luminance(c2) + 0.05;\n\tif (l1 > l2) {\n\t\treturn l1 / l2;\n\t} else {\n\t\treturn l2 / l1;\n\t}\n}\n\nfunction hslToRgb(color) {\n\tvar h = color[0],\n\t\ts = color[1],\n\t\tl = color[2];\n\tvar r, g, b;\n\n\tif (s === 0) {\n\t\tr = g = b = l;\n\t} else {\n\t\tvar hue2rgb = function hue2rgb(p, q, t) {\n\t\t\tif (t < 0) t += 1;\n\t\t\tif (t > 1) t -= 1;\n\t\t\tif (t < 1 / 6) return p + (q - p) * 6 * t;\n\t\t\tif (t < 1 / 2) return q;\n\t\t\tif (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;\n\t\t\treturn p;\n\t\t};\n\n\t\tvar q = l < 0.5 ? l * (1 + s) : l + s - l * s;\n\t\tvar p = 2 * l - q;\n\t\tr = hue2rgb(p, q, h + 1 / 3);\n\t\tg = hue2rgb(p, q, h);\n\t\tb = hue2rgb(p, q, h - 1 / 3);\n\t}\n\n\treturn [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];\n}\n\nfunction rgbToHsl(color) {\n\tvar r = color[0] / 255,\n\t\tg = color[1] / 255,\n\t\tb = color[2] / 255;\n\tvar max = Math.max(r, g, b),\n\t\tmin = Math.min(r, g, b);\n\tvar h, s, l = (max + min) / 2;\n\n\tif (max == min) {\n\t\th = s = 0; // achromatic\n\t} else {\n\t\tvar d = max - min;\n\t\ts = l > 0.5 ? d / (2 - max - min) : d / (max + min);\n\t\tswitch (max) {\n\t\t\tcase r:\n\t\t\t\th = (g - b) / d + (g < b ? 6 : 0);\n\t\t\t\tbreak;\n\t\t\tcase g:\n\t\t\t\th = (b - r) / d + 2;\n\t\t\t\tbreak;\n\t\t\tcase b:\n\t\t\t\th = (r - g) / d + 4;\n\t\t\t\tbreak;\n\t\t}\n\t\th /= 6;\n\t}\n\n\treturn [h, s, l];\n}\n\nvar white = colorToRgba('#f6f6f6');\n\nvar lessBrightColor = cachedFactory(function(colortxt) {\n\tvar rgb = colorToRgba(colortxt);\n\tvar lum = contrastRatio(rgb, white);\n\tif (lum >= 2) {\n\t\treturn colortxt;\n\t}\n\tvar hsl = rgbToHsl(rgb);\n\tdo {\n\t\thsl[2] -= 0.02;\n\t\trgb = hslToRgb(hsl);\n\t} while (contrastRatio(rgb, white) < 2);\n\treturn rgbaToColor(rgb);\n});\n\nvar highContrastColor = cachedFactory(function(colortxt) {\n\tvar rgb = colorToRgba(colortxt);\n\tvar lum = contrastRatio(rgb, white);\n\tif (lum >= 3) {\n\t\treturn colortxt;\n\t}\n\tvar hsl = rgbToHsl(rgb);\n\tdo {\n\t\thsl[2] -= 0.02;\n\t\trgb = hslToRgb(hsl);\n\t} while (contrastRatio(rgb, white) < 3);\n\treturn rgbaToColor(rgb);\n});\n\nfunction black(span) {\n\tspan.css('color', 'black');\n\tspan.css('background-color', '');\n\tspan.css('text-shadow', '');\n}\n\nfunction lowBrightness(span) {\n\tvar color = lessBrightColor(span.attr('data-color'));\n\tspan.css('color', color);\n\tspan.css('background-color', '');\n\tspan.css('text-shadow', '');\n}\n\nfunction highContrast(span) {\n\tvar color = highContrastColor(span.attr('data-color'));\n\tspan.css('color', color);\n\tspan.css('background-color', '');\n\tspan.css('text-shadow', '');\n}\n\nfunction original(span) {\n\tspan.css('color', span.attr('data-color'));\n\tspan.css('background-color', '');\n\tspan.css('text-shadow', '');\n}\n\nfunction originalWBackground(span) {\n\tvar color = span.attr('data-color');\n\tspan.css('color', color);\n\tif (contrastRatio(white, colorToRgba(color)) < 3) {\n\t\tspan.css('background-color', '#3D3D3D');\n\t} else {\n\t\tspan.css('background-color', '');\n\t}\n\tspan.css('text-shadow', '');\n}\n\nfunction originalWShadow(span) {\n\tvar color = span.attr('data-color');\n\tspan.css('color', color);\n\tif (contrastRatio(white, colorToRgba(color)) < 3) {\n\t\tspan.css('text-shadow', 'black 0 0 0.2em, black 0 0 0.2em, black 0 0 0.2em');\n\t} else {\n\t\tspan.css('text-shadow', '');\n\t}\n\tspan.css('background-color', '');\n}\n\nfunction makeOption(caption, style) {\n\tvar item = $('<li id=\"ca-colorconv-0\"><a>' + caption + '</a></li>');\n\tdropMenu.find('ul').append(item);\n\titem.click(function() {\n\t\tdropMenu.find('.selected').removeClass('selected');\n\t\titem.addClass('selected');\n\t\tlocalStorage.colorconv = style;\n\t\tapplyStyle(style);\n\t});\n}\n\nfunction applyStyle(style) {\n\t$('[data-color]').each(function(i, obj) {\n\t\tvar item = $(obj);\n\t\tstyles[style](item);\n\t});\n}\n\nvar styles = {\n\t'black': black,\n\t'lowBrightness': lowBrightness,\n\t'highContrast': highContrast,\n\t'original': original,\n\t'originalWBackground': originalWBackground,\n\t'originalWShadow': originalWShadow\n};\n\nmakeOption('\u9ed1\u8272', 'black');\nmakeOption('\u8f83\u9ad8\u5bf9\u6bd4\u5ea6', 'lowBrightness');\nmakeOption('\u9ad8\u5bf9\u6bd4\u5ea6', 'highContrast');\nmakeOption('\u539f\u8272', 'original');\nmakeOption('\u539f\u8272+\u80cc\u666f', 'originalWBackground');\nmakeOption('\u539f\u8272+\u9634\u5f71', 'originalWShadow');\n\n$(function() {\n\t$('#left-navigation').append(dropMenu);\n\tapplyStyle(localStorage.colorconv || 'lowBrightness');\n});"}}}