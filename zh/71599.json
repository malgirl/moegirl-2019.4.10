{"parse":{"title":"User:D41D8CD98F/FlowThreadPreview.js","pageid":172405,"wikitext":{"*":"// [[MediaWiki:Gadget-FlowThreadPreview.js]]\u7684\u4fee\u6539\u7248\n// \u76f8\u6bd4\u4e8e\u539f\u7248\uff0c\u505a\u51fa\u7684\u6539\u52a8\uff1a\n// * \u6539\u6b63BUG\n// * ext.flowthread \u4f1a\u5728\u5355\u51fb\u67d0\u6761\u8bc4\u8bba\u7684\u56de\u590d\u6309\u94ae\u65f6\u52a8\u6001\u6784\u9020\u56de\u590d\u6846\uff0c\u9632\u6b62\u5176\u5f71\u54cd\u539f\u6709\u529f\u80fd\u3002\u5982\u679c\u6d4f\u89c8\u5668\u652f\u6301\uff0c\u4e5f\u4e3a\u8fd9\u79cd\u56de\u590d\u6846\u4e5f\u52a0\u4e0a\u9884\u89c8\n// * \u66b4\u9732 wgFlowThreadPreviewExportedFunctions = {addPreviewButton,doPreview} \u7ed9\u5916\u90e8\uff0c\u574f\u5904\u662f\u6c61\u67d3\u5168\u5c40\u7a7a\u95f4\uff0c\u597d\u5904\u662f\u5916\u90e8\u53ef\u4ee5\u81ea\u884c\u9009\u62e9\u8c03\u7528\u9884\u89c8\u51fd\u6570\uff08\u6dfb\u52a0\u9884\u89c8\u6309\u94ae\u3001\u6267\u884c\u9884\u89c8\u64cd\u4f5c\uff09\u7684\u65f6\u673a\n// * \u66b4\u9732 wgFlowThreadPreviewConfig \u4f5c\u4e3a\u53ef\u9009\u7684\u8bbe\u7f6e\u53c2\u6570\n// * \u8c03\u6574\u6837\u5f0f\u3002\u4e0d\u518d\u624b\u52a8\u8c03\u6574\u8bc4\u8bba\u9884\u89c8\u6846\u7684\u9ad8\u5ea6\n// * \u5728\u627e\u4e0d\u5230\u56de\u590d\u6846\u7684\u65f6\u5019\u4f1a\u5c1d\u8bd5\u52a0\u8f7d ext.flowthread \u7136\u540e\u91cd\u8bd5\n\nwindow.wgFlowThreadPreviewConfig = window.wgFlowThreadPreviewConfig || {};\n\n(function() {\n    if ($('#flowthreadPreviewBox')[0]) return;\n    \n    var exportFunction = window.wgFlowThreadPreviewConfig.exportFunction === false ? false : true,\n        useDefaultStyle = window.wgFlowThreadPreviewConfig.useDefaultStyle === false ? false : true,\n        useExtFlowthread = window.wgFlowThreadPreviewConfig.useExtFlowthread === false ? false : true,\n        autoAddPreviewBTN = window.wgFlowThreadPreviewConfig.autoAddPreviewBTN === false ? false : true,\n        previewBoxTemplate = window.wgFlowThreadPreviewConfig.previewBoxTemplate || '<div id=\"flowthreadPreviewBox\" style=\"margin-left:calc((99vw - 600px)/2);height:auto;\"><div id=\"flowthreadPreviewBoxTitle\" style=\"padding:20px 10px 0 10px;\"><div id=\"flowthreadPreviewBoxTitleContent\">\u8bc4\u8bba\u9884\u89c8<span id=\"flowthreadPreviewBoxCloseButton\">\u00d7</span></div></div><div id=\"flowthreadPreviewBoxContent\"><div id=\"flowthreadPreviewBoxContentHTML\" style=\"position:relative;top:0;margin:0 10px 20px 10px;\"></div><div id=\"flowthreadPreviewBoxContentLoading\"><img src=\"/extensions/FancyBoxThumbs/modules/fancyBox/source/fancybox_loading.gif\"/>\u6b63\u5728\u52a0\u8f7d\u4e2d\u2026\u2026</div></div></div>',\n        previewButtonTemplate = window.wgFlowThreadPreviewConfig.previewButtonTemplate || '<button class=\"comment-submit comment-preview\" style=\"right:99px\">\u9884\u89c8</button>';\n        matchedBlacklistTemplate = window.wgFlowThreadPreviewConfig.matchedBlacklistTemplate || '<hr /><div><div style=\"color: red;\">\u68c0\u6d4b\u5230\u8bc4\u8bba\u5185\u5bb9\u547d\u4e2d\u8fc7\u6ee4\u89c4\u5219\uff1a</div><ol style=\"font-family: monospace;\" class=\"comment-matched-rules\"></ol><div style=\"color:red;\">\u8bf7\u4fee\u6539\u8bc4\u8bba\u5185\u5bb9\uff01</div><div>\u4ee5\u4e0a\u89c4\u5219\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u5b9a\u4e49\uff0c\u5982\u679c\u60a8\u4e0d\u6e05\u695a\uff0c\u5c31\u4e0d\u8981\u5728\u610f\u4e86\u3002</div></div>';\n    \n    if (!exportFunction && !autoAddPreviewBTN) {\n        console && console.error(\"User:D41D8CD98F/FlowThreadPreview: \" +\n                                 \"Neither exportFunction nor autoAddPreviewBTN is set. \" +\n                                 \"Can't do anything useful! \");\n        return;\n    }\n    \n    if (useExtFlowthread && !mw.config.exists('canpost')) return;\n    \n    if (useDefaultStyle)\n        mw.loader.load('/index.php?title=MediaWiki:Gadget-FlowThreadPreview.css&action=raw&ctype=text/css', 'text/css');\n    \n    var box = $(previewBoxTemplate),\n        button = $(previewButtonTemplate),\n        err = $(matchedBlacklistTemplate),\n        rules = [];\n    function bindFunc() {\n        var replybox = $(this).closest('.comment-replybox'),\n            button = replybox.find('.comment-preview'),\n            checkbox = replybox.find('.comment-toolbar input:checkbox'),\n            textarea = replybox.find('textarea');\n        if (checkbox.is(':checked') && textarea.val() !== '') {\n            button.data('disable', false).css({\n                'opacity': '1',\n                'cursor': 'pointer'\n            });\n        } else {\n            button.data('disable', true).css({\n                'opacity': '0.73',\n                'cursor': 'not-allowed'\n            });\n        }\n    }\n    function addPreviewButton(replybox) {\n        replybox = replybox || $('.comment-replybox');\n        \n        var r = replybox.filter(':not(:has(.comment-preview))');\n        if (r.length !== 0)\n            button.clone(true).appendTo(r.find('.comment-toolbar'));\n        replybox.find('.comment-toolbar input:checkbox').on('click.D4.FlowThreadPreview', bindFunc);\n        replybox.find('textarea').on('input.D4.FlowThreadPreview',bindFunc);\n        bindFunc.call(replybox);\n    }\n    function autoAddPreviewButton() {\n        var MutationObserver = window.MutationObserver || window.WebKitMutationObserver;\n        addPreviewButton();\n        if (MutationObserver) {\n            var observer = new MutationObserver(function(mutationRecords) {\n                mutationRecords.forEach(function(rec) {\n                    var replybox = $(rec.addedNodes).filter('.comment-replybox');\n                    if (replybox.length === 0) return;\n                    addPreviewButton(replybox);\n                });\n            });\n            observer.observe($('.comment-container')[0], {childList: true, subtree: true});\n        }\n    }\n    function doPreview(event, box) {\n        if ($(this).data('disable')) return false;\n        \n        box = box || $('#flowthreadPreviewBox');\n        \n        var text = $(this).closest('.comment-replybox').find('textarea').val();\n        \n        if (box.is(':visible')) {\n            box.find('#flowthreadPreviewBoxContentLoading').fadeIn(370);\n            box.find('#flowthreadPreviewBoxContentHTML').fadeOut(370);\n        } else {\n            box.fadeIn(370);\n        }\n        function error(text) {\n            box.find('#flowthreadPreviewBoxContentLoading').fadeOut(370);\n            box.find('#flowthreadPreviewBoxContentHTML').text(text).fadeIn(370);\n        }\n        $.ajax({\n            url: '/api.php',\n            type: \"POST\",\n            data: {\n                action: 'parse',\n                format: 'json',\n                formatversion: 2,\n                text: text,\n                prop: 'text',\n                preview: true,\n                contentformat: 'text/x-wiki',\n                contentmodel: 'wikitext'\n            },\n            success: function(data) {\n                if (data.parse && data.parse.text) {\n                    var html = data.parse.text,\n                        e = [];\n                    box.find('#flowthreadPreviewBoxContentLoading').fadeOut(370);\n                    box.find('#flowthreadPreviewBoxContentHTML').html(html);\n                    rules.forEach(function(v) {\n                        if (v.test(text)) e.push(v);\n                    });\n                    if (e[0]) {\n                        e.forEach(function(v, i) {\n                            e[i] = v.toString().slice(1, -1);\n                        });\n                        err.find('.comment-matched-rules').html('<li>' + e.join('</li><li>') + '</li>');\n                        box.find('#flowthreadPreviewBoxContentHTML').append(err);\n                    }\n                    box.find('#flowthreadPreviewBoxContentHTML').fadeIn(370);\n                } else if (data.error && data.error.info) error('\u840c\u767e\u670d\u52a1\u5668\u8fd4\u56de\u4e00\u4e2a\u9519\u8bef\uff1a' + data.error.info);\n                else error('');\n            },\n            error: function(eO, eM, eC) {\n                eC ? eC += '.' + eM : eC = eM;\n                error('\u548c\u840c\u767e\u670d\u52a1\u5668\u901a\u4fe1\u5931\u8d25\uff0c\u65e0\u6cd5\u83b7\u53d6\u9884\u89c8\u5185\u5bb9\uff01\\n\u9519\u8bef\u4fe1\u606f\uff1a' + eC);\n            }\n        });\n    }\n    \n    box.appendTo('body');\n    $.get('/index.php?title=MediaWiki:Flowthread-blacklist&action=raw', function(data) {\n        var lines = data.split('\\n');\n        lines.forEach(function(v, i) {\n            var length = v.indexOf('#') === -1 ? v.length : v.indexOf('#'),\n                regexp = v.slice(0, length).trim();\n            if (regexp) rules.push(RegExp(regexp));\n        });\n    });\n    button.on('click.D4.FlowThreadPreview', doPreview);\n    box.find('#flowthreadPreviewBoxCloseButton').on('click.D4.FlowThreadPreview', function() {\n        box.fadeOut(370).delay(370).queue(function() {\n            box.find('#flowthreadPreviewBoxContentLoading').show();\n            box.find('#flowthreadPreviewBoxContentHTML').empty();\n            $(this).dequeue();\n        });\n    });\n    if (exportFunction) {\n        window.wgFlowThreadPreviewExportedFunctions = {\n            addPreviewButton: addPreviewButton,\n            doPreview: doPreview,\n        };\n    }\n    if (autoAddPreviewBTN) {\n        if (!$('.comment-replybox')[0]) {\n            if (useExtFlowthread)\n                $(function(){mw.loader.using('ext.flowthread').done(autoAddPreviewButton)});\n        } else {\n            autoAddPreviewButton();\n        }\n    }\n})();"}}}