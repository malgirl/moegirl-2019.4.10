{"parse":{"title":"\u6a21\u5757:Unsubst","pageid":197882,"wikitext":{"*":"local p = {}\n\nlocal specialParams = {\n\t['$N'] = 'template name',\n\t['$B'] = 'template content',\n}\n\np[''] = function ( frame )\n\tif not frame:getParent() then\n\t\terror( '{{#invoke:Unsubst|unsubst}} makes no sense without a parent frame' )\n\tend\n\tfor k, v in pairs( specialParams ) do\n\t\tif not frame.args[k] then\n\t\t\terror( '{{#invoke:Unsubst|unsubst}} requires parameter ' .. k .. ' (' .. v .. ')' )\n\t\tend\n\tend\n\t\n\tif mw.isSubsting() then\n\t\t---- substing\n\t\t-- Combine passed args with passed defaults\n\t\tlocal args = {}\n\t\tfor k, v in pairs( frame.args ) do\n\t\t\tif not specialParams[k] then\n\t\t\t\tif v == '__DATE__' then\n\t\t\t\t\tv = mw.getContentLanguage():formatDate( 'Y\u5e74n\u6708' )\n\t\t\t\tend\n\t\t\t\targs[k] = v\n\t\t\tend\n\t\tend\n\t\tfor k, v in pairs( frame:getParent().args ) do\n\t\t\targs[k] = v\n\t\tend\n\n\t\t-- Now, build an equivalent template invocation\n\t\t-- First numbered args, then named\n\t\tlocal ret = '{{' .. frame.args['$N']\n\t\tfor k, v in ipairs( args ) do\n\t\t\tif string.find( v, '=', 1, true ) then\n\t\t\t\t-- likely something like 1=foo=bar, we need to do it as a named arg\n\t\t\t\tbreak\n\t\t\tend\n\t\t\tret = ret .. '|' .. v\n\t\t\targs[k] = nil\n\t\tend\n\t\tfor k, v in pairs( args ) do\n\t\t\tret = ret .. '|' .. k .. '=' .. v\n\t\tend\n\t\t\n\t\treturn ret .. '}}'\n\telse\n\t\t---- Not substing\n\t\t-- Just return the \"body\"\n\t\treturn frame.args['$B']\n\tend\nend\n\nreturn p"}}}