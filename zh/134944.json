{"parse":{"title":"\u6a21\u5757:CollectCodeData","pageid":307280,"wikitext":{"*":"local module = {}\n\nlocal getArgs = require('Module:Arguments').getArgs\nlocal getCode = require('Module:GetPageCode')\nlocal array = require('Module:Var-array')\n\nfunction _main(args, frame)\n\tlocal pages = mw.text.split(args['pages'] or args[1] or '', '\uff0c')\n\tif #pages == 1 and pages[1] == '' then error('\u5fc5\u987b\u4f20\u5165\u81f3\u5c11\u4e00\u4e2a\u9875\u9762\u540d\uff01') end\n\tlocal ptns = args['ptns'] or args[2]\n\tlocal filter = array.get(args['filter']) or {}\n\tif ptns == nil then error('\u5fc5\u987b\u4f20\u5165\u6b63\u5219\u8868\u8fbe\u5f0f\uff01') end\n\tlocal split = args['split'] or args[3] or '\uff0c'\n\tif string.find(ptns, '^/.+/$') then\n\t\tptns = { (string.gsub(ptns, '^/(.+)/$', '%1')) } \n\telse\n\t\tptns = array.get(ptns)\n\tend\n\t\n\tlocal contents = ''\n\tfor i, v in ipairs(pages) do\n\t\tlocal content = getCode(v)\n\t\tif content == nil then\n\t\t\terror('\u9875\u9762\u3010'..v..'\u3011\u6216\u5b83\u6240\u6307\u5411\u7684\u9875\u9762\u672a\u521b\u5efa\u6216\u65e0\u6548\uff01')\t\n\t\tend\n\t\tcontents = contents..content\n\tend\n\t\n\tlocal result = {}\n\tfor i, v in ipairs(ptns) do\n\t\tmw.ustring.gsub(contents, v, function(...)\n\t\t\tlocal ss = { ... }\n\t\t\tfor i, v in ipairs(ss) do\n\t\t\t\tresult[#result + 1] = v\t\n\t\t\tend\n\t\tend)\n\tend\n\t\n\tif type(filter[1]) == 'string' then\n\t\tfor i, v in ipairs(result) do\n\t\t\tresult[i] = mw.ustring.gsub(v, filter[1], filter[2] or '')\n\t\tend\t\t\t\n\telse\n\t\tfor i, ptn in ipairs(filter) do\n\t\t\tfor ind, val in ipairs(result) do\n\t\t\t\tresult[ind] = mw.ustring.gsub(val, ptn[1], ptn[2] or '')\n\t\t\tend\n\t\tend\n\tend\n\t\n\tlocal resultStr = ''\n\tfor i, v in ipairs(result) do\n\t\tresultStr = resultStr..v..split\t\n\tend\n\t\n\tsplit = string.gsub(split, '([%%%(%)%.%+%-%*%?%[%]%^%$])', '%%%1')\n\treturn (string.gsub(resultStr, '^(.+)'..split..'$', '%1'))\nend\n\nfunction module.main(frame)\n\tlocal args = getArgs(frame)\n\treturn _main(args, frame)\nend\n\nreturn module"}}}