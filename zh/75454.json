{"parse":{"title":"User:\u6771\u6771\u541b/js/notification.js","pageid":284276,"wikitext":{"*":"/*\n\t\u5f15\u5165\u8fd9\u4e2a\u63d2\u4ef6\u540e\uff0c\u5c06\u5728\u76d1\u89c6\u5217\u8868\u7684\u6761\u76ee\u53d1\u751f\u53d8\u5316\u4ee5\u53ca\u6536\u5230\u5404\u79cd\u4fe1\u606f\u65f6\u5728\u5c4f\u5e55\u7684\u53f3\u4e0b\u89d2\u8fdb\u884c\u901a\u77e5\uff0c\u83b7\u53d6\u901a\u77e5\u5e76\u4e0d\u9700\u8981\u5237\u65b0\u9875\u9762\u3002\n\t\u56e0\u4e3a\u4f7f\u7528\u4e86Web Notification\u53d1\u9001\u901a\u77e5\uff0c\u5373\u4f7f\u7f51\u9875\u5904\u4e8e\u6536\u8d77\u6216\u88ab\u906e\u6321\u7b49\u672a\u88ab\u6d4f\u89c8\u7684\u72b6\u6001\uff0c\u53ea\u8981\u4fdd\u6301\u5f00\u542f\uff0c\u5c31\u53ef\u4ee5\u6536\u5230\u901a\u77e5\u3002\n\t\u6b63\u5e38\u60c5\u51b5\u4e0b\uff1a\u901a\u77e5\u7684\u5de6\u8fb9\u663e\u793a\u4ea7\u751f\u52a8\u4f5c\u7684\u7528\u6237\u7684\u5934\u50cf\uff0c\u53f3\u8fb9\u4e3a\u4fe1\u606f\uff0c\u70b9\u51fb\u901a\u77e5\u53ef\u4ee5\u8fdb\u5165\u5bf9\u5e94\u7684\u6761\u76ee\u9875\u9762\u3002\n\t\u533a\u522b\u4e8e\u6761\u76ee\u53d8\u5316\u7684\u901a\u77e5\uff0c\u4fe1\u606f\u7684\u901a\u77e5\uff08\u5982\u611f\u8c22\uff0c\u8bc4\u8bba\u56de\u590d\u7b49\uff09\u4f1a\u6301\u7eed\u8f83\u957f\u7684\u65f6\u95f4\u3002\n\t\n\t\u5728\u4f7f\u7528\u8fd9\u4e2a\u63d2\u4ef6\u65f6\uff0c\u3010\u8bf7\u52a1\u5fc5\u5728\u6388\u4e88\u6743\u9650\u65f6\u70b9\u51fb\u5141\u8bb8\u3011\uff0c\u56e0\u4e3a\u4e00\u4e9b\u5957\u58f3\u6d4f\u89c8\u5668\uff08\u5982360\u6781\u901f\uff09\u5c06\u7f51\u9875\u6743\u9650\u754c\u9762\u9690\u85cf\u4e86\u8d77\u6765\uff0c\u5982\u679c\u70b9\u4e86\u963b\u6b62\uff0c\n\t\u60f3\u8981\u518d\u6539\u56de\u6765\u4f1a\u975e\u5e38\u9ebb\u70e6\uff0c\u82e5\u5df2\u7ecf\u70b9\u51fb\u4e86\u963b\u6b62\uff0c\u53ef\u4ee5\u70b9\u51fburl\u680f\u5de6\u8fb9\u7684\u5c0f\u9501\u6807\u5fd7\uff0c\u5982\u679c\u6709\u66f4\u6539\u901a\u77e5\u6743\u9650\u7684\u5730\u65b9\u8bf7\u66f4\u6539\uff0c\u6ca1\u6709\u5c31\u53ea\u80fd\u9009\u62e9\u653e\u5f03\u8be5\u63d2\u4ef6\u4e86\u3002\n\t\u63d2\u4ef6\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u5b8c\u5168\u5bf9\u5e94\u901a\u77e5\uff0c\u53ea\u662f\u8d77\u5230\u4e00\u4e2a\u8f85\u52a9\u63d0\u9192\u7684\u4f5c\u7528\uff0c\u5b8c\u5168\u51c6\u786e\u4ee5\u53ca\u6761\u76ee\u53d8\u5316\u7684\u5177\u4f53\u4fe1\u606f\u8bf7\u8ba4\u51c6\u76d1\u89c6\u5217\u8868\u9875\u9762\u3002\n\t\n\t\u6ce8\u610f\uff1a\u5728\u7f51\u7edc\u6709\u6ce2\u52a8\u65f6\uff08\u8868\u73b0\u4e3a\u840c\u767e\u7684\u7f51\u9875\u5f00\u542f\u7f13\u6162\uff09\uff0c\u63d2\u4ef6\u53ef\u80fd\u4e0d\u4f1a\u6b63\u5e38\u5de5\u4f5c\u3002\n*/\n\n$(function(){\n    if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)){\n        return false\n    }\n\n    function nct(nct, url, life){\n        var life = life || 8000\n        if(url){ nct.onclick = function(){ open(url, '_blank') } }\n        nct.addEventListener('click', function(){\n            setTimeout(function(){\n                nct.close()\n            })\n        }, 500)\n        setTimeout(function(){\n            nct.close()\n        }, life)\n    }\n\n\tfunction setCookie(cname,cvalue,GMTStr){\n        var expires = \"expires=\"+GMTStr;\n        document.cookie = cname + \"=\" + cvalue + \"; \" + expires;\n      }\n      \n    function getCookie(cname){\n        var name = cname + \"=\";\n        var ca = document.cookie.split(';');\n        for(var i=0; i<ca.length; i++) \n        {\n            var c = ca[i].trim();\n            if (c.indexOf(name)==0) return c.substring(name.length,c.length);\n        }\n        return \"\";\n    }\n    \n    function serviceToken(flag){\n    \tvar flag = flag || false\n\t\tvar d = new Date()    \t\n    \tif(flag){\n\t\t\td.setTime(d.getTime() + (2 * 60 * 1000))\n\t\t\tsetCookie('widget-notification-serviceOn', 'true', d.toGMTString())        \t\t\n    \t}else{\n    \t\td.setTime(d.getTime() - 1)\n    \t\tsetCookie('widget-notification-serviceOn', '', d.toGMTString())\n    \t}\n    }\n\n\tfunction isObjectValueEqual(a, b) {\n        var aProps = Object.getOwnPropertyNames(a);\n        var bProps = Object.getOwnPropertyNames(b);\n\n        if (aProps.length != bProps.length) {\n            return false;\n        }\n\n        for (var i = 0; i < aProps.length; i++) {\n            var propName = aProps[i];\n            if (a[propName] !== b[propName]) {\n                return false;\n            }\n        }\n        return true;\n    }\n\n    if(typeof Notification == 'undefined'){\n        mw.notify('\u4f60\u7684\u6d4f\u89c8\u5668\u7248\u672c\u8fc7\u4f4e\u6216\u4e0d\u652f\u6301\u67d0\u4e9b\u529f\u80fd\uff0c\u65e0\u6cd5\u4f7f\u7528Web Notification\u63d2\u4ef6\uff01', { type : 'warn' })\n        setTimeout(function(){\n            mw.notify('\u8bf7\u4ece\u4f60\u7684\u7528\u6237\u9875\u79fb\u9664\u8be5\u63d2\u4ef6\uff0c\u4ee5\u6d88\u9664\u8fd9\u4e9b\u8b66\u544a\uff01', { type : 'warn' }); \n        }, 2000)\n        return false\n    }\n    \n    if(Notification.permission == 'default'){\n        alert('\u70b9\u51fb\u786e\u5b9a\u5173\u95ed\u8fd9\u6761\u6d88\u606f\u540e\uff0c\u5c06\u5f39\u51fa\u6388\u4e88\u901a\u77e5\u6743\u9650\u7684\u7a97\u53e3\uff0c\u5c4a\u65f6\u8bf7\u70b9\u51fb\u201c\u5141\u8bb8\u201d\uff0c\u4ee5\u4fdd\u8bc1\u63d2\u4ef6\u7684\u6b63\u5e38\u8fd0\u884c\u3002')\n    }\n    \n    Notification.requestPermission(function(){\n        var status = Notification.permission\n        if(status == 'granted'){\n            if(! localStorage.getItem('widget-notification-messageMark')){\n                localStorage.setItem('widget-notification-messageMark', 'true')\n                nct(new Notification('\u6b22\u8fce', {\n                    body : '\u60a8\u5df2\u7ecf\u6210\u529f\u5f00\u542f\u901a\u77e5\u529f\u80fd\uff0c\u6b22\u8fce\u4f7f\u7528\uff01',\n                    icon : 'https://static.mengniang.org/common/d/d1/%E5%A4%A7%E8%90%8C%E5%AD%97.png'\n                }))\n            }\n        }\n        if(status == 'denied'){\n            alert('\u60a8\u672a\u80fd\u6b63\u786e\u6388\u4e88\u901a\u77e5\u6743\u9650\uff0c\u82e5\u8981\u7ee7\u7eed\u4f7f\u7528\uff0c\u8bf7\u5728url\u680f\u5de6\u4fa7\u70b9\u51fb\u5c0f\u9501\u6807\u5fd7\u5f00\u542f\u6743\u9650\uff0c\u82e5\u65e0\u6cd5\u8bbe\u7f6e\uff0c\u8bf7\u4ece\u4f60\u7684\u7528\u6237\u9875\u5220\u53bb\u6b64\u63d2\u4ef6\u3002')\n        }\n    })\n\n\tvar api = new mw.Api()\n\n    var userName = ''\n    api.get({\n        \"action\": \"query\",\n        \"format\": \"json\",\n        \"meta\": \"userinfo\",\n        \"utf8\": 1\n    }).done(function(data){\n        userName = data.query.userinfo.name\n    })\n\n    var pages = []\n    var pagesStr = ''\n    var apiContinue = null\n    function getWatch(){\n        var request = {\n            \"action\": \"query\",\n            \"format\": \"json\",\n            \"list\": \"watchlistraw\",\n            \"utf8\": 1,\n            \"wrlimit\": \"max\"\n        }\n        if(apiContinue){\n            request.wrcontinue = apiContinue.wrcontinue\n            request.continue = apiContinue.continue\n        }else{\n            delete request.wrcontinue\n            delete request.continue\n        }\n        api.get(request).done(function(data){\n            apiContinue = data.continue\n            var watch = data.watchlistraw\n            $.each(watch, function(){\n                if(this.title != 'User talk:' + userName){\n                    pages.push(this.title)\n                }\n            })\n            pagesStr = pages.join('|')\n            localStorage.setItem('widget-notification-watchList', pagesStr)\n            apiContinue && getWatch()\n        })\n    }\n\n    if(location.href == encodeURIComponent('https://zh.moegirl.org/Special:\u7f16\u8f91\u76d1\u89c6\u5217\u8868')){\n    \tif(/\u5df2\u4ece\u60a8\u7684\u76d1\u89c6\u5217\u8868\u79fb\u9664%d{1,2}\u4e2a\u6807\u9898/.test($('#mw-content-text').text())){\n    \t\tpages = []\n    \t\tgetWatch()\n    \t}\n    }\n\n\tfunction setWatch(act){\n\t\tvar act = act || 'push'\n\t\tvar watch = localStorage.getItem('widget-notification-watchList').split('|')\n\t\tvar thisTitle = location.href.replace(/https:\\/\\/zh\\.moegirl\\.org\\/(.+)$/, '$1')\n\t\tif(/(index\\.php|action=edit)/.test(thisTitle)){\n\t\t\tthisTitle = thisTitle.replace(/.*title=(.+?)(&.+|$)/, '$1')\n\t\t}\n\t\tthisTitle = decodeURIComponent(thisTitle)\n\t\tvar talkTitle  = 'Talk:' + thisTitle\n\t\tvar npRE = /(Template|\u840c\u5a18\u767e\u79d1|\u6a21\u5757|User|Help):(.+)/\n\t\tif(npRE.test(thisTitle)){\n\t\t\tvar prefix = thisTitle.replace(npRE, '$1')\n\t\t\tvar name = thisTitle.replace(npRE, '$2')\n\t\t}\n\t\tif(/(Template|\u840c\u5a18\u767e\u79d1|User|Help)/.test(prefix)){\n\t\t\ttalkTitle = prefix + ' talk:' + name \n\t\t}\n\t\tif(prefix == '\u6a21\u5757'){\n\t\t\ttalkTitle = '\u6a21\u5757\u8ba8\u8bba:' + name\n\t\t}\n\t\tif(act == 'push'){\n\t\t\tvar flag = true\n\t\t\t$.each(watch, function(){\n\t\t\t\tif(this == thisTitle || this == talkTitle){ flag = false }\n\t\t\t})\n\t\t\tflag && watch.push(thisTitle, talkTitle)\n\t\t}\n\t\t(act == 'remove') && $.each(watch, function(i){\n\t\t\tif(this == thisTitle || this == talkTitle){\n\t\t\t\twatch[i] = ''\n\t\t\t}\n\t\t})\n\t\t\n\t\tvar watchStr = watch.join('|')\n\t\tlocalStorage.setItem('widget-notification-watchList', watchStr)\n\t}\n\n    $('#ca-watch, #ca-unwatch').mousedown(function(){\n    \t(this.id.toLowerCase() == 'ca-watch') && setWatch()\n    \t;(this.id.toLowerCase() == 'ca-unwatch') && setWatch('remove')\n    })\n    $('#mw-editpage-watch').mouseup(function(){\n    \t$('#wpWatchthis').is(':checked') ? setWatch('remove') : setWatch()   // \u6b64\u5904\u83b7\u5f97\u4e86false\u4e3a\u9009\u4e2d\uff0ctrue\u4e3a\u672a\u9009\u4e2d\n    })\n    \n    getCookie('widget-notification-serviceOn') != 'true' && main()\n    var watchdogKey = setInterval(function(){\n        if(getCookie('widget-notification-serviceOn') != 'true'){\n            main()\n            clearInterval(watchdogKey)\n        }\n    }, 5000 + Math.random())\n\n\n\tfunction main(){\n\t\tconsole.log('notification.js\u5df2\u5f00\u542f\u670d\u52a1\uff0c\u5f00\u59cb\u8fdb\u884c\u6d88\u606f\u4e0e\u76d1\u89c6\u5217\u8868\u7684\u901a\u77e5\u63a8\u9001\u3002')\n\t\tserviceToken(true)\n\t\t;(function serviceStart(){\n\t\t\tsetTimeout(function(){\n\t\t\t\tserviceToken(true)\n\t\t\t\tserviceStart()\n\t\t\t}, 60 * 1000)\n\t\t})()\n\t\t\n\t\t$(window).on('unload', function(){\n\t\t\tserviceToken()\n\t\t})\n\t\n        if(! getCookie('widget-notification-removeTime')){\n            var d = new Date()\n            d.setTime(d.getTime()+(24*60*60*1000))\n            setCookie('widget-notification-removeTime', d.toGMTString(), d.toGMTString())\n        }\n        \n        ;(function(){\n            function getTimeISO8061(){\n                var fun = function(num){\n                    return num < 10 ? '0' + num : num\n                }\n                var time = new Date()\n                var y = time.getUTCFullYear(),\n                m = fun(time.getUTCMonth() + 1),\n                d = fun(time.getUTCDate()),\n                h = fun(time.getUTCHours()),\n                i = fun(time.getUTCMinutes()),\n                s = fun(time.getUTCSeconds())\n                var timeStr = y + '-' + m + '-' + d + 'T' + h + ':' + i + ':' + s + 'Z'\n                return timeStr\n            }\n            \n            setTimeout(function(){\n            \tgetWatch()\n            \tconsole.log('notification.js:\u5df2\u83b7\u53d6\u76d1\u89c6\u5217\u8868')\n            }, 30000)\n            \n            var lastSearchTime = getTimeISO8061()\n            setInterval(function(){\n                var usedStr = getCookie('widget-notification-usedIds')\n                if(usedStr){\n                    var used = usedStr.split('|')\n                }else{\n                    var used = []\n                }\t\t\n                \n                var rcidsStr = getCookie('widget-notification-rcids')\n                if(rcidsStr){\n                \tvar rcids = rcidsStr.split('|')\n                }else{\n                \tvar rcids = []\n                }\n                \n                var memoryTime = getCookie('widget-notification-lastSearchTime')\n                if(memoryTime){\n                    lastSearchTime = memoryTime\n                }\n                api.get({\n                    action: 'query',\n                    format: 'json',\n                    prop: '',\n                    list: 'recentchanges',\n                    rcend : lastSearchTime,\n                    rclimit: 'max',\n                    utf8: 1,\n                    formatversion: 1,\n                    rctoponly: 1,\n                    rcexcludeuser: userName,\n                    rcprop: 'title|user|comment|ids'\n                }).done(function(data){\n                    var d = new Date()\n                    d.setTime(d.getTime()+(30*60*1000))\t    \t\n                    setCookie('widget-notification-lastSearchTime', getTimeISO8061(), d.toGMTString())\n                    var query = data.query.recentchanges\n                    var filter = []\n                    var pages = localStorage.getItem('widget-notification-watchList').split('|')\n                    $.each(query, function(){\n                        for(var i=0; i < pages.length; i++){\n                            if(this.title == pages[i]){\n                            \tvar flag = true\n                            \tfor(var j=0; j < filter.length; j++){\n                            \t\tif(isObjectValueEqual(this, filter[j])){\n                            \t\t\tflag = false\n                            \t\t}\n                            \t}\n                                flag && filter.push(this)\n                            }\n                        }\n                    })\n\t\t\t\t\t\n                    $.each(filter, function(){\n\t                    var mark = true\n\t                    for(var i=0; i < rcids.length; i++){\n\t                        if(this.rcids == rcids[i]){\n\t                            mark = false\n\t                        }\n\t                    }\t          \n\t                    \n                    \tif(mark){\n\t                    \tvar commentStr = '\u5728\u3010' + this.title + '\u3011\u4f5c\u51fa\u4e86\u7f16\u8f91\u3002'\n\t                        if(this.comment){\n\t                            this.comment = this.comment.replace('// Edit via Wikiplus', '')\n\t                            var chapterRE = /\\/\\* (.+?) \\*\\/([^\\/]*)/\n\t                            if(chapterRE.test(this.comment)){\n\t                                var chapter = this.comment.replace(chapterRE, '$1')\n\t                                var comment = this.comment.replace(chapterRE, '$2').replace(/[\\s]*(.+)[\\s]*/, '$1')\n\t                                if(chapter && (chapter != this.comment)){\n\t                                    commentStr += '\\n\u7ae0\u8282 \u2192 ' +  chapter\n\t                                }\n\t                                if(comment && (comment != this.comment)){\n\t                                    commentStr += '\\n\u6458\u8981\uff1a' + comment\n\t                                }\t        \t\t\t\n\t                            }else{\n\t                                commentStr += '\\n\u6458\u8981\uff1a' + this.comment.replace(/[\\s]*(.+)[\\s]*/, '$1')\n\t                            }\n\t        \n\t                        }\n\t                        nct(new Notification(this.user, {\n\t                            body : commentStr,\n\t                            icon : '//commons.moegirl.org/extensions/Avatar/avatar.php?user=' + this.user\n\t                        }), 'https://zh.moegirl.org/index.php?title=' + this.title + '&curid=' + this.pageid + '&diff=' + this.revid + '&oldid=' + this.old_revid)    \n\t                        console.log('\u7f16\u8f91\u8005\uff1a' + this.user + '\\n' + commentStr)\n                    \t\trcids.push(this.rcid)\n                    \t}\n\t                    var rcidsStr = rcids.join('|')\n\t                    setCookie('widget-notification-rcids', rcidsStr, getCookie('widget-notification-removeTime'))                        \n                    })\n                })\n        \n                api.get({\n                    action: \"query\",\n                    format: \"json\",\n                    prop: \"\",\n                    meta: \"notifications\",\n                    utf8: 1,\n                    notfilter: \"!read\",\n                    notlimit: \"max\"\n                }).done(function(data){\n                    var query = data.query.notifications.list\n                    $.each(query, function(){\n                        var msgNct = function(text, $this){\n                            nct(new Notification($this.agent.name + '\uff1a', {\n                                body : text,\n                                icon :'//commons.moegirl.org/extensions/Avatar/avatar.php?user=' + $this.agent.name,\n                                sticky : true\n                            }), 'https://zh.moegirl.org/' + $this.title.full, 9999999999)\n                            console.log($this.agent.name + '\uff1a' + text)\n                        }\n                        \n                        var mark = true\n                        for(var i=0; i < used.length; i++){\n                            if(this.id == used[i]){\n                                mark = false\n                            }\n                        }\n                        \n                        if(mark){\n                            switch(this.type){\n                                case 'edit-thank' : {\n                                    msgNct('\u5bf9\u60a8\u5728\u3010' + this.title.full + '\u3011\u7684\u7f16\u8f91\u8868\u793a\u4e86\u611f\u8c22\uff01', this)\n                                    break\n                                }\n                                case 'edit-user-talk' : {\n                                    msgNct('\u5728\u60a8\u7684\u8ba8\u8bba\u9875\u7559\u8a00\u4e86\u3002', this)\n                                    break\n                                }\n                                case 'flowthread_reply' : {\n                                    msgNct('\u56de\u590d\u4e86\u60a8\u5728\u3010' + this.title.full + '\u3011\u7684\u8bc4\u8bba\u3002', this)\n                                    break\n                                }\n                                case 'flowthread_userpage' : {\n                                    msgNct('\u5728\u60a8\u7684\u7528\u6237\u9875\u7559\u4e0b\u4e86\u8bc4\u8bba\u3002', this)\n                                    break\n                                }\n                                case 'flowthread_delete' : {\n                                \tnct(new Notification('\u901a\u77e5', {\n\t\t                                body : '\u60a8\u5728\u3010' + this.title.full + '\u3011\u4e0b\u7684\u8bc4\u8bba\u88ab\u5220\u9664\u4e86\u3002',\n\t\t                                icon : 'https://static.mengniang.org/common/d/d1/%E5%A4%A7%E8%90%8C%E5%AD%97.png',\n\t\t                                sticky : true\n\t\t                            }), 'https://zh.moegirl.org/' + this.title.full, 9999999999)\n\t\t                            console.log('\u8bc4\u8bba\u88ab\u5220\u9664\uff1a\u5728\u9875\u9762\u3010' + this.title.full + '\u3011\u4e0a')\n                                    break\n                                }\n                                case 'mention' : {\n                                \tmsgNct('\u5728\u3010' + this.title.full + '\u3011\u4e2d\u63d0\u5230\u4e86\u60a8\u3002', this)\n                                \tbreak\n                                }\n                            }\n                            used.push(this.id)\n                        }\n                    })\n                    var usedStr = used.join('|')\n                    setCookie('widget-notification-usedIds', usedStr, getCookie('widget-notification-removeTime'))\t\t\t\n                })\n        \n            }, 60000)\n            \n        })()\n\t\n\t}    \n})"}}}