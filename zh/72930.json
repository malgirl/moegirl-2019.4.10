{"parse":{"title":"User:Nzh21/js/QuickUndo.js","pageid":314812,"wikitext":{"*":"$(function () {\n    function undo(pageid, undoid, undoafter, ignoreabusefilter = true) {\n        ajaxdata = {\n            \"action\": \"edit\",\n            \"format\": \"json\",\n            \"pageid\": pageid,\n            \"summary\": '[[User:Nzh21/js/QuickUndo.js|\u5feb\u901f\u64a4\u9500]]\u4ece\u7248\u672c' + undoafter + '\u5230\u7248\u672c' + undoid + '\u7684[[Special:Diff/' + undoafter + '/' + undoid + '|\u6240\u6709\u7f16\u8f91]]',\n            \"undo\": undoid,\n            \"token\": mw.user.tokens.values.editToken,\n        };\n        if (undoafter) ajaxdata.undoafter = undoafter;\n        mw.notify('\u6b63\u5728\u64cd\u4f5c');\n        $.ajax({\n            type: \"POST\",\n            url: '/api.php',\n            data: ajaxdata,\n            success: function (data) {\n                if (data.edit && data.edit.result == 'Success') {\n                    if (data.edit.nochange != undefined) {\n                        mw.notify('\u8fd9\u6b21\u7f16\u8f91\u4f3c\u4e4e\u5df2\u88ab\u64a4\u9500\u3002');\n                    } else {\n                        mw.notify('\u5b8c\u6210');\n                        setTimeout(function () { window.open('/Special:Diff/' + data.edit.newrevid); }, 0);\n                    }\n                } else if (data.edit && data.edit.result == 'Failure' && data.edit.abusefilter && data.edit.abusefilter.actions.indexOf('warn') != -1 && ignoreabusefilter) {\n                    mw.notify('\u9047\u5230\u8fc7\u6ee4\u5668' + data.edit.abusefilter.id + '\uff08' + data.edit.abusefilter.description + '\uff09\uff0c\u5ffd\u7565\u8b66\u544a');\n                    setTimeout(function () { undo(pageid, undoid, undoafter, false) }, 0);\n                } else if (data.error && data.error.info == 'The edit could not be undone due to conflicting intermediate edits.') {\n                    mw.notify('\u56e0\u5b58\u5728\u51b2\u7a81\u7684\u4e2d\u95f4\u7f16\u8f91\uff0c\u672c\u7f16\u8f91\u4e0d\u80fd\u64a4\u9500\u3002');\n                } else {\n                    mw.notify('\u51fa\u73b0\u672a\u77e5\u9519\u8bef\uff0c\u4ee5\u4e0b\u662f\u9519\u8bef\u4fe1\u606f:'\n                        + JSON.stringify(data));\n                    console.log(JSON.stringify(data))\n                }\n            },\n            error: function () {\n                mw.notify('\u7f51\u7edc\u8fde\u63a5\u51fa\u9519');\n            }\n        })\n    }\n    if (mw.config.values.wgDiffNewId || mw.config.values.wgDiffOldId) {\n        $('.mw-diff-undo').each(function () {\n            this.innerHTML = this.innerHTML.replace(/\uff09$/, '/<a href=\"#.\" title = \"\u65e0\u9700\u786e\u5b9a\u5e76\u5ffd\u7565\u8fc7\u6ee4\u5668\u8b66\u544a\" class=\"quickundo_diff\">\u5feb\u901f\u64a4\u9500</a >\uff09')\n        });\n        $('a.quickundo_diff').each(function () {\n            this.onclick = function () {\n                undo(mw.config.values.wgArticleId, mw.config.values.wgDiffNewId, mw.config.values.wgDiffOldId);\n            }\n        });\n    }\n    if (mw.config.values.wgAction == 'history') {\n        $('.mw-history-undo').append('/<a href=\"#.\" title = \"\u65e0\u9700\u786e\u5b9a\u5e76\u5ffd\u7565\u8fc7\u6ee4\u5668\u8b66\u544a\" class=\"quickundo_history\">\u5feb\u901f\u64a4\u9500</a >');\n        $('a.quickundo_history').each(function () {\n            this.onclick = function () {\n                var href = $(this).parents('span.mw-history-undo').children('a:not(.quickundo_history)')[0].href;\n                var undoid = href.match(/undo=(\\d+)/)[1];\n                var undoafter = href.match(/undoafter=(\\d+)/)[1];\n                undo(mw.config.values.wgArticleId, undoid, undoafter);\n            }\n        });\n\n        var last_user = $('.history-user:first .mw-userlink:first')[0].href;\n        var undoafter = -1;\n        var times = 0;\n        $.each($('.history-user .mw-userlink'), function () {\n            if (this.href != last_user) {\n                undoafter = $(this).parents('li')[0].dataset.mwRevid;\n                return false;\n            } else {\n                times++;\n            }\n        });\n        var rollback = document.createElement('a');\n        rollback.innerText = '\u56de\u9000' + times + '\u6b21\u7684\u7f16\u8f91';\n        rollback.href = '#.';\n        rollback.onclick = function () {\n            undo(mw.config.values.wgArticleId, mw.config.values.wgCurRevisionId, undoafter);\n        }\n        $('#pagehistory li:first').append('[').append(rollback).append(']')\n    }\n    window.QucikDiffExtension = window.QucikDiffExtension || [];\n    window.QucikDiffExtension.push(function (that, data) {\n        $(that).find('#quickdiffcontent').prepend('<input class=\"quickundo_quickdiff\" title=\"\u67e5\u65e0\u9700\u786e\u5b9a\u5e76\u5ffd\u7565\u8fc7\u6ee4\u5668\u8b66\u544a\" type=\"submit\" value=\"\u5feb\u901f\u64a4\u9500\u6b64\u7f16\u8f91\">');\n        $(that).find('input.quickundo_quickdiff').each(function () {\n            this.onclick = function () {\n                undo(data.compare.fromid, data.compare.fromrevid, data.compare.torevid);\n            }\n        });\n    });\n});"}}}