{"parse":{"title":"User:AnnAngela/js/SendWelcomeMessage.js","pageid":107673,"wikitext":{"*":"/* global mediaWiki */\n//<pre> mw\u50bb\u903c\uff0c\u4e0d\u5199<pre/>\u4e09\u4e2a\u4ee5\u4e0a\u6ce2\u6d6a\u53f7\u5168\u90fd\u8981\u66ff\u6362\uff0c\u50bb\u5f97\u8981\u6b7b\n(function(mw) {\n    if (!String.prototype.includes) String.prototype.includes = function includes(search, start) {\n        'use strict';\n        if (typeof start !== 'number') start = 0;\n        if (start + search.length > this.length) return false;\n        return this.indexOf(search, start) !== -1;\n    };\n    mw.loader.implement('AnnToolsSendWelcomeMessage', function() {\n        var message = '{{Template:Welcome}} --[[User:\u840c\u767e\u5a18|\u840c\u767e\u5a18]]\uff08[[User talk:\u840c\u767e\u5a18|\u8ba8\u8bba]]\uff09~~~~~{{clear}}',\n            errorFun = function errorFun(_, self) {\n                unbindFun();\n                self.addClass('unsend');\n                return false;\n            },\n            unbindFun = function unbindFun() {\n                if ($('#welcomeClear').length > 0) $('#welcomeClear').remove();\n                $('#welcomeAsk').append('<span id=\"welcomeClear\">\u8fd4\u56de</span>');\n                $('#welcomeClear').on('click.welcome', function() {\n                    $('#welcomeAsk').remove();\n                });\n            };\n        if (mw.config.get('wgNamespaceIds').user_talk == mw.config.get('wgNamespaceNumber') && !mw.config.get('wgPageName').includes('/') && mw.config.get('wgEditMessage') == 'creating' && $('#wpTextbox1')[0] && !$('#wpTextbox1').val()) $('#wpTextbox1').val(message);\n\n        function check(that, onClick) {\n            if (!$(that).is('#mw-content-text a.new')) return;\n            if (!/(?=title\\=user\\_talk\\:)[^\\&]+/i.test(that.href)) return;\n            var self = $(that),\n                href = self.attr('href'),\n                userName = decodeURIComponent(href.match(/(?=user\\_talk\\:)[^\\&]+/i)[0].replace(/user_talk\\:/i, ''));\n            if (href.includes('User_talk') && href.includes('redlink=1') && href.includes('action=edit') && !userName.includes('/')) {\n                self.addClass('sendWelcomeMessageLink unsend nopopus').on('click.sendWelcomeMessage', function() {\n                    if ($('#welcomeAskFinished')[0]) $('#welcomeClear').click();\n                    if ($('#welcomeAsk')[0]) {\n                        self.after('<span class=\"welcomeAsk\">\u4e00\u6b21\u53ea\u80fd\u53d1\u9001\u4e00\u4efd\u6b22\u8fce\u8f9e\u54e6\uff0c\u4e0d\u8981\u592a\u8d2a\u5fc3\u4e86~<span id=\"welcomeClear2\">\u8fd4\u56de</span></span>');\n                        $('#welcomeClear2').on('click.welcome', function() {\n                            $(this).parent().remove();\n                        });\n                        return false;\n                    }\n                    if (/[&\\/]+/.test(userName)) {\n                        window.open(href, '_blank');\n                        return errorFun('\u5730\u5740\u89e3\u6790\u51fa\u9519\uff01\\n\u539f\u5730\u5740\uff1a' + href + '\uff0c\u89e3\u6790\u7528\u6237\u8ba8\u8bba\u9875\u6807\u9898\u7ed3\u679c\uff1aUser talk:' + userName, self);\n                    }\n                    self.removeClass('unsend').after('<span id=\"welcomeAsk\">\u4f60\u60f3\u76f4\u63a5\u53d1\u9001\u6b22\u8fce\u8f9e\u8fd8\u662f\u8bbf\u95ee\u8be5\u672a\u521b\u5efa\u9875\u9762\uff1f<span id=\"welcomeYes\">\u53d1\u9001\u6b22\u8fce\u8f9e</span> \u00b7 <span id=\"welcomeNo\">\u8bbf\u95ee\u8be5\u9875\u9762</span> \u00b7 <span id=\"welcomeClear\">\u8fd4\u56de</span></span>');\n                    $('#welcomeNo').on('click.welcome', function() {\n                        window.open(href, '_blank');\n                    });\n                    $('#welcomeClear').on('click.welcome', function() {\n                        $('#welcomeAsk').remove();\n                    });\n                    $('#welcomeYes').on('click.welcome', function() {\n                        var api = new mw.Api();\n                        $('#welcomeAsk').empty().append('\u6b63\u5728\u901a\u4fe1\u4e2d\u2026\u2026');\n                        api.postWithToken('csrf', {\n                            'action': 'edit',\n                            'format': 'json',\n                            'title': 'User talk:' + userName,\n                            'summary': 'Welcome to MoegirlPedia',\n                            'text': message,\n                            'tags': 'Welcome to MoegirlPedia',\n                            'createonly': true\n                        }).then(function(data) {\n                            $('#welcomeAsk').empty().append('<span id=\"welcomeAskFinished\">\u901a\u4fe1\u6210\u529f\uff01\u7ee7\u7eed\u52aa\u529b\u54e6~</span>');\n                            console.debug('\u548c\u840c\u767e\u670d\u52a1\u5668\u901a\u4fe1\u6210\u529f\uff0c\u7f16\u8f91\u6210\u529f\uff01 \\n\u7f16\u8f91\u8be6\u60c5\uff1a' + JSON.stringify(data).replace(/[{}\\\"]/g, '').replace(/\\:\\,/, ',') + '\u3002');\n                            unbindFun();\n                            $('#mw-content-text a.new[href=\"' + href + '\"]').removeClass('new sendWelcomeMessageLink unsend').attr('href', '/User_talk:' + userName).off('click.sendWelcomeMessage'); //js<a>\u5bf9\u8c61\u7684href\u662f\u7edd\u5bf9url\u2026\u2026\n                        }, function(f, s) {\n                            /*\n                             * \u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u9519\u8bef\u4ee3\u7801\uff0c\u5982\u679c\u662f\u8fde\u63a5\u9519\u8bef\u503c\u4e3ahttp\uff0c\u5982\u679c\u662f\u540e\u7aef\u9519\u8bef\u503c\u4e3aarticleexists\u7b49\uff1b\n                             * \u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f\u9519\u8bef\u4fe1\u606f\u5bf9\u8c61\uff0c\u5982\u679c\u662f\u8fde\u63a5\u9519\u8bef\u503c\u4e3a{ xhr: JQueryXHR, exception: String, textStatus: String }\uff0c\u5982\u679c\u662f\u540e\u7aef\u9519\u8bef\u503c\u4e3a\u540e\u7aef\u8fd4\u56de\u7684\u5185\u5bb9\uff1b\n                             * \u5982\u679c\u662f\u540e\u7aef\u9519\u8bef\uff0c\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e0e\u7b2c\u4e8c\u4e2a\u53c2\u6570\u76ee\u89c6\u4e00\u81f4\uff1b\n                             * \u5982\u679c\u662f\u540e\u7aef\u9519\u8bef\uff0c\u7b2c\u56db\u4e2a\u53c2\u6570\u5219\u662fjQueryXHR\u3002\n                             */\n                            console.debug('sendWelcomeMessage');\n                            console.debug.apply(console, arguments);\n                            if (f === 'internal_api_error_Exception') {\n                                $('#welcomeAsk').empty().append('<span id=\"welcomeAskFinished\">\u901a\u4fe1\u6210\u529f\uff01\u7ee7\u7eed\u52aa\u529b\u54e6~</span>');\n                                console.debug('\u548c\u840c\u767e\u670d\u52a1\u5668\u901a\u4fe1\u6210\u529f\uff0c\u7f16\u8f91\u6210\u529f\uff01 \\n\u840c\u767e\u670d\u52a1\u5668\u8fd4\u56de\"internal_api_error_Exception\"\uff0c\u4f60\u4eec\u90fd\u61c2\u7684_(\uff1a3 \u300d\u2220 )_ \u3002');\n                                unbindFun();\n                                $('#mw-content-text a.new[href=\"' + href + '\"]').removeClass('new sendWelcomeMessageLink unsend').attr('href', '/User_talk:' + userName).off('click.sendWelcomeMessage'); //js<a>\u5bf9\u8c61\u7684href\u662f\u7edd\u5bf9url\u2026\u2026\n                            } else if (f === 'articleexists') {\n                                $('#welcomeAsk').empty().append('<span id=\"welcomeAskFinished\">\u901a\u4fe1\u6210\u529f\uff01\u8be5\u8ba8\u8bba\u9875\u5df2\u7ecf\u5b58\u5728\uff0c\u8bf7\u6ce8\u610f\u54e6~</span>');\n                                errorFun('\u548c\u840c\u767e\u670d\u52a1\u5668\u901a\u4fe1\u6210\u529f\uff0c\u4f46\u7f16\u8f91\u5931\u8d25\uff01\\n\u7f16\u8f91\u8be6\u60c5\uff1a' + JSON.stringify(s).replace(/[{}\\\"]/g, '').replace(/\\:\\,/g, ','), self);\n                                unbindFun();\n                                $('#mw-content-text a.new[href=\"' + href + '\"]').removeClass('new sendWelcomeMessageLink unsend').attr('href', '/User_talk:' + userName).off('click.sendWelcomeMessage'); //js<a>\u5bf9\u8c61\u7684href\u662f\u7edd\u5bf9url\u2026\u2026\n                            } else {\n                                var reason = '';\n                                var object = s.error || s;\n                                for (var i in object) {\n                                    if (['*', 'xhr'].indexOf(i) !== -1) {\n                                        if (reason) reason += ', ';\n                                        reason += i + ': ' + JSON.stringify(object[i]).replace(/[{}\\\"]/g, '').replace(/\\:\\,/g, ',');\n                                    }\n                                }\n                                if (typeof f === 'string') reason = f + '\uff08' + reason + '. \uff09';\n                                else reason += '. ';\n                                $('#welcomeAsk').empty().append('<span id=\"welcomeAskFinished\">\u6b63\u5728\u901a\u4fe1\u4e2d\u2026\u2026\u5931\u8d25\uff01\u8bf7\u91cd\u8bd5\uff01\u3010 ' + reason + '\u3011</span>');\n                                errorFun('\u548c\u840c\u767e\u670d\u52a1\u5668\u901a\u4fe1\u6210\u529f\uff0c\u4f46\u7f16\u8f91\u5931\u8d25\uff01\\n\u7f16\u8f91\u8be6\u60c5\uff1a' + JSON.stringify(s).replace(/[{}\\\"]/g, '').replace(/\\:\\,/g, ','), self);\n                                unbindFun();\n                                self.addClass('unsend');\n                            }\n                        });\n                    });\n                    return false;\n                });\n                if (onClick) self.trigger('click.sendWelcomeMessage');\n                return false;\n            }\n        }\n        $(document.body).on('click', function(event) {\n            check(event.target, true);\n        });\n        $('#mw-content-text a.new').each(function() {\n            check(this);\n        });\n        $(\"<style>#welcomeAsk,.welcomeAsk{border:#bbeeff 1px solid;margin:0 3px 0 7px} #welcomeYes,#welcomeNo,#welcomeClear,#welcomeClear2{cursor:pointer;color:purple}.sendWelcomeMessageLink.unsend:after{content:'S';color:purple;line-height:1;vertical-align:super;font-size:smaller}.sendWelcomeMessageLink{text-decoration:none!important}</style>\").appendTo(\"head\");\n    });\n})(mediaWiki);\n//</pre>"}}}