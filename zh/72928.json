{"parse":{"title":"User:Nzh21/js/LyricsKaiEditor.js","pageid":320552,"wikitext":{"*":"/**\n * \u5728\u7f16\u8f91\u65f6\uff0c\u5bf9{{LyricsKai}}\u63d0\u4f9b\u4e00\u4e2a\u7f16\u8f91\u7a97\u53e3\uff0c\u539f\u6587\u4e0e\u7ffb\u8bd1\u5e76\u6392\u6392\u5217\uff0c\u518d\u8fdb\u884c\u7ffb\u8bd1\u7b49\u5de5\u4f5c\u65e0\u9700\u6eda\u52a8\u9875\u9762\u67e5\u770b\u539f\u6587\uff0c\u65b9\u4fbf\u7f16\u8f91\u3002\n * \u9ed8\u8ba4\u5339\u914d\u7b2c\u4e00\u4e2a\u51fa\u73b0\u4e2a\u7684{{LyricsKai}}\uff0c\u5982\u9700\u5339\u914d\u5176\u4ed6\u8bf7\u4f7f\u7528\u9f20\u6807\u9009\u4e2d\u76f8\u5e94\u4ee3\u7801\u3002\n * \u5f88\u53ef\u80fd\u6709bug\uff0c\u63d0\u4ea4\u524d\u8bf7\u9884\u89c8\u3002\n */\n$(function () {\n    if (mw.config.values.wgAction == \"edit\" || mw.config.values.wgAction == \"submit\") {\n        var btn = $('<li><a title=\"LyricsKai\u53ef\u89c6\u5316\u7f16\u8f91\">\u6b4c\u8bcd\u7f16\u8f91</a></li>');\n        btn.click(showLyricsKaiEditor);\n        $('#p-cactions ul').append(btn);\n    }\n\n    function showLyricsKaiEditor() {\n        var textbox = document.getElementById('wpTextbox1');\n        var regex = /(\\{\\{[Ll]yricsKai[\\s\\S]*?\\|original=)([\\s\\S]*?)(\\|translated=)([\\s\\S]*?)\\}\\}/;\n        var codeContent = '';\n        if (textbox.selectionStart == textbox.selectionEnd) {\n            codeContent = $(textbox).val();\n        } else {\n            codeContent = textbox.value.substring(textbox.selectionStart, textbox.selectionEnd);\n            if (!regex.test(codeContent)) {\n                mw.notify('\u6240\u9009\u4ee3\u7801\u6ca1\u6709LyricsKai\uff0c\u5c1d\u8bd5\u5728\u6240\u6709\u4ee3\u7801\u4e2d\u641c\u5bfb');\n                codeContent = $(textbox).val();\n            }\n        }\n        if (!regex.test(codeContent)) {\n            mw.notify('\u4ee3\u7801\u6ca1\u6709LyricsKai');\n        }\n        var original_str, translated_str;\n        [_, _, original_str, _, translated_str] = codeContent.match(regex);\n        var original = trim(original_str).split('\\n');\n        var translated = trim(translated_str).split('\\n');\n        var n = Math.max(original.length, translated.length);\n\n        var editor = $('<div />');\n        editor.css({\n            'overflow': 'auto',\n            'padding': '16px 24px 16px 24px',\n            'max-height': '100%',\n            'box-sizing': 'border-box',\n            'line-height': '1.6'\n        });\n        editor.addClass('Lyrics');\n        editor.addClass('Lyrics-no-ruby');\n        editor.append('<style data-mw-deduplicate=\"TemplateStyles:r2208000\">.Lyrics.Lyrics-has-ruby .Lyrics-original,.Lyrics.Lyrics-has-ruby .Lyrics-translated{line-height:2.1}.Lyrics.Lyrics-no-ruby .Lyrics-original,.Lyrics.Lyrics-no-ruby .Lyrics-translated{vertical-align:top}.Lyrics .Lyrics-original,.Lyrics .Lyrics-translated{width:100%;display:inline-block;white-space:pre-wrap}@media all and (max-width:720px){.Lyrics{min-width:100%}}@media all and (min-width:720px){.Lyrics .Lyrics-original,.Lyrics .Lyrics-translated{width:49.85%}}</style>');\n        editor.append(\n            '<style>' +\n            '   #LyricsKaiEditor .Lyrics-original:hover, #LyricsKaiEditor .Lyrics-translated:hover {' +\n            '      box-shadow: inset 0px 0px 0.2em #004eff;' +\n            '   }' +\n            '   #LyricsKaiEditor .Lyrics-line {' +\n            '      margin-top: 5px;' +\n            '   }' +\n            '</style>');\n\n        for (i = 0; i < n; i++) {\n            var line = $('<div />');\n            line.addClass('Lyrics-line');\n\n            var original_line = $('<div />');\n            original_line.addClass('Lyrics-original');\n            original_line.attr('contenteditable', 'true');\n            original_line.text(original[i] || '');\n\n            var translated_line = $('<div />');\n            translated_line.addClass('Lyrics-translated');\n            translated_line.attr('contenteditable', 'true');\n            translated_line.text(translated[i] || '');\n\n            line.append(original_line);\n            line.append(translated_line);\n            editor.append(line);\n        }\n        var close = $('<span />');\n        close.text('x');\n        close.css({\n            'cursor': 'pointer',\n            'position': 'absolute',\n            'top': '0px',\n            'right': '0px',\n            'margin': '0px 3px',\n            'font-size': '20px'\n        });\n        close.on('click', function () {\n            save();\n            container.remove();\n        });\n        var container = $('<div />')\n        container.attr('id', 'LyricsKaiEditor');\n        container.css({\n            'position': 'fixed',\n            'left': '50px',\n            'bottom': '50px',\n            'top': '50px',\n            'right': '50px',\n            'width': 'calc(100% - 100px)',\n            'height': 'calc(100% - 100px)',\n            'padding-top': '20px',\n            'box-sizing': 'border-box',\n            'box-shadow': '3px 3px 5px',\n            'background': 'white'\n        });\n        container.append(close);\n        container.append('<div style=\"clear:both;\"></div>');\n        container.append(editor);\n        $('body').append(container);\n\n        container.on('keypress', '.Lyrics-original, .Lyrics-translated', function (e) {\n            if (e.which == 13) { // enter\n                var line = $('<div />');\n                line.addClass('Lyrics-line');\n\n                var original_line = $('<div />');\n                original_line.addClass('Lyrics-original');\n                original_line.attr('contenteditable', 'true');\n                original_line.text('');\n\n                var translated_line = $('<div />');\n                translated_line.addClass('Lyrics-translated');\n                translated_line.attr('contenteditable', 'true');\n                translated_line.text('');\n\n                line.append(original_line);\n                line.append(translated_line);\n                $(this).parent('.Lyrics-line').after(line);\n                if ($(this).is('.Lyrics-original')) {\n                    original_line.focus();\n                } else {\n                    translated_line.focus();\n                }\n                return false;\n            }\n        });\n        container.on('keyup', '.Lyrics-original, .Lyrics-translated', function (e) {\n            if (e.which == 38) { // up\n                if ($(this).is('.Lyrics-original')) {\n                    $(this).parent('.Lyrics-line').prev('.Lyrics-line').find('.Lyrics-original').focus();\n                } else {\n                    $(this).parent('.Lyrics-line').prev('.Lyrics-line').find('.Lyrics-translated').focus();\n                }\n            } else if (e.which == 40) { // down\n                if ($(this).is('.Lyrics-original')) {\n                    $(this).parent('.Lyrics-line').next('.Lyrics-line').find('.Lyrics-original').focus();\n                } else {\n                    $(this).parent('.Lyrics-line').next('.Lyrics-line').find('.Lyrics-translated').focus();\n                }\n            }\n        })\n\n        function trim(str) {\n            return str.replace(/(^\\s*)|(\\s*$)/g, '');\n        }\n        function save() {\n            var original_new = '';\n            var translated_new = '';\n            editor.find('.Lyrics-line').each(function () {\n                original_new = original_new + '\\n' + $(this).find('.Lyrics-original').text();\n                translated_new = translated_new + '\\n' + $(this).find('.Lyrics-translated').text();\n            });\n            original_new = trim(original_new);\n            translated_new = trim(translated_new);\n            var codeContent_new = codeContent.replace(regex, '$1\\n' + original_new + '\\n$3\\n' + translated_new + '\\n}}')\n            $('#wpTextbox1').val($('#wpTextbox1').val().replace(codeContent, codeContent_new));\n        }\n    }\n});"}}}