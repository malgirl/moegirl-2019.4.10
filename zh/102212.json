{"parse":{"title":"MediaWiki:Gadget-twinklebatchdelete.js","pageid":164860,"wikitext":{"*":"//\u672cjs\u5f15\u81ea\u4e2d\u6587\u7ef4\u57fa\u767e\u79d1[[zhwiki:Special:Permalink/39584052]]\n!function(a){Twinkle.batchdelete=function(){Morebits.userIsInGroup(\"sysop\")&&(mw.config.get(\"wgCurRevisionId\")&&mw.config.get(\"wgNamespaceNumber\")>0||\"Prefixindex\"===mw.config.get(\"wgCanonicalSpecialPageName\"))&&Twinkle.addPortletLink(Twinkle.batchdelete.callback,\"\u6279\u5220\",\"tw-batch\",\"\u5220\u9664\u6b64\u5206\u7c7b\u6216\u9875\u9762\u4e2d\u7684\u6240\u6709\u94fe\u63a5\")},Twinkle.batchdelete.unlinkCache={},Twinkle.batchdelete.callback=function(){var c,d,e,f,g,h,i,b=new Morebits.simpleWindow(600,400);if(b.setTitle(\"\u6279\u91cf\u5220\u9664\"),b.setScriptName(\"Twinkle\"),b.addFooterLink(\"Twinkle\u5e2e\u52a9\",\"WP:TW/DOC#batchdelete\"),c=new Morebits.quickForm(Twinkle.batchdelete.callback.evaluate),c.append({type:\"checkbox\",list:[{label:\"\u5220\u9664\u9875\u9762\",name:\"delete_page\",value:\"delete\",checked:!0,subgroup:{type:\"checkbox\",list:[{label:\"\u5220\u9664\u5173\u8054\u7684\u8ba8\u8bba\u9875\uff08\u7528\u6237\u5bf9\u8bdd\u9875\u9664\u5916\uff09\",name:\"delete_talk\",value:\"delete_talk\",checked:!0},{label:\"\u5220\u9664\u91cd\u5b9a\u5411\",name:\"delete_redirects\",value:\"delete_redirects\",checked:!0}]}},{label:\"\u53d6\u6d88\u94fe\u5165\uff08\u4ec5\u5904\u7406\u6761\u76ee\u53caPortal\u540d\u5b57\u7a7a\u95f4\uff09\",name:\"unlink_page\",value:\"unlink\",checked:!1},{label:\"\u79fb\u9664\u6587\u4ef6\u4f7f\u7528\uff08\u6240\u6709\u540d\u5b57\u7a7a\u95f4\uff09\",name:\"unlink_file\",value:\"unlink_file\",checked:!0}]}),c.append({type:\"input\",name:\"reason\",label:\"\u7406\u7531\uff1a\",size:60}),d={action:\"query\",prop:\"revisions|info|imageinfo\",inprop:\"protection\",rvprop:\"size|user\"},14===mw.config.get(\"wgNamespaceNumber\"))d.generator=\"categorymembers\",d.gcmtitle=mw.config.get(\"wgPageName\"),d.gcmlimit=Twinkle.getPref(\"batchMax\");else if(\"Prefixindex\"===mw.config.get(\"wgCanonicalSpecialPageName\"))if(d.generator=\"allpages\",d.gaplimit=Twinkle.getPref(\"batchMax\"),Morebits.queryString.exists(\"prefix\"))d.gapnamespace=Morebits.queryString.get(\"namespace\"),d.gapprefix=Morebits.string.toUpperCaseFirstChar(Morebits.queryString.get(\"prefix\"));else{if(e=decodeURIComponent(location.pathname).split(\"/\"),e.length<3)return;f=e[3].split(\":\"),d.gapnamespace=mw.config.get(\"wgNamespaceIds\")[f[0].toLowerCase()],f.length<2||\"undefined\"==typeof d.gapnamespace?(d.gapnamespace=0,d.gapprefix=e.splice(3).join(\"/\")):(e=e.splice(4),e.splice(0,0,f.splice(1).join(\":\")),d.gapprefix=e.join(\"/\"))}else d.generator=\"links\",d.titles=mw.config.get(\"wgPageName\"),d.gpllimit=Twinkle.getPref(\"batchMax\");g=document.createElement(\"div\"),g.style.padding=\"15px\",b.setContent(g),Morebits.status.init(g),b.display(),h=new Morebits.status(\"\u6293\u53d6\u9875\u9762\u5217\u8868\"),i=new Morebits.wiki.api(\"\u8f7d\u5165\u4e2d\u2026\",d,function(b){var f,c=b.responseXML,d=a(c).find(\"page\").filter(\":not([missing])\"),e=[];d.each(function(b,c){var d=a(c),f=d.attr(\"ns\"),g=d.attr(\"title\"),h=\"\"===d.attr(\"redirect\"),i=d.find('pr[type=\"edit\"][level=\"sysop\"]'),j=i.length>0,k=d.find(\"rev\").attr(\"size\"),l=[];h&&l.push(\"\u91cd\u5b9a\u5411\"),j&&l.push(\"\u5168\u4fdd\u62a4\uff0c\"+(\"infinity\"===i.attr(\"expiry\")?\"\u65e0\u9650\u671f\":\"\u8fc7\u671f\u65f6\u95f4\"+i.attr(\"expiry\"))),\"6\"===f?(l.push(\"\u4e0a\u4f20\u8005\uff1a\"+d.find(\"ii\").attr(\"user\")),l.push(\"\u6700\u540e\u7f16\u8f91\uff1a\"+d.find(\"rev\").attr(\"user\"))):l.push(k+\"\u5b57\u8282\"),e.push({label:g+(l.length?\"\uff08\"+l.join(\"\uff0c\")+\"\uff09\":\"\"),value:g,checked:!0,style:j?\"color:red\":\"\"})}),b.params.form.append({type:\"header\",label:\"\u5f85\u5220\u9664\u9875\u9762\"}),b.params.form.append({type:\"button\",label:\"\u5168\u9009\",event:function(b){a(Morebits.quickForm.getElements(b.target.form,\"pages\")).prop(\"checked\",!0)}}),b.params.form.append({type:\"button\",label:\"\u5168\u4e0d\u9009\",event:function(b){a(Morebits.quickForm.getElements(b.target.form,\"pages\")).prop(\"checked\",!1)}}),b.params.form.append({type:\"checkbox\",name:\"pages\",list:e}),b.params.form.append({type:\"submit\"}),f=b.params.form.render(),b.params.Window.setContent(f),Morebits.checkboxShiftClickSupport(Morebits.quickForm.getElements(f,\"pages\"))},h),i.params={form:c,Window:b},i.post()},Twinkle.batchdelete.callback.evaluate=function(b){var c,d,e,f,g,h,i,j,k;if(Morebits.wiki.actionCompleted.notice=\"\u72b6\u6001\",Morebits.wiki.actionCompleted.postfix=\"\u6279\u91cf\u5220\u9664\u5df2\u5b8c\u6210\",c=a(Morebits.quickForm.getElements(b.target,\"pages\")).filter(function(a,b){return b.checked&&\"red\"===b.nextElementSibling.style.color}).length,!(c>0)||confirm(\"\u60a8\u5373\u5c06\u5220\u9664\"+c+\"\u4e2a\u5168\u4fdd\u62a4\u9875\u9762\uff0c\u786e\u5b9a\uff1f\")){if(d=b.target.getChecked(\"pages\"),e=b.target.reason.value,f=b.target.delete_page.checked,g=b.target.delete_talk&&b.target.delete_talk.checked,h=b.target.delete_redirects&&b.target.delete_redirects.checked,i=b.target.unlink_page.checked,j=b.target.unlink_file.checked,!e)return alert(\"\u60a8\u9700\u8981\u7ed9\u51fa\u7406\u7531\uff01\"),void 0;if(Morebits.simpleWindow.setButtonsEnabled(!1),Morebits.status.init(b.target),!d)return Morebits.status.error(\"\u9519\u8bef\",\"\u6ca1\u4ec0\u4e48\u8981\u5220\u7684\uff0c\u53d6\u6d88\u64cd\u4f5c\"),void 0;k=new Morebits.batchOperation(f?\"\u6b63\u5728\u5220\u9664\u9875\u9762\":\"\u521d\u59cb\u5316\u4f5c\u4e1a\u8bf7\u6c42\"),k.setOption(\"chunkSize\",Twinkle.getPref(\"batchdeleteChunks\")),k.setOption(\"preserveIndividualStatusLines\",f),k.setPageList(d),k.run(function(a){var b={page:a,delete_page:f,delete_talk:g,delete_redirects:h,unlink_page:i,unlink_file:j&&/^(File|Image)\\:/i.test(a),reason:e,pageDeleter:k},c=new Morebits.wiki.page(a,\"\u5220\u9664\u9875\u9762\"+a);c.setCallbackParameters(b),f?(c.setEditSummary(e+Twinkle.getPref(\"deletionSummaryAd\")),c.suppressProtectWarning(),c.deletePage(Twinkle.batchdelete.callbacks.doExtras,k.workerFailure)):Twinkle.batchdelete.callbacks.doExtras(c)})}},Twinkle.batchdelete.callbacks={doExtras:function(a){var c,d,e,b=a.parent?a.parent.getCallbackParameters():a.getCallbackParameters();b.pageDeleter.workerSuccess(a),b.unlink_page&&(Twinkle.batchdelete.unlinkCache={},c={action:\"query\",list:\"backlinks\",blfilterredir:\"nonredirects\",blnamespace:[0,100],bltitle:b.page,bllimit:5e3},d=new Morebits.wiki.api(\"\u6293\u53d6\u94fe\u5165\",c,Twinkle.batchdelete.callbacks.unlinkBacklinksMain),d.params=b,d.post()),b.unlink_file&&(c={action:\"query\",list:\"imageusage\",iutitle:b.page,iulimit:5e3},d=new Morebits.wiki.api(\"\u6293\u53d6\u6587\u4ef6\u94fe\u63a5\",c,Twinkle.batchdelete.callbacks.unlinkImageInstancesMain),d.params=b,d.post()),b.delete_page&&(b.delete_redirects&&(c={action:\"query\",titles:b.page,prop:\"redirects\",rdlimit:5e3},d=new Morebits.wiki.api(\"\u6293\u53d6\u91cd\u5b9a\u5411\",c,Twinkle.batchdelete.callbacks.deleteRedirectsMain),d.params=b,d.post()),b.delete_talk&&(e=mw.Title.newFromText(b.page),e&&0===e.namespace%2&&2!==e.namespace&&(e.namespace++,c={action:\"query\",titles:e.toText()},d=new Morebits.wiki.api(\"\u68c0\u67e5\u8ba8\u8bba\u9875\u662f\u5426\u5b58\u5728\",c,Twinkle.batchdelete.callbacks.deleteTalk),d.params=b,d.params.talkPage=e.toText(),d.post())))},deleteRedirectsMain:function(b){var e,c=b.responseXML,d=a(c).find(\"rd\").map(function(){return a(this).attr(\"title\")}).get();d.length&&(e=new Morebits.batchOperation(\"\u5220\u9664\u5230\"+b.params.page+\"\u7684\u91cd\u5b9a\u5411\"),e.setOption(\"chunkSize\",Twinkle.getPref(\"batchdeleteChunks\")),e.setPageList(d),e.run(function(a){var c=new Morebits.wiki.page(a,\"\u5220\u9664\"+a);c.setEditSummary(\"[[WP:CSD#G15|G15]]: \u5b64\u7acb\u9875\u9762: \u91cd\u5b9a\u5411\u5230\u5df2\u5220\u9664\u9875\u9762\u201c\"+b.params.page+\"\u201d\"+Twinkle.getPref(\"deletionSummaryAd\")),c.deletePage(e.workerSuccess,e.workerFailure)}))},deleteTalk:function(b){var e,c=b.responseXML,d=a(c).find(\"page:not([missing])\").length>0;d&&(e=new Morebits.wiki.page(b.params.talkPage,\"\u5220\u9664\u6761\u76ee\"+b.params.page+\"\u7684\u8ba8\u8bba\u9875\"),e.setEditSummary(\"[[WP:CSD#G15|G15]]: \u5b64\u7acb\u9875\u9762: \u5df2\u5220\u9664\u9875\u9762\u201c\"+b.params.page+\"\u201d\u7684\u8ba8\u8bba\u9875\"+Twinkle.getPref(\"deletionSummaryAd\")),e.deletePage())},unlinkBacklinksMain:function(b){var e,c=b.responseXML,d=a(c).find(\"bl\").map(function(){return a(this).attr(\"title\")}).get();d.length&&(e=new Morebits.batchOperation(\"\u53d6\u6d88\u5230\"+b.params.page+\"\u7684\u94fe\u5165\"),e.setOption(\"chunkSize\",Twinkle.getPref(\"batchdeleteChunks\")),e.setPageList(d),e.run(function(c){var d=new Morebits.wiki.page(c,\"\u53d6\u6d88\u94fe\u5165\u4e8e\"+c),f=a.extend({},b.params);f.title=c,f.unlinker=e,d.setCallbackParameters(f),d.load(Twinkle.batchdelete.callbacks.unlinkBacklinks)}))},unlinkBacklinks:function(a){var c,d,e,b=a.getCallbackParameters();return a.exists()?(c=b.title in Twinkle.batchdelete.unlinkCache?Twinkle.batchdelete.unlinkCache[b.title]:a.getPageText(),d=c,e=new Morebits.wikitext.page(c),e.removeLink(b.page),c=e.getText(),Twinkle.batchdelete.unlinkCache[b.title]=c,c===d?(b.unlinker.workerSuccess(a),void 0):(a.setEditSummary(\"\u53d6\u6d88\u5230\u9875\u9762\u201c\"+b.page+\"\u201d\u7684\u94fe\u63a5\"+Twinkle.getPref(\"deletionSummaryAd\")),a.setPageText(c),a.setCreateOption(\"nocreate\"),a.setMaxConflictRetries(10),a.save(b.unlinker.workerSuccess,b.unlinker.workerFailure),void 0)):(b.unlinker.workerSuccess(a),void 0)},unlinkImageInstancesMain:function(b){var e,c=b.responseXML,d=a(c).find(\"iu\").map(function(){return a(this).attr(\"title\")}).get();d.length&&(e=new Morebits.batchOperation(\"\u53d6\u6d88\u5230\"+b.params.page+\"\u7684\u94fe\u5165\"),e.setOption(\"chunkSize\",Twinkle.getPref(\"batchdeleteChunks\")),e.setPageList(d),e.run(function(c){var d=new Morebits.wiki.page(c,\"\u79fb\u9664\u6587\u4ef6\u4f7f\u7528\u4e8e\"+c),f=a.extend({},b.params);f.title=c,f.unlinker=e,d.setCallbackParameters(f),d.load(Twinkle.batchdelete.callbacks.unlinkImageInstances)}))},unlinkImageInstances:function(a){var c,d,e,f,b=a.getCallbackParameters();return a.exists()?(c=b.image.replace(/^(?:Image|File):/,\"\"),d=b.title in Twinkle.batchdelete.unlinkCache?Twinkle.batchdelete.unlinkCache[b.title]:a.getPageText(),e=d,f=new Morebits.wikitext.page(d),f.commentOutImage(c,\"\u6ce8\u91ca\u51fa\u6587\u4ef6\uff0c\u56e0\u5176\u5df2\u88ab\u5220\u9664\"),d=f.getText(),Twinkle.batchdelete.unlinkCache[b.title]=d,d===e?(a.getStatusElement().error(\"\u672a\u80fd\u53d6\u6d88\u6587\u4ef6\"+c+\"\u5728\"+a.getPageName()+\"\u7684\u4f7f\u7528\"),b.unlinker.workerFailure(a),void 0):(a.setEditSummary(\"\u79fb\u9664\u5bf9\u6587\u4ef6\"+c+\"\u7684\u4f7f\u7528\uff08\"+b.reason+\"\uff09\"+Twinkle.getPref(\"deletionSummaryAd\")),a.setPageText(d),a.setCreateOption(\"nocreate\"),a.setMaxConflictRetries(10),a.save(b.unlinker.workerSuccess,b.unlinker.workerFailure),void 0)):(b.unlinker.workerSuccess(a),void 0)}}}(jQuery);"}}}