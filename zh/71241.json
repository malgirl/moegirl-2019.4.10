{"parse":{"title":"User:AnnAngela/js/quick-save.js","pageid":124507,"wikitext":{"*":"// <pre>\n$(function() {\n    if ([\"Talk:\u8ba8\u8bba\u7248\", \"Talk:\u63d0\u95ee\u6c42\u52a9\u533a\"].indexOf(mw.config.get('wgPageName')) === -1) return;\n    if (mw.config.get('wgUserGroups').indexOf('sysop') === -1) return;\n    mw.loader.load('https://zh.moegirl.org/User:AnnAngela/js/quick-save.js/style.css?action=raw&ctype=text/css', 'text/css');\n    mw.loader.using('mw.Api').then(function() {\n        var container = $('<div class=\"AnnTools_Frame\" style=\"display: none;\"><div class=\"AnnTools_Frame_Head\"><div class=\"AnnTools_Frame_Title\">\u516c\u5171\u8ba8\u8bba\u9875\u6bb5\u843d\u5b58\u6863\u5de5\u5177</div><span class=\"AnnTools_Frame_Close\">\u00d7</span></div><div class=\"AnnTools_Frame_Content\"><div class=\"AnnTools_Confirm\"><div class=\"AnnTools_Confirm_Content\">\u8bf7\u95ee\u4f60\u662f\u8981\u5b58\u6863\u8fd9\u4e2a\u6bb5\u843d\u5417\uff1f<br>\u6bb5\u843d\u6807\u9898\uff1a<span class=\"AnnTools_SectionTitle\"></span></div><div class=\"AnnTools_Confirm_Yes\">\u662f\u5440\u662f\u5440</div><div class=\"AnnTools_Confirm_No\">\u5e76\u4e0d\u662f\u5462</div></div><div class=\"AnnTools_Info\"><div class=\"AnnTools_ProgressBar\"><div class=\"AnnTools_ProgressBar_Finished\"></div></div>\u8fdb\u5ea6\uff1a<ol class=\"AnnTools_WorkDetail\"></ol></div></div></div>').appendTo(\"body\"),\n            api = new mw.Api();\n        container.on('click', function(event) {\n            var target = $(event.target);\n            if (target.is('.AnnTools_Frame_Close') && !target.is('.disable'))\n                container.fadeOut(370).queue(function() {\n                    container.find('.AnnTools_Confirm, .AnnTools_Info, .AnnTools_ProgressBar_Finished').removeAttr('style');\n                    container.find('.AnnTools_WorkDetail').empty();\n                    $(this).dequeue();\n                });\n            else if (target.is('.AnnTools_Confirm_Yes')) {\n                container.find('.AnnTools_Confirm').fadeOut(370);\n                container.find('.AnnTools_Info').fadeIn(370);\n                var context = container.find('.AnnTools_Frame_Content');\n                var date = new Date();\n                date.setDate(date.getDate() - 10);\n                date.month = date.getMonth() + 1;\n                if (date.month < 10) date.month = \"0\" + date.month;\n                container.trigger('submit', date);\n            } else if (target.is('.AnnTools_Confirm_No')) container.fadeOut(370);\n        }).on('submit', function(_, date) {\n            var promise = new Promise(function(res) {\n                container.trigger('update', \"\u6b63\u5728\u83b7\u53d6\u8be5\u6bb5\u843d\u5185\u5bb9\")\n                    .find('.AnnTools_Frame_Close').addClass('disable');\n                $.ajax({\n                    url: 'https://zh.moegirl.org/index.php',\n                    data: {\n                        title: mw.config.get('wgPageName'),\n                        action: \"raw\",\n                        section: container.data().section\n                    },\n                    success: function(data) {\n                        data += '';\n                        var sectionText = data.replace(new RegExp(\"^\\\\s*(\\\\={1,})\" + container.data().sectionTitle + \"\\\\1\"), \"$1\" + container.data().sectionTitleSafe + \"$1\");\n                        var sectionTitleRaw = data.match(/==(.*)==/);\n                        if (sectionTitleRaw && sectionTitleRaw[1]) sectionTitleRaw = sectionTitleRaw[1];\n                        else sectionTitleRaw = container.data().sectionTitle;\n                        container.trigger('success');\n                        res({\n                            sectionText: sectionText,\n                            sectionTitleRaw: sectionTitleRaw\n                        });\n                    },\n                    error: function(_, textStatus) {\n                        throw new Error(textStatus);\n                    }\n                });\n            });\n            promise.then(function(data) {\n                container.trigger('update', \"\u6b63\u5728\u5b58\u6863\u8be5\u6bb5\u843d\u5185\u5bb9\");\n                return new Promise(function(res) {\n                    api.postWithToken('csrf', {\n                        action: \"edit\",\n                        format: \"json\",\n                        title: mw.config.get('wgPageName') + \"/\u5b58\u6863/\" + date.getFullYear() + \"\u5e74\" + date.month + \"\u6708\",\n                        text: data.sectionText,\n                        section: \"new\",\n                        tags: \"\u5feb\u901f\u5b58\u6863\u8ba8\u8bba\u4e32\",\n                        summary: \"\u5feb\u901f\u5b58\u6863\u8ba8\u8bba\u4e32\uff1a\" + container.data().sectionTitle\n                    }).then(function(result) {\n                        if (result.error) throw new Error('Editing Error: ' + result.error['*']);\n                        container.trigger('success');\n                        res(data);\n                    }, function(_, textStatus) {\n                        throw new Error(textStatus);\n                    });\n                });\n            }).then(function(data) {\n                container.trigger('update', \"\u6b63\u5728\u6807\u8bb0\u8be5\u6bb5\u843d\u4e3a\u5df2\u5b58\u6863\");\n                return new Promise(function(res) {\n                    api.postWithToken('csrf', {\n                        action: \"edit\",\n                        format: \"json\",\n                        title: mw.config.get('wgPageName'),\n                        summary: \"\u5feb\u901f\u5b58\u6863\u8ba8\u8bba\u4e32\uff1a\" + container.data().sectionTitle,\n                        text: \"==\" + data.sectionTitleRaw + \"==\\n\" + \"{{Saved|link=\" + mw.config.get('wgPageName') + \"/\u5b58\u6863/\" + date.getFullYear() + \"\u5e74\" + date.month + \"\u6708\" + \"|title=\" + container.data().sectionTitleSafe + \"}}\",\n                        section: container.data().section,\n                        tags: \"\u5feb\u901f\u5b58\u6863\u8ba8\u8bba\u4e32\"\n                    }).then(function(result) {\n                        if (result.error) throw new Error('Editing Error: ' + result.error['*']);\n                        container.trigger('success');\n                        res(data);\n                    }, function(_, textStatus) {\n                        throw new Error(textStatus);\n                    });\n                });\n            }).then(function(data) {\n                container.trigger('update', \"\u6b63\u5728\u68c0\u67e5\u5b58\u6863\u9875\u9762\u662f\u5426\u5e26\u6709\u6863\u6848\u9986\u6a21\u677f\");\n                return new Promise(function(res) {\n                    $.ajax({\n                        url: 'https://zh.moegirl.org/index.php',\n                        data: {\n                            title: mw.config.get('wgPageName') + \"/\u5b58\u6863/\" + date.getFullYear() + \"\u5e74\" + date.month + \"\u6708\",\n                            action: \"raw\",\n                            section: \"0\"\n                        },\n                        success: function(result) {\n                            data.savePageText = result + \"\";\n                            if (data.savePageText.indexOf(mw.config.get('wgTitle') + \"\u9875\u9876/\u6863\u6848\u9986}}\") !== -1) {\n                                container.trigger('success', \"\u6a21\u677f\u5b58\u5728\");\n                                window.setTimeout(function() {\n                                    container.trigger('finish');\n                                }, 730);\n                            } else {\n                                container.data('steps', container.data('steps') + 1);\n                                container.trigger('success', '\u6a21\u677f\u4e0d\u5b58\u5728');\n                                res(data);\n                            }\n                        },\n                        error: function(_, textStatus) {\n                            throw new Error(textStatus);\n                        }\n                    });\n                });\n            }).then(function(data) {\n                container.trigger('update', '\u6b63\u5728\u5411\u5b58\u6863\u9875\u6dfb\u52a0\u6863\u6848\u9986\u6a21\u677f');\n                api.postWithToken('csrf', {\n                    action: \"edit\",\n                    format: \"json\",\n                    title: mw.config.get('wgPageName') + \"/\u5b58\u6863/\" + date.getFullYear() + \"\u5e74\" + date.month + \"\u6708\",\n                    prependtext: \"{{\" + mw.config.get('wgTitle') + \"\u9875\u9876/\u6863\u6848\u9986}}\\n\",\n                    tags: \"\u5feb\u901f\u5b58\u6863\u8ba8\u8bba\u4e32\",\n                    summary: \"\u6dfb\u52a0\u6863\u6848\u9986\u6a21\u677f\"\n                }).then(function(result) {\n                    if (result.error) throw new Error('Editing Error: ' + result.error['*']);\n                    container.trigger('success');\n                    window.setTimeout(function() {\n                        container.trigger('finish');\n                    }, 730);\n                }, function(_, textStatus) {\n                    throw new Error(textStatus);\n                });\n            }).catch(function(reason) {\n                container.trigger('error', reason);\n            });\n        }).on('update', function(_, text) {\n            container.find('.AnnTools_WorkDetail').append($(\"<li>\", {\n                attr: {\n                    \"class\": \"AnnTools_WorkDetail_Ongoing\"\n                },\n                text: text + '\u2026\u2026'\n            }));\n        }).on('success', function(_, text) {\n            var list = container.find('.AnnTools_WorkDetail');\n            if (text) text = '\u6210\u529f\uff0c' + text + '\uff01';\n            else text = '\u6210\u529f\uff01';\n            list.find('li').last().append(text).toggleClass('AnnTools_WorkDetail_Ongoing AnnTools_WorkDetail_Succeed');\n            container.find('.AnnTools_ProgressBar_Finished').width(100 * list.find('li').length / container.data().steps + '%');\n        }).on('error', function(_, reason) {\n            var text = '\u5931\u8d25\uff01';\n            if (reason) text += '[' + reason + ']';\n            container.find(\".AnnTools_ProgressBar\").addClass(\"error\");\n            container.find('.AnnTools_WorkDetail li').last().append(text).removeClass(\"AnnTools_WorkDetail_Ongoing\").addClass(\"AnnTools_WorkDetail_Failed\");\n            container.find('.AnnTools_Frame_Close').removeClass('disable');\n        }).on('finish', function() {\n            container.find('.AnnTools_WorkDetail').after('<div class=\"AnnTools_Notice\">\u5b58\u6863\u5b8c\u6210\uff0c\u5373\u5c06\u5237\u65b0\u9875\u9762\u2026\u2026</div>');\n            window.setTimeout(function() {\n                window.location.reload();\n            }, 730);\n        });\n        $(\"#mw-content-text > .mw-parser-output > h2, #mw-content-text > .mw-parser-output > .discussionContainer > h2\").each(function() {\n            var content = $(this).nextUntil('h2').not('h2');\n            if (content.hasClass('saveNotice')) return;\n            var section = $(\"#mw-content-text\").find(\".mw-editsection\").index($(this).find(\".mw-editsection\")) + 1,\n                sectionTitle = '';\n            $($(this).find('.mw-headline')[0].childNodes).toArray().forEach(function(n) {\n                if (n.classList && n.classList.contains('mw-headline-number')) return;\n                sectionTitle += n.textContent + '';\n            });\n            var sectionTitleSafe = sectionTitle.split('').map(function(c) {\n                if (c === '#') return '';\n                if (/[A-Za-z0-9 \\u4e00-\\u9fa5]/.test(c)) return c;\n                return \"&#\" + c.charCodeAt(0) + \";\";\n            }).join('');\n            $(this).find(\".mw-editsection-bracket\").first()\n                .after('<span class=\"mw-editsection-divider\"> | </span>')\n                .after('<a href=\"javascript:void(0)\" class=\"AnnTools_QuickSave\">\u5feb\u901f\u5b58\u6863</a>');\n            $(this).on('click', function(event) {\n                if (!$(event.target).is('.AnnTools_QuickSave') || container.is(':visible')) return true;\n                container.find('.AnnTools_SectionTitle').text(sectionTitle);\n                container.data({\n                    section: section,\n                    sectionTitle: sectionTitle,\n                    sectionTitleSafe: sectionTitleSafe,\n                    steps: 4\n                }).fadeIn(370);\n            });\n        });\n    });\n});\n// </pre>"}}}