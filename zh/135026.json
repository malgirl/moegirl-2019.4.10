{"parse":{"title":"\u6a21\u5757:Select*","pageid":263864,"wikitext":{"*":"--local str = \"#header:result:;+ppp.xxx:value1;+ppp.yyy:value2;+aaa.zzz:value3;@ppp-t:p-head=;@ppp-b:=p-foot;$xxx,yyy,zzz,aaa,xxx-t:xxx:;ppp;aaa;@test;\"\n--local str = \"#header:result:;@ppp;$x-t:x-t:;$v,w,x,y,z;+pv,pw,px,py,pz,a:pa;$x,y,z,a;ppp\"\nlocal str=\"#header:\u672a\u547d\u540d\uff1a;#split:\uff1b;#footer:\u7ed3\u675f;#pahse:<br/>;+\u865a\u8bb0\u5f551.\u865a\u5b57\u6bb5A:\u7a7a\u6570\u636eA1;+\u865a\u8bb0\u5f551.\u865a\u5b57\u6bb5B:\u7a7a\u6570\u636eB1;+\u865a\u8bb0\u5f551.\u865a\u5b57\u6bb5C:\u7a7a\u6570\u636eB1;+\u865a\u8bb0\u5f552.\u865a\u5b57\u6bb5A:\u7a7a\u6570\u636eA2;+\u865a\u8bb0\u5f552.\u865a\u5b57\u6bb5B:\u7a7a\u6570\u636eB2;+\u865a\u8bb0\u5f553.\u865a\u5b57\u6bb5A:\u7a7a\u6570\u636eA3;+\u865a\u8bb0\u5f553.\u865a\u5b57\u6bb5B:\u7a7a\u6570\u636eB3;+\u865a\u8bb0\u5f553.\u865a\u5b57\u6bb5C:\u7a7a\u6570\u636eB1;+\u865a\u8bb0\u5f554.\u865a\u5b57\u6bb5A:\u7a7a\u6570\u636eA4;+\u865a\u8bb0\u5f554.\u865a\u5b57\u6bb5B:\u7a7a\u6570\u636eB4;$\u865a\u5b57\u6bb5B,\u865a\u5b57\u6bb5A,\u865a\u5b57\u6bb5C;$\u865a\u5b57\u6bb5B-t:\u706b\u529b=;$\u865a\u5b57\u6bb5A-t:\u96f7\u88c5=;$\u865a\u5b57\u6bb5C-t:\u88c5\u7532=;\u865a\u8bb0\u5f552;\u865a\u8bb0\u5f551;\u865a\u8bb0\u5f553;\u865a\u8bb0\u5f554\"\n--[[handle]]\nlocal function split( str,reps )\n    local resultStrList = {}\n    string.gsub(str,'[^'..reps..']+',function ( w )\n        table.insert(resultStrList,w)\n    end)\n    return resultStrList\nend\n--[[core logic]]\nlocal func = {}\nfunction func.test(frame)\n\tlocal str = string.gsub(frame.args['str'], \"%%;\", \"%%3B\") \n    local args = split(str,';')\n    local result = \"\"\n    local datasets = {\n        [\"#para\"]={[\"header\"]=\"\",[\"footer\"]=\"\",[\"prefix\"]=\"\",[\"suffix\"]=\"\",[\"split\"]=\"\",[\"phase\"]=\"<br/>\",[\"default\"]=\"\"},\n        [\"#query\"]={[\"key1\"]=\"value1\",[\"key2\"]=\"value2\"},[\"#queryfix\"]={[\"#query\"]=\"\"},[\"#datafix\"]={[\"#query\"]=\"\"}\n    }\n   local switch={\n        [\"\"]=function(text) return 0 end,\n        [\"#default\"]=function(text)            \n            if (datasets[text]~=nil) then   \n            \tresult = result..(datasets[\"#datafix\"][text..\"-t\"] and {datasets[\"#datafix\"][text..\"-t\"]} or {datasets[\"#para\"][\"header\"]})[1]\n                for i,v in ipairs(datasets[\"#query\"]) do  \n                    local tvt = (datasets[\"#queryfix\"][v..\"-t\"] and {datasets[\"#queryfix\"][v..\"-t\"]} or {(datasets[\"#para\"][\"prefix\"] and {datasets[\"#para\"][\"prefix\"]}or{\"\"})[1]})[1]\n                    local tvb =  (datasets[\"#queryfix\"][v..\"-b\"] and {datasets[\"#queryfix\"][v..\"-b\"]} or {(datasets[\"#para\"][\"suffix\"] and {datasets[\"#para\"][\"suffix\"]}or{\"\"})[1]})[1]\n                    local tvsp = (datasets[\"#queryfix\"][v..\"-sp\"] and {datasets[\"#queryfix\"][v..\"-sp\"]} or {datasets[\"#para\"][\"split\"]})[1]\n                    if (datasets[text][v]~=nil) then\n                        result = result..tvt..datasets[text][v]..tvb..datasets[\"#para\"][\"split\"]\n                        else\n                        result = result..tvt..datasets[\"#para\"][\"default\"]..tvb..datasets[\"#para\"][\"split\"]\n                    end                \n                end \n                result = result..(datasets[\"#datafix\"][text..\"-b\"] and {datasets[\"#datafix\"][text..\"-b\"]} or {datasets[\"#para\"][\"footer\"]})[1]..datasets[\"#para\"][\"phase\"]\n            end\n        end,\n        [\"+\"]=function(text) \n            local querys = split(string.sub(text,2),\",\")  \n            local _index = 0  \n            local __index = function() _index = _index +1 return _index end\n            for k,v in pairs(querys) do\n                local strstart = 0    \n                local strbegin = string.find(v,\"%.\",strstart+1)  \n                local strend = (strbegin and {string.find(v,\":\",strbegin + 1)} or {string.find(v,\":\",strstart + 1)})[1]\n                local tdata = (strbegin and {\n                    (strbegin and {string.sub(v, strstart+1,strbegin-1)} or {string.sub(v, strstart+1)})[1]\n                }or{\n                    (datasets[\"#queryfix\"][\"#query\"]~=\"#\" and {datasets[\"#queryfix\"][\"#query\"]} or {\"#default\"})[1]\n                })[1]\n                local tkey = (strend and {\n                    (strbegin and {string.sub(v, strbegin+1,strend-1)}or{string.sub(v, strstart+1,strend-1)})[1]\n                }or{\n                    (datasets[\"#query\"] and { (datasets[\"#query\"][_index] and {datasets[\"#query\"][__index()]} or {\"#key\"..__index()})[1] }or {\"#Error:001\"})[1]\n                })[1]\n                local tvalue = (strend and {string.sub(v, strend+1)}or{v})[1]               \n\n                if(datasets[tdata])then     \n                    datasets[tdata][tkey]=tvalue\n                else\n                    datasets[tdata] = {}\n                    datasets[tdata][tkey] = tvalue\n                end\n            end\n        end,\n        [\"$\"]=function(text)\n            local querys = split(string.sub(text,2),\",\") \n            local _index = 0  \n            local __index = function() _index = _index +1 return _index end\n            for k,v in pairs(querys) do\n                local strbegin = -1\n                local strend = string.find(v,\":\",strbegin + 1)  \n                local tpara = (strend and {string.sub(v, strbegin+1,strend-1)} or {\"#query\"})[1] \n                local tvalue = (strend and {string.sub(v,strend+1)} or {string.sub(v, strbegin+1)})[1]                \n                if tpara==\"#query\" then\n                    datasets[\"#query\"][__index()] = v\n                else\n                    datasets[\"#queryfix\"][tpara]=tvalue\n                end\n            end \n        end,\n        [\"#\"]=function(text)\n            local strbegin = string.find(text,\"#\",1)  \n            local strend = string.find(text,\":\",strbegin + 1)            \n            local tpara = string.sub(text, strbegin+1,strend-1)\n            local tvalue = string.sub(text, strend+1)\n            datasets[\"#para\"][tpara]=tvalue\n        end,\n        [\"@\"]=function(text)\n            local strbegin = string.find(text,\"@\",1)  \n            local strend = string.find(text,\":\",strbegin + 1)  \n            local tpara = (strend and {string.sub(text, strbegin+1,strend-1)} or {\"#query\"})[1] \n            local tvalue = (strend and {string.sub(text,strend+1)} or {string.sub(text, strbegin+1)})[1] \n            datasets[(tpara==\"#query\" and {\"#queryfix\"} or {\"#datafix\"})[1]][tpara]=tvalue\n        end                  \n    }\n    for k,v in pairs(args) do\n    \tv = string.gsub(v, \"%%3B\", \";\") \n        local f = switch[string.sub(v,1,1)]\n        if(f) then \n            f(v) \n        else\n            f = switch[\"#default\"]       \n            f(v)    \n        end\n    end\n    return result\nend\nreturn func"}}}