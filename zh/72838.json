{"parse":{"title":"User:Nbdd0121/tools/fixlinkshere.js","pageid":155992,"wikitext":{"*":"mw.loader.using('oojs-ui').done(function() {\n\n\tfunction queryPageName(title) {\n\t\td = $.Deferred();\n\t\tnew mw.Api().get({\n\t\t\taction: 'query',\n\t\t\tprop: 'linkshere',\n\t\t\t'titles': title,\n\t\t\t'rhlimit': 100\n\t\t}).done(function(result) {\n\t\t\tvar p = result.query.pages;\n\t\t\tvar id = Object.getOwnPropertyNames(p)[0];\n\t\t\tif (!p[id].linkshere) {\n\t\t\t\td.resolve([]);\n\t\t\t}\n\t\t\tvar r = p[id].linkshere.map(function(a) {\n\t\t\t\treturn a.title;\n\t\t\t})\n\t\t\td.resolve(r);\n\t\t}).fail(function() {\n\t\t\td.reject();\n\t\t});\n\t\treturn d.promise();\n\t}\n\n\tfunction fetchWikitext(title) {\n\t\td = $.Deferred();\n\t\tnew mw.Api().get({\n\t\t\taction: 'query',\n\t\t\tprop: 'revisions',\n\t\t\ttitles: title,\n\t\t\trvprop: 'content'\n\t\t}).done(function(result) {\n\t\t\tvar p = result.query.pages;\n\t\t\tvar id = Object.getOwnPropertyNames(p)[0];\n\t\t\tvar r = p[id].revisions[0];\n\t\t\tif (r.contentmodel !== 'wikitext') {\n\t\t\t\td.reject(new Error('\u5185\u5bb9\u683c\u5f0f\u4e0d\u4e3awikitext'));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\td.resolve(r['*']);\n\t\t}).fail(function() {\n\t\t\td.reject();\n\t\t});\n\t\treturn d.promise();\n\t}\n\n\tfunction writeWikitext(title, content, summary) {\n\t\td = $.Deferred();\n\t\tnew mw.Api().post({\n\t\t\taction: 'edit',\n\t\t\tsummary: summary,\n\t\t\ttext: content,\n\t\t\ttitle: title,\n\t\t\ttoken: mw.user.tokens.get('editToken')\n\t\t}).done(function(result) {\n\t\t\td.resolve();\n\t\t}).fail(function(e) {\n\t\t\td.reject(e);\n\t\t});\n\t\treturn d.promise();\n\t}\n\n\tfunction PageSelector(titles) {\n\t\tvar container = new OO.ui.StackLayout({\n\t\t\tcontinuous: true\n\t\t});\n\n\t\tfor (var i = 0; i < titles.length; i++) {\n\t\t\tvar widget = new OO.ui.ToggleSwitchWidget({\n\t\t\t\tvalue: true\n\t\t\t});\n\t\t\tvar layout = new OO.ui.FieldLayout(widget, {\n\t\t\t\tlabel: titles[i],\n\t\t\t\talign: 'inline'\n\t\t\t});\n\t\t\tcontainer.addItems([layout]);\n\t\t}\n\n\t\tthis.container = container;\n\t}\n\n\tPageSelector.prototype.getSelectedPages = function() {\n\t\tvar ret = [];\n\t\tvar fields = this.container.getItems();\n\t\tfor (var i = 0; i < fields.length; i++) {\n\t\t\tif (fields[i].getField().getValue()) {\n\t\t\t\tret.push(fields[i].getLabel());\n\t\t\t}\n\t\t}\n\t\treturn ret;\n\t}\n\n\tfunction CustomDialog(config, titles) {\n\t\tCustomDialog.super.call(this, config);\n\t\tthis.titles = titles;\n\t}\n\tOO.inheritClass(CustomDialog, OO.ui.Dialog);\n\n\tCustomDialog.static.title = '\u4fee\u6b63\u94fe\u5165\u9875\u9762';\n\n\tCustomDialog.prototype.initialize = function() {\n\t\tCustomDialog.super.prototype.initialize.call(this);\n\n\t\tvar layout = new OO.ui.StackLayout({\n\t\t\tpadded: true,\n\t\t\texpanded: false,\n\t\t\tcontinuous: true\n\t\t});\n\n\t\tthis.selector = new PageSelector(this.titles);\n\n\t\tthis.newName = new OO.ui.TextInputWidget({\n\t\t\tvalue: '\u76ee\u6807\u9875\u9762\u540d'\n\t\t});\n\n\t\tthis.submitBtn = new OO.ui.ButtonWidget({\n\t\t\tlabel: '\u4fee\u6b63\u94fe\u63a5',\n\t\t});\n\n\t\tvar self = this;\n\t\tthis.submitBtn.on('click', function() {\n\t\t\tvar target = self.newName.getValue();\n\t\t\tvar p = self.selector.getSelectedPages();\n\t\t\tvar replaceRegex1 = new RegExp('\\\\[\\\\[' + mw.config.get('wgPageName') + '(?=\\\\|)', 'g');\n\t\t\tvar replaceRegex2 = new RegExp('\\\\[\\\\[' + mw.config.get('wgPageName') + '(?=\\\\]\\\\])', 'g');\n\n\t\t\tfunction process(index) {\n\t\t\t\tif (index >= p.length) return;\n\t\t\t\tfetchWikitext(p[index]).done(function(text) {\n\t\t\t\t\tvar nt = text.replace(replaceRegex1, '[[' + target);\n\t\t\t\t\tnt = nt.replace(replaceRegex2, '[[' + target + '|' + mw.config.get('wgPageName'));\n\t\t\t\t\twriteWikitext(p[index], nt, '\u6279\u91cf\u94fe\u63a5\u4fee\u6b63:\u5c06[[' + mw.config.get('wgPageName') + ']]\u66ff\u6362\u4e3a[[' + target + ']]').done(function() {\n\t\t\t\t\t\talert(p[index] + ' Done');\n\t\t\t\t\t\tprocess(index + 1);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t\tprocess(0);\n\t\t});\n\n\t\tlayout.addItems([this.selector.container, this.newName, this.submitBtn]);\n\n\t\tthis.content = layout;\n\t\tthis.$body.append(this.content.$element);\n\t};\n\n\tCustomDialog.prototype.getBodyHeight = function() {\n\t\treturn this.content.$element.outerHeight(true);\n\t};\n\n\tvar windowManager = new OO.ui.WindowManager();\n\t$('body').append(windowManager.$element);\n\n\tfunction launch() {\n\t\tvar title = mw.config.get('wgPageName');\n\t\tqueryPageName(title).done(function(titles) {\n\t\t\tvar dialog = new CustomDialog({\n\t\t\t\tsize: 'medium'\n\t\t\t}, titles);\n\n\t\t\twindowManager.addWindows([dialog]);\n\t\t\twindowManager.openWindow(dialog);\n\t\t}).fail(function() {\n\t\t\talert('Error');\n\t\t});\n\t}\n\n\t$(function() {\n\t\t$('#p-tb ul').append($('<li><a>\u4fee\u6b63\u94fe\u63a5</a></li>').click(launch));\n\t});\n});"}}}