{"parse":{"title":"User:AnnAngela/widgetBilibili/es2015.js","pageid":222787,"wikitext":{"*":"'use strict';\nclass BilibiliWidget {\n    appendiframe(iframe, container) {\n        const self = this;\n        let overlay = iframe.closest('.bilibili-iframe-container').find('.bilibili-iframe-overlay');\n        iframe.appendTo(container).data('ready', 'complete').on('load', function () {\n            self.load($(this));\n        });\n        window.setTimeout(function () {\n            overlay.append('<br/>').append(self.refreshLink('iframe'));\n        }, 10000);\n    }\n    constructor() {\n        let self = this;\n        self.globalAutoplay = false;\n        $('.bilibili-video-container').show().each(function () {\n            self.exec($(this));\n        });\n    }\n    error({\n        $video,\n        mode,\n        info\n    }) {\n        const self = this;\n        let message = {\n            execError: `\uff08rawPage: ${info.page}, execPage: ${info._page}, pageListLength: ${info.list.length}, list: ${JSON.stringify(info.list)}\uff09`,\n            network: `readyState: ${info.readyState}, responseText: \"${info.responseText}\", status: ${info.status}, statusText: \"${info.statusText}\"`\n        };\n        $video.find('.bilibili-iframe-overlay').text('\u975e\u5e38\u62b1\u6b49\uff0c\u6211\u4eec\u65e0\u6cd5\u89e3\u6790\u8fd9\u4e2a\u89c6\u9891~').append('<br/>').append('\u8bf7\u70b9\u51fb\u4e0b\u65b9\u94fe\u63a5\u91cd\u8bd5\uff0c\u5982\u679c\u591a\u6b21\u4e0d\u6210\u529f\u8bf7\u5230\u63d0\u95ee\u6c42\u52a9\u533a\u53cd\u9988\u5e76\u9644\u4e0a\u6700\u4e0b\u65b9\u4fe1\u606f\uff01').append(self.refreshLink('load', {\n            $video\n        })).append('<br/>').append(message[mode]);\n    }\n    exec($video) {\n        const self = this;\n        let {\n            _aid,\n            _page,\n            pagename,\n            title,\n            _height,\n            _width,\n            _autoplay\n        } = $video[0].dataset;\n        let aid = _aid.replace('av', ''),\n            page = self.validNumber(_page) ? +_page : 1,\n            height = self.validNumber(_height) ? +_height : 421,\n            width = self.validNumber(_width) ? +_width : 600,\n            autoplay = ['false', ''].find('_autoplay') ? false : true;\n        let $title = $video.find('.bilibili-title'),\n            iframeContainer = $video.find('.bilibili-iframe-container'),\n            iframe = $('<iframe/>').attr({\n                frameborder: 0,\n                scrolling: 'no',\n                src: '',\n                allowfullscreen: true\n            }).css({\n                width: width,\n                height: height\n            }),\n            overlay = iframeContainer.find('.bilibili-iframe-overlay');\n        $title.text((title || `av${aid}`) + ([0, 1].find(page) ? ` (${page})` : ''));\n        iframeContainer.add(overlay.text('\u6b63\u5728\u52a0\u8f7d\uff0c\u8bf7\u7a0d\u5019\u2026\u2026')).css({\n            width: width,\n            height: height\n        });\n        self.getCid(aid).then(function ([list, Title]) {\n            let _page = 1,\n                name = title || (Title ? Title : `av${aid}`),\n                index,\n                length;\n            if (pagename) {\n                for (index = 0, length = list.length; index < length; index++) {\n                    if (list[index].Title !== pagename && list[index].title !== pagename) continue;\n                    _page = list[index].page;\n                    break;\n                }\n            } else _page = page;\n            let idx = _page - 1,\n                href = $title.attr('href');\n            if (list[index] !== undefined && list[index].VideoCid !== undefined) {\n                iframe.attr('src', `https://www.bilibili.com/html/html5player.html?cid=${list[index].VideoCid}&aid=${aid}&page=${_page}&enable_ssl=1&as_wide=1${autoplay ? '&autoplay' : ''}`);\n                if (iframeContainer.is(':visible')) self.appendiframe(iframe, iframeContainer);\n                else iframe.data('ready', 'load');\n                $title.attr('href', href.replace(new RegExp(`/index_${page}`, 'g'), `/index_${_page}`));\n                if (_page !== 1) name += ` [${_page}/${list.length}]`;\n                $title.text(name);\n            } else {\n                $title.text(title || `av${aid} [${_page}/${list.length}]`);\n                self.error({\n                    $video,\n                    mode: 'execError',\n                    info: {\n                        page,\n                        _page,\n                        list,\n                        aid\n                    }\n                });\n            }\n        }, function (err) {\n            $title.text((title || `av${aid}`) + ([0, 1].find(page) ? ` (${page})` : ''));\n            self.error({\n                $video,\n                mode: 'network',\n                info: err\n            });\n        });\n        $video.find('.bilibili-toggle').on('click', function () {\n            $(this).closest('tbody').children('.bilibili-video').toggle();\n            if ($(this).val() === '\u663e\u793a\u89c6\u9891') {\n                $(this).val('\u9690\u85cf\u89c6\u9891');\n                if (iframe.data('ready') === true) self.appendiframe(iframe, iframeContainer);\n            } else $(this).val('\u663e\u793a\u89c6\u9891');\n        })[autoplay ? 'click' : 'data']();\n    }\n    getCid(aid) {\n        const self = this;\n        return new Promise(function (res, rej) {\n            $.ajax({\n                url: `https://mgwbcprd.azureedge.net/BilibiliCid/Index/av${aid}`,\n                type: 'GET',\n                success: function (data) {\n                    res([data.VideoEntities.map(function (e, i) {\n                        e.page = i + 1;\n                        e.title = e.Title.replace(/^\\d+\u3001/, '');\n                        delete e.Id;\n                        delete e.ParentCollectionId;\n                        return e;\n                    }), data.Title]);\n                },\n                error: function (err) {\n                    rej(err);\n                }\n            });\n        });\n    }\n    load(iframe) {\n        let overlay = iframe.closest('.bilibili-iframe-container').find('.bilibili-iframe-overlay');\n        iframe.data('load', 'complete');\n        overlay.text('\u52a0\u8f7d\u5b8c\u6bd5\uff0c\u5982\u679c\u65e0\u6cd5\u89c2\u770b\u89c6\u9891\u8bf7\u5237\u65b0\u672c\u9875\u9762\uff0c\u5982\u679c\u591a\u6b21\u65e0\u6cd5\u89c2\u770b\u8bf7\u5230\u63d0\u95ee\u6c42\u52a9\u533a\u53cd\u9988\u3002').delay(2000).queue(function () {\n            $(this).fadeOut(370, function () {\n                $(this).remove();\n            });\n            $(this).dequeue();\n        });\n    }\n    refresh(iframe) {\n        const self = this;\n        let container = $(this).closest('.bilibili-iframe-container'),\n            clone = iframe.clone();\n        iframe.remove();\n        container.append(clone.on('load', function () {\n            self.load($(this));\n        }));\n    }\n    refreshLink(mode, info) {\n        const self = this;\n        return $('<a/>').text('\u91cd\u65b0\u52a0\u8f7d').on('click', function () {\n            switch (mode) {\n                case 'iframe': {\n                    self.refresh($(this).closest('.bilibili-iframe-container').find('iframe'));\n                    break;\n                }\n                case 'load': {\n                    info.$video.remove('iframe').find('.bilibili-iframe-overlay').text('\u6b63\u5728\u52a0\u8f7d\uff0c\u8bf7\u7a0d\u5019\u2026\u2026');\n                    self.exec(info.$video);\n                }\n            }\n        });\n    }\n    validNumber(_n) {\n        var n = +_n;\n        if (isNaN(n)\n            || n < 0\n            || /\\./.test(_n))\n            return false;\n        return true;\n    }\n}"}}}