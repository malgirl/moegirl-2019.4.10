{"parse":{"title":"User:AnnAngela/widgetBilibili/es5.js","pageid":222791,"wikitext":{"*":"/* jshint ignore:start */\n'use strict';\n// https://tc39.github.io/ecma262/#sec-array.prototype.find\nif (!Array.prototype.find) {\n    Object.defineProperty(Array.prototype, 'find', {\n        value: function(predicate) {\n            // 1. Let O be ? ToObject(this value).\n            if (this == null) {\n                throw new TypeError('\"this\" is null or not defined');\n            }\n\n            var o = Object(this);\n\n            // 2. Let len be ? ToLength(? Get(O, \"length\")).\n            var len = o.length >>> 0;\n\n            // 3. If IsCallable(predicate) is false, throw a TypeError exception.\n            if (typeof predicate !== 'function') {\n                throw new TypeError('predicate must be a function');\n            }\n\n            // 4. If thisArg was supplied, let T be thisArg; else let T be undefined.\n            var thisArg = arguments[1];\n\n            // 5. Let k be 0.\n            var k = 0;\n\n            // 6. Repeat, while k < len\n            while (k < len) {\n                // a. Let Pk be ! ToString(k).\n                // b. Let kValue be ? Get(O, Pk).\n                // c. Let testResult be ToBoolean(? Call(predicate, T, \u00ab kValue, k, O \u00bb)).\n                // d. If testResult is true, return kValue.\n                var kValue = o[k];\n                if (predicate.call(thisArg, kValue, k, o)) {\n                    return kValue;\n                }\n                // e. Increase k by 1.\n                k++;\n            }\n\n            // 7. Return undefined.\n            return undefined;\n        }\n    });\n}\nvar _slicedToArray = function() {\n    function sliceIterator(arr, i) {\n        var _arr = [];\n        var _n = true;\n        var _d = false;\n        var _e = undefined;\n        try {\n            for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value);\n                if (i && _arr.length === i) break; } } catch (err) { _d = true;\n            _e = err; } finally {\n            try {\n                if (!_n && _i[\"return\"]) _i[\"return\"](); } finally {\n                if (_d) throw _e; } }\n        return _arr; }\n    return function(arr, i) {\n        if (Array.isArray(arr)) {\n            return arr; } else if (Symbol.iterator in Object(arr)) {\n            return sliceIterator(arr, i); } else {\n            throw new TypeError(\"Invalid attempt to destructure non-iterable instance\"); } }; }();\n\nvar _createClass = function() {\n    function defineProperties(target, props) {\n        for (var i = 0; i < props.length; i++) {\n            var descriptor = props[i];\n            descriptor.enumerable = descriptor.enumerable || false;\n            descriptor.configurable = true;\n            if (\"value\" in descriptor) descriptor.writable = true;\n            Object.defineProperty(target, descriptor.key, descriptor); } }\n    return function(Constructor, protoProps, staticProps) {\n        if (protoProps) defineProperties(Constructor.prototype, protoProps);\n        if (staticProps) defineProperties(Constructor, staticProps);\n        return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) {\n    if (!(instance instanceof Constructor)) {\n        throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar BilibiliWidget = function() {\n    _createClass(BilibiliWidget, [{\n        key: 'appendiframe',\n        value: function appendiframe(iframe, container) {\n            var self = this;\n            var overlay = iframe.closest('.bilibili-iframe-container').find('.bilibili-iframe-overlay');\n            iframe.appendTo(container).data('ready', 'complete').on('load', function() {\n                self.load($(this));\n            });\n            window.setTimeout(function() {\n                overlay.append('<br/>').append(self.refreshLink('iframe'));\n            }, 10000);\n        }\n    }]);\n\n    function BilibiliWidget() {\n        _classCallCheck(this, BilibiliWidget);\n\n        var self = this;\n        self.globalAutoplay = false;\n        $('.bilibili-video-container').show().each(function() {\n            self.exec($(this));\n        });\n    }\n\n    _createClass(BilibiliWidget, [{\n        key: 'error',\n        value: function error(_ref) {\n            var $video = _ref.$video,\n                mode = _ref.mode,\n                info = _ref.info;\n\n            var self = this;\n            var message = {\n                execError: '\\uFF08rawPage: ' + info.page + ', execPage: ' + info._page + ', pageListLength: ' + info.list.length + ', list: ' + JSON.stringify(info.list) + '\\uFF09',\n                network: 'readyState: ' + info.readyState + ', responseText: \"' + info.responseText + '\", status: ' + info.status + ', statusText: \"' + info.statusText + '\"'\n            };\n            $video.find('.bilibili-iframe-overlay').text('\u975e\u5e38\u62b1\u6b49\uff0c\u6211\u4eec\u65e0\u6cd5\u89e3\u6790\u8fd9\u4e2a\u89c6\u9891~').append('<br/>').append('\u8bf7\u70b9\u51fb\u4e0b\u65b9\u94fe\u63a5\u91cd\u8bd5\uff0c\u5982\u679c\u591a\u6b21\u4e0d\u6210\u529f\u8bf7\u5230\u63d0\u95ee\u6c42\u52a9\u533a\u53cd\u9988\u5e76\u9644\u4e0a\u6700\u4e0b\u65b9\u4fe1\u606f\uff01').append(self.refreshLink('load', {\n                $video: $video\n            })).append('<br/>').append(message[mode]);\n        }\n    }, {\n        key: 'exec',\n        value: function exec($video) {\n            var self = this;\n            var _$video$0$dataset = $video[0].dataset,\n                _aid = _$video$0$dataset._aid,\n                _page = _$video$0$dataset._page,\n                pagename = _$video$0$dataset.pagename,\n                title = _$video$0$dataset.title,\n                _height = _$video$0$dataset._height,\n                _width = _$video$0$dataset._width,\n                _autoplay = _$video$0$dataset._autoplay;\n\n            var aid = _aid.replace('av', ''),\n                page = self.validNumber(_page) ? +_page : 1,\n                height = self.validNumber(_height) ? +_height : 421,\n                width = self.validNumber(_width) ? +_width : 600,\n                autoplay = ['false', ''].find('_autoplay') ? false : true;\n            var $title = $video.find('.bilibili-title'),\n                iframeContainer = $video.find('.bilibili-iframe-container'),\n                iframe = $('<iframe/>').attr({\n                    frameborder: 0,\n                    scrolling: 'no',\n                    src: '',\n                    allowfullscreen: true\n                }).css({\n                    width: width,\n                    height: height\n                }),\n                overlay = iframeContainer.find('.bilibili-iframe-overlay');\n            $title.text((title || 'av' + aid) + ([0, 1].find(page) ? ' (' + page + ')' : ''));\n            iframeContainer.add(overlay.text('\u6b63\u5728\u52a0\u8f7d\uff0c\u8bf7\u7a0d\u5019\u2026\u2026')).css({\n                width: width,\n                height: height\n            });\n            self.getCid(aid).then(function(_ref2) {\n                var _ref3 = _slicedToArray(_ref2, 2),\n                    list = _ref3[0],\n                    Title = _ref3[1];\n\n                var _page = 1,\n                    name = title || (Title ? Title : 'av' + aid),\n                    index = void 0,\n                    length = void 0;\n                if (pagename) {\n                    for (index = 0, length = list.length; index < length; index++) {\n                        if (list[index].Title !== pagename && list[index].title !== pagename) continue;\n                        _page = list[index].page;\n                        break;\n                    }\n                } else _page = page;\n                var idx = _page - 1,\n                    href = $title.attr('href');\n                if (list[index] !== undefined && list[index].VideoCid !== undefined) {\n                    iframe.attr('src', 'https://www.bilibili.com/html/html5player.html?cid=' + list[index].VideoCid + '&aid=' + aid + '&page=' + _page + '&enable_ssl=1&as_wide=1' + (autoplay ? '&autoplay' : ''));\n                    if (iframeContainer.is(':visible')) self.appendiframe(iframe, iframeContainer);\n                    else iframe.data('ready', 'load');\n                    $title.attr('href', href.replace(new RegExp('/index_' + page, 'g'), '/index_' + _page));\n                    if (_page !== 1) name += ' [' + _page + '/' + list.length + ']';\n                    $title.text(name);\n                } else {\n                    $title.text(title || 'av' + aid + ' [' + _page + '/' + list.length + ']');\n                    self.error({\n                        $video: $video,\n                        mode: 'execError',\n                        info: {\n                            page: page,\n                            _page: _page,\n                            list: list,\n                            aid: aid\n                        }\n                    });\n                }\n            }, function(err) {\n                $title.text((title || 'av' + aid) + ([0, 1].find(page) ? ' (' + page + ')' : ''));\n                self.error({\n                    $video: $video,\n                    mode: 'network',\n                    info: err\n                });\n            });\n            $video.find('.bilibili-toggle').on('click', function() {\n                $(this).closest('tbody').children('.bilibili-video').toggle();\n                if ($(this).val() === '\u663e\u793a\u89c6\u9891') {\n                    $(this).val('\u9690\u85cf\u89c6\u9891');\n                    if (iframe.data('ready') === true) self.appendiframe(iframe, iframeContainer);\n                } else $(this).val('\u663e\u793a\u89c6\u9891');\n            })[autoplay ? 'click' : 'data']();\n        }\n    }, {\n        key: 'getCid',\n        value: function getCid(aid) {\n            var self = this;\n            return new Promise(function(res, rej) {\n                $.ajax({\n                    url: 'https://mgwbcprd.azureedge.net/BilibiliCid/Index/av' + aid,\n                    type: 'GET',\n                    success: function success(data) {\n                        res([data.VideoEntities.map(function(e, i) {\n                            e.page = i + 1;\n                            e.title = e.Title.replace(/^\\d+\u3001/, '');\n                            delete e.Id;\n                            delete e.ParentCollectionId;\n                            return e;\n                        }), data.Title]);\n                    },\n                    error: function error(err) {\n                        rej(err);\n                    }\n                });\n            });\n        }\n    }, {\n        key: 'load',\n        value: function load(iframe) {\n            var overlay = iframe.closest('.bilibili-iframe-container').find('.bilibili-iframe-overlay');\n            iframe.data('load', 'complete');\n            overlay.text('\u52a0\u8f7d\u5b8c\u6bd5\uff0c\u5982\u679c\u65e0\u6cd5\u89c2\u770b\u89c6\u9891\u8bf7\u5237\u65b0\u672c\u9875\u9762\uff0c\u5982\u679c\u591a\u6b21\u65e0\u6cd5\u89c2\u770b\u8bf7\u5230\u63d0\u95ee\u6c42\u52a9\u533a\u53cd\u9988\u3002').delay(2000).queue(function() {\n                $(this).fadeOut(370, function() {\n                    $(this).remove();\n                });\n                $(this).dequeue();\n            });\n        }\n    }, {\n        key: 'refresh',\n        value: function refresh(iframe) {\n            var self = this;\n            var container = $(this).closest('.bilibili-iframe-container'),\n                clone = iframe.clone();\n            iframe.remove();\n            container.append(clone.on('load', function() {\n                self.load($(this));\n            }));\n        }\n    }, {\n        key: 'refreshLink',\n        value: function refreshLink(mode, info) {\n            var self = this;\n            return $('<a/>').text('\u91cd\u65b0\u52a0\u8f7d').on('click', function() {\n                switch (mode) {\n                    case 'iframe':\n                        {\n                            self.refresh($(this).closest('.bilibili-iframe-container').find('iframe'));\n                            break;\n                        }\n                    case 'load':\n                        {\n                            info.$video.remove('iframe').find('.bilibili-iframe-overlay').text('\u6b63\u5728\u52a0\u8f7d\uff0c\u8bf7\u7a0d\u5019\u2026\u2026');\n                            self.exec(info.$video);\n                        }\n                }\n            });\n        }\n    }, {\n        key: 'validNumber',\n        value: function validNumber(_n) {\n            var n = +_n;\n            if (isNaN(n) || n < 0 || /\\./.test(_n)) return false;\n            return true;\n        }\n    }]);\n\n    return BilibiliWidget;\n}();"}}}